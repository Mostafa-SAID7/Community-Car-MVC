@{
    ViewData["Title"] = "Chats";
}

<div class="card card-glass flex h-[calc(100vh-8rem)] overflow-hidden mb-6">
    <!-- Chat Sidebar -->
    <div class="w-80 border-r border-border flex flex-col bg-muted/10">
        <div class="p-4 border-b border-border bg-muted/20">
            <h2 class="text-lg font-semibold flex items-center gap-2 mb-3">
                <i data-lucide="message-circle" class="text-primary w-5 h-5"></i>
                Messages
            </h2>
            <div class="relative">
                <input type="text" class="form-control pl-9 w-full rounded-lg bg-background border-border" placeholder="Search conversations..." id="chat-search">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"></i>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto" id="conversations-list">
            <!-- Conversations will be loaded here -->
            <div class="conversation-item flex items-center gap-3 p-3 cursor-pointer hover:bg-muted/20 transition-colors border-b border-border/50 relative" data-conversation-id="sample-1">
                <div class="relative shrink-0">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center text-white font-semibold">JD</div>
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-background rounded-full"></div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-0.5">
                        <span class="font-medium text-sm">John Doe</span>
                        <span class="text-xs text-muted-foreground">2m ago</span>
                    </div>
                    <div class="text-xs text-muted-foreground truncate">Hey, how's your car project going?</div>
                </div>
                <span class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 bg-primary text-white text-[10px] font-bold rounded-full flex items-center justify-center">2</span>
            </div>
            
            <div class="conversation-item flex items-center gap-3 p-3 cursor-pointer hover:bg-muted/20 transition-colors border-b border-border/50 relative" data-conversation-id="sample-2">
                <div class="relative shrink-0">
                    <div class="w-12 h-12 rounded-full bg-muted flex items-center justify-center font-semibold text-muted-foreground">SM</div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-0.5">
                        <span class="font-medium text-sm">Sarah Miller</span>
                        <span class="text-xs text-muted-foreground">1h ago</span>
                    </div>
                    <div class="text-xs text-muted-foreground truncate">Thanks for the help with the engine!</div>
                </div>
            </div>
            
            <div class="conversation-item flex items-center gap-3 p-3 cursor-pointer hover:bg-muted/20 transition-colors border-b border-border/50 relative" data-conversation-id="sample-3">
                <div class="relative shrink-0">
                    <div class="w-12 h-12 rounded-full bg-muted flex items-center justify-center font-semibold text-muted-foreground">CG</div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-0.5">
                        <span class="font-medium text-sm">Car Group</span>
                        <span class="text-xs text-muted-foreground">3h ago</span>
                    </div>
                    <div class="text-xs text-muted-foreground truncate">Mike: Anyone going to the car show this weekend?</div>
                </div>
                <span class="w-5 h-5 bg-primary text-white text-[10px] font-bold rounded-full flex items-center justify-center absolute right-3 top-1/2 -translate-y-1/2">5</span>
            </div>
        </div>
    </div>
    
    <!-- Chat Main Area -->
    <!-- Chat Main Area -->
    <div class="flex-1 flex flex-col bg-background/50 relative">
        <div class="flex-1 flex flex-col items-center justify-center text-center p-8 text-muted-foreground" id="chat-empty-state">
            <i data-lucide="message-circle" class="w-16 h-16 mb-4 opacity-50"></i>
            <h3 class="text-xl font-semibold mb-2 text-foreground">Select a conversation</h3>
            <p class="mb-6">Choose a conversation from the sidebar to start chatting</p>
            <button class="btn btn-primary gap-2" id="new-chat-btn">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Start New Chat
            </button>
        </div>
        
        <!-- Chat Header (hidden initially) -->
        <div class="flex justify-between items-center p-4 border-b border-border bg-card/50" id="chat-header" style="display: none;">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-10 h-10 rounded-full bg-muted flex items-center justify-center font-semibold overflow-hidden" id="chat-avatar">JD</div>
                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-background rounded-full" id="chat-online-indicator"></div>
                </div>
                <div>
                    <h3 class="font-semibold text-base m-0 leading-tight" id="chat-title">John Doe</h3>
                    <div class="text-xs text-success" id="chat-status">Online</div>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button class="btn btn-ghost btn-icon" title="Call">
                    <i data-lucide="phone" class="w-4 h-4"></i>
                </button>
                <button class="btn btn-ghost btn-icon" title="Video Call">
                    <i data-lucide="video" class="w-4 h-4"></i>
                </button>
                <button class="btn btn-ghost btn-icon" title="More Options">
                    <i data-lucide="more-vertical" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        
        <!-- Messages Area (hidden initially) -->
        <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4" id="chat-messages" style="display: none;">
            <!-- Messages will be loaded here -->
        </div>
        
        <!-- Typing Indicator Area -->
        <div id="typing-indicators"></div>
        
        <!-- Message Input (hidden initially) -->
        <div class="p-4 border-t border-border bg-card" id="chat-input-area" style="display: none;">
            <div class="flex items-end gap-3 bg-background border border-border rounded-xl p-3 focus-within:border-primary focus-within:ring-2 ring-primary/10 transition-all">
                <textarea class="flex-1 bg-transparent border-none outline-none text-sm resize-none max-h-32 min-h-[20px]" id="message-input" placeholder="Type a message..." rows="1"></textarea>
                <div class="flex items-center gap-2">
                    <button class="btn btn-ghost btn-icon btn-sm text-muted-foreground hover:text-foreground" title="Attach File">
                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                    </button>
                    <button class="btn btn-ghost btn-icon btn-sm text-muted-foreground hover:text-foreground" title="Emoji">
                        <i data-lucide="smile" class="w-4 h-4"></i>
                    </button>
                    <button class="btn btn-primary btn-icon btn-sm rounded-lg" id="send-message-btn" title="Send Message" disabled>
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Status -->
<div class="chat-connection-status" style="display: none;"></div>

@section Scripts {
    <script src="~/lib/signalr/signalr.min.js"></script>
    <script src="~/js/signalr-chat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const conversationItems = document.querySelectorAll('.conversation-item');
            const chatEmptyState = document.getElementById('chat-empty-state');
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-message-btn');
            
            let currentConversationId = null;
            
            // Handle conversation selection
            conversationItems.forEach(item => {
                item.addEventListener('click', function() {
                    const conversationId = this.getAttribute('data-conversation-id');
                    selectConversation(conversationId, this);
                });
            });
            
            function selectConversation(conversationId, element) {
                // Update active conversation
                conversationItems.forEach(item => {
                    item.classList.remove('bg-muted/20', 'active');
                    item.classList.add('hover:bg-muted/20');
                });
                element.classList.remove('hover:bg-muted/20');
                element.classList.add('bg-muted/20', 'active');
                
                // Hide empty state, show chat interface
                chatEmptyState.style.display = 'none';
                chatHeader.style.display = 'flex';
                chatMessages.style.display = 'flex';
                chatInputArea.style.display = 'block';
                
                // Update chat header
                // Note: We need to be careful with selectors as structure changed
                // Using simplistic text content retrieval for now, improvements needed for real app
                const avatar = element.querySelector('.w-12').textContent; 
                const name = element.querySelector('.font-medium').textContent;
                const hasOnline = element.querySelector('.bg-green-500'); // Check for green dot
                
                document.getElementById('chat-avatar').textContent = avatar;
                document.getElementById('chat-title').textContent = name;
                document.getElementById('chat-status').textContent = hasOnline ? 'Online' : 'Offline';
                document.getElementById('chat-status').className = hasOnline ? 'text-xs text-success' : 'text-xs text-muted-foreground';
                document.getElementById('chat-online-indicator').style.display = hasOnline ? 'block' : 'none';
                
                // Clear unread badge
                const unreadBadge = element.querySelector('.bg-primary.text-white'); // Selector for badge
                if (unreadBadge) {
                    unreadBadge.style.display = 'none';
                }
                
                // Join conversation via SignalR
                if (window.chatClient) {
                    if (currentConversationId) {
                        window.chatClient.leaveConversation(currentConversationId);
                    }
                    window.chatClient.joinConversation(conversationId);
                    currentConversationId = conversationId;
                }
                
                // Load messages for this conversation
                loadMessages(conversationId);
            }
            
            function loadMessages(conversationId) {
                // Clear existing messages
                chatMessages.innerHTML = '';
                
                // Add sample messages for demo
                const sampleMessages = [
                    {
                        id: '1',
                        content: 'Hey, how\'s your car project going?',
                        isOwn: false,
                        time: '10:30 AM'
                    },
                    {
                        id: '2',
                        content: 'It\'s going great! Just finished installing the new exhaust system.',
                        isOwn: true,
                        time: '10:32 AM'
                    },
                    {
                        id: '3',
                        content: 'That sounds awesome! How does it sound?',
                        isOwn: false,
                        time: '10:33 AM'
                    }
                ];
                
                sampleMessages.forEach(msg => {
                    addMessageToChat(msg);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function addMessageToChat(message) {
                const messageGroup = document.createElement('div');
                messageGroup.className = `flex flex-col gap-1 ${message.isOwn ? 'items-end' : 'items-start'}`;
                
                const bubbleClass = message.isOwn 
                    ? 'bg-primary text-primary-foreground rounded-l-2xl rounded-tr-2xl' 
                    : 'bg-muted text-foreground rounded-r-2xl rounded-tl-2xl';
                
                messageGroup.innerHTML = `
                    <div class="max-w-[75%] flex flex-col gap-1" data-message-id="${message.id}">
                        <div class="px-4 py-2 text-sm ${bubbleClass} shadow-sm">
                            ${message.content}
                        </div>
                        <div class="flex items-center gap-2 text-[10px] text-muted-foreground ${message.isOwn ? 'justify-end' : 'justify-start'}">
                            <span class="opacity-70">${message.time}</span>
                            ${message.isOwn ? '<span class="text-primary"><i data-lucide="check-check" class="w-3 h-3"></i></span>' : ''}
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageGroup);
                lucide.createIcons();
            }
            
            // Handle message input
            messageInput.addEventListener('input', function() {
                const hasContent = this.value.trim().length > 0;
                sendBtn.disabled = !hasContent;
                
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Send typing indicator
                if (hasContent && currentConversationId && window.chatClient) {
                    window.chatClient.startTyping(currentConversationId);
                }
            });
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);
            
            function sendMessage() {
                const content = messageInput.value.trim();
                if (!content || !currentConversationId) return;
                
                // Send via SignalR
                if (window.chatClient) {
                    window.chatClient.sendMessage(currentConversationId, content).then(success => {
                        if (success) {
                            // Add message to UI immediately for better UX
                            const message = {
                                id: Date.now().toString(),
                                content: content,
                                isOwn: true,
                                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                            };
                            addMessageToChat(message);
                            
                            // Clear input
                            messageInput.value = '';
                            messageInput.style.height = 'auto';
                            sendBtn.disabled = true;
                            
                            // Stop typing indicator
                            window.chatClient.stopTyping(currentConversationId);
                            
                            // Scroll to bottom
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    });
                }
            }
            
            // Search functionality
            const searchInput = document.getElementById('chat-search');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                conversationItems.forEach(item => {
                    const name = item.querySelector('.font-medium').textContent.toLowerCase();
                    const preview = item.querySelector('.text-xs.truncate').textContent.toLowerCase();
                    const matches = name.includes(searchTerm) || preview.includes(searchTerm);
                    item.style.display = matches ? 'flex' : 'none';
                });
            });
        });
    </script>
}
