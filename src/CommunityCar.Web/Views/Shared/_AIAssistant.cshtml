@using Microsoft.Extensions.Localization
@inject IViewLocalizer Localizer
@{
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");
}

<script>
    window.aiLocalizer = {
        ServiceError: '@Localizer["ServiceError"]',
        ConnectionError: '@Localizer["ConnectionError"]'
    };
</script>
<!-- AI Assistant FAB & Widget Wrapper -->
<div class="fixed bottom-6 @(isArabic ? "left-6" : "right-6") z-50" dir="@(isArabic ? "rtl" : "ltr")">
    <!-- Chat Widget -->
    <div id="ai-chat-widget" class="fixed bottom-24 @(isArabic ? "left-4 md:left-6" : "right-4 md:right-6") w-80 h-[500px] max-h-[70vh] max-w-[calc(100vw-2rem)] md:w-96 md:h-[600px] md:max-h-[80vh] bg-card border border-border rounded-2xl shadow-2xl flex flex-col overflow-hidden z-50 opacity-0 pointer-events-none translate-y-10 scale-95 @(isArabic ? "origin-bottom-left" : "origin-bottom-right") transition-all duration-300 ease-in-out">
        <div class="flex-none flex items-center justify-between p-4 bg-gradient-to-r from-primary to-primary/80 text-primary-foreground">
            <div class="flex items-center gap-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-primary-foreground/20">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                </div>
                <div>
                    <h4 class="text-sm font-bold">@Localizer["CCAssistant"]</h4>
                    <span class="text-xs opacity-70">@Localizer["AlwaysHelpful"]</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-primary-foreground/10 transition-colors" id="chat-history-btn" aria-label="Chat History" title="Chat History">
                    <i data-lucide="history" class="w-4 h-4"></i>
                </button>
                <button class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-primary-foreground/10 transition-colors" id="clear-chat-btn" aria-label="Clear Chat" title="Clear Chat">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
                <button class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-primary-foreground/10 transition-colors" id="close-chat" aria-label="Close Chat">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        
        <div class="flex-1 min-h-0 overflow-y-auto p-4 space-y-4 bg-muted/20 custom-scrollbar scroll-smooth" id="chat-messages">
            <div class="flex gap-3">
                <div class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground shrink-0 mt-1">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </div>
                <div class="flex-1 bg-card border border-border rounded-lg p-3 shadow-sm">
                    <p class="text-sm text-foreground">@Localizer["WelcomeMessage"]</p>
                </div>
            </div>
        </div>
        
        <div class="flex-none p-4 border-t border-border bg-card">
            <div class="flex items-center gap-2">
                <input type="text" id="chat-input" placeholder="@Localizer["AskAnything"]" autocomplete="off" class="flex-1 px-4 py-2 bg-background border border-input rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-ring">
                <button id="send-chat" class="inline-flex items-center justify-center h-10 w-10 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-colors" aria-label="Send Message">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- FAB Button -->
    <div id="ai-assist-btn">
        <button class="flex items-center justify-center h-14 w-14 rounded-full bg-gradient-to-br from-primary to-primary/80 text-primary-foreground shadow-lg hover:shadow-2xl hover:scale-110 transition-all duration-300" id="toggle-chat" aria-label="AI Assistant">
            <i data-lucide="sparkles" class="w-6 h-6"></i>
        </button>
    </div>
</div>

<!-- Chat History Modal -->
<div id="chat-history-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] opacity-0 pointer-events-none transition-all duration-300">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-card border border-border rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between p-6 border-b border-border">
                <div>
                    <h3 class="text-lg font-bold text-foreground">Chat History</h3>
                    <p class="text-sm text-muted-foreground">Your recent conversations with AI Assistant</p>
                </div>
                <button class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-accent hover:text-accent-foreground transition-colors" id="close-history-modal">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4" id="history-conversations">
                    <div class="text-center py-8 text-muted-foreground">
                        <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p>No chat history yet</p>
                        <p class="text-sm">Start a conversation to see your history here</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center justify-between p-6 border-t border-border">
                <button class="btn btn-outline" id="export-history-btn">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Export History
                </button>
                <button class="btn btn-destructive" id="clear-all-history-btn">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Clear All History
                </button>
            </div>
        </div>
    </div>
</div>
