@{
    var feedData = ViewData["FeedSidebarData"] as FeedResponse;
    var currentUserId = ViewBag.CurrentUserId as Guid?;
}

<!-- Right Sidebar -->
<aside
    class="sidebar-right fixed right-4 rtl:right-auto rtl:left-4 top-24 bottom-8 w-80 bg-card/40 backdrop-blur-xl border border-border rounded-xl shadow-2xl transition-all duration-300 z-40 translate-x-[calc(100%+2rem)] rtl:-translate-x-[calc(100%+2rem)] xl:translate-x-0 rtl:xl:translate-x-0 hidden xl:block overflow-y-auto custom-scrollbar force-rtl">
    
    <div class="force-ltr">
        <!-- Sidebar backdrop for mobile -->
        <div class="sidebar-backdrop xl:hidden"></div>
        @if (feedData != null)
        {
            <!-- Trending Topics -->
            <div class="p-4 border-b border-border">
                <h3 class="flex items-center gap-2 text-sm font-semibold mb-3">
                    <i data-lucide="trending-up" class="w-4 h-4 text-primary"></i>
                    @SharedLocalizer["TrendingTopics"]
                </h3>
                <div class="space-y-3">
                    @if (feedData.TrendingTopics?.Any() == true)
                    {
                        @foreach (var topic in feedData.TrendingTopics.Take(3))
                        {
                            <div class="p-3 rounded-md hover:bg-accent transition-colors cursor-pointer">
                                <div class="text-sm font-medium text-primary">#@topic.Topic</div>
                                <div class="text-xs text-muted-foreground mt-1">@topic.PostCount @SharedLocalizer["PostsLabel"] â€¢ @topic.TimeAgo</div>
                                <div class="inline-block px-2 py-0.5 mt-2 rounded-full bg-primary/10 text-primary text-xs font-medium">
                                    @topic.TrendingReason</div>
                            </div>
                        }
                        <a href="/feed/trending"
                            class="block text-sm text-primary hover:text-primary/80 transition-colors mt-3 font-medium">@SharedLocalizer["ViewAllTrending"]</a>
                    }
                    else
                    {
                        <div class="flex flex-col items-center justify-center py-8 text-center">
                            <i data-lucide="hash" class="w-8 h-8 text-muted-foreground mb-2"></i>
                            <p class="text-xs text-muted-foreground">@SharedLocalizer["NoTrendingTopics"]</p>
                        </div>
                    }
                </div>
            </div>

            <!-- People You May Know -->
            @if (feedData.SuggestedFriends?.Any() == true)
            {
                <div class="p-4 border-b border-border">
                    <h3 class="flex items-center gap-2 text-sm font-semibold mb-3">
                        <i data-lucide="users" class="w-4 h-4 text-primary"></i>
                        @SharedLocalizer["PeopleYouMayKnow"]
                    </h3>
                    <div class="space-y-3">
                        @foreach (var friend in feedData.SuggestedFriends.Take(3))
                        {
                            <div class="flex items-start gap-3 p-2 rounded-md hover:bg-accent transition-colors">
                                <div class="shrink-0 w-10 h-10 rounded-full overflow-hidden bg-muted">
                                    <img src="@(friend.Avatar ?? "/images/default-avatar.png")" alt="@friend.Name"
                                        class="w-full h-full object-cover" />
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium truncate">@friend.Name</div>
                                    <div class="text-xs text-muted-foreground truncate">@friend.SuggestionReason</div>
                                    @if (friend.MutualFriendsCount > 0)
                                    {
                                        <div class="text-xs text-muted-foreground mt-1">@friend.MutualFriendsCount @SharedLocalizer["MutualFriends"]</div>
                                    }
                                </div>
                                <button
                                    class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-primary hover:text-primary-foreground transition-colors shrink-0"
                                    data-action="send-friend-request" data-user-id="@friend.UserId" title="@SharedLocalizer["AddFriend"]">
                                    <i data-lucide="user-plus" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        }
                        <a href="/friends/suggestions"
                            class="block text-sm text-primary hover:text-primary/80 transition-colors mt-3 font-medium">@SharedLocalizer["SeeAllSuggestions"]</a>
                    </div>
                </div>
            }

            <!-- Your Interests (if user is logged in) -->
            @if (currentUserId.HasValue)
            {
                <div class="p-4 border-b border-border">
                    <h3 class="flex items-center gap-2 text-sm font-semibold mb-3">
                        <i data-lucide="heart" class="w-4 h-4 text-primary"></i>
                        @SharedLocalizer["YourInterests"]
                    </h3>
                    <div id="userInterests" class="space-y-2" data-user-id="@currentUserId">
                        <!-- Will be populated by JavaScript -->
                        <div class="flex items-center justify-center py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        </div>
                    </div>
                </div>
            }

            <!-- Community Stats -->
            <div class="p-4">
                <h3 class="flex items-center gap-2 text-sm font-semibold mb-3">
                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-primary"></i>
                    @SharedLocalizer["CommunityStats"]
                </h3>
                <div class="space-y-3">
                    @if (feedData.Stats != null)
                    {
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 rounded-md bg-accent/50">
                                <div class="text-xs text-muted-foreground mb-1">@SharedLocalizer["TotalPosts"]</div>
                                <div class="text-lg font-bold text-foreground">@feedData.Stats.TotalItems.ToString("N0")</div>
                            </div>
                            <div class="p-3 rounded-md bg-accent/50">
                                <div class="text-xs text-muted-foreground mb-1">@SharedLocalizer["ActiveStories"]</div>
                                <div class="text-lg font-bold text-foreground">@feedData.Stats.ActiveStoriesCount</div>
                            </div>
                            <div class="p-3 rounded-md bg-accent/50">
                                <div class="text-xs text-muted-foreground mb-1">@SharedLocalizer["TotalEngagement"]</div>
                                <div class="text-lg font-bold text-foreground">@((feedData.Stats.TotalLikes +
                                                            feedData.Stats.TotalComments).ToString("N0"))</div>
                            </div>
                            <div class="p-3 rounded-md bg-accent/50">
                                <div class="text-xs text-muted-foreground mb-1">@SharedLocalizer["LastUpdated"]</div>
                                <div class="text-sm font-semibold text-foreground">@feedData.Stats.LastRefreshAgo</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-xs text-center text-muted-foreground py-4">@SharedLocalizer["StatsUnavailable"]</div>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- Default Activity Section for non-feed pages -->
            <div class="p-4">
                <h3 class="flex items-center gap-2 text-sm font-semibold mb-3">
                    <i data-lucide="activity" class="w-4 h-4 text-primary"></i>
                    @SharedLocalizer["Activity"]
                </h3>
                <div class="space-y-3">
                    <div class="flex gap-3 items-center p-2 rounded-md hover:bg-accent transition-colors">
                        <div class="shrink-0 flex items-center justify-center w-8 h-8 rounded-md bg-accent">
                            <i data-lucide="user-plus" class="w-4 h-4 text-accent-foreground"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium text-foreground">@SharedLocalizer["NewMemberJoined"]</p>
                            <p class="text-xs text-muted-foreground">2 mins ago</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-center p-2 rounded-md hover:bg-accent transition-colors">
                        <div class="shrink-0 flex items-center justify-center w-8 h-8 rounded-md bg-accent">
                            <i data-lucide="message-circle" class="w-4 h-4 text-accent-foreground"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium text-foreground">@SharedLocalizer["ExpertAnswered"]</p>
                            <p class="text-xs text-muted-foreground">15 mins ago</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</aside>

@if (currentUserId.HasValue)
{
    <script src="~/js/sidebar-right.js" asp-append-version="true"></script>
}