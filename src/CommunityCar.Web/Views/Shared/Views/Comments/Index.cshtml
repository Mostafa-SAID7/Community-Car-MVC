@model IEnumerable<CommunityCar.Application.Features.Interactions.ViewModels.CommentVM>
@{
    ViewData["Title"] = "Comments";
    var entityId = ViewBag.EntityId?.ToString() ?? "";
    var entityType = ViewBag.EntityType?.ToString() ?? "";
    var totalComments = Model?.Count() ?? 0;
    var displayedComments = Model?.Take(3) ?? Enumerable.Empty<CommunityCar.Application.Features.Interactions.ViewModels.CommentVM>();
    var hasMoreComments = totalComments > 3;
}

<div class="comments-section space-y-8 comments-section-container p-6 md:p-8" id="comments-@entityId" data-entity-id="@entityId" data-entity-type="@entityType">
    <!-- Comments Header -->
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-black text-foreground tracking-tight uppercase">
            <span class="text-[9px] font-black uppercase tracking-widest text-muted-foreground opacity-40">Discussion</span>
            <span class="block text-xl">@totalComments @(totalComments == 1 ? "Comment" : "Comments")</span>
        </h3>
    </div>

    <!-- Comment Form (Hidden by default) -->
    <div class="comment-form-wrap hidden" data-entity-id="@entityId">
        @await Html.PartialAsync("Views/Comments/_CommentForm")
    </div>

    <!-- Comments List -->
    <div class="comments-list-container space-y-6">
        @await Html.PartialAsync("Views/Comments/_CommentsList", displayedComments)
        
        <!-- Load More Button -->
        @if (hasMoreComments)
        {
            <div class="text-center pt-4">
                <button class="inline-flex items-center gap-3 bg-muted/30 backdrop-blur-md border border-border/50 px-8 py-3 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] text-foreground hover:bg-muted/50 hover:border-border transition-all shadow-lg group load-initial-comments-btn" 
                        data-entity-id="@entityId" 
                        data-entity-type="@entityType"
                        data-page="1">
                    <i data-lucide="chevron-down" class="w-4 h-4 group-hover:translate-y-0.5 transition-transform"></i>
                    <span>View @(totalComments - 3) More @(totalComments - 3 == 1 ? "Comment" : "Comments")</span>
                </button>
            </div>
        }
    </div>

    <!-- Standard Load More (for pagination beyond initial load) -->
    @if (ViewBag.HasMore == true)
    {
        <div class="text-center hidden load-more-container">
            <button class="inline-flex items-center gap-3 bg-muted/30 backdrop-blur-md border border-border/50 px-8 py-3 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] text-foreground hover:bg-muted/50 hover:border-border transition-all shadow-lg group load-more-comments-btn" 
                    data-entity-id="@entityId" 
                    data-entity-type="@entityType"
                    data-page="@(ViewBag.Page + 1)">
                <i data-lucide="chevron-down" class="w-4 h-4 group-hover:translate-y-0.5 transition-transform"></i>
                Load More Comments
            </button>
        </div>
    }
</div>

<script>
(function() {
    function initCommentsList() {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Toggle comment form when clicking comment button
        if (!window.commentFormToggleInitialized) {
            document.addEventListener('click', function(e) {
                const commentBtn = e.target.closest('[data-button-type="comment"]');
                if (commentBtn) {
                    const entityId = commentBtn.dataset.entityId;
                    const formWrap = document.querySelector(`.comment-form-wrap[data-entity-id="${entityId}"]`);
                    if (formWrap) {
                        formWrap.classList.toggle('hidden');
                        const textarea = formWrap.querySelector('.comment-textarea');
                        if (textarea && !formWrap.classList.contains('hidden')) {
                            textarea.focus();
                        }
                    }
                }
            });
            window.commentFormToggleInitialized = true;
        }

        // Load initial comments (beyond first 3)
        const loadInitialButtons = document.querySelectorAll('.load-initial-comments-btn:not([data-initialized])');
        loadInitialButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const entityId = this.dataset.entityId;
                const entityType = this.dataset.entityType;
                const container = this.closest('.comments-section-container').querySelector('.comments-list-container');
                
                this.disabled = true;
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="w-4 h-4 mr-2 animate-spin">⟳</i>Loading...';

                fetch(`@Url.Action("GetPartial", "Comments")?entityId=${entityId}&entityType=${entityType}&page=1&pageSize=100`)
                    .then(response => {
                        const hasMore = response.headers.get('X-Has-More') === 'true';
                        const totalPages = parseInt(response.headers.get('X-Total-Pages') || '1');
                        
                        // Show load more container if there are more pages
                        if (hasMore && totalPages > 1) {
                            const loadMoreContainer = this.closest('.comments-section-container').querySelector('.load-more-container');
                            if (loadMoreContainer) {
                                loadMoreContainer.classList.remove('hidden');
                                const loadMoreBtn = loadMoreContainer.querySelector('.load-more-comments-btn');
                                if (loadMoreBtn) {
                                    loadMoreBtn.dataset.page = '2';
                                }
                            }
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Replace the entire comments list
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const newList = tempDiv.querySelector('.comments-list');
                        const currentList = container.querySelector('.comments-list');
                        if (newList && currentList) {
                            currentList.replaceWith(newList);
                        }
                        
                        // Hide the initial load button
                        this.parentElement.style.display = 'none';
                        
                        // Re-initialize icons
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading comments:', error);
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    });
            });
            btn.setAttribute('data-initialized', 'true');
        });

        // Define executeDelete at the proper scope
        function executeDelete(commentId) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("Delete", "Comments")';
            
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            if (tokenElement) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = tokenElement.value;
                form.appendChild(tokenInput);
            }
            
            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = commentId;
            form.appendChild(idInput);
            
            const returnUrlInput = document.createElement('input');
            returnUrlInput.type = 'hidden';
            returnUrlInput.name = 'returnUrl';
            returnUrlInput.value = window.location.href;
            form.appendChild(returnUrlInput);
            
            document.body.appendChild(form);
            form.submit();
        }

        // Global delegate for delete and reply buttons
        if (!window.commentsDelegateInitialized) {
            document.addEventListener('click', function(e) {
                // Delete logic
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const commentId = deleteBtn.dataset.commentId;
                    
                    if (window.AlertModal) {
                        window.AlertModal.confirm('Are you sure you want to delete this comment?', 'Delete Comment', function(confirmed) {
                            if (confirmed) {
                                executeDelete(commentId);
                            }
                        });
                    } else if (confirm('Are you sure you want to delete this comment?')) {
                        executeDelete(commentId);
                    }
                }

                // Reply logic
                const replyBtn = e.target.closest('.reply-btn');
                if (replyBtn) {
                    const commentId = replyBtn.dataset.commentId;
                    const authorName = replyBtn.dataset.authorName;
                    const container = replyBtn.closest('.comments-section-container');
                    const formWrap = container.querySelector('.comment-form-wrap');
                    const formElement = container.querySelector('.comment-form-element');
                    const formContainer = container.querySelector('.comment-form');
                    
                    // Show form wrap if hidden
                    if (formWrap && formWrap.classList.contains('hidden')) {
                        formWrap.classList.remove('hidden');
                    }
                    
                    if (formElement && formContainer) {
                        const parentIdInput = formElement.querySelector('.parent-comment-id-input');
                        const replyInfo = formContainer.querySelector('.reply-info');
                        const replyToName = formContainer.querySelector('.reply-to-name');
                        const textarea = formElement.querySelector('.comment-textarea');
                        const cancelBtn = formElement.querySelector('.cancel-btn');

                        if (parentIdInput && replyInfo && replyToName && textarea) {
                            parentIdInput.value = commentId;
                            replyToName.innerText = authorName;
                            replyInfo.style.display = 'flex';
                            textarea.placeholder = `Reply to ${authorName}...`;
                            if (cancelBtn) cancelBtn.style.display = 'inline-flex';
                            
                            // Scroll to form
                            formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            textarea.focus();
                        }
                    }
                }
            });
            window.commentsDelegateInitialized = true;
        }

        // Initialize Load More buttons
        const loadMoreButtons = document.querySelectorAll('.load-more-comments-btn:not([data-initialized])');
        loadMoreButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const entityId = this.dataset.entityId;
                const entityType = this.dataset.entityType;
                const page = this.dataset.page;
                const container = this.closest('.comments-section-container').querySelector('.comments-list-container .comments-list');
                
                this.disabled = true;
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="w-4 h-4 mr-2 animate-spin">⟳</i>Loading...';

                fetch(`@Url.Action("GetPartial", "Comments")?entityId=${entityId}&entityType=${entityType}&page=${page}`)
                    .then(response => {
                        const hasMore = response.headers.get('X-Has-More') === 'true';
                        if (!hasMore) {
                            this.parentElement.style.display = 'none';
                        }
                        return response.text();
                    })
                    .then(html => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Append new comments
                        while (tempDiv.firstChild) {
                            container.appendChild(tempDiv.firstChild);
                        }
                        
                        // Update page number
                        this.dataset.page = parseInt(page) + 1;
                        
                        // Re-initialize icons
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading more comments:', error);
                    })
                    .finally(() => {
                        this.disabled = false;
                        this.innerHTML = originalContent;
                    });
            });
            btn.setAttribute('data-initialized', 'true');
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCommentsList);
    } else {
        initCommentsList();
    }
})();
</script>
