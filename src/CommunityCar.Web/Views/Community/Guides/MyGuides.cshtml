@using Microsoft.Extensions.Localization
@using CommunityCar.Domain.Enums
@model CommunityCar.Application.Features.Guides.ViewModels.GuideListVM
@inject IViewLocalizer Localizer
@inject IStringLocalizer<SharedResource> SharedLocalizer
@{
    ViewData["Title"] = SharedLocalizer["MyGuides"];
}

<div class="space-y-8 animate-in fade-in duration-700">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6">
        <div>
            <h1 class="text-3xl font-black text-foreground tracking-tight flex items-center gap-3">
                <div class="bg-primary/10 p-2 rounded-xl text-primary">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </div>
                @SharedLocalizer["MyGuides"]
            </h1>
            <p class="text-sm text-muted-foreground font-medium opacity-70 mt-1">Manage your published guides and drafts</p>
        </div>
        <div class="flex items-center gap-3">
            <a href="/guides/create" class="btn-primary">
                <i data-lucide="plus" class="w-4 h-4"></i>
                @SharedLocalizer["CreateGuide"]
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-6">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-500/10 rounded-xl">
                    <i data-lucide="book-open" class="w-5 h-5 text-blue-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-black text-foreground">@Model.Guides.Count(g => g.IsPublished)</p>
                    <p class="text-sm text-muted-foreground font-medium">@SharedLocalizer["Published"]</p>
                </div>
            </div>
        </div>
        
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-6">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-yellow-500/10 rounded-xl">
                    <i data-lucide="file-text" class="w-5 h-5 text-yellow-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-black text-foreground">@Model.Guides.Count(g => !g.IsPublished)</p>
                    <p class="text-sm text-muted-foreground font-medium">@SharedLocalizer["Draft"]</p>
                </div>
            </div>
        </div>
        
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-6">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-green-500/10 rounded-xl">
                    <i data-lucide="eye" class="w-5 h-5 text-green-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-black text-foreground">@Model.Guides.Sum(g => g.ViewCount).ToString("N0")</p>
                    <p class="text-sm text-muted-foreground font-medium">Total @SharedLocalizer["Views"]</p>
                </div>
            </div>
        </div>
        
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-6">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-purple-500/10 rounded-xl">
                    <i data-lucide="star" class="w-5 h-5 text-purple-500"></i>
                </div>
                <div>
                    <p class="text-2xl font-black text-foreground">@(Model.Guides.Any() ? Model.Guides.Average(g => g.AverageRating).ToString("F1") : "0.0")</p>
                    <p class="text-sm text-muted-foreground font-medium">Avg @SharedLocalizer["Rating"]</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="flex justify-center">
        <div class="inline-flex gap-1 p-1 bg-muted/40 backdrop-blur-sm rounded-xl border border-border/50 shadow-sm">
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all @(ViewBag.Filter == "all" || string.IsNullOrEmpty(ViewBag.Filter) ? "bg-background text-foreground shadow-md ring-1 ring-border" : "text-muted-foreground hover:text-foreground hover:bg-muted/30")" href="?filter=all">
                <i data-lucide="grid-3x3" class="w-4 h-4"></i> All Guides
            </a>
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all @(ViewBag.Filter == "published" ? "bg-background text-foreground shadow-md ring-1 ring-border" : "text-muted-foreground hover:text-foreground hover:bg-muted/30")" href="?filter=published">
                <i data-lucide="send" class="w-4 h-4"></i> @SharedLocalizer["Published"]
            </a>
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all @(ViewBag.Filter == "drafts" ? "bg-background text-foreground shadow-md ring-1 ring-border" : "text-muted-foreground hover:text-foreground hover:bg-muted/30")" href="?filter=drafts">
                <i data-lucide="file-text" class="w-4 h-4"></i> @SharedLocalizer["Draft"]
            </a>
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all @(ViewBag.Filter == "featured" ? "bg-background text-foreground shadow-md ring-1 ring-border" : "text-muted-foreground hover:text-foreground hover:bg-muted/30")" href="?filter=featured">
                <i data-lucide="star" class="w-4 h-4"></i> @SharedLocalizer["Featured"]
            </a>
        </div>
    </div>

    <!-- Guides List -->
    @if (Model.Guides.Any())
    {
        <div class="space-y-4">
            @foreach (var guide in Model.Guides)
            {
                <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden transition-all hover:shadow-2xl hover:border-primary/20 group">
                    <div class="p-6">
                        <div class="flex items-start justify-between gap-6">
                            <!-- Guide Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-3">
                                    <!-- Status Badge -->
                                    @if (guide.IsPublished)
                                    {
                                        <span class="px-2 py-1 bg-green-500/10 text-green-600 rounded-lg text-xs font-black uppercase tracking-wider">
                                            <i data-lucide="send" class="w-3 h-3 inline mr-1"></i>
                                            @SharedLocalizer["Published"]
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="px-2 py-1 bg-yellow-500/10 text-yellow-600 rounded-lg text-xs font-black uppercase tracking-wider">
                                            <i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>
                                            @SharedLocalizer["Draft"]
                                        </span>
                                    }

                                    @if (guide.IsFeatured)
                                    {
                                        <span class="px-2 py-1 bg-yellow-500 text-yellow-900 rounded-lg text-xs font-black uppercase tracking-wider">
                                            <i data-lucide="star" class="w-3 h-3 inline mr-1"></i>
                                            @SharedLocalizer["Featured"]
                                        </span>
                                    }

                                    @if (guide.IsVerified)
                                    {
                                        <span class="px-2 py-1 bg-blue-500/10 text-blue-600 rounded-lg text-xs font-black uppercase tracking-wider">
                                            <i data-lucide="shield-check" class="w-3 h-3 inline mr-1"></i>
                                            @SharedLocalizer["Verified"]
                                        </span>
                                    }

                                    @if (!string.IsNullOrEmpty(guide.Category))
                                    {
                                        <span class="px-2 py-1 bg-primary/10 text-primary rounded-lg text-xs font-bold uppercase tracking-wider">
                                            @SharedLocalizer[guide.Category]
                                        </span>
                                    }

                                    <span class="px-2 py-1 rounded-lg text-xs font-bold uppercase tracking-wider @GetDifficultyClasses(guide.Difficulty)">
                                        @SharedLocalizer[guide.Difficulty.ToString()]
                                    </span>
                                </div>

                                <h3 class="text-xl font-black text-foreground mb-2 group-hover:text-primary transition-colors">
                                    <a href="/guides/@guide.Id">@guide.Title</a>
                                </h3>

                                @if (!string.IsNullOrEmpty(guide.Summary))
                                {
                                    <p class="text-sm text-muted-foreground font-medium line-clamp-2 mb-4">
                                        @guide.Summary
                                    </p>
                                }

                                <!-- Stats -->
                                <div class="flex items-center gap-6 text-sm text-muted-foreground">
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                        <span class="font-medium">@guide.ViewCount.ToString("N0")</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="bookmark" class="w-4 h-4"></i>
                                        <span class="font-medium">@guide.BookmarkCount.ToString("N0")</span>
                                    </div>
                                    @if (guide.AverageRating > 0)
                                    {
                                        <div class="flex items-center gap-1">
                                            <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
                                            <span class="font-medium">@guide.AverageRating.ToString("F1")</span>
                                            <span class="text-xs">(@guide.RatingCount)</span>
                                        </div>
                                    }
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="clock" class="w-4 h-4"></i>
                                        <span class="font-medium">@guide.EstimatedTimeText</span>
                                    </div>
                                </div>

                                <!-- Meta Info -->
                                <div class="flex items-center gap-4 mt-4 text-xs text-muted-foreground">
                                    <span>Created: @guide.CreatedAt.ToString("MMM dd, yyyy")</span>
                                    @if (guide.UpdatedAt != guide.CreatedAt)
                                    {
                                        <span>Updated: @guide.UpdatedAt?.ToString("MMM dd, yyyy")</span>
                                    }
                                    @if (guide.PublishedAt.HasValue)
                                    {
                                        <span>Published: @guide.PublishedAt.Value.ToString("MMM dd, yyyy")</span>
                                    }
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex flex-col gap-2">
                                <a href="/guides/@guide.Id" class="btn-outline btn-sm">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    View
                                </a>
                                <a href="/guides/@guide.Id/edit" class="btn-secondary btn-sm">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                    Edit
                                </a>
                                @if (!guide.IsPublished)
                                {
                                    <form method="post" action="/guides/@guide.Id/publish" class="inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-primary btn-sm w-full">
                                            <i data-lucide="send" class="w-4 h-4"></i>
                                            Publish
                                        </button>
                                    </form>
                                }
                                <button onclick="confirmDelete('@guide.Id')" class="btn-destructive btn-sm">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    Delete
                                </button>
                            </div>
                        </div>

                        <!-- Tags -->
                        @if (guide.Tags.Any())
                        {
                            <div class="flex flex-wrap gap-1 mt-4 pt-4 border-t border-border/40">
                                @foreach (var tag in guide.Tags.Take(5))
                                {
                                    <span class="px-2 py-1 bg-muted/30 text-muted-foreground rounded text-xs font-medium">
                                        #@tag
                                    </span>
                                }
                                @if (guide.Tags.Count > 5)
                                {
                                    <span class="px-2 py-1 bg-muted/30 text-muted-foreground rounded text-xs font-medium">
                                        +@(guide.Tags.Count - 5) more
                                    </span>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.Pagination.TotalPages > 1)
        {
            <div class="flex justify-center">
                <nav class="flex items-center gap-2">
                    @if (Model.Pagination.HasPreviousPage)
                    {
                        <a href="?page=@(Model.Pagination.CurrentPage - 1)&filter=@ViewBag.Filter" 
                           class="px-4 py-2 bg-background border border-border rounded-lg text-sm font-medium hover:bg-muted/50 transition-all">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </a>
                    }

                    @for (int i = Math.Max(1, Model.Pagination.CurrentPage - 2); i <= Math.Min(Model.Pagination.TotalPages, Model.Pagination.CurrentPage + 2); i++)
                    {
                        <a href="?page=@i&filter=@ViewBag.Filter" 
                           class="px-4 py-2 rounded-lg text-sm font-medium transition-all @(i == Model.Pagination.CurrentPage ? "bg-primary text-primary-foreground" : "bg-background border border-border hover:bg-muted/50")">
                            @i
                        </a>
                    }

                    @if (Model.Pagination.HasNextPage)
                    {
                        <a href="?page=@(Model.Pagination.CurrentPage + 1)&filter=@ViewBag.Filter" 
                           class="px-4 py-2 bg-background border border-border rounded-lg text-sm font-medium hover:bg-muted/50 transition-all">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </a>
                    }
                </nav>
            </div>
        }
    }
    else
    {
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-12 max-w-md mx-auto">
                <i data-lucide="book-open" class="w-16 h-16 text-muted-foreground mx-auto mb-6"></i>
                <h3 class="text-xl font-black text-foreground mb-2">No Guides Yet</h3>
                <p class="text-muted-foreground mb-6">You haven't created any guides yet. Start sharing your automotive knowledge with the community!</p>
                <a href="/guides/create" class="btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    @SharedLocalizer["CreateGuide"]
                </a>
            </div>
        </div>
    }
</div>

@functions {
    private string GetDifficultyClasses(GuideDifficulty difficulty)
    {
        return difficulty switch
        {
            GuideDifficulty.Beginner => "bg-green-500/10 text-green-600 dark:text-green-400",
            GuideDifficulty.Intermediate => "bg-yellow-500/10 text-yellow-600 dark:text-yellow-400",
            GuideDifficulty.Advanced => "bg-red-500/10 text-red-600 dark:text-red-400",
            _ => "bg-muted/30 text-muted-foreground"
        };
    }
}

@section Scripts {
    @await Html.PartialAsync("~/Views/Community/Guides/_LocalizationScript.cshtml")
    <script src="~/js/guides.js"></script>
    <script>
        function confirmDelete(guideId) {
            if (confirm('Are you sure you want to delete this guide? This action cannot be undone.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/guides/${guideId}/delete`;
                form.innerHTML = '@Html.AntiForgeryToken()';
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}