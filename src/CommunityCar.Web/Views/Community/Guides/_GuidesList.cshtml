@using Microsoft.Extensions.Localization
@using CommunityCar.Domain.Enums
@using CommunityCar.Application.Features.Community.Guides.ViewModels
@model CommunityCar.Application.Features.Community.Guides.ViewModels.GuideListVM
@inject IViewLocalizer Localizer
@inject IStringLocalizer<SharedResource> SharedLocalizer

@{
    // Get current culture for localization
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");
    
    // Helper function to get localized content
    string GetLocalizedTitle(GuideVM guide) => isArabic && !string.IsNullOrEmpty(guide.TitleAr) ? guide.TitleAr : guide.Title ?? string.Empty;
    string GetLocalizedSummary(GuideVM guide) => isArabic && !string.IsNullOrEmpty(guide.SummaryAr) ? guide.SummaryAr : guide.Summary ?? string.Empty;

    string GetDifficultyClasses(GuideDifficulty difficulty)
    {
        return difficulty switch
        {
            GuideDifficulty.Beginner => "bg-green-500/10 text-green-600 dark:text-green-400",
            GuideDifficulty.Intermediate => "bg-yellow-500/10 text-yellow-600 dark:text-yellow-400",
            GuideDifficulty.Advanced => "bg-red-500/10 text-red-600 dark:text-red-400",
            _ => "bg-muted/30 text-muted-foreground"
        };
    }
}

@if (Model.Guides.Any())
{
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="guides-grid">
        @foreach (var guide in Model.Guides)
        {
            <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden transition-all hover:shadow-2xl hover:border-primary/20 group">
                <!-- Guide Image -->
                @if (!string.IsNullOrEmpty(guide.ThumbnailUrl) || !string.IsNullOrEmpty(guide.CoverImageUrl))
                {
                    <div class="aspect-video overflow-hidden relative">
                        <img src="@(guide.ThumbnailUrl ?? guide.CoverImageUrl)" alt="@guide.Title" 
                             class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        
                        <!-- Badges -->
                        <div class="absolute top-3 left-3 flex gap-2">
                            @if (guide.IsFeatured)
                            {
                                <span class="px-2 py-1 bg-yellow-500 text-yellow-900 rounded-lg text-xs font-black uppercase tracking-wider">
                                    @SharedLocalizer["Featured"]
                                </span>
                            }
                            @if (guide.IsVerified)
                            {
                                <span class="px-2 py-1 bg-blue-500 text-white rounded-lg text-xs font-black uppercase tracking-wider">
                                    @SharedLocalizer["Verified"]
                                </span>
                            }
                        </div>

                        <!-- Bookmark Button -->
                        <button class="absolute top-3 right-3 w-8 h-8 bg-background/80 backdrop-blur-sm rounded-full flex items-center justify-center text-muted-foreground hover:text-yellow-500 hover:bg-yellow-500/10 transition-all @(guide.IsBookmarked ? "text-yellow-500 bg-yellow-500/10" : "")" 
                                onclick="toggleBookmark('@guide.Id', this)">
                            <i data-lucide="bookmark" class="w-4 h-4 @(guide.IsBookmarked ? "fill-current" : "")"></i>
                        </button>
                    </div>
                }
                else
                {
                    <!-- Placeholder -->
                    <div class="aspect-video bg-gradient-to-br from-primary/10 to-primary/5 flex items-center justify-center relative">
                        <i data-lucide="book-open" class="w-12 h-12 text-primary/30"></i>
                        
                        <div class="absolute top-3 left-3 flex gap-2">
                            @if (guide.IsFeatured)
                            {
                                <span class="px-2 py-1 bg-yellow-500 text-yellow-900 rounded-lg text-xs font-black uppercase tracking-wider">
                                    @Localizer["Featured"]
                                </span>
                            }
                            @if (guide.IsVerified)
                            {
                                <span class="px-2 py-1 bg-blue-500 text-white rounded-lg text-xs font-black uppercase tracking-wider">
                                    @Localizer["Verified"]
                                </span>
                            }
                        </div>

                        <button class="absolute top-3 right-3 w-8 h-8 bg-background/80 backdrop-blur-sm rounded-full flex items-center justify-center text-muted-foreground hover:text-yellow-500 hover:bg-yellow-500/10 transition-all @(guide.IsBookmarked ? "text-yellow-500 bg-yellow-500/10" : "")" 
                                onclick="toggleBookmark('@guide.Id', this)">
                            <i data-lucide="bookmark" class="w-4 h-4 @(guide.IsBookmarked ? "fill-current" : "")"></i>
                        </button>
                    </div>
                }

                <!-- Guide Content -->
                <div class="p-6">
                    <div class="flex items-center gap-2 mb-3">
                        @if (!string.IsNullOrEmpty(guide.Category))
                        {
                            <span class="px-2 py-1 bg-primary/10 text-primary rounded-lg text-xs font-bold uppercase tracking-wider">
                                @Localizer[guide.Category]
                            </span>
                        }
                        <span class="px-2 py-1 rounded-lg text-xs font-bold uppercase tracking-wider @GetDifficultyClasses(guide.Difficulty)">
                            @Localizer[guide.Difficulty.ToString()]
                        </span>
                        <span class="text-xs text-muted-foreground font-medium ml-auto">
                            @guide.EstimatedTimeText
                        </span>
                    </div>

                    <h3 class="text-lg font-black text-foreground mb-2 line-clamp-2 group-hover:text-primary transition-colors">
                        <a asp-controller="Guides" asp-action="Details" asp-route-id="@guide.Id" asp-route-culture="@currentCulture">@GetLocalizedTitle(guide)</a>
                    </h3>

                    @if (!string.IsNullOrEmpty(GetLocalizedSummary(guide)))
                    {
                        <p class="text-sm text-muted-foreground font-medium line-clamp-3 mb-4">
                            @GetLocalizedSummary(guide)
                        </p>
                    }

                    <!-- Author -->
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full overflow-hidden">
                            @if (!string.IsNullOrEmpty(guide.AuthorAvatar))
                            {
                                <img src="@guide.AuthorAvatar" alt="@guide.AuthorName" class="w-full h-full object-cover" />
                            }
                            else
                            {
                                <div class="w-full h-full bg-primary flex items-center justify-center text-primary-foreground text-xs font-bold">
                                    @guide.AuthorName.Substring(0, Math.Min(2, guide.AuthorName.Length)).ToUpper()
                                </div>
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold text-foreground truncate">@guide.AuthorName</p>
                            <p class="text-xs text-muted-foreground">@guide.TimeAgo</p>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="flex items-center justify-between pt-4 border-t border-border/40">
                        <div class="flex items-center gap-4">
                            @if (guide.AverageRating > 0)
                            {
                                <div class="flex items-center gap-1">
                                    <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
                                    <span class="text-sm font-bold text-foreground">@guide.AverageRating.ToString("F1")</span>
                                    <span class="text-xs text-muted-foreground">(@guide.RatingCount)</span>
                                </div>
                            }
                            <div class="flex items-center gap-1 text-muted-foreground">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                <span class="text-xs font-medium">@guide.ViewCount</span>
                            </div>
                            <div class="flex items-center gap-1 text-muted-foreground">
                                <i data-lucide="bookmark" class="w-4 h-4"></i>
                                <span class="text-xs font-medium">@guide.BookmarkCount</span>
                            </div>
                        </div>
                        <a asp-controller="Guides" asp-action="Details" asp-route-id="@guide.Id" asp-route-culture="@currentCulture" class="text-primary hover:text-primary/80 text-sm font-bold">
                            @Localizer["ReadGuide"] â†’
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (Model.Pagination.TotalPages > 1)
    {
        <div class="flex flex-col items-center mt-12 gap-4">
            <nav class="flex items-center gap-2 p-1.5 bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl">
                @if (Model.Pagination.HasPreviousPage)
                {
                    <a asp-controller="Guides" asp-action="Index" asp-route-culture="@currentCulture" asp-route-page="@(Model.Pagination.CurrentPage - 1)" asp-route-search="@Model.CurrentSearch" asp-route-category="@Model.CurrentCategory" asp-route-difficulty="@Model.CurrentDifficulty" asp-route-sortBy="@Model.CurrentSortBy" 
                       class="w-10 h-10 flex items-center justify-center rounded-2xl bg-background border border-border hover:border-primary hover:text-primary transition-all shadow-sm active:scale-95">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </a>
                }

                <div class="flex items-center gap-1 px-2">
                    @for (int i = Math.Max(1, Model.Pagination.CurrentPage - 2); i <= Math.Min(Model.Pagination.TotalPages, Model.Pagination.CurrentPage + 2); i++)
                    {
                        <a href="?page=@i&search=@Model.CurrentSearch&category=@Model.CurrentCategory&difficulty=@Model.CurrentDifficulty&sortBy=@Model.CurrentSortBy" 
                           class="w-10 h-10 flex items-center justify-center rounded-2xl font-black text-xs transition-all @(i == Model.Pagination.CurrentPage ? "bg-primary text-primary-foreground shadow-lg shadow-primary/30 scale-110" : "hover:bg-muted text-muted-foreground hover:text-foreground")">
                            @i
                        </a>
                    }
                </div>

                @if (Model.Pagination.HasNextPage)
                {
                    <a asp-controller="Guides" asp-action="Index" asp-route-culture="@currentCulture" asp-route-page="@(Model.Pagination.CurrentPage + 1)" asp-route-search="@Model.CurrentSearch" asp-route-category="@Model.CurrentCategory" asp-route-difficulty="@Model.CurrentDifficulty" asp-route-sortBy="@Model.CurrentSortBy" 
                       class="w-10 h-10 flex items-center justify-center rounded-2xl bg-background border border-border hover:border-primary hover:text-primary transition-all shadow-sm active:scale-95">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </a>
                }
            </nav>
        </div>
    }
}
else
{
    <!-- Empty State -->
    <div class="text-center py-16">
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-12 max-w-md mx-auto">
            <i data-lucide="book-open" class="w-16 h-16 text-muted-foreground mx-auto mb-6"></i>
            <h3 class="text-xl font-black text-foreground mb-2">@Localizer["NoResultsTitle"]</h3>
            <p class="text-muted-foreground mb-6">@Localizer["NoResultsMessage"]</p>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <a asp-controller="Guides" asp-action="Index" asp-route-culture="@currentCulture" class="px-8 py-4 bg-background border border-border hover:border-primary hover:text-primary rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-sm active:scale-95">
                    @Localizer["ClearFilters"]
                </a>
                <a asp-controller="Guides" asp-action="Create" asp-route-culture="@currentCulture" class="px-8 py-4 bg-primary text-primary-foreground hover:bg-primary/90 rounded-2xl font-black text-xs uppercase tracking-widest transition-all shadow-lg shadow-primary/20 active:scale-95">
                    @Localizer["CreateYourFirstGuide"]
                </a>
            </div>
        </div>
    </div>
}
