@using CommunityCar.Application.Features.Community.Guides.ViewModels
@model CommunityCar.Application.Features.Community.Guides.ViewModels.GuideListVM
@inject IViewLocalizer Localizer
@inject IStringLocalizer<SharedResource> SharedLocalizer
@{
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");
    string GetLocalizedTitle(GuideVM guide) => isArabic && !string.IsNullOrEmpty(guide.TitleAr) ? guide.TitleAr : guide.Title ?? string.Empty;
    string GetLocalizedSummary(GuideVM guide) => isArabic && !string.IsNullOrEmpty(guide.SummaryAr) ? guide.SummaryAr : guide.Summary ?? string.Empty;
}

@if (Model.Guides.Any())
{
    <div class="space-y-4">
        @foreach (var guide in Model.Guides)
        {
            <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden transition-all hover:shadow-2xl hover:border-primary/20 group">
                <div class="p-6">
                    <div class="flex items-start justify-between gap-6">
                        <!-- Guide Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-3">
                                <!-- Status Badge -->
                                @if (guide.IsPublished)
                                {
                                    <span class="px-2 py-1 bg-green-500/10 text-green-600 rounded-lg text-xs font-black uppercase tracking-wider">
                                        <i data-lucide="send" class="w-3 h-3 inline mr-1"></i>
                                        @SharedLocalizer["Published"]
                                    </span>
                                }
                                else
                                {
                                    <span class="px-2 py-1 bg-yellow-500/10 text-yellow-600 rounded-lg text-xs font-black uppercase tracking-wider">
                                        <i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>
                                        @SharedLocalizer["Draft"]
                                    </span>
                                }

                                @if (guide.IsFeatured)
                                {
                                    <span class="px-2 py-1 bg-yellow-500 text-yellow-900 rounded-lg text-xs font-black uppercase tracking-wider">
                                        <i data-lucide="star" class="w-3 h-3 inline mr-1"></i>
                                        @SharedLocalizer["Featured"]
                                    </span>
                                }

                                @if (guide.IsVerified)
                                {
                                    <span class="px-2 py-1 bg-blue-500/10 text-blue-600 rounded-lg text-xs font-black uppercase tracking-wider">
                                        <i data-lucide="shield-check" class="w-3 h-3 inline mr-1"></i>
                                        @SharedLocalizer["Verified"]
                                    </span>
                                }

                                @if (!string.IsNullOrEmpty(guide.Category))
                                {
                                    <span class="px-2 py-1 bg-primary/10 text-primary rounded-lg text-xs font-bold uppercase tracking-wider">
                                        @SharedLocalizer[guide.Category]
                                    </span>
                                }

                                <span class="px-2 py-1 rounded-lg text-xs font-bold uppercase tracking-wider @GetDifficultyClasses(guide.Difficulty)">
                                    @SharedLocalizer[guide.Difficulty.ToString()]
                                </span>
                            </div>

                            <h3 class="text-xl font-black text-foreground mb-2 group-hover:text-primary transition-colors">
                                <a href="/guides/@guide.Id">@GetLocalizedTitle(guide)</a>
                            </h3>

                            @if (!string.IsNullOrEmpty(GetLocalizedSummary(guide)))
                            {
                                <p class="text-sm text-muted-foreground font-medium line-clamp-2 mb-4">
                                    @GetLocalizedSummary(guide)
                                </p>
                            }

                            <!-- Stats -->
                            <div class="flex items-center gap-6 text-sm text-muted-foreground">
                                <div class="flex items-center gap-1">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    <span class="font-medium">@guide.ViewCount.ToString("N0")</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <i data-lucide="bookmark" class="w-4 h-4"></i>
                                    <span class="font-medium">@guide.BookmarkCount.ToString("N0")</span>
                                </div>
                                @if (guide.AverageRating > 0)
                                {
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="star" class="w-4 h-4 text-yellow-500 fill-current"></i>
                                        <span class="font-medium">@guide.AverageRating.ToString("F1")</span>
                                        <span class="text-xs">(@guide.RatingCount)</span>
                                    </div>
                                }
                                <div class="flex items-center gap-1">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                    <span class="font-medium">@guide.EstimatedTimeText</span>
                                </div>
                            </div>

                            <!-- Meta Info -->
                            <div class="flex items-center gap-4 mt-4 text-xs text-muted-foreground">
                                <span>Created: @guide.CreatedAt.ToString("MMM dd, yyyy")</span>
                                @if (guide.UpdatedAt != guide.CreatedAt)
                                {
                                    <span>Updated: @guide.UpdatedAt?.ToString("MMM dd, yyyy")</span>
                                }
                                @if (guide.PublishedAt.HasValue)
                                {
                                    <span>Published: @guide.PublishedAt.Value.ToString("MMM dd, yyyy")</span>
                                }
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex flex-col gap-2">
                            <a href="/guides/@guide.Id" class="btn-outline btn-sm">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                View
                            </a>
                            <a href="/guides/@guide.Id/edit" class="btn-secondary btn-sm">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                                Edit
                            </a>
                            @if (!guide.IsPublished)
                            {
                                <form method="post" action="/guides/@guide.Id/publish" class="inline">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn-primary btn-sm w-full">
                                        <i data-lucide="send" class="w-4 h-4"></i>
                                        Publish
                                    </button>
                                </form>
                            }
                            <button onclick="confirmDelete('@guide.Id', this)" class="btn-destructive btn-sm">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Delete
                            </button>
                        </div>
                    </div>

                    <!-- Tags -->
                    @if (guide.Tags.Any())
                    {
                        <div class="flex flex-wrap gap-1 mt-4 pt-4 border-t border-border/40">
                            @foreach (var tag in guide.Tags.Take(5))
                            {
                                <span class="px-2 py-1 bg-muted/30 text-muted-foreground rounded text-xs font-medium">
                                    #@tag
                                </span>
                            }
                            @if (guide.Tags.Count > 5)
                            {
                                <span class="px-2 py-1 bg-muted/30 text-muted-foreground rounded text-xs font-medium">
                                    +@(guide.Tags.Count - 5) more
                                </span>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (Model.Pagination.TotalPages > 1)
    {
        <div class="flex justify-center mt-8">
            <nav class="flex items-center gap-2">
                @if (Model.Pagination.HasPreviousPage)
                {
                    <a href="?page=@(Model.Pagination.CurrentPage - 1)&filter=@ViewBag.Filter" 
                       class="px-4 py-2 bg-background border border-border rounded-lg text-sm font-medium hover:bg-muted/50 transition-all"
                       data-page="@(Model.Pagination.CurrentPage - 1)">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </a>
                }

                @for (int i = Math.Max(1, Model.Pagination.CurrentPage - 2); i <= Math.Min(Model.Pagination.TotalPages, Model.Pagination.CurrentPage + 2); i++)
                {
                    <a href="?page=@i&filter=@ViewBag.Filter" 
                       class="px-4 py-2 rounded-lg text-sm font-medium transition-all @(i == Model.Pagination.CurrentPage ? "bg-primary text-primary-foreground" : "bg-background border border-border hover:bg-muted/50")"
                       data-page="@i">
                        @i
                    </a>
                }

                @if (Model.Pagination.HasNextPage)
                {
                    <a href="?page=@(Model.Pagination.CurrentPage + 1)&filter=@ViewBag.Filter" 
                       class="px-4 py-2 bg-background border border-border rounded-lg text-sm font-medium hover:bg-muted/50 transition-all"
                       data-page="@(Model.Pagination.CurrentPage + 1)">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </a>
                }
            </nav>
        </div>
    }
}
else
{
    <!-- Empty State -->
    <div class="text-center py-16">
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl p-12 max-w-md mx-auto">
            <i data-lucide="book-open" class="w-16 h-16 text-muted-foreground mx-auto mb-6"></i>
            <h3 class="text-xl font-black text-foreground mb-2">No Guides Found</h3>
            <p class="text-muted-foreground mb-6">We couldn't find any guides matching your current filter.</p>
            <a href="/guides/create" class="btn-primary">
                <i data-lucide="plus" class="w-4 h-4"></i>
                @SharedLocalizer["CreateGuide"]
            </a>
        </div>
    </div>
}

@functions {
    private string GetDifficultyClasses(CommunityCar.Domain.Enums.Community.GuideDifficulty difficulty)
    {
        return difficulty switch
        {
            CommunityCar.Domain.Enums.Community.GuideDifficulty.Beginner => "bg-green-500/10 text-green-600 dark:text-green-400",
            CommunityCar.Domain.Enums.Community.GuideDifficulty.Intermediate => "bg-yellow-500/10 text-yellow-600 dark:text-yellow-400",
            CommunityCar.Domain.Enums.Community.GuideDifficulty.Advanced => "bg-red-500/10 text-red-600 dark:text-red-400",
            _ => "bg-muted/30 text-muted-foreground"
        };
    }
}
