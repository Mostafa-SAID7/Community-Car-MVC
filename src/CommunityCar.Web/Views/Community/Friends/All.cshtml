@using Microsoft.Extensions.Localization
@model IEnumerable<CommunityCar.Application.Features.Community.Friends.ViewModels.FriendVM>
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["AllFriends"];
}

<div class="d-flex flex-column gap-5 animate-in fade-in duration-700">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-4">
        <div>
            <h1 class="display-5 fw-black text-gradient tracking-tight mb-2">@Localizer["AllFriends"] (@Model.Count())</h1>
            <p class="text-xs fw-bold text-muted-foreground text-uppercase tracking-widest opacity-60">@Localizer["ManageConnectionsSubtitle"]</p>
        </div>
        <div>
            <a asp-controller="Friends" asp-action="Index" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" class="btn btn-outline-secondary px-4 py-3 rounded-4 fw-black text-uppercase tracking-widest text-[10px] shadow-lg d-flex align-items-center gap-2 group">
                <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                @Localizer["BackToOverview"]
            </a>
        </div>
    </div>

    <!-- Friends Grid Container -->
    <div class="card card-premium shadow-xl overflow-hidden border-0">
        <div class="card-body p-4 p-md-5">
            <div id="friends-content">
            @if (Model.Any())
            {
                <div class="row g-4" id="friends-grid">
                    @foreach (var friend in Model)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="card card-premium h-100 p-4 border border-border border-opacity-50 hover-bg-muted-subtle transition-all text-center group">
                                <div class="position-relative d-inline-block mx-auto mb-4">
                                    <div class="user-avatar-container p-0 m-0 shadow-lg border-0" style="width: 80px; height: 80px;">
                                        @if (!string.IsNullOrEmpty(friend.ProfilePictureUrl))
                                        {
                                            <img src="@friend.ProfilePictureUrl" alt="@friend.FullName" class="rounded-circle object-fit-cover w-100 h-100" />
                                        }
                                        else
                                        {
                                            <div class="w-100 h-100 rounded-circle bg-primary-red text-white d-flex align-items-center justify-content-center fw-black h4 mb-0">
                                                @friend.FullName.Substring(0, Math.Min(2, friend.FullName.Length)).ToUpper()
                                            </div>
                                        }
                                    </div>
                                    @if (friend.IsOnline)
                                    {
                                        <span class="position-absolute bottom-0 end-0 bg-success border border-4 border-card rounded-circle shadow-sm" style="width: 20px; height: 20px;"></span>
                                    }
                                </div>
                                
                                <h5 class="fw-black text-foreground mb-1 group-hover:text-primary-red transition-colors">@friend.FullName</h5>
                                <p class="text-[10px] fw-bold text-muted-foreground text-uppercase tracking-widest opacity-60 mb-3">@@@friend.UserName</p>
                                
                                <div class="d-flex flex-column gap-2 mb-4">
                                    @if (!string.IsNullOrEmpty(friend.City))
                                    {
                                        <div class="text-[9px] fw-bold text-muted-foreground text-uppercase tracking-widest d-flex align-items-center justify-content-center gap-1 opacity-60">
                                            <i data-lucide="map-pin" style="width: 10px;"></i>
                                            @friend.City@(!string.IsNullOrEmpty(friend.Country) ? $", {friend.Country}" : "")
                                        </div>
                                    }
                                    
                                    @if (friend.MutualFriendsCount > 0)
                                    {
                                        <div class="text-[9px] fw-bold text-muted-foreground text-uppercase tracking-widest d-flex align-items-center justify-content-center gap-1 opacity-60">
                                            <i data-lucide="users" style="width: 10px;"></i>
                                            @if (friend.MutualFriendsCount == 1)
                                            {
                                                @Localizer["OneMutualFriend"]
                                            }
                                            else
                                            {
                                                @string.Format(Localizer["MutualFriendsCount"].Value, friend.MutualFriendsCount)
                                            }
                                        </div>
                                    }
                                    
                                    <div class="text-[9px] fw-bold text-muted-foreground text-uppercase tracking-widest opacity-40">
                                        @string.Format(Localizer["FriendsSince"].Value, friend.FriendsSince.ToString("MMM yyyy"))
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2 justify-content-center mt-auto">
                                    <a href="/chats?user=@friend.UserId" class="btn btn-primary-red flex-grow-1 py-2 px-3 rounded-3 fw-black text-uppercase tracking-widest text-[9px] d-flex align-items-center justify-content-center gap-2 shadow-sm animate-in zoom-in duration-300">
                                        <i data-lucide="message-circle" style="width: 14px;"></i>
                                        @Localizer["Message"]
                                    </a>
                                    <button class="btn btn-outline-secondary py-2 px-3 rounded-3 fw-black text-uppercase tracking-widest text-[9px] d-flex align-items-center justify-content-center gap-2 shadow-sm" onclick="viewProfile('@friend.UserId')">
                                        <i data-lucide="user" style="width: 14px;"></i>
                                        @Localizer["Profile"]
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary py-2 px-3 rounded-3 fw-black shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i data-lucide="more-horizontal" style="width: 14px;"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg rounded-4 p-2 scale-in-center">
                                            <li>
                                                <button class="dropdown-item rounded-3 text-[10px] fw-black text-uppercase tracking-widest py-2 d-flex align-items-center gap-2" onclick="viewMutualFriends('@friend.UserId')">
                                                    <i data-lucide="users" style="width: 14px;"></i>
                                                    @Localizer["MutualFriends"]
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider opacity-10"></li>
                                            <li>
                                                <button class="dropdown-item rounded-3 text-[10px] fw-black text-uppercase tracking-widest py-2 text-danger d-flex align-items-center gap-2" onclick="removeFriend('@friend.UserId', '@friend.FullName')">
                                                    <i data-lucide="user-minus" style="width: 14px;"></i>
                                                    @Localizer["RemoveFriend"]
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item rounded-3 text-[10px] fw-black text-uppercase tracking-widest py-2 text-danger d-flex align-items-center gap-2" onclick="blockUser('@friend.UserId', '@friend.FullName')">
                                                    <i data-lucide="user-x" style="width: 14px;"></i>
                                                    @Localizer["BlockUser"]
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="w-20 h-20 bg-muted rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4">
                        <i data-lucide="users" class="text-muted opacity-30" style="width: 40px; height: 40px;"></i>
                    </div>
                    <h5 class="h5 fw-black text-gradient mb-2">@Localizer["NoFriendsYet"]</h5>
                    <p class="text-sm text-muted-foreground mb-5 opacity-75">@Localizer["NoFriendsYetDescription"]</p>
                    <a asp-controller="Friends" asp-action="Suggestions" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" class="btn btn-primary-red px-5 py-3 rounded-4 fw-black text-uppercase tracking-widest text-xs shadow-lg d-flex align-items-center gap-2 mx-auto" style="width: fit-content;">
                        <i data-lucide="user-search" class="w-4 h-4"></i> @Localizer["FindFriends"]
                    </a>
                </div>
            }
            </div>
        </div>
    </div>
</div>


@section Scripts {

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Skeleton.initPageLoad('friends-skeleton', 'friends-content');
        });

        function toggleFriendMenu(userId) {
            const menu = document.getElementById(`friend-menu-${userId}`);
            // Close all other menus
            document.querySelectorAll('[id^="friend-menu-"]').forEach(m => {
                if (m !== menu) m.classList.add('hidden');
            });
            menu.classList.toggle('hidden');
        }

        function viewProfile(userId) {
            window.location.href = `/profile/${userId}`;
        }

        function viewMutualFriends(userId) {
            window.location.href = `/friends/mutual/${userId}`;
        }

        async function removeFriend(friendId, friendName) {
            if (!confirm(`Are you sure you want to remove ${friendName} from your friends?`)) {
                return;
            }

            try {
                const response = await fetch('/friends/remove-friend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ friendId: friendId })
                });
                
                const result = await response.json();
                if (result.success) {
                    window.notify.success(result.message);
                    location.reload();
                } else {
                    window.notify.error(result.message);
                }
            } catch (error) {
                window.notify.error('An error occurred while removing the friend.');
            }
        }

        async function blockUser(userId, userName) {
            if (!confirm(`Are you sure you want to block ${userName}? This will remove them from your friends and prevent them from contacting you.`)) {
                return;
            }

            try {
                const response = await fetch('/friends/block-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ userToBlockId: userId })
                });
                
                const result = await response.json();
                if (result.success) {
                    window.notify.success(result.message);
                    location.reload();
                } else {
                    window.notify.error(result.message);
                }
            } catch (error) {
                window.notify.error('An error occurred while blocking the user.');
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('[id^="friend-menu-"]') && !event.target.closest('button[onclick^="toggleFriendMenu"]')) {
                document.querySelectorAll('[id^="friend-menu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
    </script>
}