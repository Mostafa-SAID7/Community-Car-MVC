@using Microsoft.Extensions.Localization
@model CommunityCar.Application.Features.Community.Stories.ViewModels.StoriesSearchVM
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = "Stories";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentUserId = ViewBag.CurrentUserId as Guid?;
    var searchTerm = ViewBag.SearchTerm as string ?? "";
}

<div class="min-h-screen bg-background">
    <!-- Stories Header -->
    <div class="bg-card/40 backdrop-blur-xl border-b border-border sticky top-16 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center gap-3">
                    <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-primary/10">
                        <i data-lucide="camera" class="w-5 h-5 text-primary"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-foreground">@Localizer["Stories"]</h1>
                        <p class="text-sm text-muted-foreground">@Localizer["ShareMoments"]</p>
                    </div>
                </div>
                
                @if (currentUserId.HasValue)
                {
                    <a asp-controller="Stories" asp-action="Create" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" 
                       class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-medium">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        @Localizer["CreateStory"]
                    </a>
                }
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Search and Filters -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"></i>
                        <input type="text" 
                               id="searchInput"
                               value="@searchTerm"
                               placeholder="@Localizer["SearchPlaceholder"]"
                               class="w-full pl-10 pr-4 py-2 bg-card border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                    </div>
                </div>
                <div class="flex gap-2">
                    <select id="sortSelect" class="px-3 py-2 bg-card border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                        <option value="Default">Latest</option>
                        <option value="MostViews">Most Viewed</option>
                        <option value="MostLikes">Most Liked</option>
                        <option value="ExpiringFirst">Expiring Soon</option>
                    </select>
                    <button id="filterToggle" 
                            class="px-3 py-2 bg-card border border-border rounded-lg hover:bg-accent transition-colors">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Advanced Filters (Hidden by default) -->
            <div id="advancedFilters" class="hidden mt-4 p-4 bg-card border border-border rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Story Type</label>
                        <select id="typeFilter" class="w-full px-3 py-2 bg-background border border-border rounded-lg">
                            <option value="">All Types</option>
                            <option value="Photo">Photo</option>
                            <option value="Video">Video</option>
                            <option value="Text">Text</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Car Make</label>
                        <select id="carMakeFilter" class="w-full px-3 py-2 bg-background border border-border rounded-lg">
                            <option value="">All Makes</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes">Mercedes</option>
                            <option value="Audi">Audi</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Honda">Honda</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Tags</label>
                        <input type="text" 
                               id="tagsFilter"
                               placeholder="Enter tags..."
                               class="w-full px-3 py-2 bg-background border border-border rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end mt-4 gap-2">
                    <button id="clearFilters" class="px-4 py-2 text-muted-foreground hover:text-foreground transition-colors">
                        Clear Filters
                    </button>
                    <button id="applyFilters" class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Stories Grid -->
        <div id="stories-initial-skeleton" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            @for (int i = 0; i < 8; i++)
            {
                <partial name="_SkeletonLoading" model='"Story"' />
            }
        </div>
        <div id="storiesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            @if (Model?.Stories?.Any() == true)
            {
                @foreach (var story in Model.Stories)
                {
                    <div class="story-card group cursor-pointer" data-story-id="@story.Id" onclick="openStoryViewer('@story.Id')">
                        <div class="relative aspect-[9/16] rounded-xl overflow-hidden bg-gradient-to-br from-primary/20 to-accent/20 shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-[1.02]">
                            <!-- Story Media -->
                            @if (!string.IsNullOrEmpty(story.MediaUrl))
                            {
                                @if (story.Type == StoryType.Video)
                                {
                                    <video class="w-full h-full object-cover" poster="@(story.ThumbnailUrl ?? story.MediaUrl)">
                                        <source src="@story.MediaUrl" type="video/mp4">
                                    </video>
                                    <div class="absolute top-3 right-3 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center">
                                        <i data-lucide="play" class="w-4 h-4 text-white"></i>
                                    </div>
                                }
                                else
                                {
                                    <img src="@story.MediaUrl" alt="@story.Title" class="w-full h-full object-cover" />
                                }
                            }
                            else
                            {
                                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-primary/10 to-accent/10">
                                    <i data-lucide="image" class="w-12 h-12 text-muted-foreground"></i>
                                </div>
                            }

                            <!-- Story Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>

                            <!-- Story Header -->
                            <div class="absolute top-3 left-3 right-3 flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-white/20">
                                    <img src="@(story.AuthorAvatar ?? "/images/default-avatar.png")" alt="@story.AuthorName" class="w-full h-full object-cover" />
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-white text-sm font-medium truncate">@story.AuthorName</div>
                                    <div class="text-white/70 text-xs">@story.TimeAgo</div>
                                </div>
                                @if (story.IsHighlighted)
                                {
                                    <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center">
                                        <i data-lucide="star" class="w-3 h-3 text-white"></i>
                                    </div>
                                }
                            </div>

                            <!-- Story Footer -->
                            <div class="absolute bottom-3 left-3 right-3">
                                @if (!string.IsNullOrEmpty(story.Title))
                                {
                                    <div class="text-white text-sm font-medium mb-2 line-clamp-2">@story.Title</div>
                                }
                                
                                <div class="flex items-center justify-between text-white/70 text-xs">
                                    <div class="flex items-center gap-3">
                                        <span class="flex items-center gap-1">
                                            <i data-lucide="eye" class="w-3 h-3"></i>
                                            @story.ViewCount
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <i data-lucide="heart" class="w-3 h-3"></i>
                                            @story.LikeCount
                                        </span>
                                    </div>
                                    <div class="text-xs">
                                        @if (story.ExpiresAt.HasValue)
                                        {
                                            var timeLeft = story.ExpiresAt.Value - DateTime.UtcNow;
                                            if (timeLeft.TotalHours > 1)
                                            {
                                                <span>@((int)timeLeft.TotalHours)h left</span>
                                            }
                                            else if (timeLeft.TotalMinutes > 0)
                                            {
                                                <span>@((int)timeLeft.TotalMinutes)m left</span>
                                            }
                                            else
                                            {
                                                <span class="text-red-400">Expired</span>
                                            }
                                        }
                                    </div>
                                </div>

                                <!-- Tags -->
                                @if (story.Tags?.Any() == true)
                                {
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        @foreach (var tag in story.Tags.Take(3))
                                        {
                                            <span class="px-2 py-0.5 bg-white/20 text-white text-xs rounded-full">
                                                #@tag
                                            </span>
                                        }
                                        @if (story.Tags.Count() > 3)
                                        {
                                            <span class="px-2 py-0.5 bg-white/20 text-white text-xs rounded-full">
                                                +@(story.Tags.Count() - 3)
                                            </span>
                                        }
                                    </div>
                                }
                            </div>

                            <!-- Location indicator -->
                            @if (!string.IsNullOrEmpty(story.LocationName))
                            {
                                <div class="absolute top-3 right-3 bg-black/50 rounded-full px-2 py-1 flex items-center gap-1">
                                    <i data-lucide="map-pin" class="w-3 h-3 text-white"></i>
                                    <span class="text-white text-xs">@story.LocationName</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-span-full flex flex-col items-center justify-center py-16 text-center">
                    <div class="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="camera" class="w-8 h-8 text-muted-foreground"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-foreground mb-2">@Localizer["NoStoriesFound"]</h3>
                    <p class="text-muted-foreground mb-4">@Localizer["NoStoriesMessage"]</p>
                    @if (currentUserId.HasValue)
                    {
                        <a asp-controller="Stories" asp-action="Create" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" 
                           class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            @Localizer["CreateYourFirst"]
                        </a>
                    }
                </div>
            }
        </div>

        <!-- Load More Button -->
        @if (Model?.HasNextPage == true)
        {
            <div class="flex justify-center mt-8">
                <button id="loadMoreBtn" 
                        class="inline-flex items-center gap-2 px-6 py-3 bg-card border border-border rounded-lg hover:bg-accent transition-colors font-medium"
                        data-page="@(Model.CurrentPage + 1)">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Load More Stories
                </button>
            </div>
        }

        <!-- Loading Skeleton -->
        <div id="loadingSkeleton" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-6">
            @for (int i = 0; i < 8; i++)
            {
                <partial name="_SkeletonLoading" model='"Story"' />
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/stories.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Skeleton.initPageLoad('stories-initial-skeleton', 'storiesContainer');
            // Initialize stories page functionality
            initializeStoriesPage();
        });

        function initializeStoriesPage() {
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');
            const filterToggle = document.getElementById('filterToggle');
            const advancedFilters = document.getElementById('advancedFilters');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            // Search functionality
            let searchTimeout;
            searchInput?.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch();
                }, 500);
            });

            // Sort functionality
            sortSelect?.addEventListener('change', performSearch);

            // Filter toggle
            filterToggle?.addEventListener('click', function() {
                advancedFilters?.classList.toggle('hidden');
            });

            // Advanced filters
            document.getElementById('applyFilters')?.addEventListener('click', performSearch);
            document.getElementById('clearFilters')?.addEventListener('click', clearFilters);

            // Load more functionality
            loadMoreBtn?.addEventListener('click', loadMoreStories);
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const sortBy = document.getElementById('sortSelect')?.value || 'Default';
            const type = document.getElementById('typeFilter')?.value || '';
            const carMake = document.getElementById('carMakeFilter')?.value || '';
            const tags = document.getElementById('tagsFilter')?.value || '';

            const params = new URLSearchParams({
                searchTerm,
                sortBy,
                type,
                carMake,
                tags,
                page: '1'
            });

            window.location.href = `/${'@System.Globalization.CultureInfo.CurrentCulture.Name'}/stories?${params.toString()}`;
        }

        function clearFilters() {
            document.getElementById('typeFilter').value = '';
            document.getElementById('carMakeFilter').value = '';
            document.getElementById('tagsFilter').value = '';
            performSearch();
        }

        function loadMoreStories() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadingSkeleton = document.getElementById('loadingSkeleton');
            const storiesContainer = document.getElementById('storiesContainer');
            
            if (!loadMoreBtn) return;

            const page = parseInt(loadMoreBtn.dataset.page);
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const sortBy = document.getElementById('sortSelect')?.value || 'Default';

            // Show loading state
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Loading...';
            loadingSkeleton?.classList.remove('hidden');

            // Make API request
            const params = new URLSearchParams({
                searchTerm,
                sortBy,
                page: page.toString(),
                pageSize: '8'
            });

            fetch(`/${'@System.Globalization.CultureInfo.CurrentCulture.Name'}/stories?${params.toString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the response and extract story cards
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newStories = doc.querySelectorAll('.story-card');
                
                // Append new stories
                newStories.forEach(story => {
                    storiesContainer?.appendChild(story.cloneNode(true));
                });

                // Update load more button
                const hasNextPage = doc.querySelector('#loadMoreBtn');
                if (hasNextPage) {
                    loadMoreBtn.dataset.page = (page + 1).toString();
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> Load More Stories';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading more stories:', error);
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> Load More Stories';
            })
            .finally(() => {
                loadingSkeleton?.classList.add('hidden');
            });
        }
    </script>
}
@section SidebarRight {
    <partial name="~/Views/Community/_CommunitySidebar.cshtml" />
}
