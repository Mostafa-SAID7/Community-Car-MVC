@using Microsoft.Extensions.Localization
@model CommunityCar.Application.Features.Community.Stories.ViewModels.StoriesSearchVM
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = "Stories";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentUserId = ViewBag.CurrentUserId as Guid?;
    var searchTerm = ViewBag.SearchTerm as string ?? "";
}

<div class="min-vh-100 bg-light">
    <!-- Stories Header -->
    <div class="card bg-opacity-25 backdrop-blur border-bottom position-sticky z-3" style="top: 64px;">
        <div class="container-xxl px-3 px-sm-4 px-lg-5">
            <div class="d-flex align-items-center justify-content-between py-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="d-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-4" style="width: 40px; height: 40px;">
                        <i data-lucide="camera" style="width: 20px; height: 20px;" class="text-primary"></i>
                    </div>
                    <div>
                        <h1 class="h4 fw-bold mb-0">@Localizer["Stories"]</h1>
                        <p class="small text-muted mb-0">@Localizer["ShareMoments"]</p>
                    </div>
                </div>
                
                @if (currentUserId.HasValue)
                {
                    <a asp-controller="Stories" asp-action="Create" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" 
                       class="btn btn-primary d-inline-flex align-items-center gap-2 px-4 py-2 rounded-3">
                        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                        @Localizer["CreateStory"]
                    </a>
                }
            </div>
        </div>
    </div>

    <div class="container-xxl px-3 px-sm-4 px-lg-5 py-4">
        <!-- Search and Filters -->
        <div class="mb-4">
            <div class="row g-3">
                <div class="col-12 col-sm">
                    <div class="position-relative">
                        <i data-lucide="search" class="position-absolute text-muted" style="left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px;"></i>
                        <input type="text" 
                               id="searchInput"
                               value="@searchTerm"
                               placeholder="@Localizer["SearchPlaceholder"]"
                               class="form-control ps-5 rounded-3">
                    </div>
                </div>
                <div class="col-auto">
                    <div class="d-flex gap-2">
                        <select id="sortSelect" class="form-select rounded-3">
                            <option value="Default">Latest</option>
                            <option value="MostViews">Most Viewed</option>
                            <option value="MostLikes">Most Liked</option>
                            <option value="ExpiringFirst">Expiring Soon</option>
                        </select>
                        <button id="filterToggle" class="btn btn-outline-secondary rounded-3">
                            <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Filters (Hidden by default) -->
            <div id="advancedFilters" class="d-none mt-4 card p-4 rounded-3">
                <div class="row g-4">
                    <div class="col-12 col-md-4">
                        <label class="form-label small fw-medium">Story Type</label>
                        <select id="typeFilter" class="form-select rounded-3">
                            <option value="">All Types</option>
                            <option value="Photo">Photo</option>
                            <option value="Video">Video</option>
                            <option value="Text">Text</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label small fw-medium">Car Make</label>
                        <select id="carMakeFilter" class="form-select rounded-3">
                            <option value="">All Makes</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes">Mercedes</option>
                            <option value="Audi">Audi</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Honda">Honda</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label small fw-medium">Tags</label>
                        <input type="text" 
                               id="tagsFilter"
                               placeholder="Enter tags..."
                               class="form-control rounded-3">
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-4 gap-2">
                    <button id="clearFilters" class="btn btn-link text-muted">
                        Clear Filters
                    </button>
                    <button id="applyFilters" class="btn btn-primary rounded-3">
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Stories Grid -->
        <div id="stories-initial-skeleton" class="d-none row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            @for (int i = 0; i < 8; i++)
            {
                <div class="col">
                    <partial name="_SkeletonLoading" model='"Story"' />
                </div>
            }
        </div>
        <div id="storiesContainer" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            @if (Model?.Stories?.Any() == true)
            {
                @foreach (var story in Model.Stories)
                {
                    <div class="col">
                        <div class="story-card cursor-pointer" data-story-id="@story.Id" onclick="openStoryViewer('@story.Id')">
                            <div class="position-relative rounded-4 overflow-hidden shadow-lg hover-shadow-xl transition-all" style="aspect-ratio: 9/16; background: linear-gradient(135deg, rgba(var(--bs-primary-rgb), 0.2), rgba(var(--bs-secondary-rgb), 0.2));">
                                <!-- Story Media -->
                                @if (!string.IsNullOrEmpty(story.MediaUrl))
                                {
                                    @if (story.Type == StoryType.Video)
                                    {
                                        <video class="w-100 h-100 object-fit-cover" poster="@(story.ThumbnailUrl ?? story.MediaUrl)">
                                            <source src="@story.MediaUrl" type="video/mp4">
                                        </video>
                                        <div class="position-absolute top-0 end-0 m-3 bg-dark bg-opacity-50 rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                            <i data-lucide="play" style="width: 16px; height: 16px;" class="text-white"></i>
                                        </div>
                                    }
                                    else
                                    {
                                        <img src="@story.MediaUrl" alt="@story.Title" class="w-100 h-100 object-fit-cover" />
                                    }
                                }
                                else
                                {
                                    <div class="w-100 h-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, rgba(var(--bs-primary-rgb), 0.1), rgba(var(--bs-secondary-rgb), 0.1));">
                                        <i data-lucide="image" style="width: 48px; height: 48px;" class="text-muted"></i>
                                    </div>
                                }

                                <!-- Story Overlay -->
                                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(to top, rgba(0,0,0,0.6), transparent, transparent);"></div>

                                <!-- Story Header -->
                                <div class="position-absolute top-0 start-0 end-0 m-3 d-flex align-items-center gap-2">
                                    <div class="rounded-circle overflow-hidden border border-2 border-white border-opacity-25" style="width: 32px; height: 32px;">
                                        <img src="@(story.AuthorAvatar ?? "/images/default-avatar.png")" alt="@story.AuthorName" class="w-100 h-100 object-fit-cover" />
                                    </div>
                                    <div class="flex-grow-1 text-truncate">
                                        <div class="text-white small fw-medium text-truncate">@story.AuthorName</div>
                                        <div class="text-white text-opacity-75" style="font-size: 0.75rem;">@story.TimeAgo</div>
                                    </div>
                                    @if (story.IsHighlighted)
                                    {
                                        <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;">
                                            <i data-lucide="star" style="width: 12px; height: 12px;" class="text-white"></i>
                                        </div>
                                    }
                                </div>

                                <!-- Story Footer -->
                                <div class="position-absolute bottom-0 start-0 end-0 m-3">
                                    @if (!string.IsNullOrEmpty(story.Title))
                                    {
                                        <div class="text-white small fw-medium mb-2 text-truncate" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">@story.Title</div>
                                    }
                                    
                                    <div class="d-flex align-items-center justify-content-between text-white text-opacity-75" style="font-size: 0.75rem;">
                                        <div class="d-flex align-items-center gap-3">
                                            <span class="d-flex align-items-center gap-1">
                                                <i data-lucide="eye" style="width: 12px; height: 12px;"></i>
                                                @story.ViewCount
                                            </span>
                                            <span class="d-flex align-items-center gap-1">
                                                <i data-lucide="heart" style="width: 12px; height: 12px;"></i>
                                                @story.LikeCount
                                            </span>
                                        </div>
                                        <div style="font-size: 0.75rem;">
                                            @if (story.ExpiresAt.HasValue)
                                            {
                                                var timeLeft = story.ExpiresAt.Value - DateTime.UtcNow;
                                                if (timeLeft.TotalHours > 1)
                                                {
                                                    <span>@((int)timeLeft.TotalHours)h left</span>
                                                }
                                                else if (timeLeft.TotalMinutes > 0)
                                                {
                                                    <span>@((int)timeLeft.TotalMinutes)m left</span>
                                                }
                                                else
                                                {
                                                    <span class="text-danger">Expired</span>
                                                }
                                            }
                                        </div>
                                    </div>

                                    <!-- Tags -->
                                    @if (story.Tags?.Any() == true)
                                    {
                                        <div class="d-flex flex-wrap gap-1 mt-2">
                                            @foreach (var tag in story.Tags.Take(3))
                                            {
                                                <span class="badge bg-white bg-opacity-25 text-white rounded-pill" style="font-size: 0.7rem; padding: 2px 8px;">
                                                    #@tag
                                                </span>
                                            }
                                            @if (story.Tags.Count > 3)
                                            {
                                                <span class="badge bg-white bg-opacity-25 text-white rounded-pill" style="font-size: 0.7rem; padding: 2px 8px;">
                                                    +@(story.Tags.Count - 3)
                                                </span>
                                            }
                                        </div>
                                    }
                                </div>

                                <!-- Location indicator -->
                                @if (!string.IsNullOrEmpty(story.LocationName))
                                {
                                    <div class="position-absolute top-0 end-0 m-3 bg-dark bg-opacity-50 rounded-pill px-2 py-1 d-flex align-items-center gap-1">
                                        <i data-lucide="map-pin" style="width: 12px; height: 12px;" class="text-white"></i>
                                        <span class="text-white" style="font-size: 0.75rem;">@story.LocationName</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="d-flex flex-column align-items-center justify-content-center py-5 text-center">
                        <div class="bg-secondary bg-opacity-25 rounded-circle d-flex align-items-center justify-content-center mb-4" style="width: 64px; height: 64px;">
                            <i data-lucide="camera" style="width: 32px; height: 32px;" class="text-muted"></i>
                        </div>
                        <h3 class="h5 fw-semibold mb-2">@Localizer["NoStoriesFound"]</h3>
                        <p class="text-muted mb-4">@Localizer["NoStoriesMessage"]</p>
                        @if (currentUserId.HasValue)
                        {
                            <a asp-controller="Stories" asp-action="Create" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" 
                               class="btn btn-primary d-inline-flex align-items-center gap-2 rounded-3">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                @Localizer["CreateYourFirst"]
                            </a>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Load More Button -->
        @if (Model?.HasNextPage == true)
        {
            <div class="d-flex justify-content-center mt-5">
                <button id="loadMoreBtn" 
                        class="btn btn-outline-secondary d-inline-flex align-items-center gap-2 px-5 py-3 rounded-3"
                        data-page="@(Model.CurrentPage + 1)">
                    <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                    Load More Stories
                </button>
            </div>
        }

        <!-- Loading Skeleton -->
        <div id="loadingSkeleton" class="d-none row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mt-4">
            @for (int i = 0; i < 8; i++)
            {
                <div class="col">
                    <partial name="_SkeletonLoading" model='"Story"' />
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Skeleton.initPageLoad('stories-initial-skeleton', 'storiesContainer');
            // Initialize stories page functionality
            initializeStoriesPage();
        });

        function initializeStoriesPage() {
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');
            const filterToggle = document.getElementById('filterToggle');
            const advancedFilters = document.getElementById('advancedFilters');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            // Search functionality
            let searchTimeout;
            searchInput?.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch();
                }, 500);
            });

            // Sort functionality
            sortSelect?.addEventListener('change', performSearch);

            // Filter toggle
            filterToggle?.addEventListener('click', function() {
                advancedFilters?.classList.toggle('d-none');
            });

            // Advanced filters
            document.getElementById('applyFilters')?.addEventListener('click', performSearch);
            document.getElementById('clearFilters')?.addEventListener('click', clearFilters);

            // Load more functionality
            loadMoreBtn?.addEventListener('click', loadMoreStories);
        }

        function performSearch() {
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const sortBy = document.getElementById('sortSelect')?.value || 'Default';
            const type = document.getElementById('typeFilter')?.value || '';
            const carMake = document.getElementById('carMakeFilter')?.value || '';
            const tags = document.getElementById('tagsFilter')?.value || '';

            const params = new URLSearchParams({
                searchTerm,
                sortBy,
                type,
                carMake,
                tags,
                page: '1'
            });

            window.location.href = `/${'@System.Globalization.CultureInfo.CurrentCulture.Name'}/stories?${params.toString()}`;
        }

        function clearFilters() {
            document.getElementById('typeFilter').value = '';
            document.getElementById('carMakeFilter').value = '';
            document.getElementById('tagsFilter').value = '';
            performSearch();
        }

        function loadMoreStories() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadingSkeleton = document.getElementById('loadingSkeleton');
            const storiesContainer = document.getElementById('storiesContainer');
            
            if (!loadMoreBtn) return;

            const page = parseInt(loadMoreBtn.dataset.page);
            const searchTerm = document.getElementById('searchInput')?.value || '';
            const sortBy = document.getElementById('sortSelect')?.value || 'Default';

            // Show loading state
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<i data-lucide="loader-2" style="width: 16px; height: 16px;" class="spinner-border spinner-border-sm"></i> Loading...';
            loadingSkeleton?.classList.remove('d-none');

            // Make API request
            const params = new URLSearchParams({
                searchTerm,
                sortBy,
                page: page.toString(),
                pageSize: '8'
            });

            fetch(`/${'@System.Globalization.CultureInfo.CurrentCulture.Name'}/stories?${params.toString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the response and extract story cards
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newStories = doc.querySelectorAll('.story-card');
                
                // Append new stories
                newStories.forEach(story => {
                    storiesContainer?.appendChild(story.cloneNode(true));
                });

                // Update load more button
                const hasNextPage = doc.querySelector('#loadMoreBtn');
                if (hasNextPage) {
                    loadMoreBtn.dataset.page = (page + 1).toString();
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = '<i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i> Load More Stories';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading more stories:', error);
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = '<i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i> Load More Stories';
            })
            .finally(() => {
                loadingSkeleton?.classList.add('d-none');
            });
        }
    </script>
}
@section SidebarRight {
    <partial name="~/Views/Community/_CommunitySidebar.cshtml" />
}
