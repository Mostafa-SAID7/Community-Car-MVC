@using Microsoft.Extensions.Localization
@model dynamic
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = $"{Model.Title} - {Localizer["BroadcastArchive"]}";
}

<div class="container-fluid community-detail-container mx-auto py-4 animate-in fade-in">
    <!-- Skeleton Loader -->
    <div id="loading-skeleton" class="d-none vstack gap-4">
        <div class="vstack gap-3">
            <div class="skeleton-line" style="width: 200px;"></div> <!-- Breadcrumb -->
            <div class="skeleton-card" style="height: 400px;"></div> <!-- Hero -->
            <div class="skeleton-line"></div> <!-- Meta -->
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <!-- Navigation & Signal Strategy -->
        <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-4 px-2 mb-4">
            <div class="vstack gap-4">
                <nav class="d-flex align-items-center gap-3 text-primary mb-3 nav-breadcrumb">
                    <i data-lucide="zap" class="icon-sm"></i> @Localizer["SignalBroadcast"]
                </nav>
                <h1 class="display-4 fw-black text-dark lh-1">@Model.Title</h1>
                <p class="small fw-medium text-muted opacity-75 mt-4 border-start border-4 border-primary border-opacity-25 ps-4 py-1 transmission-log">@Localizer["TransmissionLog"]</p>
            </div>
            
            <a asp-controller="Posts" asp-action="Index" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" class="btn btn-outline-secondary d-inline-flex align-items-center justify-content-center gap-2 px-4 py-2 rounded-4 back-btn">
                <i data-lucide="arrow-left" class="icon-md back-arrow"></i>
                @Localizer["FeedRegistry"]
            </a>
        </div>

        <div class="position-relative mb-4">
            <div class="position-relative community-content-card border border-secondary border-opacity-25 rounded-5 shadow-lg overflow-hidden">
                <!-- Article Header: Hero Style -->
                <div class="p-4 p-md-5 vstack gap-4">
                    <div class="vstack gap-3">
                        <div class="d-flex align-items-center gap-3">
                             <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 payload-badge">
                                @Model.Type PAYLOAD
                             </span>
                             <span class="frequency-text xx-small fw-black text-uppercase text-muted opacity-50">@string.Format(Localizer["Frequency"].Value, Model.CreatedAt.ToString("MMM dd, yyyy"))</span>
                        </div>
                    </div>

                    <div class="d-flex align-items-center justify-content-between pt-4 border-top border-secondary border-opacity-25">
                        <div class="d-flex align-items-center gap-4">
                            <div class="user-avatar-container border border-secondary shadow-sm overflow-hidden">
                                 @if (!string.IsNullOrEmpty(Model.AuthorProfilePicture))
                                 {
                                     <img src="@Model.AuthorProfilePicture" class="w-100 h-100 object-fit-cover hover-scale transition-all" alt="@Model.AuthorName" />
                                 }
                                 else
                                 {
                                     <i data-lucide="user" class="icon-lg text-muted opacity-50 hover-scale transition-all"></i>
                                 }
                            </div>
                            <div>
                                 @if (Model.AuthorId != Guid.Empty)
                                 {
                                     <a href="@Url.Action("Index", "Profile", new { area = "", culture = System.Globalization.CultureInfo.CurrentCulture.Name, id = Model.AuthorId })" class="d-block small fw-black text-dark text-decoration-underline text-decoration-primary text-underline-offset-2 hover-text-primary transition-all">@Model.AuthorName</a>
                                 }
                                 else
                                 {
                                     <span class="d-block small fw-black text-dark text-decoration-underline text-decoration-primary text-underline-offset-2 hover-text-primary transition-all">@Localizer["ProtocolGhost"]</span>
                                 }
                                 <span class="d-block xxx-small fw-black text-uppercase text-muted opacity-50">@Localizer["SystemContributor"] â€¢ @Localizer["VerifiedEnthusiast"]</span>
                            </div>
                        </div>
                        
                        <div class="d-none d-sm-flex gap-4">
                            <div class="text-end">
                                 <span class="d-block fs-4 fw-black text-dark lh-1 like-count">@(Model.LikeCount > 0 ? Model.LikeCount.ToString("N0") : "0")</span>
                                 <span class="d-block xxx-small fw-black text-uppercase text-muted opacity-50">@Localizer["SignalPulse"]</span>
                            </div>
                            <div class="text-end">
                                 <span class="d-block fs-4 fw-black text-dark lh-1">@(Model.CommentCount > 0 ? Model.CommentCount.ToString("N0") : "0")</span>
                                 <span class="d-block xxx-small fw-black text-uppercase text-muted opacity-50">@Localizer["Interactions"]</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Fluidity -->
                <div class="px-4 px-md-5 py-5 bg-light bg-opacity-25 border-top border-bottom border-secondary border-opacity-25">
                    <div class="text-dark lh-lg fw-medium">
                        @Html.Raw(Model.Content.Replace("\n", "<br/>"))
                    </div>
                </div>

                <!-- Interaction Control Strip -->
                <div class="p-4 p-md-5 d-flex align-items-center justify-content-between bg-white bg-opacity-50">
                    <div class="d-flex gap-4">
                        <!-- Like Button -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            <form asp-controller="Posts" asp-action="Like" method="post" class="like-form" data-post-id="@Model.Id">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-link d-flex align-items-center gap-3 community-interaction-btn xx-small fw-black text-uppercase text-muted hover-text-danger transition-all like-btn p-0">
                                    <div class="interaction-icon-container bg-light bg-opacity-75 rounded-4 d-flex align-items-center justify-content-center">
                                        <i data-lucide="heart" class="icon-md"></i>
                                    </div>
                                    @Localizer["OscillateLiked"]
                                </button>
                            </form>
                        }
                        else
                        {
                            <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="btn btn-link d-flex align-items-center gap-3 community-interaction-btn xx-small fw-black text-uppercase text-muted hover-text-danger transition-all p-0" title="Login to like">
                                <div class="interaction-icon-container bg-light bg-opacity-75 rounded-4 d-flex align-items-center justify-content-center">
                                    <i data-lucide="heart" class="icon-md"></i>
                                </div>
                                @Localizer["OscillateLiked"]
                            </a>
                        }

                        <!-- Join Stream (Comment) Button -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            <button onclick="scrollToCommentForm()" class="btn btn-link d-flex align-items-center gap-3 community-interaction-btn xx-small fw-black text-uppercase text-muted hover-text-info transition-all p-0">
                                <div class="interaction-icon-container bg-light bg-opacity-75 rounded-4 d-flex align-items-center justify-content-center">
                                    <i data-lucide="message-circle" class="icon-md"></i>
                                </div>
                                @Localizer["JoinStream"]
                            </button>
                        }
                        else
                        {
                            <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="btn btn-link d-flex align-items-center gap-3 community-interaction-btn xx-small fw-black text-uppercase text-muted hover-text-info transition-all p-0" title="Login to comment">
                                <div class="interaction-icon-container bg-light bg-opacity-75 rounded-4 d-flex align-items-center justify-content-center">
                                    <i data-lucide="message-circle" class="icon-md"></i>
                                </div>
                                @Localizer["JoinStream"]
                            </a>
                        }
                    </div>

                    <div class="d-flex gap-3">
                        <!-- Share Button -->
                        <button onclick="sharePost()" class="btn btn-outline-secondary rounded-4 d-flex align-items-center justify-content-center community-interaction-btn share-btn" style="width: 48px; height: 48px;" title="Share post">
                            <i data-lucide="share-2" class="icon-md"></i>
                        </button>

                        <!-- Bookmark Button -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            <form asp-controller="Posts" asp-action="Bookmark" method="post" class="bookmark-form" data-post-id="@Model.Id">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-outline-secondary rounded-4 d-flex align-items-center justify-content-center community-interaction-btn bookmark-btn" style="width: 48px; height: 48px;" title="Bookmark post">
                                    <i data-lucide="bookmark" class="icon-md"></i>
                                </button>
                            </form>
                        }
                        else
                        {
                            <a href="@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })" class="btn btn-outline-secondary rounded-4 d-flex align-items-center justify-content-center community-interaction-btn" style="width: 48px; height: 48px;" title="Login to bookmark">
                                <i data-lucide="bookmark" class="icon-md"></i>
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        @if (User.Identity.IsAuthenticated)
        {
            <div class="community-content-card border border-secondary border-opacity-25 rounded-5 shadow-lg overflow-hidden mb-4">
                <div class="p-4 p-md-5">
                    <h3 class="h4 fw-black text-dark lh-1 mb-4">@Localizer["JoinStream"]</h3>
                    
                    <form asp-controller="Posts" asp-action="Comment" method="post" class="comment-form" data-post-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        
                        <div class="vstack gap-3">
                            <div class="position-relative">
                                <textarea name="content" class="form-control border-0 bg-light bg-opacity-50 rounded-4 p-4" rows="4" style="resize: none;" placeholder="@Localizer["ShareYourThoughts"]" required></textarea>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-2 px-4 py-3 rounded-4 fw-medium comment-submit-btn">
                                    <i data-lucide="send" class="icon-sm"></i>
                                    @Localizer["PostComment"]
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        }

        <!-- System Metadata Trace -->
        <div class="p-4 p-md-5 bg-light bg-opacity-50 border border-secondary border-opacity-25 rounded-5 row g-4">
            <div class="col-12 col-md-3">
                <div class="vstack gap-1">
                    <span class="d-block xxx-small fw-black text-uppercase text-muted opacity-50">@Localizer["TransportID"]</span>
                    <code class="xx-small font-monospace text-primary fw-bold">@Model.Id.ToString().Substring(0, 18)...</code>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="vstack gap-1">
                    <span class="d-block xxx-small fw-black text-uppercase text-muted opacity-50">@Localizer["CipherFormat"]</span>
                    <span class="xx-small fw-black text-dark">UTF-8 RAW</span>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="vstack gap-1">
                    <span class="d-block xxx-small fw-black text-uppercase text-muted opacity-50">@Localizer["Originator"]</span>
                    <span class="xx-small fw-black text-dark">EN-AUT-GATEWAY</span>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="vstack gap-1 text-md-end d-flex flex-column align-items-md-end">
                    <span class="d-block xx-small fw-black text-uppercase text-muted opacity-50">@Localizer["Status"]</span>
                    <span class="d-flex align-items-center gap-2 xx-small fw-black text-success">
                        <span class="status-indicator bg-success rounded-circle animate-pulse"></span>
                        @Localizer["ActiveArchive"]
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/signalr.min.js"></script>
    <script>
        let broadcastConnection;
        
        document.addEventListener('DOMContentLoaded', function() {
            initializePostInteractions();
            initializeBroadcastHub();
        });

        function initializeBroadcastHub() {
            // Initialize SignalR connection to BroadcastHub
            broadcastConnection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/broadcast")
                .withAutomaticReconnect()
                .build();

            // Handle connection events
            broadcastConnection.start().then(function () {
                console.log('BroadcastHub connected');
                
                // Join group broadcast if this post belongs to a group
                @if (Model.GroupId != null && Model.GroupId != Guid.Empty)
                {
                    <text>
                    broadcastConnection.invoke("JoinGroupBroadcast", "@Model.GroupId");
                    </text>
                }
                
                // Request accessible posts
                broadcastConnection.invoke("GetAccessiblePosts", 1, 10);
                
            }).catch(function (err) {
                console.error('BroadcastHub connection error:', err);
            });

            // Handle real-time post interactions
            broadcastConnection.on("PostInteractionBroadcast", function (data) {
                if (data.PostId === "@Model.Id") {
                    handleRealTimeInteraction(data);
                }
            });

            // Handle new post broadcasts
            broadcastConnection.on("NewPostBroadcast", function (postData) {
                showNewPostNotification(postData);
            });

            // Handle group access responses
            broadcastConnection.on("GroupPostAccessGranted", function (groupId) {
                showToast('Access granted to group posts!', 'success');
            });

            broadcastConnection.on("GroupPostAccessDenied", function (groupId, reason) {
                showToast(`Access denied: ${reason}`, 'error');
            });

            broadcastConnection.on("GroupPostAccessRequested", function (groupId) {
                showToast('Join request sent to group admins', 'info');
            });

            // Handle accessible posts updates
            broadcastConnection.on("AccessiblePostsUpdate", function (posts) {
                updateAccessiblePostsList(posts);
            });
        }

        function handleRealTimeInteraction(data) {
            switch (data.InteractionType) {
                case 'like':
                    updateLikeCount(data.Data.likeCount, data.Data.liked);
                    break;
                case 'comment':
                    updateCommentCount(data.Data.commentCount);
                    break;
                case 'bookmark':
                    // Handle bookmark updates if needed
                    break;
            }
        }

        function updateLikeCount(newCount, isLiked) {
            const likeCountElement = document.querySelector('.like-count');
            if (likeCountElement) {
                likeCountElement.textContent = newCount || '0';
                
                // Add visual feedback for real-time updates
                likeCountElement.classList.add('animate-pulse');
                setTimeout(() => likeCountElement.classList.remove('animate-pulse'), 1000);
            }
        }

        function updateCommentCount(newCount) {
            // Update comment count display if it exists
            const commentElements = document.querySelectorAll('[data-comment-count]');
            commentElements.forEach(element => {
                element.textContent = newCount || '0';
                element.classList.add('animate-pulse');
                setTimeout(() => element.classList.remove('animate-pulse'), 1000);
            });
        }

        function showNewPostNotification(postData) {
            // Show a subtle notification for new posts in the same group
            @if (Model.GroupId != null && Model.GroupId != Guid.Empty)
            {
                <text>
                if (postData.GroupId === "@Model.GroupId" && postData.Id !== "@Model.Id") {
                    const notification = document.createElement('div');
                    notification.className = 'position-fixed top-0 end-0 m-4 bg-primary text-white px-4 py-2 rounded-3 shadow-lg animate-in fade-in';
                    notification.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <i data-lucide="zap" class="icon-sm"></i>
                            <span class="small fw-medium">New post by ${postData.AuthorName}</span>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 5000);
                }
                </text>
            }
        }

        function updateAccessiblePostsList(posts) {
            // This could be used to update a sidebar or feed of accessible posts
            console.log('Accessible posts updated:', posts);
        }

        function initializePostInteractions() {
            // Handle like form submissions
            document.querySelectorAll('.like-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleLike(this);
                });
            });

            // Handle bookmark form submissions
            document.querySelectorAll('.bookmark-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleBookmark(this);
                });
            });

            // Handle comment form submissions
            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleComment(this);
                });
            });
        }

        async function handleLike(form) {
            const button = form.querySelector('.like-btn');
            const postId = form.dataset.postId;
            
            // Disable button during request
            button.disabled = true;
            button.style.opacity = '0.6';
            
            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update button appearance
                    const icon = button.querySelector('i');
                    const container = button.querySelector('.interaction-icon-container');
                    
                    if (data.liked) {
                        button.classList.add('text-danger');
                        container.classList.add('bg-danger', 'bg-opacity-10');
                        icon.classList.add('fill-current');
                        showToast('Post liked!', 'success');
                    } else {
                        button.classList.remove('text-danger');
                        container.classList.remove('bg-danger', 'bg-opacity-10');
                        icon.classList.remove('fill-current');
                        showToast('Like removed!', 'success');
                    }
                    
                    // Update like count locally
                    if (data.likeCount !== undefined) {
                        updateLikeCount(data.likeCount, data.liked);
                    }
                    
                    // Broadcast the interaction via SignalR
                    if (broadcastConnection && broadcastConnection.state === signalR.HubConnectionState.Connected) {
                        broadcastConnection.invoke("BroadcastPostInteraction", postId, "like", {
                            liked: data.liked,
                            likeCount: data.likeCount
                        });
                    }
                } else {
                    showToast('Failed to update likePlease try again.', 'error');
                }
            } catch (error) {
                console.error('Like error:', error);
                showToast('An error occurred. Please try again.', 'error');
            } finally {
                // Re-enable button
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        async function handleBookmark(form) {
            const button = form.querySelector('.bookmark-btn');
            const postId = form.dataset.postId;
            
            button.disabled = true;
            button.style.opacity = '0.6';
            
            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update button appearance
                    const icon = button.querySelector('i');
                    if (data.bookmarked) {
                        button.classList.add('text-warning', 'bg-warning', 'bg-opacity-5', 'border-warning', 'border-opacity-25');
                        icon.classList.add('fill-current');
                        showToast('Post bookmarked!', 'success');
                    } else {
                        button.classList.remove('text-warning', 'bg-warning', 'bg-opacity-5', 'border-warning', 'border-opacity-25');
                        icon.classList.remove('fill-current');
                        showToast('Bookmark removed!', 'success');
                    }
                    
                    // Broadcast the interaction via SignalR
                    if (broadcastConnection && broadcastConnection.state === signalR.HubConnectionState.Connected) {
                        broadcastConnection.invoke("BroadcastPostInteraction", postId, "bookmark", {
                            bookmarked: data.bookmarked
                        });
                    }
                } else {
                    showToast('Failed to update bookmark. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Bookmark error:', error);
                showToast('An error occurred. Please try again.', 'error');
            } finally {
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        async function handleComment(form) {
            const button = form.querySelector('.comment-submit-btn');
            const textarea = form.querySelector('textarea[name="content"]');
            const postId = form.dataset.postId;
            
            if (!textarea.value.trim()) {
                showToast('Please enter a comment.', 'error');
                return;
            }
            
            button.disabled = true;
            button.style.opacity = '0.6';
            
            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Clear the textarea
                    textarea.value = '';
                    
                    // Show success message
                    showToast('Comment posted successfully!', 'success');
                    
                    // Update comment count if provided
                    if (data.commentCount !== undefined) {
                        updateCommentCount(data.commentCount);
                    }
                    
                    // Broadcast the interaction via SignalR
                    if (broadcastConnection && broadcastConnection.state === signalR.HubConnectionState.Connected) {
                        broadcastConnection.invoke("BroadcastPostInteraction", postId, "comment", {
                            commentCount: data.commentCount,
                            newComment: data.comment
                        });
                    }
                    
                    // Optionally reload to show new comment
                    if (data.shouldReload) {
                        setTimeout(() => window.location.reload(), 1000);
                    }
                } else {
                    showToast('Failed to post comment. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Comment error:', error);
                showToast('An error occurred. Please try again.', 'error');
            } finally {
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        function scrollToCommentForm() {
            const commentForm = document.querySelector('.comment-form');
            if (commentForm) {
                commentForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                const textarea = commentForm.querySelector('textarea[name="content"]');
                if (textarea) {
                    setTimeout(() => textarea.focus(), 500);
                }
            } else {
                // If not authenticated, redirect to login
                window.location.href = '@Url.Action("Login", "Account", new { returnUrl = Context.Request.Path })';
            }
        }

        function sharePost() {
            const title = document.title;
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: title,
                    url: url
                }).then(() => {
                    showToast('Post shared successfully!', 'success');
                }).catch((error) => {
                    console.log('Error sharing:', error);
                    fallbackShare(url);
                });                fallbackShare(url);
                });
            } else {
                fallbackShare(url);
            }
        }

        function fallbackShare(url) {
            // Copy to clipboard as fallback
            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!', 'success');
            }).catch(() => {
                // Final fallback - show URL in prompt
                prompt('Copy this link to share:', url);
            });
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.className = `position-fixed top-0 end-0 m-4 px-4 py-3 rounded-3 shadow-lg animate-in fade-in ${
                type === 'success' ? 'bg-success text-white' :
                type === 'error' ? 'bg-danger text-white' :
                'bg-info text-white'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (broadcastConnection) {
                broadcastConnection.stop();
            }
        });
    </script>
}