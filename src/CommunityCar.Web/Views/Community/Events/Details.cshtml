@model CommunityCar.Application.Features.Community.Events.ViewModels.EventVM
@inject IViewLocalizer Localizer
@{
    // Get current culture for localization
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");

    var displayTitle = isArabic && !string.IsNullOrEmpty(Model.TitleAr) ? Model.TitleAr : Model.Title;
    var displayDescription = isArabic && !string.IsNullOrEmpty(Model.DescriptionAr) ? Model.DescriptionAr : Model.Description;
    var displayLocationDetails = isArabic && !string.IsNullOrEmpty(Model.LocationDetailsAr) ? Model.LocationDetailsAr : Model.LocationDetails;

    ViewData["Title"] = displayTitle;
}

    <!-- Navigation & Header Strategy -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 px-2 mb-10">
        <div class="space-y-4">
            <nav class="flex items-center gap-3 text-[10px] font-black uppercase tracking-[0.3em] text-primary mb-6">
                <i data-lucide="calendar" class="w-3.5 h-3.5 fill-current"></i> @Localizer["EventPayload"]
            </nav>
            <h1 class="text-5xl font-black text-foreground tracking-tighter leading-none">@displayTitle</h1>
            <p class="text-sm font-medium text-muted-foreground opacity-70 mt-4 border-l-4 border-primary/20 pl-4 py-1 max-w-2xl">@displayDescription</p>
        </div>
        
        <a asp-controller="Events" asp-action="Index" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name" class="inline-flex items-center justify-center gap-2.5 px-6 py-2.5 bg-background border border-border/50 hover:bg-muted/10 text-foreground text-[10px] font-black uppercase tracking-widest rounded-xl transition-all active:scale-95 group/back">
            <i data-lucide="arrow-left" class="w-4 h-4 group-hover/back:-translate-x-1 transition-transform"></i>
            @Localizer["BackToEvents"]
        </a>
    </div>

    <div class="relative group mb-12">
        <div class="absolute -inset-1.5 bg-gradient-to-r from-primary/20 via-blue-500/5 to-primary/20 rounded-[3rem] blur-3xl opacity-10 group-hover:opacity-30 transition duration-1000"></div>
        
        <div class="relative bg-card/40 backdrop-blur-2xl border border-border/50 rounded-[2.5rem] shadow-2xl p-8 md:p-12 overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -mr-32 -mt-32"></div>
            
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-8">
                <div class="flex-1 space-y-6">
                    <!-- Event Status & Badges -->
                    <div class="flex flex-wrap items-center gap-3">
                        @if (Model.IsUpcoming)
                        {
                            <span class="px-4 py-1.5 rounded-2xl bg-green-500/10 text-green-500 border border-green-500/20 text-[9px] font-black uppercase tracking-widest">
                                @Localizer["Upcoming"]
                            </span>
                        }
                        else if (Model.IsActive)
                        {
                            <span class="px-4 py-1.5 rounded-2xl bg-orange-500/10 text-orange-500 border border-orange-500/20 text-[9px] font-black uppercase tracking-widest animate-pulse">
                                @Localizer["ActiveNow"]
                            </span>
                        }
                        else
                        {
                            <span class="px-4 py-1.5 rounded-2xl bg-muted/20 text-muted-foreground border border-border/50 text-[9px] font-black uppercase tracking-widest">
                                @Localizer["PastEvent"]
                            </span>
                        }
                        
                        @if (Model.IsFree)
                        {
                            <span class="px-4 py-1.5 rounded-2xl bg-primary/10 text-primary border border-primary/20 text-[9px] font-black uppercase tracking-widest">FREE ACCESS</span>
                        }
                        else if (Model.TicketPrice.HasValue)
                        {
                            <span class="px-4 py-1.5 rounded-2xl bg-blue-500/10 text-blue-500 border border-blue-500/20 text-[9px] font-black uppercase tracking-widest">$@Model.TicketPrice.Value REGISTRY</span>
                        }
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
                        <div class="space-y-1">
                            <span class="block text-[10px] font-black uppercase tracking-widest text-muted-foreground opacity-40">@Localizer["LocationRegistry"]</span>
                            <div class="flex items-center gap-2 text-sm font-bold text-foreground">
                                <i data-lucide="map-pin" class="w-4 h-4 text-primary"></i>
                                @Model.Location
                            </div>
                        </div>
                        <div class="space-y-1 text-right md:text-left">
                            <span class="block text-[10px] font-black uppercase tracking-widest text-muted-foreground opacity-40">@Localizer["TemporalStamp"]</span>
                            <div class="flex items-center justify-end md:justify-start gap-2 text-sm font-bold text-foreground">
                                <i data-lucide="calendar" class="w-4 h-4 text-primary"></i>
                                @Model.StartTime.ToString("MMM dd, yyyy")
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Interaction Matrix -->
                <div class="flex flex-col sm:flex-row md:flex-col gap-4">
                    @if (Model.IsUpcoming)
                    {
                        <button onclick="joinEvent('@Model.Id')" class="inline-flex items-center justify-center min-w-[180px] px-6 py-3 bg-primary text-primary-foreground hover:bg-primary/90 font-black uppercase tracking-widest rounded-xl transition-all shadow-lg shadow-primary/20 active:scale-95" id="joinBtn">
                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i> @Localizer["JoinEvent"]
                        </button>
                        <button onclick="leaveEvent('@Model.Id')" class="inline-flex items-center justify-center min-w-[180px] px-6 py-3 bg-background border border-border/50 hover:border-red-500/50 hover:text-red-500 font-black uppercase tracking-widest rounded-xl transition-all active:scale-95 hidden" id="leaveBtn">
                            <i data-lucide="user-minus" class="w-4 h-4 mr-2"></i> @Localizer["LeaveEvent"]
                        </button>
                    }
                    
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                        if (currentUserId == Model.OrganizerId.ToString())
                        {
                            <a href="/events/@Model.Id/edit" class="inline-flex items-center justify-center min-w-[180px] px-6 py-3 bg-background border border-border/50 hover:border-primary/50 hover:text-primary font-black uppercase tracking-widest rounded-xl transition-all active:scale-95">
                                <i data-lucide="edit-3" class="w-4 h-4 mr-2"></i> @Localizer["ModifyProtocol"]
                            </a>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Event Details Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Event Information Matrix -->
            <div class="relative bg-card/40 backdrop-blur-2xl border border-border/50 rounded-[2.5rem] shadow-xl overflow-hidden p-8">
                <div class="space-y-8">
                    <h3 class="text-[11px] font-black uppercase tracking-[0.25em] text-primary flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-primary shadow-glow-primary"></span>
                        @Localizer["TechnicalBlueprint"]
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <div class="bg-primary/10 p-2 rounded-lg text-primary">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-medium text-foreground">@Localizer["DateTime"]</div>
                                <div class="text-sm text-muted-foreground">
                                    <div>@Model.StartTime.ToString("dddd, MMMM dd, yyyy 'at' h:mm tt")</div>
                                    <div>@Model.EndTime.ToString("dddd, MMMM dd, yyyy 'at' h:mm tt")</div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="bg-primary/10 p-2 rounded-lg text-primary">
                                <i data-lucide="map-pin" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-medium text-foreground">@Localizer["Location"]</div>
                                <div class="text-sm text-muted-foreground">
                                    <div>@Model.Location</div>
                                    @if (!string.IsNullOrEmpty(displayLocationDetails))
                                    {
                                        <div class="mt-1">@displayLocationDetails</div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="flex items-start gap-3">
                            <div class="bg-primary/10 p-2 rounded-lg text-primary">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-medium text-foreground">@Localizer["Attendance"]</div>
                                <div class="text-sm text-muted-foreground">
                                    @Model.AttendeeCount @Localizer["Attendees"]
                                    @if (Model.MaxAttendees.HasValue)
                                    {
                                        <span>/ @Model.MaxAttendees.Value @Localizer["Max"]</span>
                                        @if (!Model.HasAvailableSpots)
                                        {
                                            <span class="text-red-500 font-medium">(@Localizer["Full"])</span>
                                        }
                                    }
                                </div>
                            </div>
                        </div>

                        @if (Model.TicketPrice.HasValue || !string.IsNullOrEmpty(Model.TicketInfo))
                        {
                            <div class="flex items-start gap-3">
                                <div class="bg-primary/10 p-2 rounded-lg text-primary">
                                    <i data-lucide="credit-card" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-foreground">@Localizer["Pricing"]</div>
                                    <div class="text-sm text-muted-foreground">
                                        @if (Model.TicketPrice.HasValue)
                                        {
                                            <div>$@Model.TicketPrice.Value</div>
                                        }
                                        @if (!string.IsNullOrEmpty(Model.TicketInfo))
                                        {
                                            <div>@Model.TicketInfo</div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Tags -->
            @if (Model.Tags.Any())
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-foreground mb-4">Tags</h3>
                        <div class="flex flex-wrap gap-2">
                            @foreach (var tag in Model.Tags)
                            {
                                <span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">#@tag</span>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Images -->
            @if (Model.ImageUrls.Any())
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-foreground mb-4">Photos</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            @foreach (var imageUrl in Model.ImageUrls)
                            {
                                <img src="@imageUrl" alt="Event photo" class="w-full h-32 object-cover rounded-lg" />
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Organizer Info -->
            <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden">
                <div class="p-6">
                    <h3 class="text-lg font-bold text-foreground mb-4">@Localizer["Organizer"]</h3>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 text-primary"></i>
                        </div>
                        <div>
                            <div class="font-medium text-foreground">Event Organizer</div>
                            <div class="text-sm text-muted-foreground">@Model.OrganizerId</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Info -->
            @if (!string.IsNullOrEmpty(Model.ExternalUrl) || !string.IsNullOrEmpty(Model.ContactInfo))
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-lg font-bold text-foreground mb-4">Contact</h3>
                        <div class="space-y-3">
                            @if (!string.IsNullOrEmpty(Model.ExternalUrl))
                            {
                                <a href="@Model.ExternalUrl" target="_blank" class="flex items-center gap-2 text-primary hover:text-primary/80 text-sm">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                    @Localizer["ExternalLink"]
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(Model.ContactInfo))
                            {
                                <div class="text-sm text-muted-foreground">
                                    @Model.ContactInfo
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <div class="bg-card/40 backdrop-blur-2xl border border-border/50 rounded-[2.5rem] shadow-xl overflow-hidden">
                <div class="p-8">
                    <h3 class="text-[11px] font-black uppercase tracking-[0.25em] text-primary mb-6">@Localizer["QuickActions"]</h3>
                    <div class="space-y-4">
                        <button onclick="shareEvent()" class="inline-flex items-center justify-start w-full px-6 py-3 bg-background border border-border/50 hover:bg-muted/10 text-foreground font-bold uppercase tracking-widest rounded-xl transition-all active:scale-95 group/share">
                            <i data-lucide="share-2" class="w-4 h-4 mr-3 text-primary group-hover/share:scale-110 transition-transform"></i>
                            @Localizer["ShareEvent"]
                        </button>
                        <button onclick="addToCalendar()" class="inline-flex items-center justify-start w-full px-6 py-3 bg-background border border-border/50 hover:bg-muted/10 text-foreground font-bold uppercase tracking-widest rounded-xl transition-all active:scale-95 group/calendar">
                            <i data-lucide="calendar-plus" class="w-4 h-4 mr-3 text-primary group-hover/calendar:scale-110 transition-transform"></i>
                            @Localizer["AddToCalendar"]
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End Main Content -->
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        Skeleton.initPageLoad('loading-skeleton', 'main-content');
    });

async function joinEvent(eventId) {
    try {
        const response = await fetch(`/events/${eventId}/join`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('joinBtn').classList.add('hidden');
            document.getElementById('leaveBtn').classList.remove('hidden');
            // Update attendee count
            location.reload();
        } else {
            if (window.AlertModal) {
                window.AlertModal.error(result.message, 'Error');
            } else {
                alert(result.message);
            }
        }
    } catch (error) {
        if (window.AlertModal) {
            window.AlertModal.error('An error occurred while joining the event.', 'Error');
        } else {
            alert('An error occurred while joining the event.');
        }
    }
}

async function leaveEvent(eventId) {
    try {
        const response = await fetch(`/events/${eventId}/leave`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('leaveBtn').classList.add('hidden');
            document.getElementById('joinBtn').classList.remove('hidden');
            // Update attendee count
            location.reload();
        } else {
            if (window.AlertModal) {
                window.AlertModal.error(result.message, 'Error');
            } else {
                alert(result.message);
            }
        }
    } catch (error) {
        if (window.AlertModal) {
            window.AlertModal.error('An error occurred while leaving the event.', 'Error');
        } else {
            alert('An error occurred while leaving the event.');
        }
    }
}

function shareEvent() {
    if (navigator.share) {
        navigator.share({
            title: '@Model.Title',
            text: '@Model.Description',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        if (window.AlertModal) {
            window.AlertModal.success('Event link copied to clipboard!', 'Success');
        } else {
            alert('Event link copied to clipboard!');
        }
    }
}

function addToCalendar() {
    const startDate = new Date('@Model.StartTime.ToString("yyyy-MM-ddTHH:mm:ss")');
    const endDate = new Date('@Model.EndTime.ToString("yyyy-MM-ddTHH:mm:ss")');
    
    const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent('@Model.Title')}&dates=${startDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endDate.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details=${encodeURIComponent('@Model.Description')}&location=${encodeURIComponent('@Model.Location')}`;
    
    window.open(googleCalendarUrl, '_blank');
}

// Initialize skeleton loading
document.addEventListener('DOMContentLoaded', function() {
    Skeleton.initPageLoad('loading-skeleton', 'main-content');
});
</script>