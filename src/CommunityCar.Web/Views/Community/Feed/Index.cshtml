@model CommunityCar.Application.Features.Feed.DTOs.FeedResponse
@{
    ViewData["Title"] = "Community Feed";
    var feedType = ViewBag.FeedType as string ?? "personalized";
    var currentUserId = ViewBag.CurrentUserId as Guid?;
}

<div class="feed-container">
    <!-- Stories Section -->
    <div class="stories-section">
        <div class="stories-container">
            <div class="story-item add-story">
                <div class="story-avatar">
                    <i class="fas fa-plus"></i>
                </div>
                <span class="story-label">Your Story</span>
            </div>
            
            @foreach (var story in Model.Stories.Take(10))
            {
                <div class="story-item" data-story-id="@story.Id">
                    <div class="story-avatar @(story.IsViewed ? "viewed" : "")">
                        <img src="@(story.ThumbnailUrl ?? story.MediaUrl)" alt="@story.AuthorName" />
                        @if (!story.IsViewed)
                        {
                            <div class="story-ring"></div>
                        }
                    </div>
                    <span class="story-label">@story.AuthorName</span>
                    <div class="story-time">@story.TimeRemaining</div>
                </div>
            }
        </div>
    </div>

    <!-- Feed Navigation -->
    <div class="feed-nav">
        <div class="nav-pills" role="tablist">
            <a class="nav-link @(feedType == "personalized" ? "active" : "")" href="?feedType=personalized">
                <i class="fas fa-home"></i> For You
            </a>
            <a class="nav-link @(feedType == "trending" ? "active" : "")" href="?feedType=trending">
                <i class="fas fa-fire"></i> Trending
            </a>
            <a class="nav-link @(feedType == "friends" ? "active" : "")" href="?feedType=friends">
                <i class="fas fa-users"></i> Friends
            </a>
        </div>
    </div>

    <!-- Create Post Section -->
    @if (currentUserId.HasValue)
    {
        <div class="create-post-card">
            <div class="content-section">
                <div class="flex items-center gap-3">
                    <div class="user-avatar">
                        <img src="/images/default-avatar.png" alt="Your Avatar" />
                    </div>
                    <input type="text" class="create-post-input" placeholder="What's on your mind about cars?" readonly onclick="openCreatePostModal()" />
                </div>
                <div class="create-post-actions">
                    <button class="btn" onclick="openCreatePostModal('photo')">
                        <i class="fas fa-camera text-success"></i> Photo
                    </button>
                    <button class="btn" onclick="openCreatePostModal('review')">
                        <i class="fas fa-star text-warning"></i> Review
                    </button>
                    <button class="btn" onclick="openCreatePostModal('question')">
                        <i class="fas fa-question-circle text-info"></i> Ask
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- Feed Items -->
    <div class="feed-items">
        @foreach (var item in Model.FeedItems)
        {
            <div class="feed-item" data-content-id="@item.Id" data-content-type="@item.ContentType">
                <!-- Post Header -->
                <div class="content-section">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="user-avatar">
                                <img src="@(item.AuthorAvatar ?? "/images/default-avatar.png")" alt="@item.AuthorName" />
                                @if (item.IsVerified)
                                {
                                    <i class="fas fa-check-circle verified-badge"></i>
                                }
                            </div>
                            <div>
                                <h6 class="text-base font-semibold">@item.AuthorName</h6>
                                <small class="text-muted">
                                    @item.TimeAgo
                                    @if (!string.IsNullOrEmpty(item.Location))
                                    {
                                        <span> • <i class="fas fa-map-marker-alt"></i> @item.Location</span>
                                    }
                                </small>
                                @if (!string.IsNullOrEmpty(item.ReasonForShowing))
                                {
                                    <div class="reason-badge">@item.ReasonForShowing</div>
                                }
                            </div>
                        </div>
                        <div class="custom-dropdown">
                            <button class="btn btn-ghost dropdown-toggle">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="bookmarkContent('@item.Id', '@item.ContentType')">
                                    <i class="fas fa-bookmark"></i> Save Post
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="hideContent('@item.Id')">
                                    <i class="fas fa-eye-slash"></i> Hide
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="reportContent('@item.Id', '@item.ContentType')">
                                    <i class="fas fa-flag"></i> Report
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Post Content -->
                <div class="content-section">
                    @if (!string.IsNullOrEmpty(item.Title))
                    {
                        <h5 class="text-lg font-semibold">@item.Title</h5>
                    }
                    
                    @if (!string.IsNullOrEmpty(item.Summary))
                    {
                        <p class="text-base">@item.Summary</p>
                    }
                    else if (!string.IsNullOrEmpty(item.Content))
                    {
                        <p class="text-base">@(item.Content.Length > 300 ? item.Content.Substring(0, 300) + "..." : item.Content)</p>
                    }

                    <!-- Car Information -->
                    @if (!string.IsNullOrEmpty(item.CarDisplayName))
                    {
                        <div class="car-info">
                            <i class="fas fa-car"></i> @item.CarDisplayName
                        </div>
                    }

                    <!-- Rating for Reviews -->
                    @if (item.Rating.HasValue)
                    {
                        <div class="rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="fas fa-star @(i <= item.Rating ? "text-warning" : "text-muted")"></i>
                            }
                            <span class="ml-2">@item.Rating.Value/5</span>
                        </div>
                    }

                    <!-- Tags -->
                    @if (item.Tags.Any())
                    {
                        <div class="tags">
                            @foreach (var tag in item.Tags.Take(5))
                            {
                                <span class="tag">#@tag</span>
                            }
                        </div>
                    }

                    <!-- Media -->
                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                    {
                        <div class="post-media">
                            <img src="@item.ImageUrl" alt="Post Image" class="gallery-image" onclick="openImageModal('@item.ImageUrl')" />
                        </div>
                    }
                    else if (item.ImageUrls.Any())
                    {
                        <div class="post-media">
                            <div class="image-gallery">
                                @foreach (var imageUrl in item.ImageUrls.Take(4))
                                {
                                    <img src="@imageUrl" alt="Post Image" class="gallery-image" onclick="openImageModal('@imageUrl')" />
                                }
                                @if (item.ImageUrls.Count() > 4)
                                {
                                    <div class="more-images">+@(item.ImageUrls.Count() - 4)</div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Engagement Stats -->
                    <div class="engagement-stats">
                        <div class="flex justify-between items-center">
                            <div class="stats-left">
                                @if (item.LikeCount > 0)
                                {
                                    <span class="stat-item">
                                        <i class="fas fa-heart text-danger"></i> @item.LikeCount
                                    </span>
                                }
                                @if (item.ViewCount > 0)
                                {
                                    <span class="stat-item">
                                        <i class="fas fa-eye text-muted"></i> @item.ViewCount
                                    </span>
                                }
                            </div>
                            <div class="stats-right">
                                @if (item.CommentCount > 0)
                                {
                                    <span class="stat-item">@item.CommentCount comments</span>
                                }
                                @if (item.ShareCount > 0)
                                {
                                    <span class="stat-item">@item.ShareCount shares</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Post Actions -->
                <div class="post-actions">
                    <button class="action-btn @(item.IsLikedByUser ? "liked" : "")" onclick="toggleLike('@item.Id', '@item.ContentType')">
                        <i class="fas fa-heart"></i> Like
                    </button>
                    <button class="action-btn" onclick="toggleComments('@item.Id')">
                        <i class="fas fa-comment"></i> Comment
                    </button>
                    <button class="action-btn" onclick="shareContent('@item.Id', '@item.ContentType')">
                        <i class="fas fa-share"></i> Share
                    </button>
                    <button class="action-btn @(item.IsBookmarkedByUser ? "bookmarked" : "")" onclick="bookmarkContent('@item.Id', '@item.ContentType')">
                        <i class="fas fa-bookmark"></i>
                    </button>
                </div>

                <!-- Comments Section (Initially Hidden) -->
                <div class="comments-section" id="comments-@item.Id" style="display: none;">
                    <div class="content-section">
                        <div class="comment-input">
                            <div class="flex gap-2">
                                <div class="user-avatar">
                                    <img src="/images/default-avatar.png" alt="Your Avatar" />
                                </div>
                                <input type="text" class="form-input" placeholder="Write a comment..." onkeypress="handleCommentSubmit(event, '@item.Id', '@item.ContentType')" />
                            </div>
                        </div>
                        <div class="comments-list">
                            <!-- Comments will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Load More Button -->
    @if (Model.HasMoreContent)
    {
        <div class="text-center">
            <button class="btn btn-primary" onclick="loadMoreContent()">
                <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                Load More Posts
            </button>
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/feed.js"></script>
    <script>
        // Initialize feed functionality
        $(document).ready(function() {
            initializeFeed();
            loadStoriesData();
            
            // Auto-refresh every 5 minutes
            setInterval(function() {
                refreshFeedStats();
            }, 300000);
        });
    </script>
}