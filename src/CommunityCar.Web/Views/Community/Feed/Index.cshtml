@using Microsoft.Extensions.Localization
@model CommunityCar.Application.Features.Community.Feed.ViewModels.FeedVM
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer ViewLocalizer
@{
    ViewData["Title"] = ViewLocalizer["PageTitle"];
    var feedType = ViewBag.FeedType as string ?? "personalized";
    var currentUserId = ViewBag.CurrentUserId as Guid?;
    
    // Get current culture for localization
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");
}

@* Anti-forgery token for AJAX requests *@
@Html.AntiForgeryToken()

<div class="max-w-6xl mx-auto  animate-in fade-in duration-700">
    <!-- Page Header with Backdrop Accent -->
    <div class="relative group">
        <div class="absolute -inset-1 bg-gradient-to-r from-primary/10 via-transparent to-primary/10 rounded-[2.5rem] blur-2xl opacity-0 group-hover:opacity-100 transition duration-1000"></div>
        <div class="relative flex flex-col md:flex-row md:items-center justify-between gap-8 p-2">
            <div>
                <h1 class="text-4xl md:text-5xl font-black text-foreground tracking-tighter leading-tight">@ViewLocalizer["FeedTitle"]</h1>
                <p class="text-[10px] font-black uppercase tracking-widest text-muted-foreground/60 mt-2">@ViewLocalizer["FeedSubtitle"]</p>
            </div>
            <div class="flex items-center gap-4">
                <button class="inline-flex items-center gap-3 px-8 py-4 bg-primary text-primary-foreground hover:bg-primary/90 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] transition-all shadow-xl shadow-primary/20 active:scale-95 group" onclick="openCreatePostModal()">
                    <i data-lucide="plus" class="w-4 h-4 group-hover:rotate-90 transition-transform"></i>
                    @ViewLocalizer["CreatePost"]
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced Stories Section -->
    <div class="bg-card/40 backdrop-blur-xl border border-border/50 rounded-[2.5rem] shadow-2xl overflow-hidden group/stories transition-all hover:border-primary/20">
        <div class="p-6 md:p-8 flex justify-between items-center border-b border-border/30">
            <div class="flex items-center gap-3">
                <div class="px-3 py-1 bg-primary/10 rounded-full text-primary text-[9px] font-black uppercase tracking-widest border border-primary/10">@ViewLocalizer["Live"]</div>
                <h5 class="text-xs font-black text-foreground uppercase tracking-[0.2em] opacity-70">@ViewLocalizer["Stories"]</h5>
            </div>
            <span class="text-[9px] font-black text-muted-foreground uppercase opacity-40 tracking-widest">@ViewLocalizer["ShareYourCarMoments"]</span>
        </div>
        
        <div class="p-6 md:p-8">
            <div class="flex gap-6 overflow-x-auto pb-6 pt-1 snap-x no-scrollbar" id="storiesContainer">
                <!-- Add Story Button -->
                <div class="flex-shrink-0 flex flex-col items-center gap-3 cursor-pointer group/add-story snap-start" onclick="openCreateStoryModal()">
                    <div class="w-16 h-16 rounded-2xl bg-muted/30 border-2 border-dashed border-border/50 group-hover/add-story:border-primary group-hover/add-story:bg-primary/5 transition-all flex items-center justify-center relative shadow-inner">
                        <i data-lucide="plus" class="w-6 h-6 text-muted-foreground group-hover/add-story:text-primary transition-all group-hover/add-story:scale-125"></i>
                    </div>
                    <span class="text-[9px] font-black text-muted-foreground uppercase tracking-widest group-hover/add-story:text-primary transition-colors opacity-60">@ViewLocalizer["Add"]</span>
                </div>

                <!-- Existing Stories -->
                @foreach (var story in Model.Stories.Take(10))
                {
                    <div class="flex-shrink-0 flex flex-col items-center gap-3 cursor-pointer group/story snap-start" onclick="openStoryViewer('@story.Id')">
                        <div class="w-16 h-16 rounded-2xl p-0.5 relative transition-all group-hover/story:scale-105 active:scale-95 shadow-lg shadow-black/5">
                            @if (!story.IsViewed)
                            {
                                <div class="absolute -inset-1 rounded-[1.25rem] bg-gradient-to-tr from-primary via-primary/50 to-primary/80 opacity-40 blur-sm group-hover:opacity-70 transition-opacity"></div>
                            }
                            <div class="w-full h-full rounded-2xl overflow-hidden border border-border/50 relative z-10 p-[1px] bg-background shadow-inner">
                                <img src="@(story.ThumbnailUrl ?? story.MediaUrl)" alt="@story.AuthorName" class="w-full h-full object-cover rounded-[14px] @(story.IsViewed ? "opacity-60 grayscale-[0.2]" : "")" />
                            </div>
                        </div>
                        <span class="text-[9px] font-black text-foreground/80 text-center truncate w-16 uppercase tracking-widest group-hover/story:text-primary transition-colors">@story.AuthorName.Split(' ')[0]</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Feed Navigation: Mirroring "Sorting Pulse" aesthetic -->
    <div class="flex justify-center mb-4">
        <div class="inline-flex items-center gap-4 bg-muted/30 backdrop-blur-md p-1.5 rounded-[1.5rem] border border-border/50 shadow-xl">
            <a class="inline-flex items-center gap-3 px-8 py-2.5 rounded-[1.25rem] text-[10px] font-black uppercase tracking-[0.15em] transition-all @(feedType == "personalized" ? "bg-background text-foreground shadow-lg border border-border" : "text-muted-foreground/60 hover:text-foreground hover:bg-muted/50")" 
               asp-controller="Feed" asp-action="Index" asp-route-culture="@currentCulture" asp-route-feedType="personalized">
                <i class="fas fa-home text-[9px]"></i> @ViewLocalizer["ForYou"]
            </a>
            <a class="inline-flex items-center gap-3 px-8 py-2.5 rounded-[1.25rem] text-[10px] font-black uppercase tracking-[0.15em] transition-all @(feedType == "trending" ? "bg-background text-foreground shadow-lg border border-border" : "text-muted-foreground/60 hover:text-foreground hover:bg-muted/50")" 
               asp-controller="Feed" asp-action="Trending" asp-route-culture="@currentCulture">
                <i class="fas fa-fire text-[9px]"></i> @ViewLocalizer["Trending"]
            </a>
            <a class="inline-flex items-center gap-3 px-8 py-2.5 rounded-[1.25rem] text-[10px] font-black uppercase tracking-[0.15em] transition-all @(feedType == "friends" ? "bg-background text-foreground shadow-lg border border-border" : "text-muted-foreground/60 hover:text-foreground hover:bg-muted/50")" 
               asp-controller="Feed" asp-action="Friends" asp-route-culture="@currentCulture">
                <i class="fas fa-users text-[9px]"></i> @ViewLocalizer["Friends"]
            </a>
        </div>
    </div>

    <!-- Create Post Section: Mirroring "Commit Response" aesthetic -->
    @if (currentUserId.HasValue)
    {
        <div class="bg-card/40 backdrop-blur-xl border border-border/50 rounded-[2.5rem] shadow-2xl p-8 md:p-10 transition-all hover:border-primary/30 group/create relative overflow-hidden">
            <div class="absolute -right-20 -top-20 w-80 h-80 bg-primary/5 rounded-full blur-3xl group-hover/create:bg-primary/10 transition-all duration-700"></div>
            
            <div class="relative flex items-center gap-6">
                <div class="w-12 h-12 rounded-2xl bg-muted border border-border/50 flex items-center justify-center overflow-hidden shadow-inner ring-2 ring-primary/10 group-hover/create:ring-primary/20 transition-all">
                    <img src="/images/default-avatar.png" alt="Your Avatar" class="w-full h-full object-cover" />
                </div>
                <div class="flex-1">
                    <button class="w-full bg-background/50 backdrop-blur-sm hover:bg-background/80 border border-border/50 hover:border-primary/30 transition-all rounded-2xl px-6 py-4 text-sm text-foreground/70 text-left font-medium focus:ring-2 focus:ring-primary/20 outline-none shadow-inner" onclick="openCreatePostModal()">
                        @ViewLocalizer["WhatsOnYourMind"]
                    </button>
                </div>
            </div>
            
            <div class="flex items-center gap-4 mt-8 pt-6 border-t border-border/30">
                <button class="flex-1 py-3 text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 hover:text-primary hover:bg-primary/5 rounded-xl transition-all flex items-center justify-center gap-3 group/btn" onclick="openCreatePostModal('photo')">
                    <i class="fas fa-camera text-green-500/80 group-hover/btn:scale-110 transition-transform"></i> @ViewLocalizer["Photo"]
                </button>
                <div class="w-px h-6 bg-border/30"></div>
                <button class="flex-1 py-3 text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 hover:text-primary hover:bg-primary/5 rounded-xl transition-all flex items-center justify-center gap-3 group/btn" onclick="openCreatePostModal('review')">
                    <i class="fas fa-star text-orange-400 group-hover/btn:scale-110 transition-transform"></i> @ViewLocalizer["Review"]
                </button>
                <div class="w-px h-6 bg-border/30"></div>
                <button class="flex-1 py-3 text-[9px] font-black uppercase tracking-widest text-muted-foreground/60 hover:text-primary hover:bg-primary/5 rounded-xl transition-all flex items-center justify-center gap-3 group/btn" onclick="openCreatePostModal('question')">
                    <i class="fas fa-question-circle text-blue-400 group-hover/btn:scale-110 transition-transform"></i> @ViewLocalizer["Ask"]
                </button>
            </div>
        </div>
    }

    <!-- Feed Items -->
    <div id="feed-skeleton" class="hidden space-y-12">
        <skeleton type="Post" />
        <skeleton type="Post" />
        <skeleton type="Post" />
    </div>

    <div class="flex flex-col gap-12" id="feed-container">
        @foreach (var item in Model.FeedItems.Take(20))
        {
            <div class="bg-card/40 backdrop-blur-xl border border-border/50 rounded-[2.5rem] shadow-2xl transition-all hover:shadow-primary/5 hover:border-primary/20 group/feed-item relative" data-content-id="@item.Id" data-content-type="@item.ContentType">
                <!-- Background Glow for Item -->
                <div class="absolute -inset-1 bg-gradient-to-r from-primary/5 via-transparent to-primary/5 rounded-[2.5rem] blur-2xl opacity-0 group-hover/feed-item:opacity-100 transition duration-1000"></div>

                <!-- Stats Numbers Overlaying Half Inside/Half Outside Card -->
                @await Html.PartialAsync("Components/_StatsOverlay", new CommunityCar.Application.Features.Shared.ViewModels.StatsOverlayVM
                {
                    EntityId = item.Id.ToString(),
                    EntityType = item.ContentType,
                    CommentCount = item.CommentCount,
                    LikeCount = item.LikeCount,
                    ViewCount = item.ViewCount,
                    ShareCount = item.ShareCount,
                    IsLikedByUser = item.IsLikedByUser
                })

                <!-- Post Header: Mirroring QA Header Layout -->
                <div class="p-8 md:p-10 pb-4 flex items-start justify-between relative z-10">
                    <div class="flex items-center gap-5">
                        @if (item.AuthorId != Guid.Empty)
                        {
                            <a asp-controller="Profile" asp-action="ViewProfile" asp-route-id="@item.AuthorId" asp-route-culture="@currentCulture" class="w-12 h-12 rounded-2xl bg-muted border border-border/50 flex items-center justify-center overflow-hidden shadow-inner ring-2 ring-primary/5 group-hover/feed-item:ring-primary/20 transition-all group/avatar cursor-pointer block">
                                <img src="@(item.AuthorAvatar ?? "/images/default-avatar.png")" alt="@item.AuthorName" class="w-full h-full object-cover transition-transform group-hover/avatar:scale-110" />
                                @if (item.IsVerified)
                                {
                                    <div class="absolute -bottom-1 -right-1 bg-white dark:bg-slate-900 rounded-full p-[2px] shadow-sm transform group-hover/avatar:scale-110 transition-transform">
                                        <i class="fas fa-check-circle text-blue-500 text-[10px]"></i>
                                    </div>
                                }
                            </a>
                        }
                        else
                        {
                            <div class="w-12 h-12 rounded-2xl bg-muted border border-border/50 flex items-center justify-center overflow-hidden shadow-inner ring-2 ring-primary/5 transition-all group/avatar block">
                                <img src="@(item.AuthorAvatar ?? "/images/default-avatar.png")" alt="@item.AuthorName" class="w-full h-full object-cover" />
                            </div>
                        }
                        <div class="flex flex-col gap-0.5">
                            <div class="flex items-center gap-3">
                                @if (item.AuthorId != Guid.Empty)
                                {
                                    <a asp-controller="Profile" asp-action="ViewProfile" asp-route-id="@item.AuthorId" asp-route-culture="@currentCulture" class="text-sm font-black text-foreground m-0 hover:text-primary transition-colors cursor-pointer block tracking-tight">@item.AuthorName</a>
                                }
                                else
                                {
                                    <h6 class="text-sm font-black text-foreground m-0 tracking-tight">@item.AuthorName</h6>
                                }
                                @if (!string.IsNullOrEmpty(item.ReasonForShowing))
                                {
                                    <span class="px-2 py-0.5 rounded-full text-[8px] font-black bg-primary/10 text-primary uppercase tracking-widest border border-primary/10">@item.ReasonForShowing</span>
                                }
                            </div>
                            <div class="flex items-center gap-2 text-[9px] font-black uppercase tracking-widest text-muted-foreground opacity-60">
                                <span>@item.TimeAgo</span>
                                @if (!string.IsNullOrEmpty(item.Location))
                                {
                                    <span class="opacity-20">ï¿½</span>
                                    <span class="flex items-center gap-1.5"><i data-lucide="map-pin" class="w-3 h-3"></i> @item.Location</span>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative group/menu">
                        <button class="w-10 h-10 flex items-center justify-center rounded-xl bg-muted/20 border border-border/50 text-muted-foreground hover:bg-muted/40 hover:text-foreground transition-all focus:outline-none">
                            <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                        </button>
                        <div class="absolute right-0 rtl:left-0 rtl:right-auto mt-2 w-52 bg-popover/90 backdrop-blur-xl border border-border/50 rounded-2xl shadow-2xl z-50 py-2 hidden group-focus-within/menu:block transform origin-top-right rtl:origin-top-left transition-all animate-in zoom-in-95 duration-200">
                            <a class="flex items-center gap-3 px-4 py-3 text-[10px] font-black uppercase tracking-widest text-foreground hover:bg-primary hover:text-primary-foreground transition-all mx-1 rounded-xl" href="#" onclick="bookmarkContent('@item.Id', '@item.ContentType', event)">
                                <i data-lucide="bookmark" class="w-4 h-4"></i> @ViewLocalizer["SavePost"]
                            </a>
                            <a class="flex items-center gap-3 px-4 py-3 text-[10px] font-black uppercase tracking-widest text-foreground hover:bg-muted transition-all mx-1 rounded-xl" href="#" onclick="hideContent('@item.Id')">
                                <i data-lucide="eye-off" class="w-4 h-4"></i> @ViewLocalizer["Hide"]
                            </a>
                            <div class="mx-4 my-2 h-px bg-border/40"></div>
                            <a class="flex items-center gap-3 px-4 py-3 text-[10px] font-black uppercase tracking-widest text-destructive hover:bg-destructive/10 transition-all mx-1 rounded-xl" href="#" onclick="reportContent('@item.Id', '@item.ContentType')">
                                <i data-lucide="flag" class="w-4 h-4"></i> @ViewLocalizer["Report"]
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Post Content -->
                <div class="p-8 md:p-10 pt-2 relative z-10">
                    <div class="space-y-4 mb-8">
                        @{
                            var displayTitle = isArabic && !string.IsNullOrEmpty(item.TitleAr) ? item.TitleAr : item.Title;
                            var displayContent = isArabic && !string.IsNullOrEmpty(item.ContentAr) ? item.ContentAr : item.Content;
                            var displaySummary = isArabic && !string.IsNullOrEmpty(item.SummaryAr) ? item.SummaryAr : item.Summary;
                        }

                        @if (!string.IsNullOrEmpty(displayTitle))
                        {
                            <h5 class="text-2xl md:text-3xl font-black text-foreground tracking-tighter leading-tight decoration-primary/20 decoration-4 underline-offset-8">@displayTitle</h5>
                        }
                        
                        @if (!string.IsNullOrEmpty(displaySummary) || !string.IsNullOrEmpty(displayContent))
                        {
                            <div class="prose prose-sm dark:prose-invert max-w-none text-foreground/80 leading-relaxed font-medium">
                                @(string.IsNullOrEmpty(displaySummary) ? (displayContent.Length > 280 ? displayContent.Substring(0, 280) + "..." : displayContent) : displaySummary)
                                @if (displayContent?.Length > 280)
                                {
                                    <button class="text-primary font-black ml-2 hover:underline text-[10px] uppercase tracking-widest" onclick="window.location.href='/@currentCulture/posts/@item.Id'">@ViewLocalizer["ReadMore"]</button>
                                }
                            </div>
                        }
                    </div>

                    <!-- Enhanced Meta Info Row: Mirroring QA Badge Styles -->
                    <div class="flex flex-wrap items-center gap-4 mb-8">
                        @if (!string.IsNullOrEmpty(item.CarDisplayName))
                        {
                            <div class="inline-flex items-center gap-3 px-4 py-2 bg-primary/[0.03] border border-primary/10 rounded-xl shadow-inner">
                                <i data-lucide="car-front" class="w-3.5 h-3.5 text-primary/60"></i>
                                <span class="text-[9px] font-black uppercase tracking-[0.1em] text-foreground">@item.CarDisplayName</span>
                            </div>
                        }

                        @if (item.Rating.HasValue)
                        {
                            <div class="inline-flex items-center gap-2 px-4 py-2 bg-orange-500/5 border border-orange-500/10 rounded-xl">
                                <div class="flex items-center text-orange-400">
                                    <i data-lucide="star" class="w-3.5 h-3.5 fill-current"></i>
                                </div>
                                <span class="text-[9px] font-black uppercase tracking-widest text-orange-600 dark:text-orange-400">@item.Rating.Value.ToString("F1") / 5.0</span>
                            </div>
                        }
                    </div>

                    <!-- Media Display -->
                    @if (!string.IsNullOrEmpty(item.ImageUrl) || item.ImageUrls.Any())
                    {
                        <div class="rounded-[2rem] overflow-hidden mb-8 border border-border/50 shadow-inner group/media relative">
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="@item.ImageUrl" alt="Post Image" class="w-full h-auto object-cover max-h-[600px] transition-all duration-1000 group-hover/media:scale-105 cursor-zoom-in" onclick="openImageModal('@item.ImageUrl')" />
                            }
                            else
                            {
                                <div class="grid grid-cols-2 gap-2 bg-muted/20">
                                    @foreach (var imageUrl in item.ImageUrls.Take(4))
                                    {
                                        <div class="h-64 overflow-hidden relative">
                                            <img src="@imageUrl" alt="Post Image" class="w-full h-full object-cover transition-all duration-1000 group-hover/media:scale-110 cursor-zoom-in" onclick="openImageModal('@imageUrl')" />
                                        </div>
                                    }
                                </div>
                                @if (item.ImageUrls.Count() > 4)
                                {
                                    <div class="absolute bottom-6 right-6 bg-background/80 backdrop-blur-xl px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest ring-1 ring-border/50 shadow-2xl">
                                        +@(item.ImageUrls.Count() - 4) @ViewLocalizer["More"]
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- Tags: Mirroring QA Tag Style -->
                    @if (item.Tags.Any())
                    {
                        <div class="flex flex-wrap gap-4 mb-6">
                            @foreach (var tag in item.Tags.Take(6))
                            {
                                <a asp-controller="Feed" asp-action="Trending" asp-route-culture="@currentCulture" asp-route-topic="@tag" class="text-[9px] font-black uppercase tracking-widest text-primary/40 hover:text-primary transition-all cursor-pointer decoration-0">#@tag</a>
                            }
                        </div>
                    }
                </div>

                <!-- Action Toolbar: Subtle Border Top -->
                <div class="border-t border-border/30">
                    @await Html.PartialAsync("Components/_ActionToolbar", new CommunityCar.Application.Features.Shared.ViewModels.ActionToolbarVM
                    {
                        EntityId = item.Id.ToString(),
                        EntityType = item.ContentType,
                        IsLikedByUser = item.IsLikedByUser,
                        IsBookmarkedByUser = item.IsBookmarkedByUser
                    })
                </div>

                <!-- Comments Section -->
                @{
                    ViewBag.EntityId = item.Id;
                    ViewBag.EntityType = item.ContentType;
                    ViewBag.CommentCount = item.CommentCount;
                }
                <div class="bg-muted/10">
                    @await Html.PartialAsync("Comments/Index", item.InitialComments)
                </div>
            </div>
        }
    </div>

    <!-- Infinite Scroll Trigger -->
    @if (Model.HasMoreContent)
    {
        <div class="py-16 text-center">
            <button class="inline-flex items-center gap-4 bg-card/40 backdrop-blur-xl border border-border/50 px-10 py-4 rounded-[2rem] text-[10px] font-black uppercase tracking-[0.2em] text-foreground hover:bg-primary hover:text-primary-foreground hover:border-primary transition-all shadow-2xl shadow-black/5 group" onclick="loadMoreFeedContent()">
                <i data-lucide="plus-circle" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-700"></i>
                @ViewLocalizer["LoadMorePosts"]
            </button>
        </div>
    }

    <!-- Skeleton Loading Template (Hidden by default) -->
    <div id="skeleton-template" class="hidden">
        <partial name="_SkeletonLoading" model='"Post"' />
    </div>
</div>

<!-- Conversion of Modals should happen in layout or partials if they are shared, but here is the content -->
<!-- I will omit the heavy Bootstrap HTML for modals and use Tailwind analogs -->

@section Scripts {

    <script src="~/js/feed.js"></script>
    <script src="~/js/stories.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof $ !== 'undefined') {
                $(document).ready(function() {
                    if (typeof Skeleton !== 'undefined') Skeleton.initPageLoad('feed-skeleton', 'feed-container');
                    if (typeof initializeFeed === 'function') initializeFeed();
                    if (typeof initializeStories === 'function') initializeStories();
                });
            } else {
                if (typeof Skeleton !== 'undefined') Skeleton.initPageLoad('feed-skeleton', 'feed-container');
                if (typeof initializeFeed === 'function') initializeFeed();
                if (typeof initializeStories === 'function') initializeStories();
            }
        });
    </script>
}

@section SidebarRight {
    <partial name="~/Views/Community/_CommunitySidebar.cshtml" />
}