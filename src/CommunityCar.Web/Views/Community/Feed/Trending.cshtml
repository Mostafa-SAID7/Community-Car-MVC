@using Microsoft.Extensions.Localization
@model CommunityCar.Application.Features.Community.Feed.ViewModels.FeedVM
@inject IViewLocalizer Localizer
@inject IStringLocalizer<SharedResource> SharedLocalizer
@{
    ViewData["Title"] = Localizer["TrendingTitle"];
    var currentUserId = ViewBag.CurrentUserId as Guid?;

    // Get current culture for localization
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");
}

<div class="space-y-10 animate-in fade-in duration-700">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <h1 class="text-3xl font-black text-foreground tracking-tight">@Localizer["TrendingTitle"]</h1>
            <p class="text-sm text-muted-foreground font-medium opacity-70 mt-1">@Localizer["TrendingSubtitle"]</p>
        </div>
        <div class="flex items-center gap-3">
            <button class="inline-flex items-center gap-2.5 px-8 py-3 bg-primary text-primary-foreground hover:bg-primary/90 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-primary/20 active:scale-95 group" onclick="openCreatePostModal()">
                <i data-lucide="plus" class="w-4 h-4 group-hover:scale-125 transition-transform"></i>
                @Localizer["CreatePost"]
            </button>
        </div>
    </div>

    <!-- Feed Navigation -->
    <div class="flex justify-center mb-12">
        <div class="inline-flex gap-1 p-1 bg-muted/40 backdrop-blur-sm rounded-xl border border-border/50 shadow-sm">
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all text-muted-foreground hover:text-foreground hover:bg-muted/30" asp-controller="Feed" asp-action="Index" asp-route-culture="@System.Globalization.CultureInfo.CurrentCulture.Name">
                <i class="fas fa-home text-[10px]"></i> @Localizer["ForYou"]
            </a>
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all bg-background text-foreground shadow-md ring-1 ring-border" href="/feed/trending">
                <i class="fas fa-fire text-[10px]"></i> @Localizer["Trending"]
            </a>
            <a class="inline-flex items-center gap-2 px-6 py-2 rounded-lg text-sm font-black transition-all text-muted-foreground hover:text-foreground hover:bg-muted/30" href="/feed/friends">
                <i class="fas fa-users text-[10px]"></i> @Localizer["Friends"]
            </a>
        </div>
    </div>

    <!-- Trending Topics Section -->
    @if (Model.TrendingTopics?.Any() == true)
    {
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl mb-12 overflow-hidden">
            <div class="p-6 border-b border-border/50">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-orange-500/10 rounded-lg">
                        <i data-lucide="trending-up" class="w-5 h-5 text-orange-500"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-black text-foreground">@Localizer["HotTopics"]</h2>
                        <p class="text-xs text-muted-foreground font-medium">@Localizer["MostDiscussedTopics"]</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    @foreach (var topic in Model.TrendingTopics.Take(9))
                    {
                        var displayTopic = isArabic && !string.IsNullOrEmpty(topic.TopicAr) ? topic.TopicAr : topic.Topic;
                        var displayReason = isArabic && !string.IsNullOrEmpty(topic.TrendingReason) ? topic.TrendingReason : topic.TrendingReason; // TODO: Localize reasons if needed

                        <div class="group p-4 bg-muted/20 hover:bg-muted/40 rounded-xl border border-border/30 hover:border-primary/30 transition-all cursor-pointer" onclick="filterByTopic('@topic.Topic')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="text-lg font-black text-primary">#@displayTopic</span>
                                    <div class="px-2 py-0.5 bg-orange-500/10 text-orange-600 text-[8px] font-black uppercase rounded-full">
                                        @displayReason
                                    </div>
                                </div>
                                <i data-lucide="arrow-up-right" class="w-4 h-4 text-muted-foreground group-hover:text-primary transition-colors"></i>
                            </div>
                            <div class="space-y-1">
                                <div class="text-sm font-bold text-foreground">@topic.PostCount @SharedLocalizer["Posts"]</div>
                                <div class="text-xs text-muted-foreground">@topic.TimeAgo</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Create Post Section -->
    @if (currentUserId.HasValue)
    {
        <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl shadow-lg mb-12 p-6 transition-all hover:border-primary/30 group/create">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full overflow-hidden ring-2 ring-primary/10 group-hover/create:ring-primary/30 transition-all shadow-inner">
                    <img src="/images/default-avatar.png" alt="Your Avatar" class="w-full h-full object-cover" />
                </div>
                <div class="flex-1">
                    <button class="w-full bg-muted/30 hover:bg-muted/50 border border-transparent hover:border-border transition-all rounded-full px-5 py-2.5 text-sm text-muted-foreground text-left font-medium focus:ring-2 focus:ring-primary/20 outline-none" onclick="openCreatePostModal()">
                        @Localizer["WhatsOnYourMind"]
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-1 mt-5 pt-2 border-t border-border/40">
                <button class="flex-1 py-2 text-xs font-bold text-muted-foreground hover:text-foreground hover:bg-muted/30 rounded-lg transition-all flex items-center justify-center gap-2 group/btn" onclick="openCreatePostModal('photo')">
                    <i class="fas fa-camera text-green-500 group-hover/btn:scale-110 transition-transform"></i> @Localizer["Photo"]
                </button>
                <div class="w-px h-4 bg-border/40"></div>
                <button class="flex-1 py-2 text-xs font-bold text-muted-foreground hover:text-foreground hover:bg-muted/30 rounded-lg transition-all flex items-center justify-center gap-2 group/btn" onclick="openCreatePostModal('review')">
                    <i class="fas fa-star text-orange-400 group-hover/btn:scale-110 transition-transform"></i> @Localizer["Review"]
                </button>
                <div class="w-px h-4 bg-border/40"></div>
                <button class="flex-1 py-2 text-xs font-bold text-muted-foreground hover:text-foreground hover:bg-muted/30 rounded-lg transition-all flex items-center justify-center gap-2 group/btn" onclick="openCreatePostModal('question')">
                    <i class="fas fa-question-circle text-blue-400 group-hover/btn:scale-110 transition-transform"></i> @Localizer["Ask"]
                </button>
            </div>
        </div>
    }

    <!-- Items Skeleton -->
    <div id="trending-skeleton" class="hidden space-y-12">
        <skeleton type="Post" />
        <skeleton type="Post" />
        <skeleton type="Post" />
    </div>

    <!-- Trending Feed Items -->
    <div class="flex flex-col gap-12" id="trending-feed-container">
        @foreach (var item in Model.FeedItems.Take(20))
        {
            <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden transition-all hover:shadow-2xl hover:border-primary/10 group/feed-item" data-content-id="@item.Id" data-content-type="@item.ContentType">
                <!-- Post Header -->
                <div class="p-5 pb-3 flex items-start justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-11 h-11 rounded-full relative ring-2 ring-primary/5 group-hover/feed-item:ring-primary/20 transition-all shadow-inner group/avatar cursor-pointer">
                            <img src="@(item.AuthorAvatar ?? "/images/default-avatar.png")" alt="@item.AuthorName" class="w-full h-full object-cover rounded-full" />
                            @if (item.IsVerified)
                            {
                                <div class="absolute -bottom-1 -right-1 bg-white dark:bg-slate-900 rounded-full p-[2px] shadow-sm transform group-hover/avatar:scale-110 transition-transform">
                                    <i class="fas fa-check-circle text-blue-500 text-[10px]"></i>
                                </div>
                            }
                        </div>
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2">
                                <h6 class="text-sm font-black text-foreground m-0 hover:text-primary transition-colors cursor-pointer">@item.AuthorName</h6>
                                <span class="px-1.5 py-0.5 rounded-full text-[8px] font-black bg-orange-500/10 text-orange-600 uppercase tracking-tighter">@Localizer["Trending"]</span>
                            </div>
                            <div class="flex items-center gap-2 text-[10px] font-bold text-muted-foreground uppercase opacity-70">
                                <span>@item.TimeAgo</span>
                                @if (!string.IsNullOrEmpty(item.Location))
                                {
                                    <span class="opacity-50">•</span>
                                    <span class="flex items-center gap-1"><i class="fas fa-map-marker-alt text-[8px]"></i> @item.Location</span>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative group/menu">
                        <button class="p-2 text-muted-foreground hover:bg-muted/50 rounded-full transition-all focus:outline-none">
                            <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                        </button>
                        <div class="absolute right-0 mt-1 w-48 bg-popover/90 backdrop-blur-lg border border-border rounded-xl shadow-2xl z-50 py-2 hidden group-focus-within/menu:block transform origin-top-right transition-all">
                            <a class="flex items-center gap-3 px-4 py-2.5 text-sm font-bold text-foreground hover:bg-primary hover:text-primary-foreground transition-all mx-1 rounded-lg" href="#" onclick="bookmarkContent('@item.Id', '@item.ContentType', event)">
                                <i data-lucide="bookmark" class="w-4 h-4"></i> @Localizer["SavePost"]
                            </a>
                            <a class="flex items-center gap-3 px-4 py-2.5 text-sm font-bold text-foreground hover:bg-muted transition-all mx-1 rounded-lg" href="#" onclick="hideContent('@item.Id')">
                                <i data-lucide="eye-off" class="w-4 h-4"></i> @Localizer["Hide"]
                            </a>
                            <div class="mx-4 my-2 h-px bg-border/40"></div>
                            <a class="flex items-center gap-3 px-4 py-2.5 text-sm font-bold text-destructive hover:bg-destructive/10 transition-all mx-1 rounded-lg" href="#" onclick="reportContent('@item.Id', '@item.ContentType')">
                                <i data-lucide="flag" class="w-4 h-4"></i> @Localizer["Report"]
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Post Content -->
                <div class="p-5 pt-0">
                    <div class="space-y-3 mb-5">
                        @{
                            var displayTitle = isArabic && !string.IsNullOrEmpty(item.TitleAr) ? item.TitleAr : item.Title;
                            var displayContent = isArabic && !string.IsNullOrEmpty(item.ContentAr) ? item.ContentAr : item.Content;
                            var displaySummary = isArabic && !string.IsNullOrEmpty(item.SummaryAr) ? item.SummaryAr : item.Summary;
                        }

                        @if (!string.IsNullOrEmpty(displayTitle))
                        {
                            <h5 class="text-xl font-black text-foreground tracking-tight leading-tight">@displayTitle</h5>
                        }
                        
                        @if (!string.IsNullOrEmpty(displaySummary) || !string.IsNullOrEmpty(displayContent))
                        {
                            <p class="text-[15px] text-foreground/90 leading-relaxed font-medium">
                                @(string.IsNullOrEmpty(displaySummary) ? (displayContent.Length > 280 ? displayContent.Substring(0, 280) + "..." : displayContent) : displaySummary)
                                @if (displayContent?.Length > 280)
                                {
                                    <button class="text-primary font-black ml-1 hover:underline text-xs" onclick="window.location.href='/posts/@item.Id'">@Localizer["ReadMore"]</button>
                                }
                            </p>
                        }
                    </div>

                    <!-- Enhanced Meta Info Row -->
                    <div class="flex flex-wrap items-center gap-3 mb-5">
                        @if (!string.IsNullOrEmpty(item.CarDisplayName))
                        {
                            <div class="inline-flex items-center gap-2 bg-primary/10 px-3 py-1.5 rounded-lg text-[10px] font-black text-primary border border-primary/20 shadow-sm uppercase tracking-wider">
                                <i class="fas fa-car text-[10px]"></i> @item.CarDisplayName
                            </div>
                        }

                        @if (item.Rating.HasValue)
                        {
                            <div class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-orange-500/10 border border-orange-500/20">
                                <div class="flex items-center text-orange-400">
                                    <i data-lucide="star" class="w-3.5 h-3.5 fill-current"></i>
                                </div>
                                <span class="text-[10px] font-black text-orange-600 dark:text-orange-400">@item.Rating.Value.ToString("F1") / 5.0</span>
                            </div>
                        }
                    </div>

                    <!-- Media Display -->
                    @if (!string.IsNullOrEmpty(item.ImageUrl) || item.ImageUrls.Any())
                    {
                        <div class="rounded-2xl overflow-hidden mb-5 border border-border/50 shadow-inner group/media relative">
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="@item.ImageUrl" alt="Post Image" class="w-full h-auto object-cover max-h-[500px] transition-all duration-700 group-hover/media:scale-105 cursor-zoom-in" onclick="openImageModal('@item.ImageUrl')" />
                            }
                            else
                            {
                                <div class="grid grid-cols-2 gap-1 bg-muted/20">
                                    @foreach (var imageUrl in item.ImageUrls.Take(4))
                                    {
                                        <div class="h-48 overflow-hidden">
                                            <img src="@imageUrl" alt="Post Image" class="w-full h-full object-cover transition-all duration-700 group-hover/media:scale-110 cursor-zoom-in" onclick="openImageModal('@imageUrl')" />
                                        </div>
                                    }
                                </div>
                                @if (item.ImageUrls.Count() > 4)
                                {
                                    <div class="absolute bottom-4 right-4 bg-background/80 backdrop-blur-md px-4 py-2 rounded-xl text-xs font-black ring-1 ring-border shadow-2xl">
                                        +@(item.ImageUrls.Count() - 4) @Localizer["More"]
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- Tags -->
                    @if (item.Tags.Any())
                    {
                        <div class="flex flex-wrap gap-2 mb-6 opacity-80">
                            @foreach (var tag in item.Tags.Take(6))
                            {
                                <span class="text-[10px] font-black text-primary bg-primary/5 px-2.5 py-1 rounded-full border border-primary/20 uppercase tracking-widest hover:bg-primary/10 transition-colors cursor-pointer">#@tag</span>
                            }
                        </div>
                    }

                    <!-- Stats Bar -->
                    <div class="flex items-center justify-between pt-4 border-t border-border/40">
                        <div class="flex gap-4">
                            @if (item.LikeCount > 0)
                            {
                                <div class="flex items-center gap-1.5 text-[11px] font-black text-muted-foreground uppercase tracking-widest">
                                    <div class="p-1 bg-destructive/10 rounded-full">
                                        <i data-lucide="heart" class="w-3 h-3 text-destructive fill-destructive"></i>
                                    </div>
                                    @item.LikeCount
                                </div>
                            }
                            @if (item.ViewCount > 0)
                            {
                                <div class="flex items-center gap-1.5 text-[11px] font-black text-muted-foreground uppercase tracking-widest">
                                    <i data-lucide="eye" class="w-3.5 h-3.5"></i>
                                    @item.ViewCount
                                </div>
                            }
                        </div>
                        <div class="flex gap-4 text-[10px] font-black text-muted-foreground uppercase tracking-widest opacity-60">
                            @if (item.CommentCount > 0)
                            {
                                <span>@item.CommentCount @Localizer["Comments"]</span>
                            }
                            @if (item.CommentCount > 0 && item.ShareCount > 0)
                            {
                                <span class="opacity-30">•</span>
                            }
                            @if (item.ShareCount > 0)
                            {
                                <span>@item.ShareCount @Localizer["Shares"]</span>
                            }
                        </div>
                    </div>
                </div>

                <!-- Action Toolbar -->
                <div class="flex p-2 bg-muted/10 border-t border-border/40 gap-1 mt-auto">
                    <button class="flex-1 py-3 text-xs font-black rounded-xl transition-all flex items-center justify-center gap-2 group/btn @(item.IsLikedByUser ? "text-destructive bg-destructive/5" : "text-muted-foreground hover:bg-muted/30 hover:text-foreground")" onclick="toggleLike('@item.Id', '@item.ContentType', event)">
                        <i data-lucide="heart" class="w-5 h-5 group-hover/btn:scale-125 transition-all @(item.IsLikedByUser ? "fill-current" : "")"></i> @Localizer["Like"]
                    </button>
                    <button class="flex-1 py-3 text-xs font-black text-muted-foreground hover:text-foreground hover:bg-muted/30 rounded-xl transition-all flex items-center justify-center gap-2 group/btn" onclick="toggleComments('@item.Id')">
                        <i data-lucide="message-circle" class="w-5 h-5 group-hover/btn:scale-125 transition-all"></i> @Localizer["Comment"]
                    </button>
                    <button class="flex-1 py-3 text-xs font-black text-muted-foreground hover:text-foreground hover:bg-muted/30 rounded-xl transition-all flex items-center justify-center gap-2 group/btn" onclick="shareContent('@item.Id', '@item.ContentType')">
                        <i data-lucide="share-2" class="w-5 h-5 group-hover/btn:scale-125 transition-all"></i> @Localizer["Share"]
                    </button>
                    <button class="w-12 h-12 flex items-center justify-center text-muted-foreground hover:text-yellow-500 hover:bg-yellow-500/5 rounded-xl transition-all group/bookmark @(item.IsBookmarkedByUser ? "text-yellow-500 bg-yellow-500/5 shadow-inner" : "")" onclick="bookmarkContent('@item.Id', '@item.ContentType', event)">
                        <i data-lucide="bookmark" class="w-5 h-5 group-hover/bookmark:scale-125 transition-all @(item.IsBookmarkedByUser ? "fill-current" : "")"></i>
                    </button>
                </div>

                <!-- Comments Dropdown -->
                <div class="hidden px-5 py-4 border-t border-border/40 bg-muted/10 animate-in slide-in-from-top-2 duration-300" id="comments-@item.Id">
                    <div class="flex gap-3 mb-6">
                        <div class="w-9 h-9 rounded-full overflow-hidden shrink-0 ring-2 ring-border">
                            <img src="/images/default-avatar.png" alt="Your Avatar" class="w-full h-full object-cover" />
                        </div>
                        <div class="flex-1 relative">
                            <input type="text" class="w-full bg-background border border-border rounded-full pl-4 pr-12 py-2 text-sm font-medium focus:ring-4 focus:ring-primary/10 transition-all outline-none" placeholder="@Localizer["WriteComment"]" onkeypress="handleCommentSubmit(event, '@item.Id', '@item.ContentType')" />
                            <button class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-primary hover:scale-110 transition-transform">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="comments-list space-y-4">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Load More with Skeleton Loading -->
    @if (Model.HasMoreContent)
    {
        <div class="py-12 text-center">
            <button class="inline-flex items-center gap-3 bg-card border border-border px-8 py-3 rounded-2xl text-sm font-black text-foreground hover:bg-primary hover:text-primary-foreground hover:border-primary transition-all shadow-xl shadow-black/5 group" onclick="loadMoreTrendingContent()">
                <i data-lucide="plus-circle" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-500"></i>
                @Localizer["LoadMorePosts"]
            </button>
        </div>
    }

    <!-- Skeleton Loading Template (Hidden by default) -->
    <div id="skeleton-template" class="hidden">
        <div class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-xl overflow-hidden animate-pulse">
            <div class="p-5 pb-3 flex items-start gap-4">
                <div class="w-11 h-11 rounded-full bg-muted"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-muted rounded w-1/4"></div>
                    <div class="h-3 bg-muted rounded w-1/6"></div>
                </div>
            </div>
            <div class="p-5 pt-0 space-y-4">
                <div class="h-6 bg-muted rounded w-3/4"></div>
                <div class="space-y-2">
                    <div class="h-4 bg-muted rounded"></div>
                    <div class="h-4 bg-muted rounded w-5/6"></div>
                </div>
                <div class="h-48 bg-muted rounded-xl"></div>
            </div>
            <div class="flex p-2 bg-muted/10 border-t border-border/40 gap-1">
                <div class="flex-1 h-12 bg-muted/50 rounded-xl"></div>
                <div class="flex-1 h-12 bg-muted/50 rounded-xl"></div>
                <div class="flex-1 h-12 bg-muted/50 rounded-xl"></div>
                <div class="w-12 h-12 bg-muted/50 rounded-xl"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script src="~/js/feed.js"></script>
    <script>
        $(document).ready(function() {
            Skeleton.initPageLoad('trending-skeleton', 'trending-feed-container');
            initializeTrendingFeed();
            
            setInterval(function() {
                refreshFeedStats();
            }, 300000);
        });

        function initializeTrendingFeed() {
            feedType = 'trending';
            observePostVisibility();
        }

        function loadMoreTrendingContent() {
            if (isLoading) return;
            
            isLoading = true;
            const loadButton = event.target.closest('button');
            const originalContent = loadButton.innerHTML;
            
            // Show loading state
            loadButton.innerHTML = `<i class="fas fa-spinner fa-spin w-5 h-5"></i> ${window.feedLocalizer?.Loading || 'Loading...'}`;
            loadButton.disabled = true;
            
            // Show skeleton loading
            showSkeletonLoading(10);
            
            currentPage++;
            
            fetch(`/feed/trending?page=${currentPage}&pageSize=10`)
                .then(response => response.text())
                .then(html => {
                    // Parse the HTML to extract feed items
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newItems = doc.querySelectorAll('[data-content-id]');
                    
                    // Remove skeleton loading
                    removeSkeletonLoading();
                    
                    // Append new items
                    const container = document.getElementById('trending-feed-container');
                    newItems.forEach(item => {
                        container.appendChild(item.cloneNode(true));
                    });
                    
                    // Check if there are more items
                    const hasMore = doc.querySelector('.py-12.text-center button');
                    if (!hasMore) {
                        loadButton.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading more content:', error);
                    currentPage--; // Revert page increment on error
                    removeSkeletonLoading();
                })
                .finally(() => {
                    isLoading = false;
                    loadButton.innerHTML = originalContent;
                    loadButton.disabled = false;
                });
        }

        function showSkeletonLoading(count) {
            const container = document.getElementById('trending-feed-container');
            const template = document.getElementById('skeleton-template');
            
            for (let i = 0; i < count; i++) {
                const skeleton = template.cloneNode(true);
                skeleton.id = `skeleton-${i}`;
                skeleton.classList.remove('hidden');
                skeleton.classList.add('skeleton-item');
                container.appendChild(skeleton);
            }
        }

        function removeSkeletonLoading() {
            document.querySelectorAll('.skeleton-item').forEach(skeleton => {
                skeleton.remove();
            });
        }

        function filterByTopic(topic) {
            window.location.href = `/feed/trending?topic=${encodeURIComponent(topic)}`;
        }
    </script>
}