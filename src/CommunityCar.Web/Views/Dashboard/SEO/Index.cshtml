@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["SearchOptimization"];
    ViewData["UseModernTheme"] = true;
}

<div class="animate-slide-up">
    <!-- Top Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="page-title mb-2">Search Optimization</h1>
            <p class="text-muted fw-medium">Protocol health and visibility metrics</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <a href="/SEO/Sitemap" class="btn-icon-modern" title="@Localizer["Sitemap"]" target="_blank">
                <i data-lucide="map" class="w-4 h-4"></i>
            </a>
            <a href="/SEO/RSS" class="btn-icon-modern" title="@Localizer["RSSFeed"]" target="_blank">
                <i data-lucide="rss" class="w-4 h-4"></i>
            </a>
            <button type="button" class="btn-modern-primary ms-2" data-action="analyze-page">
                <i data-lucide="refresh-cw" class="w-4 h-4 me-2"></i>
                Run Audit
            </button>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <!-- Health Score -->
        <div class="col-12 col-xl-4">
            <div class="card-modern d-flex flex-column align-items-center justify-content-center py-5">
                <p class="modern-label mb-4">GLOBAL HEALTH SCORE</p>
                <div class="modern-circular-progress mb-4">
                    <svg viewBox="0 0 100 100" class="w-100 h-100">
                        <circle class="bg-circle" cx="50" cy="50" r="42" />
                        <circle class="fg-circle" cx="50" cy="50" r="42" 
                                style="stroke-dasharray: 264; stroke-dashoffset: @(264 * (1 - (Model.Score / 100.0)))" />
                    </svg>
                    <div class="position-absolute text-center">
                        <div class="h2 fw-black mb-0">@Model.Score</div>
                        <div class="xx-small fw-black text-muted">OPTIMIZED</div>
                    </div>
                </div>
                @{
                    var grade = (Model?.Score ?? 0) >= 80 ? "Optimized" : (Model?.Score ?? 0) >= 60 ? "Standard" : "Needs Review";
                }
                <div class="modern-badge modern-badge-success py-2 px-4">@grade Status</div>
            </div>
        </div>

        <!-- URL Inspector -->
        <div class="col-12 col-xl-8">
            <div class="card-modern p-5 h-100">
                <h5 class="fw-black mb-3">Live URI Inspector</h5>
                <p class="small text-muted mb-4 opacity-75">Analyze any system endpoint for schema integrity and search crawlability.</p>
                
                <div class="d-flex gap-2 mb-5">
                    <input type="text" id="analyzeUrl" class="modern-input px-3" value="/" style="flex: 1">
                    <button class="btn-modern-primary" data-action="analyze-page">Execute Audit</button>
                </div>

                <div class="card-modern-dark bg-opacity-5 p-4 d-flex gap-4">
                    <div class="w-10 h-10 rounded bg-white bg-opacity-10 d-flex align-items-center justify-content-center text-white">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h6 class="small fw-black text-white mb-1">Architectural Standard</h6>
                        <p class="xx-small fw-medium text-white opacity-60 mb-0 lh-lg">Maintain a single H1 tag per page. Keep meta descriptions between 120-160 characters for peak indexing efficiency.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Metrics -->
    @if (Model?.Metrics != null)
    {
        <div class="row g-4 mb-5">
            <div class="col-6 col-md-3">
                <div class="card-modern p-4 text-center">
                    <p class="modern-label mb-2">TITLE LENGTH</p>
                    <h3 class="fw-black mb-0">@Model.Metrics.TitleLength</h3>
                    <div class="modern-badge modern-badge-success mt-2">Optimal</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card-modern p-4 text-center">
                    <p class="modern-label mb-2">META DESC</p>
                    <h3 class="fw-black mb-0">@Model.Metrics.DescriptionLength</h3>
                    <div class="modern-badge modern-badge-warning mt-2">Optimize</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card-modern p-4 text-center">
                    <p class="modern-label mb-2">H1 COUNT</p>
                    <h3 class="fw-black mb-0">@Model.Metrics.H1Count</h3>
                    <div class="modern-badge @(Model.Metrics.H1Count == 1 ? "modern-badge-success" : "modern-badge-error") mt-2">
                        @(Model.Metrics.H1Count == 1 ? "Valid" : "Issue")
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card-modern p-4 text-center">
                    <p class="modern-label mb-2">NO-ALT IMAGES</p>
                    <h3 class="fw-black mb-0">@Model.Metrics.ImagesWithoutAlt</h3>
                    <div class="modern-badge @(Model.Metrics.ImagesWithoutAlt == 0 ? "modern-badge-success" : "modern-badge-error") mt-2">
                        @(Model.Metrics.ImagesWithoutAlt == 0 ? "Healthy" : "Fix")
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Detailed Insights -->
    <div class="row g-4 mb-5">
        <div class="col-12 col-lg-6">
            <div class="card-modern p-4 h-100">
                <h5 class="fw-black mb-4">Critical Issues</h5>
                <div class="d-flex flex-column gap-3">
                    @if (Model?.Issues?.Count > 0 == true)
                    {
                        @foreach (var issue in Model.Issues)
                        {
                            <div class="modern-issue-card">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="modern-badge modern-badge-error">@issue.Severity Severity</span>
                                    <span class="xx-small text-muted fw-black">@issue.Type</span>
                                </div>
                                <h6 class="small fw-black mb-2">@issue.Message</h6>
                                <p class="xx-small text-muted fw-medium mb-0">FIX: @issue.Fix</p>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5 opacity-30">
                            <i data-lucide="check-circle" class="w-12 h-12 mb-2"></i>
                            <p class="small fw-black">No critical issues found</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card-modern p-4 h-100">
                <h5 class="fw-black mb-4">Strategic Recommendations</h5>
                <div class="d-flex flex-column gap-4">
                    @if (Model?.Recommendations?.Any() == true)
                    {
                        @foreach (var recommendation in Model.Recommendations)
                        {
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="small fw-black">@recommendation.Title</div>
                                    <span class="xx-small text-primary fw-black">@recommendation.Impact IMPACT</span>
                                </div>
                                <p class="xx-small text-muted fw-medium mb-2 opacity-75">@recommendation.Description</p>
                                <div class="modern-progress h-1">
                                    <div class="modern-progress-bar @(recommendation.Impact == "High" ? "bg-primary" : "bg-info")" 
                                         style="width: @(recommendation.Impact == "High" ? "100" : recommendation.Impact == "Medium" ? "66" : "33")%"></div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/modules/dashboard/reports-controller.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (CC && CC.Modules && CC.Modules.Dashboard && CC.Modules.Dashboard.Reports) {
                CC.Modules.Dashboard.Reports.init();
            }
        });
    </script>
}
