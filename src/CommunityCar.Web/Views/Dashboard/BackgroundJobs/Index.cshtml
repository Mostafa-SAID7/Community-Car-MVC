@inject IViewLocalizer Localizer
@model CommunityCar.Application.Features.Dashboard.BackgroundJobs.ViewModels.BackgroundJobsViewModel
@{
    ViewData["Title"] = Localizer["BackgroundJobsTitle"];
    Layout = "_DashboardLayout";
}

<div class="d-flex flex-column gap-5 animate-in fade-in duration-700">
    <!-- Breadcrumb Protocol -->
    <nav class="d-flex align-items-center gap-2 small text-uppercase fw-bold tracking-wider text-muted opacity-75">
        <a href="@Url.Action("Index", "Dashboard")" class="text-decoration-none text-reset hover-primary transition-all">
            <i data-lucide="layout-dashboard" class="w-14px h-14px me-1"></i> @Localizer["Dashboard"]
        </a>
        <i data-lucide="chevron-right" class="w-12px h-12px opacity-50"></i>
        <span class="text-primary">@Localizer["BackgroundProcessingEngine"]</span>
    </nav>

    <!-- Header Section -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4">
        <div>
            <div class="d-flex align-items-center gap-2 mb-2">
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-20 px-3 py-2 rounded-pill small fw-bold text-uppercase tracking-widest">
                    <i data-lucide="activity" class="w-12px h-12px me-1"></i> @Localizer["ProcessingEngineActive"]
                </span>
            </div>
            <h1 class="display-5 fw-black text-gradient-red mb-2">@Localizer["JobProcessingEngine"]</h1>
            <p class="text-muted fw-medium border-start border-primary border-4 ps-3">@Localizer["BackgroundJobsDescription"]</p>
        </div>
        <div class="d-flex gap-3">
            <button onclick="refreshStatistics()" class="btn btn-primary-red px-4 py-2 rounded-xl fw-bold text-uppercase tracking-wider d-flex align-items-center gap-2 shadow-lg shadow-red-500/20 active-scale">
                <i data-lucide="refresh-cw" class="w-16px h-16px"></i> @Localizer["RefreshStatistics"]
            </button>
        </div>
    </div>

    <!-- Job Statistics Engine -->
    <div class="card card-premium overflow-hidden">
        <div class="row g-0">
            <div class="col-lg-8 border-end border-border border-opacity-50">
                <div class="p-4 p-md-5">
                    <div class="grid-stats-4">
                        <div class="stat-item p-4 rounded-4 bg-primary bg-opacity-10 border border-primary border-opacity-10 text-center transition-all hover-translate-y">
                            <i data-lucide="clock" class="w-24px h-24px text-primary mb-3 mx-auto"></i>
                            <div class="display-6 fw-black text-primary mb-1" id="enqueued-count">@Model.JobStatistics.EnqueuedCount</div>
                            <div class="small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["Enqueued"]</div>
                        </div>

                        <div class="stat-item p-4 rounded-4 bg-success bg-opacity-10 border border-success border-opacity-10 text-center transition-all hover-translate-y">
                            <i data-lucide="check-circle" class="w-24px h-24px text-success mb-3 mx-auto"></i>
                            <div class="display-6 fw-black text-success mb-1" id="succeeded-count">@Model.JobStatistics.SucceededCount</div>
                            <div class="small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["Succeeded"]</div>
                        </div>

                        <div class="stat-item p-4 rounded-4 bg-danger bg-opacity-10 border border-danger border-opacity-10 text-center transition-all hover-translate-y">
                            <i data-lucide="x-circle" class="w-24px h-24px text-danger mb-3 mx-auto"></i>
                            <div class="display-6 fw-black text-danger mb-1" id="failed-count">@Model.JobStatistics.FailedCount</div>
                            <div class="small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["Failed"]</div>
                        </div>

                        <div class="stat-item p-4 rounded-4 bg-warning bg-opacity-10 border border-warning border-opacity-10 text-center transition-all hover-translate-y">
                            <i data-lucide="calendar" class="w-24px h-24px text-warning mb-3 mx-auto"></i>
                            <div class="display-6 fw-black text-warning mb-1" id="scheduled-count">@Model.JobStatistics.ScheduledCount</div>
                            <div class="small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["Scheduled"]</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 bg-primary bg-opacity-5 d-flex flex-column justify-content-center p-4 p-md-5">
                <div class="d-flex flex-column gap-5">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="display-5 fw-black text-gradient-red mb-0" id="processing-count">@Model.JobStatistics.ProcessingCount.ToString("D2")</div>
                            <div class="small fw-bold text-uppercase tracking-widest text-muted opacity-75">@Localizer["ActiveJobs"]</div>
                        </div>
                        <div class="w-56px h-56px rounded-4 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center">
                            <i data-lucide="zap" class="w-28px h-28px text-primary"></i>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="display-5 fw-black text-gradient-red mb-0" id="servers-count">@Model.JobStatistics.ServersCount.ToString("D2")</div>
                            <div class="small fw-bold text-uppercase tracking-widest text-muted opacity-75">@Localizer["ServerNodes"]</div>
                        </div>
                        <div class="w-56px h-56px rounded-4 bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center">
                            <i data-lucide="server" class="w-28px h-28px text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Job Execution Interface -->
    <div class="row g-4">
        <div class="col-xl-8">
            <div class="card card-premium h-100">
                <div class="card-header bg-transparent border-bottom border-border border-opacity-50 p-4">
                    <h3 class="h5 fw-black mb-0 d-flex align-items-center gap-2">
                        <i data-lucide="play-circle" class="w-20px h-20px text-primary"></i>
                        @Localizer["ManualJobExecution"]
                    </h3>
                </div>
                <div class="card-body p-4 p-md-5">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="p-4 rounded-4 bg-primary bg-opacity-5 border border-primary border-opacity-10 h-100 transition-all hover-border-primary">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="w-40px h-40px rounded-3 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center text-primary">
                                        <i data-lucide="wrench" class="w-20px h-20px"></i>
                                    </div>
                                    <div>
                                        <span class="d-block small fw-black text-foreground">@Localizer["SystemMaintenance"]</span>
                                        <span class="d-block xx-small fw-black text-uppercase tracking-widest text-muted">@Localizer["DatabaseHealthChecks"]</span>
                                    </div>
                                </div>
                                <p class="small text-muted mb-4 opacity-75">@Localizer["SystemMaintenanceDesc"]</p>
                                <form asp-action="RunMaintenance" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" onclick="return confirm('@Localizer["ConfirmMaintenance"]')" class="btn btn-primary-red w-100 py-3 rounded-3 fw-bold text-uppercase tracking-wider small shadow-sm active-scale">
                                        <i data-lucide="play" class="w-14px h-14px me-1"></i> @Localizer["ExecuteMaintenance"]
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="p-4 rounded-4 bg-success bg-opacity-5 border border-success border-opacity-10 h-100 transition-all hover-border-success">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="w-40px h-40px rounded-3 bg-success bg-opacity-10 d-flex align-items-center justify-content-center text-success">
                                        <i data-lucide="rss" class="w-20px h-20px"></i>
                                    </div>
                                    <div>
                                        <span class="d-block small fw-black text-foreground">@Localizer["FeedUpdates"]</span>
                                        <span class="d-block xx-small fw-black text-uppercase tracking-widest text-muted">@Localizer["ContentSynchronization"]</span>
                                    </div>
                                </div>
                                <p class="small text-muted mb-4 opacity-75">@Localizer["FeedUpdatesDesc"]</p>
                                <form asp-action="UpdateFeeds" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" onclick="return confirm('@Localizer["ConfirmFeedUpdate"]')" class="btn btn-success w-100 py-3 border-0 rounded-3 fw-bold text-uppercase tracking-wider small shadow-sm active-scale">
                                        <i data-lucide="play" class="w-14px h-14px me-1"></i> @Localizer["UpdateFeeds"]
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="p-4 rounded-4 bg-warning bg-opacity-5 border border-warning border-opacity-10 h-100 transition-all hover-border-warning">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="w-40px h-40px rounded-3 bg-warning bg-opacity-10 d-flex align-items-center justify-content-center text-warning">
                                        <i data-lucide="trending-up" class="w-20px h-20px"></i>
                                    </div>
                                    <div>
                                        <span class="d-block small fw-black text-foreground">@Localizer["TrendingTopics"]</span>
                                        <span class="d-block xx-small fw-black text-uppercase tracking-widest text-muted">@Localizer["AlgorithmRefresh"]</span>
                                    </div>
                                </div>
                                <p class="small text-muted mb-4 opacity-75">@Localizer["TrendingTopicsDesc"]</p>
                                <form asp-action="UpdateTrending" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" onclick="return confirm('@Localizer["ConfirmTrendingUpdate"]')" class="btn btn-warning w-100 py-3 border-0 text-dark rounded-3 fw-bold text-uppercase tracking-wider small shadow-sm active-scale">
                                        <i data-lucide="play" class="w-14px h-14px me-1"></i> @Localizer["UpdateTrending"]
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="p-4 rounded-4 bg-info bg-opacity-5 border border-info border-opacity-10 h-100 transition-all hover-border-info">
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <div class="w-40px h-40px rounded-3 bg-info bg-opacity-10 d-flex align-items-center justify-content-center text-info">
                                        <i data-lucide="trophy" class="w-20px h-20px"></i>
                                    </div>
                                    <div>
                                        <span class="d-block small fw-black text-foreground">@Localizer["Gamification"]</span>
                                        <span class="d-block xx-small fw-black text-uppercase tracking-widest text-muted">@Localizer["AchievementProcessing"]</span>
                                    </div>
                                </div>
                                <p class="small text-muted mb-4 opacity-75">@Localizer["GamificationDesc"]</p>
                                <form asp-action="ProcessGamification" method="post">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" onclick="return confirm('@Localizer["ConfirmGamification"]')" class="btn btn-info w-100 py-3 border-0 rounded-3 fw-bold text-uppercase tracking-wider small shadow-sm active-scale">
                                        <i data-lucide="play" class="w-14px h-14px me-1"></i> @Localizer["ProcessGamification"]
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recurring Jobs Sidebar -->
        <div class="col-xl-4">
            <div class="card card-premium h-100">
                <div class="card-header bg-transparent border-bottom border-border border-opacity-50 p-4 d-flex align-items-center justify-content-between">
                    <h3 class="h5 fw-black mb-0 d-flex align-items-center gap-2">
                        <i data-lucide="repeat" class="w-20px h-20px text-primary"></i>
                        @Localizer["RecurringJobs"]
                    </h3>
                    <a href="@Url.Action("RecurringJobs")" class="btn btn-sm btn-outline-primary-subtle rounded-pill px-3 py-1 fw-bold text-uppercase tracking-tighter small">
                        <i data-lucide="arrow-right" class="w-12px h-12px me-1"></i> @Localizer["ViewAll"]
                    </a>
                </div>
                <div class="card-body p-4">
                    @if (Model.RecurringJobs.Any())
                    {
                        <div class="d-flex flex-column gap-3">
                            @foreach (var job in Model.RecurringJobs.Take(5))
                            {
                                <div class="p-3 rounded-4 bg-muted bg-opacity-5 border border-border border-opacity-30 transition-all hover-bg-opacity-10">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <span class="small fw-black text-foreground">@System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(job.Id.Replace("-", " "))</span>
                                        <span class="badge bg-@(string.IsNullOrEmpty(job.Error) ? "success" : "danger") bg-opacity-10 text-@(string.IsNullOrEmpty(job.Error) ? "success" : "danger") border border-@(string.IsNullOrEmpty(job.Error) ? "success" : "danger") border-opacity-20 rounded-pill xx-small fw-black">
                                            @(string.IsNullOrEmpty(job.Error) ? Localizer["Healthy"] : Localizer["Error"])
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["NextExecution"]:</span>
                                        <span class="small text-muted fw-bold">@(job.NextExecution?.ToString("HH:mm") ?? "N/A")</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="h-100 d-flex flex-column align-items-center justify-content-center py-5 text-center opacity-50">
                            <i data-lucide="calendar-x" class="w-48px h-48px text-muted mb-3 opacity-20"></i>
                            <span class="d-block small fw-bold text-foreground">@Localizer["NoRecurringJobs"]</span>
                            <span class="d-block xx-small text-uppercase tracking-widest">@Localizer["NoRecurringJobsDesc"]</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs History -->
    <div class="card card-premium">
        <div class="card-header bg-transparent border-bottom border-border border-opacity-50 p-4">
            <h3 class="h5 fw-black mb-0 d-flex align-items-center gap-2">
                <i data-lucide="history" class="w-20px h-20px text-primary"></i>
                @Localizer["RecentJobHistory"]
            </h3>
        </div>
        <div class="card-body p-4">
            @if (Model.RecentJobs.Any())
            {
                <div class="table-responsive">
                    <table class="table table-premium align-middle mb-0">
                        <thead>
                            <tr class="text-uppercase small fw-black tracking-widest text-muted opacity-60">
                                <th class="border-0 ps-4">@Localizer["JobID"]</th>
                                <th class="border-0">@Localizer["Method"]</th>
                                <th class="border-0">@Localizer["State"]</th>
                                <th class="border-0">@Localizer["Created"]</th>
                                <th class="border-0 text-end pe-4">@Localizer["Duration"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var job in Model.RecentJobs)
                            {
                                <tr class="transition-all hover-translate-x">
                                    <td class="ps-4">
                                        <code class="small fw-bold text-primary">#@job.Id</code>
                                    </td>
                                    <td>
                                        <span class="small fw-bold text-foreground">@job.Method</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-@GetJobStateColor(job.State) bg-opacity-10 text-@GetJobStateColor(job.State) border border-@GetJobStateColor(job.State) border-opacity-20 px-3 py-1 rounded-pill small fw-bold">
                                            <i data-lucide="@GetJobStateIcon(job.State)" class="w-12px h-12px me-1"></i> @job.State
                                        </span>
                                        @if (!string.IsNullOrEmpty(job.Error))
                                        {
                                            <button onclick="showError('@job.Error')" class="btn btn-link py-0 ps-2 text-danger small text-decoration-none hover-primary transition-all">
                                                <i data-lucide="alert-circle" class="w-14px h-14px"></i>
                                            </button>
                                        }
                                    </td>
                                    <td>
                                        <span class="small text-muted fw-medium">@job.CreatedAt?.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                    </td>
                                    <td class="text-end pe-4">
                                        <span class="small fw-black text-foreground">@(job.Duration?.ToString(@"mm\:ss") ?? "N/A")</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="py-5 text-center opacity-50">
                    <i data-lucide="history" class="w-48px h-48px text-muted mb-3 opacity-20 mx-auto"></i>
                    <h5 class="fw-black mb-1">@Localizer["NoJobHistory"]</h5>
                    <p class="small text-muted mb-0">@Localizer["NoJobHistoryDesc"]</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content card-premium border-0 shadow-2xl">
            <div class="modal-header border-bottom border-border border-opacity-50 p-4">
                <h5 class="modal-title fw-black d-flex align-items-center gap-2">
                    <i data-lucide="alert-triangle" class="text-danger"></i>
                    @Localizer["JobErrorAnalysis"]
                </h5>
                <button type="button" class="btn-close btn-close-white opacity-50 transition-all hover-opacity-100" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="p-4 rounded-4 bg-danger bg-opacity-5 border border-danger border-opacity-10">
                    <pre id="error-details" class="small text-danger font-mono mb-0 whitespace-pre-wrap" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer border-top border-border border-opacity-50 p-4">
                <button type="button" class="btn btn-secondary px-4 rounded-pill fw-bold text-uppercase tracking-wider small shadow-sm active-scale" data-bs-dismiss="modal">
                    @Localizer["CloseAnalysis"]
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refreshStatistics() {
            $.get('@Url.Action("GetStatistics")', function(data) {
                if (data.error) {
                    CC.Utils.Notifier.error('Statistics refresh failed: ' + data.error);
                    return;
                }
                
                $('#enqueued-count').text(data.EnqueuedCount || 0);
                $('#processing-count').text((data.ProcessingCount || 0).toString().padStart(2, '0'));
                $('#succeeded-count').text(data.SucceededCount || 0);
                $('#failed-count').text(data.FailedCount || 0);
                $('#scheduled-count').text(data.ScheduledCount || 0);
                $('#servers-count').text((data.ServersCount || 0).toString().padStart(2, '0'));
                
                CC.Utils.Notifier.success('Processing statistics synchronized');
            }).fail(function() {
                CC.Utils.Notifier.error('Statistics synchronization failed');
            });
        }
        
        function showError(error) {
            $('#error-details').text(error);
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            modal.show();
        }
        
        // Auto-refresh every 30 seconds
        setInterval(refreshStatistics, 30000);
    </script>
}

@functions {
    private string GetJobStateColor(string state)
    {
        return state?.ToLower() switch
        {
            "succeeded" => "success",
            "failed" => "danger",
            "processing" => "warning",
            "enqueued" => "primary",
            _ => "secondary"
        };
    }
    
    private string GetJobStateIcon(string state)
    {
        return state?.ToLower() switch
        {
            "succeeded" => "check-circle",
            "failed" => "x-circle",
            "processing" => "loader",
            "enqueued" => "clock",
            _ => "help-circle"
        };
    }
}
