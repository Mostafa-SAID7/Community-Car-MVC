@using CommunityCar.Domain.Entities.Shared
@model ErrorLog
@{
    ViewData["Title"] = "Error Details";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="space-y-8 animate-in fade-in duration-700">
    <!-- Skeleton Loader -->
    <div id="error-skeleton" class="hidden space-y-8">
        <skeleton type="Line" class="w-48" />
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <skeleton type="Card" class="h-96" />
            </div>
            <div class="space-y-6">
                <skeleton type="Card" />
                <skeleton type="Card" />
            </div>
        </div>
    </div>

    <div id="error-content">
    <!-- Navigation & Header Strategy -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-8 px-2 mb-10">
        <div class="space-y-4">
            <nav class="flex items-center gap-3 text-[10px] font-black uppercase tracking-[0.3em] text-red-500 mb-6 font-mono">
                <i data-lucide="terminal" class="w-3.5 h-3.5 fill-current"></i> SYSTEM_FAILURE_ARCHIVE
            </nav>
            <h1 class="text-5xl font-black text-foreground tracking-tighter leading-none">Error Details</h1>
            <p class="text-[10px] font-black text-muted-foreground opacity-50 mt-4 border-l-4 border-red-500/20 pl-4 py-1 tracking-[0.2em] font-mono">ID: @Model.ErrorId</p>
        </div>
        
        <div class="flex gap-3">
            <a href="@Url.Action("Index")" class="inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-muted/20 border border-border/50 hover:bg-muted/30 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all active:scale-95 group/back">
                <i data-lucide="arrow-left" class="w-4 h-4 group-hover/back:-translate-x-1 transition-transform"></i>
                Back to Logs
            </a>
            <button onclick="deleteError('@Model.Id')" class="inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-background border border-red-500/20 text-red-500 hover:bg-red-500/10 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all active:scale-95 group/purge">
                <i data-lucide="trash-2" class="w-4 h-4 mr-2 group-hover/purge:rotate-12 transition-transform"></i>
                Purge Entry
            </button>
        </div>
    </div>

    <!-- Error Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Error Info -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Error Summary Registry -->
            <div class="bg-card/40 backdrop-blur-2xl border border-border/50 rounded-[2.5rem] p-8 md:p-10 shadow-2xl overflow-hidden relative group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-red-500/5 rounded-full blur-3xl -mr-32 -mt-32"></div>
                
                <div class="flex items-start gap-6 relative z-10">
                    <div class="w-16 h-16 rounded-[2rem] bg-red-500/10 border border-red-500/20 flex items-center justify-center text-red-600 shadow-2xl shadow-red-500/5 shrink-0">
                        <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                    </div>
                    <div class="flex-1 space-y-4">
                        <div class="text-[10px] font-black uppercase tracking-widest text-red-500 opacity-60">CRITICAL_EXCEPTION_MESSAGE</div>
                        <h2 class="text-2xl font-black text-foreground leading-tight tracking-tight">@Model.Message</h2>
                        
                        <div class="flex flex-wrap items-center gap-6 pt-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" class="w-3.5 h-3.5 text-muted-foreground opacity-40"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest text-muted-foreground opacity-70">@Model.CreatedAt.ToString("MMM dd, HH:mm:ss")</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-3.5 h-3.5 text-muted-foreground opacity-40"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest text-muted-foreground opacity-70">SEV_@Model.Severity.ToUpper()</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="globe" class="w-3.5 h-3.5 text-muted-foreground opacity-40"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest text-muted-foreground opacity-70">SRC_@Model.Source.ToUpper()</span>
                            </div>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.InnerException))
                {
                    <div class="mb-6">
                        <h3 class="text-lg font-black text-foreground mb-3">Exception Details</h3>
                        <div class="bg-muted/20 border border-border/50 rounded-xl p-4 font-mono text-sm overflow-x-auto">
                            <pre class="whitespace-pre-wrap text-muted-foreground">@Model.InnerException</pre>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.StackTrace))
                {
                    <div class="mb-6">
                        <h3 class="text-lg font-black text-foreground mb-3">Stack Trace</h3>
                        <div class="bg-muted/20 border border-border/50 rounded-xl p-4 font-mono text-sm overflow-x-auto max-h-96 overflow-y-auto">
                            <pre class="whitespace-pre-wrap text-muted-foreground">@Model.StackTrace</pre>
                        </div>
                    </div>
                }
            </div>

            <!-- Request Information -->
            @if (!string.IsNullOrEmpty(Model.RequestPath) || !string.IsNullOrEmpty(Model.UserAgent))
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-black text-foreground mb-4 flex items-center gap-2">
                        <i data-lucide="globe" class="w-5 h-5 text-primary"></i>
                        Request Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        @if (!string.IsNullOrEmpty(Model.RequestPath))
                        {
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Request Path</label>
                                <div class="mt-1 p-3 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm">
                                    @Model.RequestPath
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.RequestMethod))
                        {
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">HTTP Method</label>
                                <div class="mt-1 p-3 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm">
                                    @Model.RequestMethod
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.UserAgent))
                        {
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium text-muted-foreground">User Agent</label>
                                <div class="mt-1 p-3 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm break-all">
                                    @Model.UserAgent
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Additional Data -->
            @if (!string.IsNullOrEmpty(Model.AdditionalData))
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-black text-foreground mb-4 flex items-center gap-2">
                        <i data-lucide="database" class="w-5 h-5 text-primary"></i>
                        Additional Data
                    </h3>
                    <div class="bg-muted/20 border border-border/50 rounded-xl p-4 font-mono text-sm overflow-x-auto">
                        <pre class="whitespace-pre-wrap text-muted-foreground">@Model.AdditionalData</pre>
                    </div>
                </div>
            }
        </div>

        <!-- Diagnostic Sidebar -->
        <div class="space-y-6">
            <!-- Metadata Registry -->
            <div class="bg-card/40 backdrop-blur-xl border border-border/50 rounded-[2rem] p-8 shadow-xl">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-1 h-4 bg-primary rounded-full"></div>
                    <h3 class="text-sm font-black text-foreground tracking-widest uppercase">METADATA_EXTRACT</h3>
                </div>
                
                <div class="space-y-6">
                    <div class="space-y-2">
                        <div class="text-[9px] font-black uppercase tracking-widest text-muted-foreground opacity-40">SYSTEM_ID</div>
                        <div class="p-3 bg-muted/20 border border-border/50 rounded-xl font-mono text-[11px] text-foreground">@Model.ErrorId</div>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[9px] font-black uppercase tracking-widest text-muted-foreground opacity-40">SEVERITY_LEVEL</div>
                        @{
                            var severityStyle = Model.Severity switch {
                                "Critical" => "bg-red-500/10 text-red-500 border-red-500/20",
                                "Error" => "bg-orange-500/10 text-orange-500 border-orange-500/20",
                                _ => "bg-blue-500/10 text-blue-500 border-blue-500/20"
                            };
                        }
                        <div class="inline-flex px-3 py-1.5 rounded-xl border @severityStyle text-[10px] font-black uppercase tracking-widest">
                            @Model.Severity
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[9px] font-black uppercase tracking-widest text-muted-foreground opacity-40">REGISTRY_STAMP</div>
                        <div class="p-3 bg-muted/20 border border-border/50 rounded-xl font-mono text-[11px] text-foreground">@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")</div>
                    </div>
                </div>
            </div>

            <!-- Execution Protocols -->
            <div class="bg-card/40 backdrop-blur-xl border border-border/50 rounded-[2rem] p-8 shadow-xl">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-1 h-4 bg-primary rounded-full"></div>
                    <h3 class="text-sm font-black text-foreground tracking-widest uppercase">ACTION_PROTOCOLS</h3>
                </div>
                <div class="space-y-3">
                    <button onclick="copyErrorDetails()" class="inline-flex items-center justify-start w-full px-6 h-12 bg-muted/20 border border-border/50 hover:bg-muted/30 text-foreground font-bold uppercase tracking-widest rounded-xl transition-all active:scale-95 group/clone">
                        <i data-lucide="copy" class="w-4 h-4 mr-3 opacity-60 group-hover/clone:scale-110 transition-transform"></i> CLONE_DATA
                    </button>
                    <button onclick="exportError()" class="inline-flex items-center justify-start w-full px-6 h-12 bg-muted/20 border border-border/50 hover:bg-muted/30 text-foreground font-bold uppercase tracking-widest rounded-xl transition-all active:scale-95 group/export">
                        <i data-lucide="download" class="w-4 h-4 mr-3 opacity-60 group-hover/export:translate-y-0.5 transition-transform"></i> EXPORT_ARCHIVE
                    </button>
                    <button onclick="markAsResolved('@Model.Id')" class="inline-flex items-center justify-start w-full px-6 h-12 bg-primary text-primary-foreground hover:bg-primary/90 font-black uppercase tracking-widest rounded-xl transition-all shadow-lg shadow-primary/20 active:scale-95 group/resolve">
                        <i data-lucide="check-circle" class="w-4 h-4 mr-3 group-hover/resolve:scale-110 transition-transform"></i> FLAG_RESOLVED
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End error-content -->
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Skeleton.initPageLoad('error-skeleton', 'error-content');
        });
        
        async function deleteError(errorId) {
            if (!confirm('Are you sure you want to delete this error log? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/errors/${errorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });

                if (response.ok) {
                    showToast('Error log deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Index")';
                    }, 1500);
                } else {
                    const result = await response.json();
                    showToast(result.message || 'Failed to delete error log', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }

        async function markAsResolved(errorId) {
            try {
                const response = await fetch(`/api/errors/${errorId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });

                if (response.ok) {
                    showToast('Error marked as resolved', 'success');
                    location.reload();
                } else {
                    const result = await response.json();
                    showToast(result.message || 'Failed to mark error as resolved', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }

        function copyErrorDetails() {
            const errorDetails = `
Error ID: @Model.ErrorId
Level: @Model.Severity
Source: @Model.Source
Timestamp: @Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")
Message: @Model.Message
@if (!string.IsNullOrEmpty(Model.RequestPath))
{
@:Request Path: @Model.RequestPath
}
@if (!string.IsNullOrEmpty(Model.InnerException))
{
@:Exception: @Model.InnerException
}
@if (!string.IsNullOrEmpty(Model.StackTrace))
{
@:Stack Trace: @Model.StackTrace
}
            `.trim();

            if (navigator.clipboard) {
                navigator.clipboard.writeText(errorDetails).then(() => {
                    showToast('Error details copied to clipboard', 'success');
                }).catch(() => {
                    fallbackCopy(errorDetails);
                });
            } else {
                fallbackCopy(errorDetails);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Error details copied to clipboard', 'success');
            } catch (err) {
                showToast('Failed to copy error details', 'error');
            }
            document.body.removeChild(textArea);
        }

        function exportError() {
            const errorData = {
                errorId: '@Model.ErrorId',
                level: '@Model.Severity',
                source: '@Model.Source',
                timestamp: '@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")',
                message: '@Html.Raw(Html.Encode(Model.Message).Replace("'", "\\'"))',
                exception: '@Html.Raw(Html.Encode(Model.InnerException ?? "").Replace("'", "\\'"))',
                stackTrace: '@Html.Raw(Html.Encode(Model.StackTrace ?? "").Replace("'", "\\'"))',
                requestPath: '@Model.RequestPath',
                requestMethod: '@Model.RequestMethod',
                userAgent: '@Html.Raw(Html.Encode(Model.UserAgent ?? "").Replace("'", "\\'"))',
                additionalData: '@Html.Raw(Html.Encode(Model.AdditionalData ?? "").Replace("'", "\\'"))'
            };

            const dataStr = JSON.stringify(errorData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `error-${errorData.errorId}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Error exported successfully', 'success');
        }

        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value ||
                   document.querySelector('meta[name="__RequestVerificationToken"]')?.content;
        }

        function showToast(message, type = 'info') {
            if (window.ToasterSystem) {
                window.ToasterSystem.show(message, type);
            } else if (window.notify) {
                window.notify[type](message);
            } else {
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }
    </script>
}