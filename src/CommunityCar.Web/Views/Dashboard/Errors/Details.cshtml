@using CommunityCar.Domain.Entities.Shared
@model ErrorLog
@{
    ViewData["Title"] = "Error Details";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="space-y-8 animate-in fade-in duration-700">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <h1 class="text-3xl font-black text-foreground tracking-tight">Error Details</h1>
            <p class="text-sm text-muted-foreground font-medium opacity-70 mt-1">@Model.ErrorId</p>
        </div>
        <div class="flex items-center gap-4">
            <a href="@Url.Action("Index")" class="inline-flex items-center gap-2.5 px-6 py-2.5 bg-background border border-border hover:border-primary hover:text-primary rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-black/5 active:scale-95 group">
                <i data-lucide="arrow-left" class="w-4 h-4 group-hover:scale-125 transition-transform"></i>
                Back to Errors
            </a>
            <button onclick="deleteError('@Model.Id')" class="inline-flex items-center gap-2.5 px-6 py-2.5 bg-red-500 text-red-50 hover:bg-red-600 rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-red-500/20 active:scale-95 group">
                <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-125 transition-transform"></i>
                Delete Error
            </button>
        </div>
    </div>

    <!-- Error Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Error Info -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Error Summary -->
            <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 rounded-xl bg-red-500/10 flex items-center justify-center text-red-600">
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-black text-foreground mb-2">@Model.Message</h2>
                        <div class="flex items-center gap-4 text-sm text-muted-foreground">
                            <span class="flex items-center gap-1">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                @Model.CreatedAt.ToString("MMM dd, yyyy HH:mm:ss")
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="layers" class="w-4 h-4"></i>
                                @Model.Severity
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="globe" class="w-4 h-4"></i>
                                @Model.Source
                            </span>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.InnerException))
                {
                    <div class="mb-6">
                        <h3 class="text-lg font-black text-foreground mb-3">Exception Details</h3>
                        <div class="bg-muted/20 border border-border/50 rounded-xl p-4 font-mono text-sm overflow-x-auto">
                            <pre class="whitespace-pre-wrap text-muted-foreground">@Model.InnerException</pre>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Model.StackTrace))
                {
                    <div class="mb-6">
                        <h3 class="text-lg font-black text-foreground mb-3">Stack Trace</h3>
                        <div class="bg-muted/20 border border-border/50 rounded-xl p-4 font-mono text-sm overflow-x-auto max-h-96 overflow-y-auto">
                            <pre class="whitespace-pre-wrap text-muted-foreground">@Model.StackTrace</pre>
                        </div>
                    </div>
                }
            </div>

            <!-- Request Information -->
            @if (!string.IsNullOrEmpty(Model.RequestPath) || !string.IsNullOrEmpty(Model.UserAgent))
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-black text-foreground mb-4 flex items-center gap-2">
                        <i data-lucide="globe" class="w-5 h-5 text-primary"></i>
                        Request Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        @if (!string.IsNullOrEmpty(Model.RequestPath))
                        {
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">Request Path</label>
                                <div class="mt-1 p-3 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm">
                                    @Model.RequestPath
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.RequestMethod))
                        {
                            <div>
                                <label class="text-sm font-medium text-muted-foreground">HTTP Method</label>
                                <div class="mt-1 p-3 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm">
                                    @Model.RequestMethod
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.UserAgent))
                        {
                            <div class="md:col-span-2">
                                <label class="text-sm font-medium text-muted-foreground">User Agent</label>
                                <div class="mt-1 p-3 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm break-all">
                                    @Model.UserAgent
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Additional Data -->
            @if (!string.IsNullOrEmpty(Model.AdditionalData))
            {
                <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-black text-foreground mb-4 flex items-center gap-2">
                        <i data-lucide="database" class="w-5 h-5 text-primary"></i>
                        Additional Data
                    </h3>
                    <div class="bg-muted/20 border border-border/50 rounded-xl p-4 font-mono text-sm overflow-x-auto">
                        <pre class="whitespace-pre-wrap text-muted-foreground">@Model.AdditionalData</pre>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Error Metadata -->
            <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                <h3 class="text-lg font-black text-foreground mb-4 flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5 text-primary"></i>
                    Error Metadata
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-sm font-medium text-muted-foreground">Error ID</label>
                        <div class="mt-1 p-2 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm">
                            @Model.ErrorId
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-muted-foreground">Level</label>
                        <div class="mt-1">
                            @{
                                var levelClass = Model.Severity switch
                                {
                                    "Error" => "bg-red-500/10 text-red-600 border-red-500/20",
                                    "Warning" => "bg-yellow-500/10 text-yellow-600 border-yellow-500/20",
                                    "Info" => "bg-blue-500/10 text-blue-600 border-blue-500/20",
                                    "Critical" => "bg-purple-500/10 text-purple-600 border-purple-500/20",
                                    _ => "bg-muted/20 text-muted-foreground border-border/50"
                                };
                            }
                            <span class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium border @levelClass">
                                @Model.Severity
                            </span>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-muted-foreground">Source</label>
                        <div class="mt-1 p-2 bg-muted/20 border border-border/50 rounded-lg text-sm">
                            @Model.Source
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-muted-foreground">Timestamp</label>
                        <div class="mt-1 p-2 bg-muted/20 border border-border/50 rounded-lg text-sm">
                            @Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.UserId))
                    {
                        <div>
                            <label class="text-sm font-medium text-muted-foreground">User ID</label>
                            <div class="mt-1 p-2 bg-muted/20 border border-border/50 rounded-lg font-mono text-sm">
                                @Model.UserId
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-card/50 backdrop-blur-md border border-border rounded-2xl p-6 shadow-lg">
                <h3 class="text-lg font-black text-foreground mb-4 flex items-center gap-2">
                    <i data-lucide="zap" class="w-5 h-5 text-primary"></i>
                    Quick Actions
                </h3>
                <div class="space-y-3">
                    <button onclick="copyErrorDetails()" class="w-full inline-flex items-center gap-2.5 px-4 py-2.5 bg-background border border-border hover:border-primary hover:text-primary rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-black/5 active:scale-95 group">
                        <i data-lucide="copy" class="w-4 h-4 group-hover:scale-125 transition-transform"></i>
                        Copy Details
                    </button>
                    <button onclick="exportError()" class="w-full inline-flex items-center gap-2.5 px-4 py-2.5 bg-background border border-border hover:border-primary hover:text-primary rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-black/5 active:scale-95 group">
                        <i data-lucide="download" class="w-4 h-4 group-hover:scale-125 transition-transform"></i>
                        Export Error
                    </button>
                    <button onclick="markAsResolved('@Model.Id')" class="w-full inline-flex items-center gap-2.5 px-4 py-2.5 bg-green-500 text-green-50 hover:bg-green-600 rounded-xl text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-green-500/20 active:scale-95 group">
                        <i data-lucide="check-circle" class="w-4 h-4 group-hover:scale-125 transition-transform"></i>
                        Mark Resolved
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function deleteError(errorId) {
            if (!confirm('Are you sure you want to delete this error log? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/errors/${errorId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });

                if (response.ok) {
                    showToast('Error log deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.href = '@Url.Action("Index")';
                    }, 1500);
                } else {
                    const result = await response.json();
                    showToast(result.message || 'Failed to delete error log', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }

        async function markAsResolved(errorId) {
            try {
                const response = await fetch(`/api/errors/${errorId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    }
                });

                if (response.ok) {
                    showToast('Error marked as resolved', 'success');
                    location.reload();
                } else {
                    const result = await response.json();
                    showToast(result.message || 'Failed to mark error as resolved', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }

        function copyErrorDetails() {
            const errorDetails = `
Error ID: @Model.ErrorId
Level: @Model.Severity
Source: @Model.Source
Timestamp: @Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")
Message: @Model.Message
@if (!string.IsNullOrEmpty(Model.RequestPath))
{
@:Request Path: @Model.RequestPath
}
@if (!string.IsNullOrEmpty(Model.InnerException))
{
@:Exception: @Model.InnerException
}
@if (!string.IsNullOrEmpty(Model.StackTrace))
{
@:Stack Trace: @Model.StackTrace
}
            `.trim();

            if (navigator.clipboard) {
                navigator.clipboard.writeText(errorDetails).then(() => {
                    showToast('Error details copied to clipboard', 'success');
                }).catch(() => {
                    fallbackCopy(errorDetails);
                });
            } else {
                fallbackCopy(errorDetails);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Error details copied to clipboard', 'success');
            } catch (err) {
                showToast('Failed to copy error details', 'error');
            }
            document.body.removeChild(textArea);
        }

        function exportError() {
            const errorData = {
                errorId: '@Model.ErrorId',
                level: '@Model.Severity',
                source: '@Model.Source',
                timestamp: '@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")',
                message: '@Html.Raw(Html.Encode(Model.Message).Replace("'", "\\'"))',
                exception: '@Html.Raw(Html.Encode(Model.InnerException ?? "").Replace("'", "\\'"))',
                stackTrace: '@Html.Raw(Html.Encode(Model.StackTrace ?? "").Replace("'", "\\'"))',
                requestPath: '@Model.RequestPath',
                requestMethod: '@Model.RequestMethod',
                userAgent: '@Html.Raw(Html.Encode(Model.UserAgent ?? "").Replace("'", "\\'"))',
                additionalData: '@Html.Raw(Html.Encode(Model.AdditionalData ?? "").Replace("'", "\\'"))'
            };

            const dataStr = JSON.stringify(errorData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `error-${errorData.errorId}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Error exported successfully', 'success');
        }

        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value ||
                   document.querySelector('meta[name="__RequestVerificationToken"]')?.content;
        }

        function showToast(message, type = 'info') {
            if (window.ToasterSystem) {
                window.ToasterSystem.show(message, type);
            } else if (window.notify) {
                window.notify[type](message);
            } else {
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }
    </script>
}