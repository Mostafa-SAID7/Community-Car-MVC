@inject IViewLocalizer Localizer
@model CommunityCar.Application.Features.Dashboard.ViewModels.BackgroundJobs.BackgroundJobsViewModel
@{
    ViewData["Title"] = Localizer["BackgroundJobsSystemManagement"];
    ViewData["PageHeader"] = Localizer["BackgroundJobs"];
    ViewData["PageDescription"] = Localizer["BackgroundJobsDesc"];
}

<div class="animate-slide-up">
    <!-- Breadcrumb Protocol -->
    <nav class="d-flex align-items-center gap-2 xx-small fw-bold text-uppercase tracking-wider text-muted opacity-50 mb-3 px-1">
        <a href="@Url.Action("Index", "Overview")" class="text-decoration-none text-reset hover-primary">
            @Localizer["Dashboard"]
        </a>
        <span>/</span>
        <span>@Localizer["SystemBackgroundJobs"]</span>
    </nav>

    <!-- Header Section -->
    <div class="card-modern p-0 overflow-hidden mb-4">
        <div class="row g-0">
            <div class="col-12 col-lg-8 p-4 p-md-5">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="badge bg-success-subtle text-success rounded-pill px-3 py-1 xx-small fw-bold border border-success border-opacity-10">
                        <i data-lucide="activity" class="w-3 h-3 me-1"></i> @Localizer["SystemActive"]
                    </span>
                </div>
                <h1 class="display-5 fw-black mb-3">@Localizer["BackgroundJobSystem"]</h1>
                <p class="text-muted mb-4 pe-lg-5">@Localizer["BackgroundJobSystemDesc"]</p>
                
                <button onclick="refreshStatistics()" class="btn-modern-primary d-inline-flex">
                    <i data-lucide="refresh-cw" class="w-4 h-4 me-2"></i>
                    @Localizer["RefreshStats"]
                </button>
            </div>
            <div class="col-12 col-lg-4 bg-light bg-opacity-30 border-start border-light p-4 p-md-5 d-flex flex-column justify-content-center">
                <div class="row g-4">
                    <div class="col-6 col-lg-12">
                        <div class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-1">@Localizer["Processing"]</div>
                        <div class="display-6 fw-black">@Model.JobStatistics.ProcessingCount.ToString("D2")</div>
                    </div>
                    <div class="col-6 col-lg-12">
                        <div class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-1">@Localizer["Queued"]</div>
                        <div class="display-6 fw-black">@Model.JobStatistics.EnqueuedCount.ToString("D2")</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-3 mb-4">
        @foreach (var action in new[] { 
            new { Icon = "wrench", Title = Localizer["RunMaintenance"], Desc = Localizer["RunMaintenanceDesc"], Color = "primary", Action = "RunMaintenance", Confirm = Localizer["RunMaintenanceConfirm"] },
            new { Icon = "rss", Title = Localizer["UpdateFeeds"], Desc = Localizer["UpdateFeedsDesc"], Color = "success", Action = "UpdateFeeds", Confirm = Localizer["UpdateFeedsConfirm"] },
            new { Icon = "trophy", Title = Localizer["ProcessGamification"], Desc = Localizer["ProcessGamificationDesc"], Color = "info", Action = "ProcessGamification", Confirm = Localizer["ProcessGamificationConfirm"] },
            new { Icon = "mail", Title = Localizer["SendEmailDigest"], Desc = Localizer["SendEmailDigestDesc"], Color = "warning", Action = "SendEmailDigest", Confirm = Localizer["SendEmailDigestConfirm"] }
        })
        {
            <div class="col-12 col-sm-6 col-xl-3">
                <div class="card-modern h-100 d-flex flex-column">
                    <div class="w-10 h-10 rounded-3 bg-@action.Color bg-opacity-10 text-@action.Color d-flex align-items-center justify-content-center mb-3">
                        <i data-lucide="@action.Icon" class="w-5 h-5"></i>
                    </div>
                    <h4 class="small fw-bold mb-2">@action.Title</h4>
                    <p class="xx-small text-muted mb-4 flex-grow-1">@action.Desc</p>
                    <form asp-action="@action.Action" method="post">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-light w-100 rounded-pill xx-small fw-bold border-0 shadow-sm py-2" onclick="return confirm('@action.Confirm')">
                            @Localizer["Execute"]
                        </button>
                    </form>
                </div>
            </div>
        }
    </div>

    <!-- Job Statistics Grid -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-md-4">
            <div class="card-modern">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="xx-small fw-bold text-muted text-uppercase tracking-wider">@Localizer["SucceededJobs"]</h4>
                    <div class="w-8 h-8 rounded-pill bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="display-6 fw-black mb-2">@Model.JobStatistics.SucceededCount.ToString("N0")</div>
                <div class="progress" style="height: 3px; background: rgba(0,0,0,0.05)">
                    <div class="progress-bar bg-success" style="width: 85%"></div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card-modern">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="xx-small fw-bold text-muted text-uppercase tracking-wider">@Localizer["FailedJobs"]</h4>
                    <div class="w-8 h-8 rounded-pill bg-danger bg-opacity-10 text-danger d-flex align-items-center justify-content-center">
                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="display-6 fw-black mb-2">@Model.JobStatistics.FailedCount.ToString("N0")</div>
                <div class="progress" style="height: 3px; background: rgba(0,0,0,0.05)">
                    <div class="progress-bar bg-danger" style="width: 15%"></div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card-modern">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h4 class="xx-small fw-bold text-muted text-uppercase tracking-wider">@Localizer["ScheduledJobs"]</h4>
                    <div class="w-8 h-8 rounded-pill bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                    </div>
                </div>
                <div class="display-6 fw-black mb-2">@Model.JobStatistics.ScheduledCount.ToString("N0")</div>
                <div class="progress" style="height: 3px; background: rgba(0,0,0,0.05)">
                    <div class="progress-bar bg-primary" style="width: 45%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="card-modern p-4 p-md-5">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
            <h3 class="h5 fw-black mb-0 d-flex align-items-center gap-2">
                <span class="badge bg-primary text-white rounded-pill px-2 py-1 xx-small">@Model.RecentJobs.Count</span>
                @Localizer["RecentJobActivity"]
            </h3>
            <a href="@Url.Action("RecurringJobs")" class="text-decoration-none xx-small fw-bold text-uppercase tracking-wider text-muted hover-primary">
                <i data-lucide="calendar" class="w-4 h-4 me-1"></i>
                @Localizer["ViewRecurringJobs"]
            </a>
        </div>

        @if (Model.RecentJobs.Any())
        {
            <div class="list-group list-group-flush border-0">
                @foreach (var job in Model.RecentJobs.Take(10))
                {
                    <div class="list-group-item bg-transparent border-light px-0 py-3">
                        <div class="d-flex align-items-start gap-3">
                            <div class="w-10 h-10 rounded-3 bg-@(job.State == "Succeeded" ? "success" : "danger") bg-opacity-10 text-@(job.State == "Succeeded" ? "success" : "danger") d-flex align-items-center justify-content-center flex-shrink-0">
                                <i data-lucide="@(job.State == "Succeeded" ? "check" : "x")" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-grow-1 min-w-0">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <span class="small fw-bold text-truncate pe-2">@job.Method</span>
                                    <span class="xx-small text-muted flex-shrink-0">@job.CreatedAt?.ToString("HH:mm:ss")</span>
                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <span class="badge bg-@(job.State == "Succeeded" ? "success" : "danger")-subtle text-@(job.State == "Succeeded" ? "success" : "danger") xx-small rounded-pill border-0 px-2 py-0.5">
                                        @Localizer[job.State]
                                    </span>
                                    @if (job.Duration.HasValue)
                                    {
                                        <span class="xx-small text-muted"><i data-lucide="timer" class="w-3 h-3 me-1"></i> @job.Duration.Value.TotalSeconds.ToString("F1")s</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="py-5 text-center bg-light bg-opacity-30 rounded-4 border-2 border-dashed border-light">
                <i data-lucide="activity" class="w-10 h-10 text-muted opacity-20 mb-3"></i>
                <h4 class="h6 fw-bold mb-1">@Localizer["NoRecentActivity"]</h4>
                <p class="xx-small text-muted text-uppercase tracking-wider">@Localizer["NoRecentActivityDesc"]</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function refreshStatistics() {
            $.get('@Url.Action("GetStatistics")', function(data) {
                if (data.error) {
                    toastr.error(data.error);
                    return;
                }
                
                // Update statistics display
                location.reload(); // Simple refresh for now
                
                toastr.success('Statistics refreshed successfully');
            }).fail(function() {
                toastr.error('Failed to refresh statistics');
            });
        }
        
        // Auto-refresh every 30 seconds
        setInterval(refreshStatistics, 30000);
    </script>
}