@model CommunityCar.Application.Features.Dashboard.ViewModels.Cache.CacheKeysViewModel
@{
    ViewData["Title"] = "Cache Registry - Key Explorer";
    ViewData["PageHeader"] = "Cache Registry";
    ViewData["PageDescription"] = "Browse and manage cache key infrastructure";
}

@Html.AntiForgeryToken()

<div class="animate-slide-up">
    <!-- Breadcrumb Protocol -->
    <nav class="d-flex align-items-center gap-2 xx-small fw-bold text-uppercase tracking-wider text-muted opacity-50 mb-3 px-1">
        <a href="@Url.Action("Index")" class="text-decoration-none text-reset hover-primary">
            System Cache
        </a>
        <span>/</span>
        <span>Key Registry Explorer</span>
    </nav>

    <!-- Search Protocol Interface -->
    <div class="card-modern p-0 overflow-hidden mb-4">
        <div class="row g-0">
            <div class="col-12 col-lg-8 p-4 p-md-5">
                <div class="d-flex align-items-center gap-2 mb-3">
                    <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-1 xx-small fw-bold border border-primary border-opacity-10">
                        <i data-lucide="search" class="w-3 h-3 me-1"></i> Pattern Search
                    </span>
                </div>
                <h1 class="display-6 fw-black mb-4">Cache Key Registry</h1>

                <form method="get" asp-action="ViewKeys">
                    <div class="d-flex flex-column flex-md-row gap-2 bg-light bg-opacity-50 p-2 rounded-4">
                        <input type="text" name="pattern" value="@Model.Pattern" class="form-control border-0 bg-transparent px-3 py-2 small" placeholder="Initialize pattern search protocol (e.g., user:*, *)">
                        <button type="submit" class="btn-modern-primary py-2 px-4 flex-shrink-0">
                            <i data-lucide="search" class="w-4 h-4 me-2"></i> Execute Search
                        </button>
                    </div>
                    
                    <div class="mt-3 ps-1">
                        <span class="xx-small fw-bold text-muted text-uppercase tracking-wider">Pattern Examples:</span>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <code class="xx-small fw-bold text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">user:*</code>
                            <code class="xx-small fw-bold text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">feed:trending:*</code>
                            <code class="xx-small fw-bold text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">gamification:leaderboard:*</code>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-12 col-lg-4 bg-light bg-opacity-30 border-start border-light p-4 p-md-5 d-flex flex-column justify-content-center">
                <div class="row g-4">
                    <div class="col-6 col-lg-12">
                        <div class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-1">Keys Located</div>
                        <div class="display-6 fw-black">@Model.TotalCount.ToString("D2")</div>
                    </div>
                    <div class="col-6 col-lg-12">
                        <div class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-1">Active Pattern</div>
                        <div class="display-6 fw-black text-truncate" title="@Model.Pattern">@Model.Pattern</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Registry Data Stream -->
    <div class="card-modern p-0 overflow-hidden">
        <div class="p-4 border-b border-light d-flex justify-content-between align-items-center">
            <h3 class="h6 fw-bold mb-0 d-flex align-items-center gap-2">
                <span class="badge bg-primary text-white rounded-pill px-2 py-1 xx-small">@Model.TotalCount</span>
                Registry Entries
            </h3>
            <div class="d-none d-md-flex align-items-center gap-2 xx-small fw-bold text-uppercase text-muted opacity-50">
                Pattern: <span class="text-primary">@Model.Pattern</span>
            </div>
        </div>

        <div class="p-4 p-md-5">
            @if (Model.Keys.Any())
            {
                <div class="row g-3">
                    @for (int i = 0; i < Model.Keys.Count; i++)
                    {
                        var key = Model.Keys[i];
                        var category = key.Split(':').FirstOrDefault() ?? "Unknown";
                        var color = GetCategoryColor(category);
                        
                        <div class="col-12">
                            <div class="card border-0 bg-light bg-opacity-30 rounded-4 p-3 hover-shadow-sm transition-all mb-3">
                                <div class="row align-items-center g-3">
                                    <div class="col-auto d-none d-md-block">
                                        <div class="display-6 fw-black opacity-10">@(i + 1).ToString("D2")</div>
                                    </div>
                                    <div class="col">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <div class="w-8 h-8 rounded-3 bg-@color bg-opacity-10 text-@color d-flex align-items-center justify-content-center">
                                                <i data-lucide="@GetCategoryIcon(category)" class="w-4 h-4"></i>
                                            </div>
                                            <div>
                                                <span class="xx-small fw-bold text-uppercase tracking-wider text-muted opacity-50">@category.ToUpper() NAMESPACE</span>
                                            </div>
                                        </div>
                                        <div class="bg-white rounded-3 px-3 py-2 small font-monospace break-all text-dark shadow-sm">
                                            @key
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-auto">
                                        <div class="d-flex gap-2 justify-content-md-end">
                                            <button onclick="inspectKey('@key')" class="btn btn-sm btn-light rounded-pill xx-small fw-bold flex-grow-1 flex-md-grow-0 px-3"><i data-lucide="eye" class="w-3 h-3 me-1"></i> Inspect</button>
                                            <button onclick="deleteKey('@key')" class="btn btn-sm btn-light rounded-pill xx-small fw-bold flex-grow-1 flex-md-grow-0 px-3 text-danger"><i data-lucide="trash-2" class="w-3 h-3 me-1"></i> Purge</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                @if (Model.TotalCount > 100)
                {
                    <div class="mt-4 p-3 bg-primary bg-opacity-10 rounded-4 border border-primary border-opacity-10 d-flex align-items-center gap-3">
                        <i data-lucide="info" class="text-primary w-5 h-5"></i>
                        <span class="xx-small fw-bold text-uppercase text-primary">Displaying first 100 entries. Refine pattern for more results.</span>
                    </div>
                }
            }
            else
            {
                <div class="py-5 text-center bg-light bg-opacity-30 rounded-4 border-2 border-dashed border-light">
                    <i data-lucide="search-x" class="w-10 h-10 text-muted opacity-20 mb-3"></i>
                    <h4 class="h6 fw-bold mb-1">No Registry Entries Located</h4>
                    <p class="xx-small text-muted text-uppercase tracking-wider">Pattern "@Model.Pattern" returned zero matches.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Key Inspector Modal -->
<div class="modal fade" id="keyInspectorModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-body p-4 p-md-5">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <div class="d-flex align-items-center gap-3">
                        <div class="w-12 h-12 bg-primary bg-opacity-10 text-primary rounded-3 d-flex align-items-center justify-content-center">
                            <i data-lucide="eye" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="h5 fw-black mb-1">Registry Inspector</h3>
                            <p class="xx-small text-muted text-uppercase tracking-wider mb-0 px-1">Protocol Analysis for cached key</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-2 d-inline-block">Registry Key</label>
                        <div class="bg-light rounded-3 p-3 font-monospace small break-all shadow-sm">
                            <span id="inspected-key"></span>
                        </div>
                    </div>
                    <div>
                        <label class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-2 d-inline-block">Cached Payload</label>
                        <div class="bg-dark rounded-3 p-3 font-monospace small text-success shadow-inner" style="max-height: 400px; overflow-y: auto;">
                            <pre id="inspected-value" class="mb-0 whitespace-pre-wrap"></pre>
                        </div>
                    </div>
                    <div>
                        <label class="xx-small fw-bold text-muted text-uppercase tracking-wider mb-2 d-inline-block">TTL Status</label>
                        <div class="bg-light rounded-3 p-3 small shadow-sm d-flex align-items-center gap-2">
                            <i data-lucide="timer" class="w-4 h-4 text-primary"></i>
                            <span id="inspected-ttl"></span>
                        </div>
                    </div>
                </div>

                <div class="row g-2 mt-4">
                    <div class="col-12 col-md-6 order-2 order-md-1">
                        <button type="button" class="btn btn-light w-100 rounded-pill xx-small fw-bold py-2 shadow-sm border-0" data-bs-dismiss="modal">Close Inspector</button>
                    </div>
                    <div class="col-12 col-md-6 order-1 order-md-2">
                        <button type="button" class="btn btn-danger w-100 rounded-pill xx-small fw-bold py-2 shadow-sm text-white border-0" onclick="deleteInspectedKey()"><i data-lucide="trash-2" class="w-3 h-3 me-2"></i> Purge Entry</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function inspectKey(key) {
            $('#inspected-key').text(key);
            $('#inspected-value').text('Loading cache payload...');
            $('#inspected-ttl').text('Analyzing TTL status...');
            const modal = new bootstrap.Modal(document.getElementById('keyInspectorModal'));
            modal.show();
            
            $.get('@Url.Action("GetKeyValue")/' + encodeURIComponent(key))
                .done(function(data) {
                    if (data.error) {
                        $('#inspected-value').text('Error: ' + data.error);
                        $('#inspected-ttl').text('N/A');
                    } else {
                        $('#inspected-value').text(JSON.stringify(data.value, null, 2));
                        $('#inspected-ttl').text(data.ttl ? data.ttl + ' seconds remaining' : 'No expiration configured');
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                })
                .fail(function() {
                    $('#inspected-value').text('Failed to retrieve cache payload');
                    $('#inspected-ttl').text('N/A');
                });
        }
        
        function deleteKey(key) {
            if (!confirm('Confirm purge operation for registry key "' + key + '"? This action is irreversible.')) return;
            
            $.ajax({
                url: '@Url.Action("DeleteKey")/' + encodeURIComponent(key),
                type: 'DELETE',
                headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
                success: function(data) {
                    if (data.success) {
                        toastr.success('Registry entry purged successfully');
                        location.reload();
                    } else {
                        toastr.error(data.error || 'Failed to purge registry entry');
                    }
                }
            });
        }
        
        function deleteInspectedKey() {
            var key = $('#inspected-key').text();
            bootstrap.Modal.getInstance(document.getElementById('keyInspectorModal')).hide();
            deleteKey(key);
        }
    </script>
}

@functions {
    private string GetCategoryColor(string category)
    {
        return category.ToLower() switch
        {
            "user" => "primary",
            "profile" => "info",
            "feed" => "success",
            "community" => "warning",
            "gamification" => "primary",
            "content" => "secondary",
            "reference" => "dark",
            _ => "muted"
        };
    }
    
    private string GetCategoryIcon(string category)
    {
        return category.ToLower() switch
        {
            "user" => "user",
            "profile" => "user-circle",
            "feed" => "rss",
            "community" => "users",
            "gamification" => "trophy",
            "content" => "file-text",
            "reference" => "database",
            _ => "key"
        };
    }
}
