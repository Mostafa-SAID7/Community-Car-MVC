@model CommunityCar.Application.Features.Dashboard.ViewModels.OverviewVM
@{
    ViewData["Title"] = Localizer["DashboardOverview"];
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}
@inject IViewLocalizer Localizer

<div class="space-y-8 animate-in fade-in duration-700">
    <div id="dashboard-skeleton" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <skeleton type="Card" />
        <skeleton type="Card" />
        <skeleton type="Card" />
        <skeleton type="Card" />
    </div>

    <!-- Stats Cards Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-content">
        <div class="eng-stat-group">
            <div class="eng-stat-icon-wrap bg-blue-500 shadow-blue-500/20">
                <i class="fas fa-users text-lg"></i>
            </div>
            <div class="flex-1">
                <div class="eng-stat-value">@Model.Stats.TotalUsers.ToString("N0")</div>
                <div class="eng-stat-label">@Localizer["TotalUsers"]</div>
                <div class="eng-stat-delta text-green-500">
                    <i class="fas fa-arrow-up mr-1 text-[8px]"></i> +@Model.Stats.GrowthRate% <span class="opacity-60 font-bold">@Localizer["ThisMonth"]</span>
                </div>
            </div>
        </div>

        <div class="eng-stat-group">
            <div class="eng-stat-icon-wrap bg-green-500 shadow-green-500/20">
                <i class="fas fa-edit text-lg"></i>
            </div>
            <div class="flex-1">
                <div class="eng-stat-value">@Model.Stats.TotalPosts.ToString("N0")</div>
                <div class="eng-stat-label">@Localizer["TotalPosts"]</div>
                <div class="eng-stat-delta text-muted-foreground opacity-60">
                    @Localizer["ActiveToday"]: <span class="text-foreground">@Model.Stats.ActiveUsersToday</span>
                </div>
            </div>
        </div>

        <div class="eng-stat-group">
            <div class="eng-stat-icon-wrap bg-indigo-500 shadow-indigo-500/20">
                <i class="fas fa-comments text-lg"></i>
            </div>
            <div class="flex-1">
                <div class="eng-stat-value">@Model.Stats.TotalComments.ToString("N0")</div>
                <div class="eng-stat-label">@Localizer["TotalComments"]</div>
                <div class="eng-stat-delta text-indigo-500">
                    @Localizer["Engagement"]: <span class="font-bold">@Model.Stats.EngagementRate%</span>
                </div>
            </div>
        </div>

        <div class="eng-stat-group">
            <div class="eng-stat-icon-wrap bg-amber-500 shadow-amber-500/20">
                <i class="fas fa-question-circle text-lg"></i>
            </div>
            <div class="flex-1">
                <div class="eng-stat-value">@(Model.Stats.TotalQuestions + Model.Stats.TotalAnswers)</div>
                <div class="eng-stat-label">@Localizer["QAItems"]</div>
                <div class="eng-stat-delta text-amber-600 dark:text-amber-400 opacity-80">
                    @Model.Stats.TotalQuestions Q / @Model.Stats.TotalAnswers A
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 eng-card overflow-hidden group/chart">
            <div class="eng-card-header">
                <h5 class="eng-card-title">User Growth</h5>
                <div class="inline-flex p-1 bg-background/50 rounded-lg border border-border/40 shadow-inner">
                    <button type="button"
                        class="px-3 py-1 text-[10px] font-black rounded-md transition-all active bg-primary text-primary-foreground shadow-sm"
                        data-period="7">7D</button>
                    <button type="button"
                        class="px-3 py-1 text-[10px] font-black rounded-md transition-all text-muted-foreground hover:text-foreground"
                        data-period="30">30D</button>
                    <button type="button"
                        class="px-3 py-1 text-[10px] font-black rounded-md transition-all text-muted-foreground hover:text-foreground"
                        data-period="90">90D</button>
                </div>
            </div>
            <div class="p-6">
                <canvas id="userGrowthChart" class="w-full h-[300px]"></canvas>
            </div>
        </div>

        <div class="eng-card overflow-hidden group/health">
            <div class="eng-card-header">
                <h5 class="eng-card-title">System Health</h5>
            </div>
            <div class="p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h6 class="text-[10px] font-black uppercase tracking-tighter text-muted-foreground">Status</h6>
                    <span
                        class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-current/20 @(Model.SystemHealth.IsHealthy ? "bg-green-500/10 text-green-500" : "bg-red-500/10 text-red-500 animate-pulse")">
                        <div
                            class="w-1.5 h-1.5 rounded-full bg-current @(Model.SystemHealth.IsHealthy ? "" : "animate-ping")">
                        </div>
                        @(Model.SystemHealth.IsHealthy ? "Healthy" : "Issues Detected")
                    </span>
                </div>

                <div class="space-y-4">
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-bold uppercase tracking-widest opacity-60">CPU Usage</span>
                            <span class="text-sm font-black tabular-nums">@Model.SystemHealth.CpuUsage%</span>
                        </div>
                        <div class="eng-progress-container">
                            <div class="eng-progress-bar @(Model.SystemHealth.CpuUsage > 70 ? "bg-red-500" : Model.SystemHealth.CpuUsage > 50 ? "bg-amber-500" : "bg-green-500") w-[@Model.SystemHealth.CpuUsage%]"
                                ></div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-bold uppercase tracking-widest opacity-60">Memory Usage</span>
                            <span class="text-sm font-black tabular-nums">@Model.SystemHealth.MemoryUsage%</span>
                        </div>
                        <div class="eng-progress-container">
                            <div class="eng-progress-bar @(Model.SystemHealth.MemoryUsage > 80 ? "bg-red-500" : Model.SystemHealth.MemoryUsage > 60 ? "bg-amber-500" : "bg-green-500") w-[@Model.SystemHealth.MemoryUsage%]"
                                ></div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <span class="text-[10px] font-bold uppercase tracking-widest opacity-60">Disk Usage</span>
                            <span class="text-sm font-black tabular-nums">@Model.SystemHealth.DiskUsage%</span>
                        </div>
                        <div class="eng-progress-container">
                            <div class="eng-progress-bar @(Model.SystemHealth.DiskUsage > 85 ? "bg-red-500" : Model.SystemHealth.DiskUsage > 70 ? "bg-amber-500" : "bg-green-500") w-[@Model.SystemHealth.DiskUsage%]"
                                ></div>
                        </div>
                    </div>
                </div>

                <div class="pt-4 mt-6 border-t border-border/30">
                    <div
                        class="flex items-center gap-2 text-[10px] font-bold text-muted-foreground uppercase opacity-60">
                        <i class="fas fa-clock text-[8px]"></i> Last check: <span
                            class="text-foreground">@Model.SystemHealth.LastCheck.ToString("HH:mm")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div
            class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-md overflow-hidden transition-all hover:border-primary/10">
            <div class="p-4 border-b border-border/50 bg-muted/20 flex justify-between items-center px-6">
                <h5 class="text-xs font-black uppercase tracking-widest text-foreground">@Localizer["RecentActivity"]</h5>
                <button class="p-1.5 rounded-lg hover:bg-background/50 hover:text-primary transition-all group/refresh"
                    onclick="refreshActivity()">
                    <i class="fas fa-sync-alt text-xs group-hover:rotate-180 transition-transform duration-500"></i>
                </button>
            </div>
            <div class="p-6 relative">
                <div id="activity-skeleton" class="hidden absolute inset-0 bg-background/50 backdrop-blur-sm z-10 flex flex-col p-6 gap-4">
                    <skeleton type="Line" />
                    <skeleton type="Line" />
                    <skeleton type="Line" />
                    <skeleton type="Line" />
                </div>
                <div class="divide-y divide-border/30 max-h-[400px] overflow-y-auto no-scrollbar" id="activityList">
                    @foreach (var activity in Model.RecentActivity)
                    {
                        <div class="flex items-center gap-4 p-4 hover:bg-muted/30 transition-colors group/activity cursor-default">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-[10px] shadow-lg group-hover/activity:scale-110 transition-transform @(activity.Color == "blue" ? "bg-blue-500" : activity.Color == "green" ? "bg-green-500" : activity.Color == "amber" ? "bg-amber-500" : "bg-red-500")">
                                <i class="@activity.Icon"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-[13px] font-bold text-foreground leading-snug truncate">@activity.Description</div>
                                <div class="flex items-center gap-2 mt-0.5 text-[10px] font-bold text-muted-foreground uppercase opacity-60">
                                    <span class="text-primary/80">@activity.UserName</span>
                                    <span>â€¢</span>
                                    <span>@activity.TimeAgo</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div
            class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-md overflow-hidden transition-all hover:border-primary/10">
            <div class="p-4 border-b border-border/50 bg-muted/20 px-6">
                <h5 class="text-xs font-black uppercase tracking-widest text-foreground">@Localizer["TopContent"]</h5>
            </div>
            <div class="divide-y divide-border/30">
                @foreach (var content in Model.TopContent)
                {
                    <div class="p-4 hover:bg-muted/30 transition-colors group/content cursor-default">
                        <div class="flex items-start justify-between gap-4 mb-2">
                            <div class="min-w-0">
                                <h6
                                    class="text-[13px] font-black text-foreground truncate group-hover/content:text-primary transition-colors">
                                    @content.Title</h6>
                                <div class="flex items-center gap-2 mt-1">
                                    <span
                                        class="inline-flex px-1.5 py-0.5 rounded-full text-[8px] font-black bg-muted border border-border/50 uppercase tracking-tighter text-muted-foreground group-hover/content:bg-primary/10 group-hover/content:text-primary transition-colors">@content.Type</span>
                                    <span class="text-[9px] font-bold text-muted-foreground opacity-60">by
                                        @content.AuthorName</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="flex items-center gap-4 text-[10px] font-black text-muted-foreground uppercase tracking-widest opacity-50 mt-1">
                            <div class="flex items-center gap-1"><i class="fas fa-eye text-[8px]"></i> @content.Views</div>
                            <div class="flex items-center gap-1"><i
                                    class="fas fa-heart text-[8px] text-red-500/60 group-hover/content:text-red-500 transition-colors"></i>
                                @content.Likes</div>
                            <div class="flex items-center gap-1"><i class="fas fa-comment text-[8px]"></i> @content.Comments
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div
            class="bg-card/40 backdrop-blur-md border border-border rounded-2xl shadow-md overflow-hidden transition-all hover:border-primary/10">
            <div class="p-4 border-b border-border/50 bg-muted/20 px-6">
                <h5 class="text-xs font-black uppercase tracking-widest text-foreground">@Localizer["ActiveUsers"]</h5>
            </div>
            <div class="divide-y divide-border/30">
                @foreach (var user in Model.ActiveUsers)
                {
                    <div class="flex items-center gap-4 p-4 hover:bg-muted/30 transition-colors group/user cursor-default">
                        <div
                            class="w-10 h-10 rounded-full bg-muted flex items-center justify-center overflow-hidden border border-border relative shadow-inner font-black text-xs group-hover/user:ring-2 group-hover/user:ring-primary/20 transition-all shrink-0">
                            @if (!string.IsNullOrEmpty(user.ProfilePictureUrl))
                            {
                                <img src="@user.ProfilePictureUrl" alt="@user.UserName" class="w-full h-full object-cover" />
                            }
                            else
                            {
                                <div class="w-full h-full flex items-center justify-center text-muted-foreground uppercase">
                                    @user.UserName.Substring(0, 1)
                                </div>
                            }
                            @if (user.IsOnline)
                            {
                                <div
                                    class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-background rounded-full ring-1 ring-border shadow-sm">
                                </div>
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <div
                                class="text-[13px] font-black text-foreground group-hover/user:text-primary transition-colors truncate">
                                @user.UserName</div>
                            <div
                                class="text-[10px] font-bold text-muted-foreground opacity-60 uppercase tracking-tighter truncate">
                                @user.LastActivityText</div>
                        </div>
                        <div class="text-right shrink-0">
                            <div class="text-sm font-black text-foreground tabular-nums">@user.PostsCount</div>
                            <div class="text-[8px] font-black text-muted-foreground uppercase tracking-widest opacity-50">
                                Posts</div>
                        </div>
                    </div>
                }
            </div>
        </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Use custom styling for Chart.js to match Tailwind theme
        const rootStyles = getComputedStyle(document.documentElement);
        const gridColor = `hsla(${rootStyles.getPropertyValue('--chart-grid').trim()}, 0.5)`;
        const textColor = `hsl(${rootStyles.getPropertyValue('--muted-foreground').trim()})`;
        const primaryColor = `hsl(${rootStyles.getPropertyValue('--chart-primary').trim()})`;

        const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
        const userGrowthChart = new Chart(userGrowthCtx, {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(Model.UserGrowthChart.Select(x => x.Label))),
                datasets: [{
                    label: 'New Users',
                    data: @Html.Raw(Json.Serialize(Model.UserGrowthChart.Select(x => x.Value))),
                    borderColor: primaryColor,
                    backgroundColor: `hsla(${rootStyles.getPropertyValue('--chart-primary').trim()}, 0.1)`,
                    borderWidth: 3,
                    pointBackgroundColor: rootStyles.getPropertyValue('--background'),
                    pointBorderColor: primaryColor,
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: rootStyles.getPropertyValue('--card'),
                        titleColor: rootStyles.getPropertyValue('--foreground'),
                        bodyColor: rootStyles.getPropertyValue('--muted-foreground'),
                        borderColor: rootStyles.getPropertyValue('--border'),
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        usePointStyle: true,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: gridColor, drawBorder: false },
                        ticks: { font: { weight: 'bold', size: 10 }, color: textColor, padding: 8 }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { weight: 'bold', size: 10 }, color: textColor, padding: 8 }
                    }
                }
            }
        });

        function refreshActivity() {
            const skeleton = document.getElementById('activity-skeleton');
            skeleton.classList.remove('hidden');
            
            // Simulate API call
            setTimeout(() => {
                skeleton.classList.add('hidden');
                console.log('Activity refreshed');
            }, 1000);
        }

        setInterval(refreshActivity, 30000);
    </script>
}