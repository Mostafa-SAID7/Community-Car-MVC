@inject IViewLocalizer Localizer
@model CommunityCar.Application.Features.SEO.ViewModels.PerformanceMetricsVM
@{
    ViewData["Title"] = Localizer["PerformanceDashboardTitle"];
    Layout = "_DashboardLayout";
}

<div class="d-flex flex-column gap-5 animate-in fade-in duration-700">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4">
        <div>
            <h1 class="h2 fw-black text-gradient-red mb-1">@Localizer["PerformanceEngineering"]</h1>
            <p class="small fw-bold text-muted opacity-70">@Localizer["PerformanceEngineeringDesc"]</p>
        </div>
        <div class="d-inline-flex align-items-center gap-2 px-3 py-2 bg-muted bg-opacity-5 rounded-3 border border-border xx-small fw-black text-muted text-uppercase tracking-widest shadow-sm">
            <div class="w-8px h-8px rounded-circle bg-success animate-pulse"></div>
            @Localizer["RealTimeMonitoringActive"]
        </div>
    </div>

    <div id="performance-skeleton" class="d-none">
        <div class="row g-4 mb-5">
            <div class="col-12 col-md-4"><skeleton type="Card" /></div>
            <div class="col-12 col-md-4"><skeleton type="Card" /></div>
            <div class="col-12 col-md-4"><skeleton type="Card" /></div>
        </div>
    </div>

    <div id="performance-content" class="d-flex flex-column gap-5">
    @if (Model?.CoreWebVitals != null)
    {
        <div class="row g-4">
            <!-- LCP -->
            <div class="col-12 col-md-4">
                <div class="card card-premium shadow-lg h-100 text-center p-4 group transition-all hover-border-primary border-opacity-20 animate-float" style="animation-delay: 0.1s">
                    <h3 class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60 mb-4">@Localizer["LCPTitle"]</h3>
                    <div class="position-relative w-128px h-128px mx-auto mb-4 d-flex align-items-center justify-content-center">
                        <svg class="w-100 h-100 rotate-n90" viewBox="0 0 100 100">
                            <circle class="text-muted opacity-10" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                            <circle class="@(Model.CoreWebVitals.LCPGrade == "Good" ? "text-success" : "text-warning")" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="@(251.2 * (1 - Math.Min((double)Model.CoreWebVitals.LCP / 4000.0, 1.0)))" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                        </svg>
                        <div class="position-absolute d-flex flex-column align-items-center justify-content-center">
                            <span class="h3 fw-black text-foreground tabular-nums mb-0">@Model.CoreWebVitals.LCP.ToString("N0")</span>
                            <span class="xx-small fw-black text-uppercase text-muted">@Localizer["ms"]</span>
                        </div>
                    </div>
                    <div>
                        <span class="badge rounded-pill px-3 py-2 xx-small fw-black text-uppercase tracking-widest @(Model.CoreWebVitals.LCPGrade == "Good" ? "bg-success bg-opacity-10 text-success border border-success border-opacity-20" : "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-20")">
                            @string.Format(Localizer["GradeLabel"].Value, Model.CoreWebVitals.LCPGrade)
                        </span>
                    </div>
                    <p class="xx-small fw-bold text-muted mt-3 opacity-70 mb-0">@Localizer["LCPDesc"]</p>
                </div>
            </div>

            <!-- FID -->
            <div class="col-12 col-md-4">
                <div class="card card-premium shadow-lg h-100 text-center p-4 group transition-all hover-border-primary border-opacity-20 animate-float" style="animation-delay: 0.2s">
                    <h3 class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60 mb-4">@Localizer["FIDTitle"]</h3>
                    <div class="position-relative w-128px h-128px mx-auto mb-4 d-flex align-items-center justify-content-center">
                        <svg class="w-100 h-100 rotate-n90" viewBox="0 0 100 100">
                            <circle class="text-muted opacity-10" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                            <circle class="@(Model.CoreWebVitals.FIDGrade == "Good" ? "text-success" : "text-warning")" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="@(251.2 * (1 - Math.Min((double)Model.CoreWebVitals.FID / 100.0, 1.0)))" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                        </svg>
                        <div class="position-absolute d-flex flex-column align-items-center justify-content-center">
                            <span class="h3 fw-black text-foreground tabular-nums mb-0">@Model.CoreWebVitals.FID.ToString("F1")</span>
                            <span class="xx-small fw-black text-uppercase text-muted">@Localizer["ms"]</span>
                        </div>
                    </div>
                    <div>
                        <span class="badge rounded-pill px-3 py-2 xx-small fw-black text-uppercase tracking-widest @(Model.CoreWebVitals.FIDGrade == "Good" ? "bg-success bg-opacity-10 text-success border border-success border-opacity-20" : "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-20")">
                            @string.Format(Localizer["GradeLabel"].Value, Model.CoreWebVitals.FIDGrade)
                        </span>
                    </div>
                    <p class="xx-small fw-bold text-muted mt-3 opacity-70 mb-0">@Localizer["FIDDesc"]</p>
                </div>
            </div>

            <!-- CLS -->
            <div class="col-12 col-md-4">
                <div class="card card-premium shadow-lg h-100 text-center p-4 group transition-all hover-border-primary border-opacity-20 animate-float" style="animation-delay: 0.3s">
                    <h3 class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60 mb-4">@Localizer["CLSTitle"]</h3>
                    <div class="position-relative w-128px h-128px mx-auto mb-4 d-flex align-items-center justify-content-center">
                        <svg class="w-100 h-100 rotate-n90" viewBox="0 0 100 100">
                            <circle class="text-muted opacity-10" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                            <circle class="@(Model.CoreWebVitals.CLSGrade == "Good" ? "text-success" : "text-warning")" stroke-width="8" stroke-dasharray="251.2" stroke-dashoffset="@(251.2 * (1 - Math.Min((double)Model.CoreWebVitals.CLS / 0.1, 1.0)))" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                        </svg>
                        <div class="position-absolute d-flex flex-column align-items-center justify-content-center">
                            <span class="h3 fw-black text-foreground tabular-nums mb-0">@Model.CoreWebVitals.CLS.ToString("F3")</span>
                        </div>
                    </div>
                    <div>
                        <span class="badge rounded-pill px-3 py-2 xx-small fw-black text-uppercase tracking-widest @(Model.CoreWebVitals.CLSGrade == "Good" ? "bg-success bg-opacity-10 text-success border border-success border-opacity-20" : "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-20")">
                            @string.Format(Localizer["GradeLabel"].Value, Model.CoreWebVitals.CLSGrade)
                        </span>
                    </div>
                    <p class="xx-small fw-bold text-muted mt-3 opacity-70 mb-0">@Localizer["CLSDesc"]</p>
                </div>
            </div>
        </div>
    }

    <!-- Analysis Tools -->
    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="card card-premium shadow-xl h-100 p-4 border-opacity-10 group hover-border-primary transition-all">
                <h3 class="x-small fw-black text-uppercase tracking-widest text-primary mb-4 d-flex align-items-center gap-2">
                    <i data-lucide="scan-line" class="w-16px h-16px"></i>
                    @Localizer["RuntimeAnalysis"]
                </h3>
                <div class="d-flex flex-column gap-4">
                    <div class="d-flex flex-column gap-2">
                        <label class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60" for="analyzeUrl">@Localizer["TargetURL"]</label>
                        <div class="input-group">
                            <input type="text" id="analyzeUrl" class="form-control bg-background border border-border px-4 py-2 rounded-start-3 text-sm fw-medium shadow-none" placeholder="@Localizer["AnalyzePlaceholder"]" value="/">
                            <button class="btn btn-primary-red px-4 xx-small fw-black text-uppercase tracking-widest shadow-lg" data-action="analyze-performance">@Localizer["Analyze"]</button>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <button class="btn btn-muted bg-opacity-5 border border-border rounded-3 xx-small fw-black text-uppercase tracking-widest text-foreground hover-bg-muted transition-all px-4 py-2" data-action="generate-report">@Localizer["GenerateAudit"]</button>
                        <button class="btn btn-muted bg-opacity-5 border border-border rounded-3 xx-small fw-black text-uppercase tracking-widest text-foreground hover-bg-muted transition-all px-4 py-2" data-action="get-critical-resources">@Localizer["CriticalChain"]</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card card-premium shadow-xl h-100 p-4 border-opacity-10 group hover-border-success transition-all">
                <h3 class="x-small fw-black text-uppercase tracking-widest text-success mb-4 d-flex align-items-center gap-2">
                    <i data-lucide="image" class="w-16px h-16px"></i>
                    @Localizer["AssetOptimization"]
                </h3>
                <form id="imageOptimizationForm" enctype="multipart/form-data" class="d-flex flex-column gap-4">
                    <div class="d-flex flex-column gap-2">
                        <label class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60" for="imageFile">@Localizer["SourceImage"]</label>
                        <input type="file" id="imageFile" name="image" class="form-control form-control-sm bg-background border border-border rounded-3 text-xs fw-medium group-hover-border-success border-opacity-20 transition-all" accept="image/*">
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60" for="quality">@Localizer["QualityLabel"] (%)</label>
                            <input type="number" id="quality" name="Quality" class="form-control bg-background border border-border px-3 py-2 rounded-3 text-sm fw-black shadow-none" value="80" min="1" max="100">
                        </div>
                        <div class="col-6">
                            <label class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60" for="format">@Localizer["Engine"]</label>
                            <select id="format" name="Format" class="form-select bg-background border border-border px-3 py-2 rounded-3 text-sm fw-black shadow-none">
                                <option value="webp">WebP (@Localizer["Recommended"])</option>
                                <option value="avif">AVIF (@Localizer["BestRatio"])</option>
                                <option value="jpeg">Legacy JPEG</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success text-white w-100 rounded-3 xx-small fw-black text-uppercase tracking-widest shadow-lg shadow-success shadow-opacity-20 hover-bg-success active-scale-95 transition-all d-flex align-items-center justify-content-center gap-2 mt-2" data-action="optimize-image">
                        <i data-lucide="check" class="w-14px h-14px"></i>
                        @Localizer["ExecuteOptimization"]
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Issues Listing -->
    <div class="card card-premium shadow-xl overflow-hidden border-opacity-10 shadow-danger shadow-opacity-5">
        <div class="card-header border-bottom border-border border-opacity-50 bg-transparent p-4 d-flex justify-content-between align-items-center">
            <h3 class="xx-small fw-black text-uppercase tracking-widest text-foreground mb-0">@Localizer["IdentifiedBottlenecks"]</h3>
             <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-20 xx-small fw-black text-uppercase tracking-widest px-3 py-2">@string.Format(Localizer["FlagsRaising"].Value, (Model?.Issues?.Count ?? 0))</span>
        </div>
        <div class="card-body p-0">
            <div class="d-flex flex-column divide-y divide-border divide-opacity-20">
                @if (Model?.Issues?.Any() == true)
                {
                    @foreach (var issue in Model.Issues)
                    {
                        <div class="p-4 transition-all group/issue hover-bg-muted hover-bg-opacity-5">
                            <div class="d-flex flex-column gap-3">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge rounded-pill px-3 py-1 xx-small fw-black text-uppercase tracking-widest @(issue.Severity == "High" ? "bg-danger bg-opacity-10 text-danger border border-danger border-opacity-20" : "bg-warning bg-opacity-10 text-warning border border-warning border-opacity-20")">@string.Format(Localizer["SeverityLabel"].Value, issue.Severity)</span>
                                    <span class="xx-small fw-bold text-muted opacity-60 text-uppercase tracking-widest">@string.Format(Localizer["ImpactLabel"].Value, issue.Impact.ToString("F1"))</span>
                                </div>
                                <h4 class="small fw-black text-foreground mb-1">@issue.Message</h4>
                                <div class="font-monospace xx-small text-muted bg-muted bg-opacity-5 p-2 px-3 rounded-3 border border-border border-opacity-50 break-all mb-1">@issue.Resource</div>
                                <div class="bg-success bg-opacity-5 border border-success border-opacity-20 rounded-3 p-3">
                                     <div class="xx-small fw-black text-uppercase tracking-widest text-success mb-1">@Localizer["RecommendedCorrection"]</div>
                                     <div class="text-xs fw-medium text-foreground opacity-90">@issue.Fix</div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="p-5 text-center opacity-30 font-medium d-flex flex-column align-items-center">
                        <i data-lucide="shield-check" class="w-48px h-48px mb-3 text-success"></i>
                        <p class="fst-italic small">@Localizer["NoIssuesDetected"]</p>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div id="resultsContainer" class="d-none animate-in slide-in-from-bottom-5 duration-500 mb-5">
        <div class="card card-premium shadow-2xl overflow-hidden border-primary border-opacity-20 ring-4 ring-primary ring-opacity-5">
            <div class="card-header bg-primary text-white p-3 xx-small fw-black text-uppercase tracking-widest border-0">@Localizer["ProtocolAnalysisLog"]</div>
            <pre id="resultsContent" class="card-body p-4 xx-small font-monospace overflow-auto max-h-400px bg-muted bg-opacity-5 mb-0"></pre>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/modules/dashboard/performance-controller.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (CC.Modules.Dashboard.Performance) {
                CC.Modules.Dashboard.Performance.init();
            }
        });
    </script>
}
