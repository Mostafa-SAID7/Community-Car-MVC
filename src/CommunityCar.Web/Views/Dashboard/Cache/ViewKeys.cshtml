@inject IViewLocalizer Localizer
@model CommunityCar.Application.Features.Dashboard.ViewModels.Cache.CacheKeysViewModel
@{
    ViewData["Title"] = Localizer["CacheRegistryTitle"];
    Layout = "_DashboardLayout";
}

@Html.AntiForgeryToken()

<div class="d-flex flex-column gap-5 animate-in fade-in duration-700">
    <!-- Breadcrumb Protocol -->
    <nav class="d-flex align-items-center gap-2 small text-uppercase fw-bold tracking-wider text-muted opacity-75">
        <a href="@Url.Action("Index", "Dashboard")" class="text-decoration-none text-reset hover-primary transition-all">
            <i data-lucide="layout-dashboard" class="w-14px h-14px me-1"></i> @Localizer["Dashboard"]
        </a>
        <i data-lucide="chevron-right" class="w-12px h-12px opacity-50"></i>
        <a href="@Url.Action("Index")" class="text-decoration-none text-reset hover-primary transition-all">@Localizer["CacheManagement"]</a>
        <i data-lucide="chevron-right" class="w-12px h-12px opacity-50"></i>
        <span class="text-primary">@Localizer["KeyRegistryExplorer"]</span>
    </nav>

    <!-- Search Protocol Interface -->
    <div class="card card-premium overflow-hidden">
        <div class="row g-0">
            <div class="col-lg-8 border-end border-border border-opacity-50">
                <div class="p-4 p-md-5">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-20 px-3 py-2 rounded-pill small fw-bold text-uppercase tracking-widest">
                            <i data-lucide="search" class="w-12px h-12px me-1"></i> @Localizer["PatternSearch"]
                        </span>
                    </div>
                    <h1 class="display-5 fw-black text-gradient-red mb-4">@Localizer["CacheKeyRegistry"]</h1>
                    
                    <form method="get" asp-action="ViewKeys" class="d-flex flex-column gap-4">
                        <div class="input-group input-group-lg shadow-sm rounded-4 overflow-hidden border border-border border-opacity-50">
                            <input type="text" name="pattern" value="@Model.Pattern" class="form-control border-0 bg-muted bg-opacity-5 px-4 fw-medium text-foreground focus-primary" placeholder="@Localizer["SearchPlaceholder"]">
                            <button type="submit" class="btn btn-primary px-4 fw-black text-uppercase tracking-widest small active-scale">
                                <i data-lucide="search" class="w-16px h-16px me-2"></i> @Localizer["ExecuteSearch"]
                            </button>
                        </div>
                        
                        <div class="px-2">
                            <span class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-40">@Localizer["PatternExamples"]:</span>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                <code class="small fw-bold text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">user:*</code>
                                <code class="small fw-bold text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">feed:trending:*</code>
                                <code class="small fw-bold text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">gamification:leaderboard:*</code>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Stats Panel -->
            <div class="col-lg-4 bg-primary bg-opacity-5 d-flex align-items-center p-4 p-md-5">
                <div class="row w-100 g-4">
                    <div class="col-6 lg-col-12">
                        <div class="display-6 fw-black text-primary mb-0">@Model.TotalCount.ToString("D2")</div>
                        <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["KeysLocated"]</div>
                    </div>
                    <div class="col-6 lg-col-12">
                        <div class="display-6 fw-black text-foreground mb-0 text-truncate" title="@Model.Pattern">@Model.Pattern</div>
                        <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["ActivePattern"]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Registry Data Stream -->
    <div class="d-flex flex-column gap-4">
        <div class="d-flex align-items-center justify-content-between px-3">
            <h3 class="h6 fw-black text-uppercase tracking-widest text-muted mb-0">
                <span class="badge bg-primary text-white rounded-pill me-2">@Model.TotalCount</span>
                @Localizer["RegistryEntries"]
            </h3>
            <div class="d-none d-md-flex align-items-center gap-2">
                <span class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-40">@Localizer["PatternFilter"]:</span>
                <span class="badge bg-muted bg-opacity-10 text-muted border border-border border-opacity-50 px-3 py-1 rounded-pill xx-small fw-black text-uppercase tracking-widest">@Model.Pattern</span>
            </div>
        </div>

        @if (Model.Keys.Any())
        {
            <div class="row g-4">
                @for (int i = 0; i < Model.Keys.Count; i++)
                {
                    var key = Model.Keys[i];
                    var category = key.Split(':').FirstOrDefault() ?? "Unknown";
                    
                    <div class="col-12">
                        <div class="card card-premium overflow-hidden transition-all hover-translate-y">
                            <div class="card-body p-4 p-md-5">
                                <div class="row g-4 align-items-center">
                                    <!-- Key Index -->
                                    <div class="col-auto d-none d-md-block">
                                        <div class="d-flex flex-column align-items-center text-center">
                                            <span class="display-6 fw-black text-muted opacity-10">@(i + 1).ToString("D2")</span>
                                        </div>
                                    </div>

                                    <!-- Key Content -->
                                    <div class="col">
                                        <div class="d-flex flex-column gap-4">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="d-flex align-items-center gap-3">
                                                    <div class="w-48px h-48px bg-@GetCategoryColor(category) bg-opacity-10 rounded-4 d-flex align-items-center justify-content-center text-@GetCategoryColor(category)">
                                                        <i data-lucide="@GetCategoryIcon(category)" class="w-24px h-24px"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="h6 fw-black text-foreground mb-1">@string.Format(Localizer["Namespace"].Value, category.ToUpper())</h4>
                                                        <span class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["CacheRegistryEntry"]</span>
                                                    </div>
                                                </div>
                                                <span class="badge bg-@GetCategoryColor(category) bg-opacity-10 text-@GetCategoryColor(category) border border-@GetCategoryColor(category) border-opacity-20 px-3 py-1 rounded-pill xx-small fw-black text-uppercase tracking-widest shadow-sm">
                                                    @category.ToUpper()
                                                </span>
                                            </div>

                                            <div class="p-3 rounded-4 bg-muted bg-opacity-5 border border-border border-opacity-30">
                                                <code class="small fw-black text-foreground break-all">@key</code>
                                            </div>

                                            <div class="d-flex align-items-center gap-4 pt-3 border-top border-border border-opacity-30">
                                                <button onclick="inspectKey('@key')" class="btn btn-link p-0 text-decoration-none small fw-black text-uppercase tracking-widest text-muted hover-primary transition-all d-flex align-items-center gap-2">
                                                    <i data-lucide="eye" class="w-16px h-16px"></i>
                                                    @Localizer["InspectProtocol"]
                                                </button>
                                                <button onclick="deleteKey('@key')" class="btn btn-link p-0 text-decoration-none small fw-black text-uppercase tracking-widest text-muted hover-danger transition-all ms-auto d-flex align-items-center gap-2">
                                                    <i data-lucide="trash-2" class="w-16px h-16px"></i>
                                                    @Localizer["PurgeEntry"]
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            @if (Model.TotalCount > 100)
            {
                <div class="card card-premium bg-primary bg-opacity-5 border-primary border-opacity-10 p-4 mt-4">
                    <div class="d-flex align-items-center gap-4">
                        <div class="w-48px h-48px rounded-4 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center text-primary">
                            <i data-lucide="info" class="w-24px h-24px"></i>
                        </div>
                        <div>
                            <span class="small fw-black text-uppercase tracking-widest text-primary d-block mb-1">@Localizer["RegistryLimitReached"]</span>
                            <span class="small fw-bold text-foreground">@Localizer["RegistryLimitReachedDesc"]</span>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="card card-premium py-5 text-center opacity-75">
                <i data-lucide="search-x" class="w-64px h-64px text-muted mb-4 opacity-10 mx-auto"></i>
                <h4 class="fw-black text-foreground mb-2">@Localizer["NoRegistryEntries"]</h4>
                <p class="small text-muted mb-0 mx-auto max-w-lg">@string.Format(Localizer["NoRegistryEntriesDesc"].Value, Model.Pattern)</p>
            </div>
        }
    </div>
</div>

<!-- Key Inspector Modal -->
<div class="modal fade" id="keyInspectorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content card-premium border-0 shadow-2xl">
            <div class="modal-header border-bottom border-border border-opacity-50 p-4">
                <h5 class="modal-title fw-black d-flex align-items-center gap-2">
                    <i data-lucide="eye" class="text-primary"></i>
                    @Localizer["RegistryInspectorProtocol"]
                </h5>
                <button type="button" class="btn-close btn-close-white opacity-50 transition-all hover-opacity-100" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 p-md-5">
                <div class="d-flex flex-column gap-4">
                    <div class="p-4 rounded-4 bg-muted bg-opacity-5 border border-border border-opacity-30">
                        <span class="xx-small d-block fw-black text-uppercase tracking-widest text-muted opacity-50 mb-2">@Localizer["RegistryKey"]</span>
                        <code class="small fw-bold text-foreground break-all" id="inspected-key"></code>
                    </div>
                    
                    <div class="p-4 rounded-4 bg-muted bg-opacity-5 border border-border border-opacity-30">
                        <span class="xx-small d-block fw-black text-uppercase tracking-widest text-muted opacity-50 mb-3">@Localizer["CachedPayload"]</span>
                        <pre id="inspected-value" class="small text-foreground font-mono mb-0 whitespace-pre-wrap" style="max-height: 300px; overflow-y: auto;"></pre>
                    </div>

                    <div class="p-4 rounded-4 bg-primary bg-opacity-5 border border-primary border-opacity-10">
                        <span class="xx-small d-block fw-black text-uppercase tracking-widest text-primary opacity-75 mb-1">@Localizer["TTLStatus"]</span>
                        <span id="inspected-ttl" class="small fw-bold text-foreground font-mono"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-border border-opacity-50 p-4 d-flex gap-3">
                <button type="button" class="btn btn-secondary px-4 rounded-pill fw-bold text-uppercase tracking-wider small shadow-sm active-scale" data-bs-dismiss="modal">
                    @Localizer["CloseInspector"]
                </button>
                <button type="button" class="btn btn-danger px-4 rounded-pill fw-bold text-uppercase tracking-wider small shadow-sm active-scale ms-auto" onclick="deleteInspectedKey()">
                    <i data-lucide="trash-2" class="w-16px h-16px me-2"></i> @Localizer["PurgeEntry"]
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function inspectKey(key) {
            $('#inspected-key').text(key);
            $('#inspected-value').text('@Localizer["LoadingPayloadJS"]');
            $('#inspected-ttl').text('@Localizer["AnalyzingTTLJS"]');
            const modalElement = document.getElementById('keyInspectorModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
            
            // Get key value and TTL from API
            $.get('@Url.Action("GetKeyValue")/' + encodeURIComponent(key))
                .done(function(data) {
                    if (data.error) {
                        $('#inspected-value').text('Error: ' + data.error);
                        $('#inspected-ttl').text('N/A');
                    } else {
                        $('#inspected-value').text(JSON.stringify(data.value, null, 2));
                        $('#inspected-ttl').text(data.ttl ? data.ttl + ' seconds remaining' : 'No expiration configured');
                    }
                })
                .fail(function() {
                    $('#inspected-value').text('@Localizer["FailedToRetrieveJS"]');
                    $('#inspected-ttl').text('N/A');
                });
        }
        
        function deleteKey(key) {
            if (!confirm('@Localizer["ConfirmPurgeJS"] ' + key + '?')) {
                return;
            }
            
            $.ajax({
                url: '@Url.Action("DeleteKey")/' + encodeURIComponent(key),
                type: 'POST', // MVC often uses POST with [HttpDelete] or dedicated action
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(data) {
                    if (data.success) {
                        CC.Utils.Notifier.success('@Localizer["PurgedSuccessJS"]');
                        location.reload();
                    } else {
                        CC.Utils.Notifier.error(data.error || 'Failed to purge registry entry');
                    }
                },
                error: function() {
                    CC.Utils.Notifier.error('@Localizer["PurgeFailedJS"]');
                }
            });
        }
        
        function deleteInspectedKey() {
            var key = $('#inspected-key').text();
            const modalElement = document.getElementById('keyInspectorModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            deleteKey(key);
        }
    </script>
}

@functions {
    private string GetCategoryColor(string category)
    {
        return category.ToLower() switch
        {
            "user" => "primary",
            "profile" => "info",
            "feed" => "success",
            "community" => "warning",
            "gamification" => "secondary",
            "content" => "dark",
            "reference" => "secondary",
            _ => "muted"
        };
    }
    
    private string GetCategoryIcon(string category)
    {
        return category.ToLower() switch
        {
            "user" => "user",
            "profile" => "user-circle",
            "feed" => "rss",
            "community" => "users",
            "gamification" => "trophy",
            "content" => "file-text",
            "reference" => "database",
            _ => "key"
        };
    }
}
