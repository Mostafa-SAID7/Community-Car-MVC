@inject IViewLocalizer Localizer
@model CommunityCar.Application.Features.Dashboard.ViewModels.Cache.CacheManagementViewModel
@{
    ViewData["Title"] = Localizer["CacheManagementTitle"];
    Layout = "_DashboardLayout";
}

<div class="d-flex flex-column gap-5 animate-in fade-in duration-700">
    <!-- Breadcrumb Protocol -->
    <nav class="d-flex align-items-center gap-2 small text-uppercase fw-bold tracking-wider text-muted opacity-75">
        <a href="@Url.Action("Index", "Dashboard")" class="text-decoration-none text-reset hover-primary transition-all">
            <i data-lucide="layout-dashboard" class="w-14px h-14px me-1"></i> @Localizer["Dashboard"]
        </a>
        <i data-lucide="chevron-right" class="w-12px h-12px opacity-50"></i>
        <span class="text-primary">@Localizer["CacheManagement"]</span>
    </nav>

    <!-- Header Section -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4">
        <div>
            <div class="d-flex align-items-center gap-2 mb-2">
                <span class="badge @(Model.IsRedisConnected ? "bg-success" : "bg-danger") bg-opacity-10 text-@(Model.IsRedisConnected ? "success" : "danger") border border-@(Model.IsRedisConnected ? "success" : "danger") border-opacity-20 px-3 py-2 rounded-pill small fw-bold text-uppercase tracking-widest">
                    <div class="w-6px h-6px rounded-full bg-current d-inline-block me-1 @(Model.IsRedisConnected ? "" : "animate-ping")"></div>
                    @(Model.IsRedisConnected ? Localizer["Connected"] : Localizer["Disconnected"])
                </span>
                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-20 px-3 py-2 rounded-pill small fw-bold text-uppercase tracking-widest">
                    @string.Format(Localizer["CacheEngine"].Value, Model.CacheType)
                </span>
            </div>
            <h1 class="display-5 fw-black text-gradient-red mb-2">@Localizer["CacheManagementHeader"]</h1>
            <p class="text-muted fw-medium border-start border-primary border-4 ps-3">@Localizer["CacheManagementDesc"]</p>
        </div>
        <button onclick="refreshStatistics()" class="btn btn-primary px-4 py-2 rounded-pill fw-bold text-uppercase tracking-wider small shadow-sm active-scale d-flex align-items-center gap-2 group">
            <i data-lucide="refresh-cw" class="w-16px h-16px group-hover-rotate-180 transition-all"></i>
            @Localizer["RefreshStats"]
        </button>
    </div>

    <!-- Cache Overview Card -->
    <div class="card card-premium overflow-hidden">
        <div class="row g-0">
            <div class="col-lg-8 border-end border-border border-opacity-50">
                <div class="p-4 p-md-5">
                    <div class="d-flex align-items-center gap-4">
                        <div class="w-64px h-64px rounded-4 bg-primary bg-opacity-10 d-flex align-items-center justify-content-center text-primary shadow-inner">
                            <i data-lucide="database" class="w-32px h-32px"></i>
                        </div>
                        <div>
                            <h2 class="h4 fw-black text-foreground mb-1">@Localizer["CacheEngineInfra"]</h2>
                            <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-20 rounded-pill xx-small fw-black text-uppercase tracking-widest">
                                @Model.CacheType @Localizer["EngineActive"]
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 bg-primary bg-opacity-5 d-flex align-items-center p-4 p-md-5">
                <div class="row w-100 g-4">
                    <div class="col-6 lg-col-12">
                        <div class="display-6 fw-black text-primary mb-0" id="memory-usage">
                            @(Model.Statistics.ContainsKey("used_memory_human") ? Model.Statistics["used_memory_human"] : "N/A")
                        </div>
                        <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["MemoryUsage"]</div>
                    </div>
                    <div class="col-6 lg-col-12">
                        <div class="display-6 fw-black text-foreground mb-0" id="total-keys">
                            @(Model.Statistics.ContainsKey("db0") ? Model.Statistics["db0"] : "N/A")
                        </div>
                        <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60">@Localizer["TotalKeys"]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Operations Section -->
    <div class="d-flex flex-column gap-4">
        <h3 class="h6 fw-black text-uppercase tracking-widest text-muted px-3 mb-0">@Localizer["CacheOperations"]</h3>
        <div class="row g-4">
            <!-- Warm Up Cache -->
            <div class="col-md-6 col-lg-3">
                <div class="card card-premium h-100 transition-all hover-translate-y">
                    <div class="card-body p-4 d-flex flex-column gap-4">
                        <div class="w-48px h-48px bg-success bg-opacity-10 rounded-4 d-flex align-items-center justify-content-center text-success">
                            <i data-lucide="flame" class="w-24px h-24px"></i>
                        </div>
                        <div>
                            <h4 class="h6 fw-black text-foreground mb-2">@Localizer["WarmUpCache"]</h4>
                            <p class="xx-small text-muted fw-medium leading-relaxed mb-0">@Localizer["WarmUpCacheDesc"]</p>
                        </div>
                        <form asp-action="WarmupCache" method="post" class="mt-auto">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-success w-100 rounded-pill xx-small fw-black text-uppercase tracking-widest active-scale" onclick="return confirm('@Localizer["ConfirmWarmUp"]')">
                                @Localizer["Execute"]
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Clear All Cache -->
            <div class="col-md-6 col-lg-3">
                <div class="card card-premium h-100 transition-all hover-translate-y">
                    <div class="card-body p-4 d-flex flex-column gap-4">
                        <div class="w-48px h-48px bg-danger bg-opacity-10 rounded-4 d-flex align-items-center justify-content-center text-danger">
                            <i data-lucide="trash-2" class="w-24px h-24px"></i>
                        </div>
                        <div>
                            <h4 class="h6 fw-black text-foreground mb-2">@Localizer["ClearAllCache"]</h4>
                            <p class="xx-small text-muted fw-medium leading-relaxed mb-0">@Localizer["ClearAllCacheDesc"]</p>
                        </div>
                        <form asp-action="ClearCache" method="post" class="mt-auto">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-danger w-100 rounded-pill xx-small fw-black text-uppercase tracking-widest active-scale" onclick="return confirm('@Localizer["ConfirmClearAll"]')">
                                @Localizer["Execute"]
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- View Keys -->
            <div class="col-md-6 col-lg-3">
                <div class="card card-premium h-100 transition-all hover-translate-y">
                    <div class="card-body p-4 d-flex flex-column gap-4">
                        <div class="w-48px h-48px bg-primary bg-opacity-10 rounded-4 d-flex align-items-center justify-content-center text-primary">
                            <i data-lucide="key" class="w-24px h-24px"></i>
                        </div>
                        <div>
                            <h4 class="h6 fw-black text-foreground mb-2">@Localizer["BrowseKeys"]</h4>
                            <p class="xx-small text-muted fw-medium leading-relaxed mb-0">@Localizer["BrowseKeysDesc"]</p>
                        </div>
                        <a href="@Url.Action("ViewKeys")" class="btn btn-outline-primary w-100 rounded-pill mt-auto xx-small fw-black text-uppercase tracking-widest active-scale">
                            @Localizer["Browse"]
                        </a>
                    </div>
                </div>
            </div>

            <!-- Pattern Clear -->
            <div class="col-md-6 col-lg-3">
                <div class="card card-premium h-100 transition-all hover-translate-y">
                    <div class="card-body p-4 d-flex flex-column gap-4">
                        <div class="w-48px h-48px bg-warning bg-opacity-10 rounded-4 d-flex align-items-center justify-content-center text-warning">
                            <i data-lucide="search" class="w-24px h-24px"></i>
                        </div>
                        <div>
                            <h4 class="h6 fw-black text-foreground mb-2">@Localizer["PatternClear"]</h4>
                            <p class="xx-small text-muted fw-medium leading-relaxed mb-0">@Localizer["PatternClearDesc"]</p>
                        </div>
                        <button onclick="showPatternClearModal()" class="btn btn-outline-warning w-100 rounded-pill mt-auto xx-small fw-black text-uppercase tracking-widest active-scale">
                            @Localizer["Configure"]
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Statistics -->
    <div class="card card-premium">
        <div class="card-header border-bottom border-border border-opacity-50 p-4">
            <h3 class="h6 fw-black text-uppercase tracking-widest text-muted mb-0 d-flex align-items-center gap-2">
                <i data-lucide="bar-chart-3" class="w-18px h-18px text-primary"></i>
                @Localizer["PerformanceMetrics"]
            </h3>
        </div>
        <div class="card-body p-4 p-md-5">
            <div id="cache-statistics">
                @if (Model.Statistics.Any())
                {
                    <div class="row g-4">
                        @foreach (var stat in Model.Statistics.Take(12))
                        {
                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 rounded-4 bg-muted bg-opacity-5 border border-border border-opacity-30">
                                    <div class="d-flex justify-content-between align-items-end mb-2">
                                        <span class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60">@stat.Key.Replace("_", " ")</span>
                                        <span class="small fw-black tabular-nums text-foreground">@stat.Value</span>
                                    </div>
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar bg-primary opacity-50" role="progressbar" style="width: 35%"></div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="py-5 text-center opacity-75">
                        <i data-lucide="database" class="w-48px h-48px text-muted mb-3 opacity-10 mx-auto"></i>
                        <h4 class="small fw-black text-foreground mb-1">@Localizer["NoStatistics"]</h4>
                        <p class="xx-small text-muted mb-0 mx-auto max-w-lg">@Localizer["NoStatisticsDesc"]</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Pattern Clear Modal -->
<div class="modal fade" id="patternClearModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-premium border-0 shadow-2xl">
            <div class="modal-header border-bottom border-border border-opacity-50 p-4">
                <h5 class="modal-title fw-black d-flex align-items-center gap-2">
                    <i data-lucide="search" class="text-warning"></i>
                    @Localizer["ClearCachePattern"]
                </h5>
                <button type="button" class="btn-close btn-close-white opacity-50 transition-all hover-opacity-100" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 p-md-5">
                <form asp-action="ClearCachePattern" method="post" id="patternClearForm">
                    @Html.AntiForgeryToken()
                    <div class="mb-4">
                        <label class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-60 mb-2 d-block">@Localizer["Pattern"]</label>
                        <input type="text" name="pattern" class="form-control bg-muted bg-opacity-5 border-border rounded-4 text-foreground focus-primary" placeholder="@Localizer["PatternPlaceholder"]" required>
                        <p class="xx-small text-muted mt-2">@Localizer["PatternHelp"]</p>
                    </div>
                    
                    <div class="d-flex gap-3 pt-2">
                        <button type="button" class="btn btn-secondary flex-grow-1 rounded-pill fw-bold text-uppercase tracking-wider small active-scale" data-bs-dismiss="modal">
                            @Localizer["Cancel"]
                        </button>
                        <button type="submit" class="btn btn-warning flex-grow-1 rounded-pill fw-bold text-uppercase tracking-wider small active-scale text-white" onclick="return confirm('@Localizer["ConfirmPatternClear"]')">
                            @Localizer["ClearPattern"]
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refreshStatistics() {
            $.get('@Url.Action("GetStatistics")', function(data) {
                if (data.error) {
                    CC.Utils.Notifier.error(data.error);
                    return;
                }
                
                // Update memory usage
                if (data.used_memory_human) {
                    $('#memory-usage').text(data.used_memory_human);
                }
                
                // Update total keys
                if (data.db0) {
                    $('#total-keys').text(data.db0);
                }
                
                // Update statistics
                updateStatisticsGrid(data);
                
                CC.Utils.Notifier.success('@Localizer["StatsRefreshedJS"]');
            }).fail(function() {
                CC.Utils.Notifier.error('@Localizer["StatsRefreshFailedJS"]');
            });
        }
        
        function updateStatisticsGrid(data) {
            // Update statistics grid if needed
            console.log('Statistics updated:', data);
        }
        
        function showPatternClearModal() {
            const modal = new bootstrap.Modal(document.getElementById('patternClearModal'));
            modal.show();
        }
        
        // Auto-refresh every 30 seconds
        setInterval(refreshStatistics, 30000);
    </script>
}
