@{
    ViewData["Title"] = "AI Test Console";
    Layout = "_DashboardLayout";
}

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-foreground">AI Test Console</h1>
            <p class="text-muted-foreground">Test AI responses and debug issues in real-time</p>
        </div>
        <div class="flex items-center gap-3">
            <a asp-action="Index" class="btn btn-outline">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Test Console -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Test AI Assistant</h3>
            <p class="card-description">Send test messages to the AI assistant</p>
        </div>
        <div class="card-content space-y-4">
            <div class="space-y-2">
                <label class="text-sm font-medium text-foreground">Test Message</label>
                <textarea id="testMessage" class="textarea min-h-[120px]" placeholder="Enter your test message here..."></textarea>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-sm text-muted-foreground" id="charCount">0 characters</span>
                <button class="btn btn-primary" onclick="sendTestMessage()" id="sendButton">
                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                    Send Test
                </button>
            </div>
        </div>
    </div>

    <!-- Test Results -->
    <div class="card" id="testResults" style="display: none;">
        <div class="card-header">
            <h3 class="card-title">AI Response</h3>
        </div>
        <div class="card-content">
            <div class="p-4 rounded-lg bg-muted/50 border border-border">
                <p class="text-foreground" id="aiResponse">Response will appear here...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Character counter
            const testMessage = document.getElementById('testMessage');
            const charCount = document.getElementById('charCount');
            
            testMessage.addEventListener('input', function() {
                charCount.textContent = `${this.value.length} characters`;
            });
        });

        async function sendTestMessage() {
            const message = document.getElementById('testMessage').value.trim();
            if (!message) {
                alert('Please enter a test message');
                return;
            }

            const sendButton = document.getElementById('sendButton');
            const testResults = document.getElementById('testResults');
            const aiResponse = document.getElementById('aiResponse');

            // Update UI
            sendButton.disabled = true;
            sendButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Testing...';

            try {
                const response = await fetch('/Dashboard/AIManagement/TestMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    aiResponse.textContent = data.data.response;
                    testResults.style.display = 'block';
                } else {
                    aiResponse.textContent = data.message || 'Test failed';
                    testResults.style.display = 'block';
                }
            } catch (error) {
                console.error('Test error:', error);
                aiResponse.textContent = 'Connection error. Please check your network.';
                testResults.style.display = 'block';
            } finally {
                // Reset button
                sendButton.disabled = false;
                sendButton.innerHTML = '<i data-lucide="send" class="w-4 h-4 mr-2"></i>Send Test';
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }
    </script>
}