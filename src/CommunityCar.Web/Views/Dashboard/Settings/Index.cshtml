@inject IViewLocalizer Localizer
@model IEnumerable<CommunityCar.Application.Features.Dashboard.ViewModels.SettingsVM>
@{
    ViewData["Title"] = Localizer["DashboardSettings"];
    Layout = "_DashboardLayout";
    ViewData["UseModernTheme"] = true;
    var category = ViewBag.Category as string;
    var categories = ViewBag.Categories as string[] ?? new string[0];
}

<div class="animate-slide-up">
    <!-- Top Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="page-title mb-2">@Localizer["DashboardSettings"]</h1>
            <p class="text-muted fw-medium">@Localizer["ManageYourDashboardPreferences"]</p>
        </div>
    </div>

    <!-- Alert Section -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert card-modern border-success border-opacity-20 d-flex align-items-center gap-3 p-3 mb-4 animate-slide-up">
            <div class="w-8 h-8 rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center text-success">
                <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            <span class="small fw-bold text-success">@TempData["SuccessMessage"]</span>
        </div>
    }

    <div class="row g-4 modern-gap">
        <!-- Sidebar Navigation -->
        <div class="col-12 col-lg-3">
            <div class="card-modern p-3">
                <p class="modern-label mb-3 px-2">CATEGORIES</p>
                <div class="d-flex flex-column gap-1">
                    <a href="@Url.Action("Index", "Settings", new { area = "" })" 
                       class="modern-settings-nav-item @(string.IsNullOrEmpty(category) ? "active" : "")">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i>
                        @Localizer["AllSettings"]
                    </a>
                    @foreach (var cat in categories)
                    {
                        <a href="@Url.Action("Category", "Settings", new { category = cat })" 
                           class="modern-settings-nav-item @(category == cat ? "active" : "")">
                            <i data-lucide="@(cat.ToLower() switch { "display" => "monitor", "notifications" => "bell", "performance" => "gauge", "security" => "shield", _ => "settings" })" class="w-4 h-4"></i>
                            @cat
                        </a>
                    }
                </div>
            </div>
        </div>

        <!-- Settings List -->
        <div class="col-12 col-lg-9">
            <div class="card-modern p-4">
                <h5 class="fw-black mb-4 d-flex align-items-center gap-2">
                    <i data-lucide="sliders" class="w-5 h-5 opacity-40"></i>
                    @(category ?? @Localizer["AllSettings"].Value)
                </h5>

                <div class="d-flex flex-column">
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var setting in Model)
                        {
                            <div class="modern-settings-action-row">
                                <div>
                                    <div class="fw-bold text-dark">@setting.SettingKey</div>
                                    <div class="xx-small text-muted text-uppercase tracking-widest mt-1">CAT: @setting.Category</div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <form asp-action="UpdateSetting" method="post" class="d-flex align-items-center gap-2">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="SettingKey" value="@setting.SettingKey" />
                                        <input type="hidden" name="Category" value="@setting.Category" />
                                        <input type="text" name="Value" value="@setting.Value" 
                                               class="modern-input py-1 px-3" 
                                               style="width: 140px; font-size: 0.85rem" />
                                        <button type="submit" class="btn-modern-primary py-1 px-3" style="font-size: 0.75rem">
                                            @Localizer["Update"]
                                        </button>
                                    </form>
                                    <form asp-action="ResetSetting" asp-route-settingKey="@setting.SettingKey" method="post" class="reset-setting-form">
                                        @Html.AntiForgeryToken()
                                        <button type="button" class="btn-icon-modern" data-action="confirm-reset">
                                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        }

                        <!-- Danger Zone -->
                        <div class="mt-5 pt-4 border-top">
                            <div class="card-modern border-danger border-opacity-10 bg-danger bg-opacity-5 p-4 d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-black text-danger mb-1">RESET EVERYTHING</h6>
                                    <p class="xx-small text-muted fw-bold mb-0">RETURN ALL CONFIGURATIONS TO DEFAULTS</p>
                                </div>
                                <form asp-action="ResetAllSettings" method="post" class="reset-all-settings-form">
                                    @Html.AntiForgeryToken()
                                    <button type="button" class="btn-modern-primary bg-danger border-danger py-2 px-4 shadow-none" data-action="confirm-reset-all">
                                        <i data-lucide="trash-2" class="w-4 h-4 me-2"></i>
                                        @Localizer["ResetAllNow"]
                                    </button>
                                </form>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 opacity-30">
                            <i data-lucide="settings-2" class="w-12 h-12 mb-3"></i>
                            <p class="fw-bold">No settings found in this category</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/modules/dashboard/settings-controller.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (CC && CC.Modules && CC.Modules.Dashboard && CC.Modules.Dashboard.Settings) {
                CC.Modules.Dashboard.Settings.init();
            }
        });
    </script>
}
