@inject IViewLocalizer Localizer
@model IEnumerable<CommunityCar.Application.Features.Dashboard.ViewModels.SettingsVM>
@{
    ViewData["Title"] = Localizer["DashboardSettings"];
    ViewData["PageType"] = "Settings";
    var category = ViewBag.Category as string;
    var categories = ViewBag.Categories as string[] ?? new string[0];
}

<div class="space-y-8 animate-in fade-in duration-700">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
        <div>
            <h1 class="text-3xl font-black text-foreground tracking-tight">@Localizer["DashboardSettings"]</h1>
            <p class="text-sm text-muted-foreground font-medium opacity-70 mt-1">@Localizer["ManageYourDashboardPreferences"]</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="mb-6 bg-success-50 border border-success-200 text-success-700 px-6 py-4 rounded-2xl shadow-lg shadow-success-500/10 animate-in slide-in-from-top duration-300">
            <div class="flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                <span class="font-medium">@TempData["SuccessMessage"]</span>
            </div>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="mb-6 bg-error-50 border border-error-200 text-error-700 px-6 py-4 rounded-2xl shadow-lg shadow-error-500/10 animate-in slide-in-from-top duration-300">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                <span class="font-medium">@TempData["ErrorMessage"]</span>
            </div>
        </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Categories Sidebar -->
        <div class="lg:col-span-1">
            <div class="eng-card hover-lift">
                <div class="eng-card-header">
                    <h3 class="eng-card-title">@Localizer["Categories"]</h3>
                    <div class="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
                </div>
                <div class="eng-card-content">
                    <nav class="space-y-2">
                        <a href="@Url.Action("Index", "Settings", new { area = "" })" 
                           class="@(string.IsNullOrEmpty(category) ? "bg-primary/10 text-primary border-primary/20 shadow-glow-primary" : "text-foreground/70 hover:text-primary hover:bg-primary/5") block px-4 py-3 rounded-xl text-sm font-medium border border-border/30 transition-all duration-300 hover:border-primary/20 hover:shadow-md group">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-list w-4 h-4 group-hover:scale-110 transition-transform"></i>
                                @Localizer["AllSettings"]
                            </div>
                        </a>
                        @foreach (var cat in categories)
                        {
                            <a href="@Url.Action("Category", "Settings", new { category = cat })" 
                               class="@(category == cat ? "bg-primary/10 text-primary border-primary/20 shadow-glow-primary" : "text-foreground/70 hover:text-primary hover:bg-primary/5") block px-4 py-3 rounded-xl text-sm font-medium border border-border/30 transition-all duration-300 hover:border-primary/20 hover:shadow-md group">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-@(cat.ToLower() switch { "display" => "desktop", "notifications" => "bell", "performance" => "tachometer-alt", "security" => "shield-alt", _ => "cog" }) w-4 h-4 group-hover:scale-110 transition-transform"></i>
                                    @cat
                                </div>
                            </a>
                        }
                    </nav>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="lg:col-span-3">
            <div class="eng-card hover-lift">
                <div class="eng-card-header">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                            <i class="fas fa-@(category?.ToLower() switch { "display" => "desktop", "notifications" => "bell", "performance" => "tachometer-alt", "security" => "shield-alt", _ => "cog" }) w-4 h-4"></i>
                        </div>
                        <h2 class="text-xl font-bold text-foreground">
                            @if (!string.IsNullOrEmpty(category))
                            {
                                @string.Format(Localizer["CategorySettings"].Value, category)
                            }
                            else
                            {
                                @Localizer["AllSettings"]
                            }
                        </h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-success animate-pulse"></div>
                        <span class="eng-stat-label">Live</span>
                    </div>
                </div>
                            {
                                @Localizer["AllSettings"]
                            }
                        </h2>
                    </div>
                </div>

                <div class="eng-card-content">
                    <div id="settings-skeleton" class="hidden space-y-6">
                        @for (int i = 0; i < 5; i++)
                        {
                            <div class="eng-card border-border/30">
                                <div class="eng-card-content p-4">
                                    <div class="skeleton h-4 w-3/4 mb-2"></div>
                                    <div class="skeleton h-3 w-1/2"></div>
                                </div>
                            </div>
                        }
                    </div>
                    <div id="settings-content">
                        @if (Model != null && Model.Any())
                        {
                            <div class="space-y-4">
                                @foreach (var setting in Model)
                                {
                                    <div class="eng-card border-border/30 hover:border-primary/20 transition-all duration-300 group hover-lift">
                                        <div class="eng-card-content">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-3 mb-2">
                                                        <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors">
                                                            <i class="fas fa-cog text-primary text-sm"></i>
                                                        </div>
                                                        <h4 class="text-sm font-bold text-foreground">@setting.SettingKey</h4>
                                                    </div>
                                                    <p class="eng-stat-label ml-11">
                                                        @Localizer["CategoryLabel"]: <span class="text-primary font-medium">@setting.Category</span>
                                                    </p>
                                                </div>
                                                <div class="flex items-center space-x-3">
                                                    <form asp-action="UpdateSetting" method="post" class="inline-flex items-center space-x-3">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="SettingKey" value="@setting.SettingKey" />
                                                        <input type="hidden" name="Category" value="@setting.Category" />
                                                        <div class="relative">
                                                            <input type="text" name="Value" value="@setting.Value" 
                                                                   class="input w-48 h-10 text-sm bg-background/50 border-border/50 focus:border-primary/50 focus:ring-primary/20" 
                                                                   placeholder="Enter value..." />
                                                        </div>
                                                        <button type="submit" 
                                                                class="btn btn-primary btn-sm px-4 py-2 btn-gradient hover:shadow-glow-primary transition-all duration-300">
                                                            <i class="fas fa-save mr-2"></i>
                                                            @Localizer["Update"]
                                                        </button>
                                                    </form>
                                                    <form asp-action="ResetSetting" asp-route-settingKey="@setting.SettingKey" method="post" class="inline reset-setting-form">
                                                        @Html.AntiForgeryToken()
                                                        <button type="button" 
                                                                class="btn btn-outline btn-sm px-4 py-2 text-muted-foreground hover:text-foreground hover:border-border transition-all duration-300"
                                                                data-action="confirm-reset">
                                                            <i class="fas fa-undo mr-2"></i>
                                                            @Localizer["Reset"]
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                                
                            <!-- Reset All Settings -->
                            <div class="mt-8 pt-6 border-t border-border/30">
                                <div class="eng-card border-destructive/20 hover:border-destructive/30 transition-all duration-300 hover-lift">
                                    <div class="eng-card-content">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-4">
                                                <div class="eng-stat-icon-wrap bg-destructive/10 text-destructive">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </div>
                                                <div>
                                                    <h3 class="text-lg font-bold text-foreground">@Localizer["ResetAllSettings"]</h3>
                                                    <p class="eng-stat-label mt-1">@Localizer["ResetAllDescription"]</p>
                                                </div>
                                            </div>
                                            <form asp-action="ResetAllSettings" method="post" class="inline reset-all-settings-form">
                                                @Html.AntiForgeryToken()
                                                <button type="button" 
                                                        class="btn btn-destructive px-6 py-3 hover:shadow-glow-destructive transition-all duration-300"
                                                        data-action="confirm-reset-all">
                                                    <i class="fas fa-trash-alt mr-2"></i>
                                                    @Localizer["ResetAllSettings"]
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-16">
                                <div class="eng-stat-icon-wrap bg-muted/20 text-muted-foreground mx-auto mb-6">
                                    <i class="fas fa-cog text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-bold text-foreground mb-2">@Localizer["NoSettingsFound"]</h3>
                                <p class="eng-stat-label">
                                    @if (!string.IsNullOrEmpty(category))
                                    {
                                        var localizedMsg = Localizer["NoSettingsForCategory"].Value;
                                        @string.Format(localizedMsg, category)
                                    }
                                    else
                                    {
                                        @Localizer["NoSettingsConfigured"]
                                    }
                                </p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dashboard-settings.js" asp-append-version="true"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Confirmation dialogs
        document.querySelectorAll('[data-action="confirm-reset"]').forEach(button => {
            button.addEventListener('click', function(e) {
                if (confirm('@Localizer["ConfirmResetSetting"]')) {
                    this.closest('form').submit();
                }
            });
        });
        
        document.querySelectorAll('[data-action="confirm-reset-all"]').forEach(button => {
            button.addEventListener('click', function(e) {
                if (confirm('@Localizer["ConfirmResetAllSettings"]')) {
                    this.closest('form').submit();
                }
            });
        });
    </script>
}