@model CommunityCar.Application.Features.Dashboard.Analytics.Users.Behavior.UserBehaviorAnalyticsVM
@{
    ViewData["Title"] = "User Behavior Analytics";
    ViewData["PageTitle"] = "User Behavior Analytics";
    ViewData["Description"] = "Analyze user behavior patterns and engagement metrics";
    Layout = "_DashboardLayout";
}

<div class="container-fluid py-4 animate-in fade-in">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-5 mt-2">
        <div>
            <h2 class="fw-black text-gradient mb-1"><i class="fas fa-brain me-2 small opacity-50"></i>Behavioral Intelligence</h2>
            <p class="text-muted small text-uppercase tracking-widest opacity-50 fw-black">Deep analysis of user interaction vectors</p>
        </div>
        <div class="d-flex gap-2 bg-light p-1 rounded-4 shadow-sm">
            <button type="button" class="btn btn-sm px-3 rounded-3 fw-bold transition-all" id="btn-24h" onclick="setTimeRange('24h')">24H</button>
            <button type="button" class="btn btn-sm btn-primary-red px-3 rounded-3 fw-bold shadow-sm" id="btn-7d" onclick="setTimeRange('7d')">7D</button>
            <button type="button" class="btn btn-sm px-3 rounded-3 fw-bold transition-all" id="btn-30d" onclick="setTimeRange('30d')">30D</button>
        </div>
    </div>

    <!-- Behavior Metrics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="card card-premium border-0 h-100 overflow-hidden">
                <div class="card-body p-4">
                    <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center mb-3" style="width: 42px; height: 42px;">
                        <i class="fas fa-clock text-primary"></i>
                    </div>
                    <h2 class="fw-black mb-1">@(Model?.AverageSessionDuration?.ToString(@"mm\:ss") ?? "00:00")</h2>
                    <h6 class="text-muted small text-uppercase tracking-widest fw-black mb-0 opacity-50">Avg Depth</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-premium border-0 h-100 overflow-hidden">
                <div class="card-body p-4">
                    <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center mb-3" style="width: 42px; height: 42px;">
                        <i class="fas fa-mouse-pointer text-success"></i>
                    </div>
                    <h2 class="fw-black mb-1">@(Model?.PagesPerSession?.ToString("F1") ?? "0.0")</h2>
                    <h6 class="text-muted small text-uppercase tracking-widest fw-black mb-0 opacity-50">Hop Density</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-premium border-0 h-100 overflow-hidden">
                <div class="card-body p-4">
                    <div class="rounded-circle bg-warning bg-opacity-10 d-flex align-items-center justify-content-center mb-3" style="width: 42px; height: 42px;">
                        <i class="fas fa-sign-out-alt text-warning"></i>
                    </div>
                    <h2 class="fw-black mb-1">@(Model?.BounceRate?.ToString("F1") ?? "0.0")%</h2>
                    <h6 class="text-muted small text-uppercase tracking-widest fw-black mb-0 opacity-50">Exit Velocity</h6>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-premium border-0 h-100 overflow-hidden">
                <div class="card-body p-4">
                    <div class="rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center mb-3" style="width: 42px; height: 42px;">
                        <i class="fas fa-redo text-info"></i>
                    </div>
                    <h2 class="fw-black mb-1">@(Model?.ReturnVisitorRate?.ToString("F1") ?? "0.0")%</h2>
                    <h6 class="text-muted small text-uppercase tracking-widest fw-black mb-0 opacity-50">Loyalty Cycle</h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Heatmap -->
    <div class="row g-4 mb-5">
        <div class="col-md-12">
            <div class="card card-premium border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="fw-black text-uppercase tracking-tight mb-0">Engagement Heatmap</h5>
                        <p class="text-muted xx-small fw-bold text-uppercase tracking-widest mb-0 opacity-50">Temporal activity density across the operational cycle</p>
                    </div>
                    <i class="fas fa-bolt text-warning opacity-50"></i>
                </div>
                <div class="card-body p-4">
                    <div id="activityHeatmapContainer" class="table-responsive">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary-red" role="status"></div>
                            <p class="mt-3 text-muted fw-bold text-uppercase tracking-widest small">Calculating density matrix...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Engagement -->
    <div class="row g-4 mb-5">
        <div class="col-md-8">
            <div class="card card-premium border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-black text-uppercase tracking-tight mb-0">Momentum Trends</h5>
                </div>
                <div class="card-body p-4">
                    <canvas id="engagementChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-premium border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-black text-uppercase tracking-tight mb-0">Operational Signals</h5>
                </div>
                <div class="card-body p-4 pt-0">
                    <div id="topActionsContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary-red" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Flow -->
    <div class="row g-4">
        <div class="col-md-12">
            <div class="card card-premium border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-black text-uppercase tracking-tight mb-0">Traversal Flow Architecture</h5>
                    <p class="text-muted xx-small fw-bold text-uppercase tracking-widest mb-0 opacity-50">Logical progression through the ecosystem</p>
                </div>
                <div class="card-body p-4">
                    <div id="userFlowContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary-red" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dashboard/user-behavior.js"></script>
    <script>
        let currentTimeRange = '7d';

        function setTimeRange(range) {
            currentTimeRange = range;
            $('.btn-group .btn, .d-flex.gap-2.bg-light .btn').removeClass('btn-primary-red shadow-sm').addClass('bg-transparent');
            $(`#btn-${range}`).removeClass('bg-transparent').addClass('btn-primary-red shadow-sm');
            loadBehaviorData();
        }

        function loadBehaviorData() {
            // Load activity heatmap
            $.get('@Url.Action("GetActivityHeatmap")', function(data) {
                if (data.success) {
                    renderActivityHeatmap(data.data);
                }
            });

            // Load user engagement data
            $.get('@Url.Action("GetUserEngagement")', { count: 100 }, function(data) {
                if (data.success) {
                    renderEngagementChart(data.data);
                    renderTopActions(data.data);
                }
            });

            // Load user flow data (mock for now)
            renderUserFlow();
        }

        function renderActivityHeatmap(heatmapData) {
            let html = '<div class="heatmap-wrapper p-2 rounded-4 bg-dark bg-opacity-5">';
            
            if (heatmapData && heatmapData.hourlyActivity) {
                html += '<table class="table table-borderless mb-0 heatmap-table">';
                
                // Days of week
                const days = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
                
                // Hours header
                html += '<thead><tr><th></th>';
                for (let hour = 0; hour < 24; hour++) {
                    html += `<th class="xx-small text-muted text-center fw-black">${hour}h</th>`;
                }
                html += '</tr></thead><tbody>';
                
                // Data rows
                days.forEach(function(day, dayIndex) {
                    html += '<tr>';
                    html += `<td class="xx-small fw-black text-muted pe-3">${day}</td>`;
                    
                    for (let hour = 0; hour < 24; hour++) {
                        const activity = heatmapData.hourlyActivity[hour] || 0;
                        const intensity = Math.min(activity / 100, 1);
                        const opacity = 0.05 + (intensity * 0.95);
                        
                        html += `<td class="p-1">
                                    <div class="heatmap-cell" 
                                         style="background-color: rgba(251, 44, 54, ${opacity}); height: 30px; border-radius: 4px;" 
                                         title="${day} ${hour}:00 - ${activity} active segments">
                                    </div>
                                </td>`;
                    }
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            } else {
                html += '<div class="text-center py-5 text-muted fw-bold">Temporal matrix unavailable.</div>';
            }
            
            html += '</div>';
            $('#activityHeatmapContainer').html(html);
        }

        function renderEngagementChart(engagementData) {
            // Updated via dashboard/user-behavior.js
        }

        function renderTopActions(data) {
            const actions = [
                { name: 'Core Navigation', count: 1250, percentage: 45, icon: 'compass', color: 'primary' },
                { name: 'Entity Appreciation', count: 890, percentage: 32, icon: 'heart', color: 'danger' },
                { name: 'Network Dispatch', count: 420, percentage: 15, icon: 'share', color: 'info' },
                { name: 'Dialog Input', count: 220, percentage: 8, icon: 'comment', color: 'warning' }
            ];

            let html = '<div class="vstack gap-3 mt-4">';
            actions.forEach(function(action) {
                html += `
                    <div class="p-3 rounded-4 bg-light bg-opacity-50 border border-light transition-all hover-translate-x">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-black text-uppercase tracking-widest xx-small"><i class="fas fa-${action.icon} me-2 text-${action.color}"></i>${action.name}</span>
                            <span class="fw-black small">${action.count}</span>
                        </div>
                        <div class="progress rounded-pill shadow-sm" style="height: 6px;">
                            <div class="progress-bar bg-${action.color}" style="width: ${action.percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            $('#topActionsContainer').html(html);
        }

        function renderUserFlow() {
            let html = `
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-4 py-5 px-4 overflow-auto">
                    <div class="flow-node-premium">
                        <div class="node-icon bg-primary"><i class="fas fa-play"></i></div>
                        <div class="node-label">Entry Point</div>
                        <div class="node-meta">100% Volume</div>
                    </div>
                    <i class="fas fa-chevron-right text-muted opacity-25 d-none d-md-block"></i>
                    <i class="fas fa-chevron-down text-muted opacity-25 d-md-none"></i>
                    <div class="flow-node-premium">
                        <div class="node-icon bg-success"><i class="fas fa-home"></i></div>
                        <div class="node-label">Home Hub</div>
                        <div class="node-meta">75% Retention</div>
                    </div>
                    <i class="fas fa-chevron-right text-muted opacity-25 d-none d-md-block"></i>
                    <i class="fas fa-chevron-down text-muted opacity-25 d-md-none"></i>
                    <div class="flow-node-premium highlighted">
                        <div class="node-icon bg-primary-red shadow-premium"><i class="fas fa-file-alt"></i></div>
                        <div class="node-label text-gradient fw-black">Entity Catalog</div>
                        <div class="node-meta">45% Depth</div>
                    </div>
                    <i class="fas fa-chevron-right text-muted opacity-25 d-none d-md-block"></i>
                    <i class="fas fa-chevron-down text-muted opacity-25 d-md-none"></i>
                    <div class="flow-node-premium exit">
                        <div class="node-icon bg-secondary"><i class="fas fa-sign-out-alt"></i></div>
                        <div class="node-label">Exit Node</div>
                        <div class="node-meta">30% Depletion</div>
                    </div>
                </div>
            `;
            $('#userFlowContainer').html(html);
        }

        $(document).ready(function() {
            loadBehaviorData();
        });
    </script>
}

<style>
    .hover-translate-x:hover { transform: translateX(5px); }
    .hover-translate-y:hover { transform: translateY(-5px); }
    .transition-all { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .xx-small { font-size: 0.6rem; }
    .heatmap-cell { cursor: pointer; transition: transform 0.1s ease; border: 1px solid rgba(255,255,255,0.05); }
    .heatmap-cell:hover { transform: scale(1.1); z-index: 2; border: 1px solid rgba(0,0,0,0.1); }
    .flow-node-premium { text-align: center; min-width: 120px; }
    .node-icon { width: 56px; height: 56px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; color: #fff; font-size: 1.25rem; transition: all 0.3s ease; }
    .flow-node-premium:hover .node-icon { transform: translateY(-5px) rotate(5deg); }
    .node-label { font-weight: 900; font-size: 0.75rem; text-uppercase: uppercase; letter-spacing: 0.05rem; margin-bottom: 4px; }
    .node-meta { font-size: 0.65rem; font-weight: 700; color: var(--bs-gray-500); text-transform: uppercase; }
    .flow-node-premium.highlighted .node-icon { transform: scale(1.1); }
</style>