@model CommunityCar.Application.Features.SEO.ViewModels.PerformanceMetricsVM
@{
    ViewData["Title"] = "Performance Dashboard";
    Layout = "_DashboardLayout";
}

<div class="dashboard-content">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Performance Dashboard</h1>
        <p class="dashboard-subtitle">Monitor Core Web Vitals and optimize site performance</p>
    </div>

    <!-- Core Web Vitals -->
    @if (Model?.CoreWebVitals != null)
    {
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Largest Contentful Paint (LCP)</h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="metric-circle lcp-@Model.CoreWebVitals.LCPGrade.ToLower()">
                            <span class="metric-value">@Model.CoreWebVitals.LCP.ToString("F1")</span>
                            <span class="metric-unit">ms</span>
                        </div>
                        <div class="metric-grade mt-2">@Model.CoreWebVitals.LCPGrade</div>
                        <div class="metric-description">Time to render largest element</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">First Input Delay (FID)</h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="metric-circle fid-@Model.CoreWebVitals.FIDGrade.ToLower()">
                            <span class="metric-value">@Model.CoreWebVitals.FID.ToString("F1")</span>
                            <span class="metric-unit">ms</span>
                        </div>
                        <div class="metric-grade mt-2">@Model.CoreWebVitals.FIDGrade</div>
                        <div class="metric-description">Time to first interaction</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cumulative Layout Shift (CLS)</h3>
                    </div>
                    <div class="card-body text-center">
                        <div class="metric-circle cls-@Model.CoreWebVitals.CLSGrade.ToLower()">
                            <span class="metric-value">@Model.CoreWebVitals.CLS.ToString("F3")</span>
                            <span class="metric-unit"></span>
                        </div>
                        <div class="metric-grade mt-2">@Model.CoreWebVitals.CLSGrade</div>
                        <div class="metric-description">Visual stability score</div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Performance Tools -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Performance Analysis</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="analyzeUrl">Analyze Page Performance</label>
                        <div class="input-group">
                            <input type="text" id="analyzeUrl" class="form-control" placeholder="Enter URL to analyze" value="/">
                            <button class="btn btn-primary" onclick="analyzePerformance()">Analyze</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline-primary" onclick="generateReport()">Generate Full Report</button>
                        <button class="btn btn-outline-info" onclick="getCriticalResources()">Critical Resources</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Image Optimization</h3>
                </div>
                <div class="card-body">
                    <form id="imageOptimizationForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="imageFile">Select Image</label>
                            <input type="file" id="imageFile" name="image" class="form-control" accept="image/*">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="quality">Quality (1-100)</label>
                                    <input type="number" id="quality" name="Quality" class="form-control" value="80" min="1" max="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="format">Format</label>
                                    <select id="format" name="Format" class="form-control">
                                        <option value="webp">WebP</option>
                                        <option value="avif">AVIF</option>
                                        <option value="jpeg">JPEG</option>
                                        <option value="png">PNG</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success" onclick="optimizeImage()">Optimize Image</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Issues -->
    @if (Model?.Issues?.Any() == true)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Performance Issues</h3>
                    </div>
                    <div class="card-body">
                        @foreach (var issue in Model.Issues)
                        {
                            <div class="issue-item">
                                <div class="issue-header">
                                    <span class="issue-type">@issue.Type</span>
                                    <span class="issue-severity severity-@issue.Severity.ToLower()">@issue.Severity</span>
                                    <span class="issue-impact">Impact: @issue.Impact.ToString("F1")s</span>
                                </div>
                                <div class="issue-message">@issue.Message</div>
                                <div class="issue-resource">Resource: @issue.Resource</div>
                                <div class="issue-fix">
                                    <strong>Fix:</strong> @issue.Fix
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Performance Recommendations -->
    @if (Model?.Recommendations?.Any() == true)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Performance Recommendations</h3>
                    </div>
                    <div class="card-body">
                        @foreach (var recommendation in Model.Recommendations)
                        {
                            <div class="recommendation-item">
                                <div class="recommendation-header">
                                    <span class="recommendation-category">@recommendation.Category</span>
                                    <span class="recommendation-priority priority-@recommendation.Priority.ToLower()">@recommendation.Priority</span>
                                    <span class="recommendation-savings">Potential: @recommendation.PotentialSavings.ToString("F1")s</span>
                                </div>
                                <div class="recommendation-title">@recommendation.Title</div>
                                <div class="recommendation-description">@recommendation.Description</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Results Display -->
    <div id="resultsContainer" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Analysis Results</h3>
            </div>
            <div class="card-body">
                <pre id="resultsContent"></pre>
            </div>
        </div>
    </div>
</div>

<script>
    async function analyzePerformance() {
        const url = document.getElementById('analyzeUrl').value;
        if (!url) {
            alert('Please enter a URL to analyze');
            return;
        }

        try {
            const response = await fetch('/Performance/GetCoreWebVitals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}`
            });

            const result = await response.json();
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                displayResults(result);
            }
        } catch (error) {
            alert('Error analyzing performance: ' + error.message);
        }
    }

    async function generateReport() {
        const url = document.getElementById('analyzeUrl').value || '/';

        try {
            const response = await fetch('/Performance/GenerateReport', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}`
            });

            const result = await response.json();
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                displayResults(result);
            }
        } catch (error) {
            alert('Error generating report: ' + error.message);
        }
    }

    async function getCriticalResources() {
        const url = document.getElementById('analyzeUrl').value || '/';

        try {
            const response = await fetch(`/Performance/GetCriticalResources?url=${encodeURIComponent(url)}`);
            const result = await response.json();
            
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                displayResults(result);
            }
        } catch (error) {
            alert('Error getting critical resources: ' + error.message);
        }
    }

    async function optimizeImage() {
        const form = document.getElementById('imageOptimizationForm');
        const formData = new FormData(form);

        if (!formData.get('image') || formData.get('image').size === 0) {
            alert('Please select an image file');
            return;
        }

        try {
            const response = await fetch('/Performance/OptimizeImage', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                displayResults(result);
            }
        } catch (error) {
            alert('Error optimizing image: ' + error.message);
        }
    }

    function displayResults(data) {
        const container = document.getElementById('resultsContainer');
        const content = document.getElementById('resultsContent');
        
        content.textContent = JSON.stringify(data, null, 2);
        container.style.display = 'block';
        
        // Scroll to results
        container.scrollIntoView({ behavior: 'smooth' });
    }
</script>

<style>
    .metric-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        border: 8px solid;
    }

    .metric-circle.lcp-good, .metric-circle.fid-good, .metric-circle.cls-good {
        border-color: var(--success-color);
        color: var(--success-color);
    }

    .metric-circle.lcp-needs, .metric-circle.fid-needs, .metric-circle.cls-needs {
        border-color: var(--warning-color);
        color: var(--warning-color);
    }

    .metric-circle.lcp-poor, .metric-circle.fid-poor, .metric-circle.cls-poor {
        border-color: var(--danger-color);
        color: var(--danger-color);
    }

    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }

    .metric-unit {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .metric-grade {
        font-weight: 500;
        font-size: 1.1rem;
    }

    .metric-description {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }

    .issue-item, .recommendation-item {
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .issue-header, .recommendation-header {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .issue-type, .recommendation-category {
        font-weight: 500;
        color: var(--primary-color);
    }

    .issue-impact, .recommendation-savings {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .severity-high, .priority-high {
        background-color: var(--danger-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .severity-medium, .priority-medium {
        background-color: var(--warning-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .severity-low, .priority-low {
        background-color: var(--info-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .issue-resource {
        font-family: monospace;
        font-size: 0.9rem;
        color: var(--text-muted);
        margin: 0.5rem 0;
    }

    #resultsContent {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
</style>