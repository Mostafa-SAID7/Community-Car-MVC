@model CommunityCar.Application.Features.Account.ViewModels.Core.ProfileSettingsVM
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["PageTitle"];
    ViewData["HideLeftSidebar"] = true;
    ViewData["HideRightSidebar"] = true;
    ViewData["HideMainContainer"] = true;
    ViewData["HideMainContentId"] = true;
    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
}

<div class="container-fluid py-4 animate-in fade-in">
    <!-- Grid Layout with Sidebar -->
    <div class="row g-4">
        <!-- Left Sidebar -->
        <div class="col-12 col-lg-3">
            <partial name="~/Views/Account/Profile/_ProfileSidebar.cshtml" />
        </div>
        
        <!-- Main Content Area -->
        <div class="col-12 col-lg-9">
            <div class="vstack gap-4">
                <!-- Tab Navigation -->
                <partial name="~/Views/Account/Profile/_ProfileNavigation.cshtml" />

                <!-- Settings Content Card -->
                <div class="card card-premium border-0 shadow-lg overflow-hidden rounded-4">
                    <div class="card-body p-4 p-md-5">
                        <!-- Header -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4 mb-5 pb-4 border-bottom border-light">
                            <div>
                                <h1 class="h3 fw-black text-dark tracking-tighter mb-1 d-flex align-items-center gap-3">
                                    <i class="fas fa-cog text-primary-red"></i>
                                    @Localizer["AccountSettings"]
                                </h1>
                                <p class="small text-muted fw-bold mb-0">@Localizer["SettingsSubtitle"]</p>
                            </div>
                        </div>

                        <!-- Settings Navigation (Tactical Pills) -->
                        <div class="d-flex justify-content-center mb-5">
                            <div class="bg-light bg-opacity-50 p-2 rounded-pill border border-light d-inline-flex gap-2 backdrop-blur shadow-sm">
                                <button data-action="show-tab" data-tab="profile" id="profileTab" class="btn btn-dark rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest transition-all shadow-sm">
                                    <i class="fas fa-user me-2 small"></i> @Localizer["Profile"]
                                </button>
                                <button data-action="show-tab" data-tab="privacy" id="privacyTab" class="btn btn-link text-muted rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest text-decoration-none hover-bg-light transition-all">
                                    <i class="fas fa-shield-alt me-2 small"></i> @Localizer["Privacy"]
                                </button>
                                <button data-action="show-tab" data-tab="notifications" id="notificationsTab" class="btn btn-link text-muted rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest text-decoration-none hover-bg-light transition-all">
                                    <i class="fas fa-bell me-2 small"></i> @Localizer["Notifications"]
                                </button>
                                <button data-action="show-tab" data-tab="security" id="securityTab" class="btn btn-link text-muted rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest text-decoration-none hover-bg-light transition-all">
                                    <i class="fas fa-lock me-2 small"></i> @Localizer["Security"]
                                </button>
                            </div>
                        </div>
                        
                        <!-- Settings Content -->
                        <div class="settings-content">
                            <!-- Profile Tab -->
                            <div id="profileSettings" class="tab-content animate-in slide-in-from-bottom-2 duration-300">
                                <form asp-controller="ProfileSettings" asp-action="UpdateProfile" asp-route-culture="@currentCulture" method="post" enctype="multipart/form-data">
                                    @Html.AntiForgeryToken()
                                    
                                    <!-- Visual Identity Section -->
                                    <div class="row g-5 mb-5 align-items-center">
                                        <div class="col-12 col-md-4">
                                            <div class="text-center group-avatar position-relative">
                                                <div class="mx-auto rounded-4 overflow-hidden border-4 border-light shadow-lg mb-4" style="width: 160px; height: 160px;">
                                                    <img src="@(Model.ProfilePictureUrl ?? "/images/default-avatar.png")?v=@DateTime.Now.Ticks" 
                                                         alt="Avatar" id="profile-preview" class="w-100 h-100 object-fit-cover transition-all duration-500 hover-scale-110" />
                                                </div>
                                                <label class="btn btn-light rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest border border-light shadow-sm cursor-pointer hover-translate-y">
                                                    <i class="fas fa-camera me-2 small"></i> @Localizer["ChangePhoto"]
                                                    <input type="file" name="ProfilePicture" class="d-none" accept="image/*" />
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-8">
                                            <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 position-relative overflow-hidden">
                                                <div class="position-absolute top-0 end-0 p-4 opacity-10">
                                                    <i class="fas fa-image display-1"></i>
                                                </div>
                                                <p class="xx-small fw-black text-dark text-uppercase tracking-widest mb-3">@Localizer["CoverImage"]</p>
                                                <div class="rounded-3 overflow-hidden border border-light mb-3" style="height: 100px;">
                                                    <img src="@(Model.CoverImageUrl ?? "/images/default-cover.svg")?v=@DateTime.Now.Ticks" 
                                                         alt="Cover" id="cover-preview" class="w-100 h-100 object-fit-cover" />
                                                </div>
                                                <label class="btn btn-outline-dark rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest border-light hover-translate-y">
                                                    <i class="fas fa-upload me-2 small"></i> @Localizer["ChangeCover"]
                                                    <input type="file" name="CoverImage" class="d-none" accept="image/*" />
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Personal Information Matrix -->
                                    <div class="bg-light bg-opacity-30 border border-light rounded-4 p-4 p-md-5 mb-5">
                                        <h3 class="xx-small fw-black text-dark text-uppercase tracking-widest mb-4 d-flex align-items-center gap-3">
                                            <i class="fas fa-user-edit text-primary-red"></i>
                                            @Localizer["PersonalIdentity"]
                                        </h3>
                                        <div class="row g-4">
                                            <div class="col-12 col-md-6">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["FullName"]</label>
                                                <input type="text" asp-for="FullName" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" placeholder="@Localizer["FullNamePlaceholder"]" />
                                            </div>
                                            <div class="col-12 col-md-6">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["PrimaryEmail"]</label>
                                                <input type="email" value="@Model.Email" class="form-control form-control-lg border-2 border-light rounded-3 bg-light text-muted" readonly />
                                                <p class="xx-small text-muted mt-2 fw-bold">@Localizer["EmailChangeRestriction"]</p>
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["PhoneNumber"]</label>
                                                <input type="tel" asp-for="PhoneNumber" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" placeholder="@Localizer["PhoneNumberPlaceholder"]" />
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["Country"]</label>
                                                <input type="text" asp-for="Country" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" placeholder="@Localizer["CountryPlaceholder"]" />
                                            </div>
                                            <div class="col-12 col-md-4">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["City"]</label>
                                                <input type="text" asp-for="City" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" placeholder="@Localizer["CityPlaceholder"]" />
                                            </div>
                                            <div class="col-12 col-md-6">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["CountryAr"]</label>
                                                <input type="text" asp-for="CountryAr" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" placeholder="@Localizer["CountryArPlaceholder"]" dir="rtl" />
                                            </div>
                                            <div class="col-12 col-md-6">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["CityAr"]</label>
                                                <input type="text" asp-for="CityAr" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" placeholder="@Localizer["CityArPlaceholder"]" dir="rtl" />
                                            </div>
                                            <div class="col-12">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["Bio"] (EN)</label>
                                                <textarea asp-for="Bio" class="form-control border-2 border-light rounded-3 bg-white" rows="4" placeholder="@Localizer["BioPlaceholder"]"></textarea>
                                            </div>
                                            <div class="col-12">
                                                <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["BioAr"] (AR)</label>
                                                <textarea asp-for="BioAr" class="form-control border-2 border-light rounded-3 bg-white" rows="4" placeholder="@Localizer["BioArPlaceholder"]" dir="rtl"></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary-red w-100 py-3 rounded-4 xx-small fw-black text-uppercase tracking-widest shadow-lg transition-all hover-translate-y">
                                        <i class="fas fa-save me-2"></i> @Localizer["SaveProfileChanges"]
                                    </button>
                                </form>
                            </div>

                            <!-- Privacy Tab -->
                            <div id="privacySettings" class="tab-content d-none animate-in slide-in-from-bottom-2 duration-300">
                                <form asp-controller="ProfileSettings" asp-action="UpdatePrivacy" asp-route-culture="@currentCulture" method="post" data-ajax="true">
                                    @Html.AntiForgeryToken()
                                    <div class="vstack gap-4">
                                        <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 p-md-5">
                                            <h3 class="xx-small fw-black text-dark text-uppercase tracking-widest mb-5 d-flex align-items-center gap-3">
                                                <i class="fas fa-eye text-primary-red"></i>
                                                @Localizer["ProfileVisibility"]
                                            </h3>
                                            <div class="vstack gap-4">
                                                <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 shadow-sm">
                                                    <div>
                                                        <p class="small fw-black text-dark mb-0">@Localizer["PublicProfile"]</p>
                                                        <p class="xx-small text-muted fw-bold mb-0">@Localizer["PublicProfileDescription"]</p>
                                                    </div>
                                                    <div class="form-check form-switch p-0 m-0">
                                                        <input type="checkbox" asp-for="PublicProfile" class="form-check-input ms-0" style="width: 44px; height: 22px;" />
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 shadow-sm">
                                                    <div>
                                                        <p class="small fw-black text-dark mb-0">@Localizer["ShowOnlineStatus"]</p>
                                                        <p class="xx-small text-muted fw-bold mb-0">@Localizer["ShowOnlineStatusDescription"]</p>
                                                    </div>
                                                    <div class="form-check form-switch p-0 m-0">
                                                        <input type="checkbox" asp-for="ShowOnlineStatus" class="form-check-input ms-0" style="width: 44px; height: 22px;" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 p-md-5">
                                            <h3 class="xx-small fw-black text-dark text-uppercase tracking-widest mb-5 d-flex align-items-center gap-3">
                                                <i class="fas fa-users text-primary-red"></i>
                                                @Localizer["ContactAndDiscovery"]
                                            </h3>
                                            <div class="vstack gap-4">
                                                <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 shadow-sm">
                                                    <div>
                                                        <p class="small fw-black text-dark mb-0">@Localizer["AllowMessages"]</p>
                                                        <p class="xx-small text-muted fw-bold mb-0">@Localizer["AllowMessagesDescription"]</p>
                                                    </div>
                                                    <div class="form-check form-switch p-0 m-0">
                                                        <input type="checkbox" asp-for="AllowMessages" class="form-check-input ms-0" style="width: 44px; height: 22px;" />
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 shadow-sm">
                                                    <div>
                                                        <p class="small fw-black text-dark mb-0">@Localizer["AllowFriendRequests"]</p>
                                                        <p class="xx-small text-muted fw-bold mb-0">@Localizer["AllowFriendRequestsDescription"]</p>
                                                    </div>
                                                    <div class="form-check form-switch p-0 m-0">
                                                        <input type="checkbox" asp-for="AllowFriendRequests" class="form-check-input ms-0" style="width: 44px; height: 22px;" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-dark w-100 py-3 rounded-4 xx-small fw-black text-uppercase tracking-widest shadow-lg">
                                            @Localizer["UpdatePrivacySettings"]
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Notifications Tab -->
                            <div id="notificationsSettings" class="tab-content d-none animate-in slide-in-from-bottom-2 duration-300">
                                <form asp-controller="ProfileSettings" asp-action="UpdateNotifications" asp-route-culture="@currentCulture" method="post" data-ajax="true">
                                    @Html.AntiForgeryToken()
                                    <div class="vstack gap-4">
                                        <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 p-md-5">
                                            <h3 class="xx-small fw-black text-dark text-uppercase tracking-widest mb-5 d-flex align-items-center gap-3">
                                                <i class="fas fa-paper-plane text-primary-red"></i>
                                                @Localizer["CommunicationChannels"]
                                            </h3>
                                            <div class="vstack gap-4">
                                                @foreach (var (prop, label, dec) in new[] { 
                                                    ("EmailNotifications", Localizer["EmailNotifications"], Localizer["EmailNotificationsDescription"]),
                                                    ("PushNotifications", Localizer["PushNotifications"], Localizer["PushNotificationsDescription"]) 
                                                }) {
                                                    <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 shadow-sm">
                                                        <div>
                                                            <p class="small fw-black text-dark mb-0">@label</p>
                                                            <p class="xx-small text-muted fw-bold mb-0">@dec</p>
                                                        </div>
                                                        <div class="form-check form-switch p-0 m-0">
                                                            <input type="checkbox" name="@prop" @(prop == "EmailNotifications" && Model.EmailNotifications || prop == "PushNotifications" && Model.PushNotifications ? "checked" : "") class="form-check-input ms-0" style="width: 44px; height: 22px;" />
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-dark w-100 py-3 rounded-4 xx-small fw-black text-uppercase tracking-widest shadow-lg">
                                            @Localizer["UpdateNotificationSettings"]
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Security Tab -->
                            <div id="securitySettings" class="tab-content d-none animate-in slide-in-from-bottom-2 duration-300">
                                <form asp-controller="ProfileSettings" asp-action="UpdateSecurity" asp-route-culture="@currentCulture" method="post" data-ajax="true">
                                    @Html.AntiForgeryToken()
                                    <div class="vstack gap-4">
                                        <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 p-md-5">
                                            <h3 class="xx-small fw-black text-dark text-uppercase tracking-widest mb-5 d-flex align-items-center gap-3">
                                                <i class="fas fa-lock text-primary-red"></i>
                                                @Localizer["PasswordManagement"]
                                            </h3>
                                            <div class="row g-4">
                                                <div class="col-12">
                                                    <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["CurrentPassword"]</label>
                                                    <input type="password" asp-for="CurrentPassword" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" />
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["NewPassword"]</label>
                                                    <input type="password" asp-for="NewPassword" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" />
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <label class="xx-small fw-black text-muted text-uppercase tracking-widest mb-2 d-block">@Localizer["ConfirmNewPassword"]</label>
                                                    <input type="password" asp-for="ConfirmPassword" class="form-control form-control-lg border-2 border-light rounded-3 bg-white" />
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-dark w-100 py-3 rounded-4 xx-small fw-black text-uppercase tracking-widest shadow-lg">
                                            @Localizer["ChangePassword"]
                                        </button>

                                        <!-- Danger Zone -->
                                        <div class="card border-danger border-opacity-25 bg-danger bg-opacity-5 rounded-4 p-4 p-md-5 mt-4">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h3 class="xx-small fw-black text-danger text-uppercase tracking-widest mb-2">@Localizer["DangerZone"]</h3>
                                                    <p class="small fw-black text-dark mb-0">@Localizer["DeleteAccount"]</p>
                                                    <p class="xx-small text-muted fw-bold mb-0">@Localizer["DeleteAccountDescription"]</p>
                                                </div>
                                                <button type="button" data-action="show-delete-modal" class="btn btn-danger rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest shadow-sm">
                                                    @Localizer["DeleteMyAccount"]
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .xx-small { font-size: 0.6rem; }
    .card-premium-subtle { border: 1px solid rgba(0,0,0,0.05); }
    .hover-translate-y:hover { transform: translateY(-3px); }
    .hover-scale-110:hover { transform: scale(1.1); }
    .backdrop-blur { backdrop-filter: blur(10px); }
    .transition-all { transition: all 0.3s ease; }
    .shadow-sm-hover:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .form-switch .form-check-input { cursor: pointer; }
    .form-switch .form-check-input:checked { background-color: var(--primary-red); border-color: var(--primary-red); }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="~/js/modules/profile/settings-controller.js" asp-append-version="true"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab Switching Logic (Legacy Support for the Controller)
            const tabButtons = document.querySelectorAll('[data-action="show-tab"]');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-tab');
                    
                    // Update buttons
                    tabButtons.forEach(b => {
                        b.classList.remove('btn-dark', 'shadow-sm');
                        b.classList.add('btn-link', 'text-muted');
                    });
                    btn.classList.add('btn-dark', 'shadow-sm');
                    btn.classList.remove('btn-link', 'text-muted');
                    
                    // Update content
                    tabContents.forEach(c => c.classList.add('d-none'));
                    document.getElementById(target + 'Settings').classList.remove('d-none');
                });
            });

            // Image Previews
            const setupPreview = (inputName, previewId) => {
                const input = document.querySelector(`input[name="${inputName}"]`);
                const preview = document.getElementById(previewId);
                if (input && preview) {
                    input.addEventListener('change', e => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = e => preview.src = e.target.result;
                            reader.readAsDataURL(file);
                        }
                    });
                }
            };
            setupPreview('ProfilePicture', 'profile-preview');
            setupPreview('CoverImage', 'cover-preview');
        });
    </script>
    
    @if (TempData["SuccessMessage"] != null)
    {
        <script>
            Toastify({
                text: "@TempData["SuccessMessage"]",
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
            }).showToast();
        </script>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <script>
            Toastify({
                text: "@TempData["ErrorMessage"]",
                duration: 4000,
                gravity: "top",
                position: "right",
                style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
            }).showToast();
        </script>
    }
}