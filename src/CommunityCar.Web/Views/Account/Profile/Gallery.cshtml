@model IEnumerable<CommunityCar.Application.Features.Account.ViewModels.Media.UserGalleryItemVM>
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Gallery"];
    ViewData["HideLeftSidebar"] = true;
    ViewData["HideRightSidebar"] = true;
    ViewData["HideMainContainer"] = true;
    ViewData["HideMainContentId"] = true;
    var hideLeftSidebar = false; // Always show profile sidebar
}

<div class="profile-container py-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
    <div>
        @if (hideLeftSidebar)
        {
            <!-- Single Column Layout - No Sidebar -->
            <div class="space-y-6">
                <!-- Cover Header with Integrated Profile Avatar -->
                @{
                    var coverImageUrl = ViewBag.CoverImageUrl as string ?? "/images/default-cover.svg";
                    var profilePictureUrl = ViewBag.ProfilePictureUrl as string ?? "/images/default-avatar.png";
                }
                <div class="relative h-48 rounded-2xl overflow-hidden shadow-lg mb-6">
                    <img src="@(coverImageUrl)?v=@DateTime.Now.Ticks" alt="Cover" class="w-full h-full object-cover" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                    
                    <!-- Profile Avatar integrated with cover -->
                    <div class="absolute bottom-4 left-6 flex items-end gap-3">
                        <!-- Profile Avatar -->
                        @{
                            ViewData["Size"] = "medium";
                            ViewData["Context"] = "cover";
                            ViewData["ShowLevel"] = false;
                            ViewData["ShowStatus"] = false;
                            ViewData["IconBadge"] = "image";
                        }
                        <partial name="~/Views/Account/Profile/_ProfileAvatar.cshtml" />
                        
                        <!-- Gallery Info -->
                        <div class="text-white pb-1">
                            <h1 class="text-2xl font-black mb-1 drop-shadow-lg">@Localizer["Gallery"]</h1>
                            <p class="text-white/90 font-medium drop-shadow-md">@ViewBag.ImageCount @Localizer["Images"]</p>
                        </div>
                    </div>
                    
                    <!-- Inner Profile Sidebar positioned over cover -->
                    <div class="absolute top-4 right-4 w-72 hidden lg:block">
                        <partial name="~/Views/Account/Profile/_InnerProfileSidebar.cshtml" />
                    </div>
                </div>

                <!-- Tab Navigation & Content -->
                <div class="bg-card border border-border rounded-2xl shadow-lg overflow-hidden">
                    <partial name="_ProfileNavigation" />

                    <div class="p-6 sm:p-8">
                        <div class="mb-8 border-b border-border pb-4 flex items-center justify-between">
                            <h1 class="text-2xl font-black flex items-center mb-0">
                                <i data-lucide="image" class="w-6 h-6 mr-3 text-primary"></i>@Localizer["Gallery"]
                                <span class="ml-2 text-sm font-normal text-muted-foreground">(@ViewBag.ImageCount @Localizer["Images"])</span>
                            </h1>
                            <button id="uploadBtn" class="inline-flex items-center justify-center bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all shadow-sm">
                                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                @Localizer["UploadImage"]
                            </button>
                        </div>

                        <!-- Upload Form (Hidden) -->
                        <div id="uploadForm" class="hidden mb-6 p-6 bg-background border border-border rounded-2xl">
                            <form asp-controller="Gallery" asp-action="Upload" method="post" enctype="multipart/form-data" id="imageUploadForm">
                                @Html.AntiForgeryToken()
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-2">@Localizer["SelectImage"]</label>
                                        <input type="file" name="file" accept="image/jpeg,image/png,image/webp" required 
                                               class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                                        <p class="text-xs text-muted-foreground mt-1">@Localizer["SupportedFormats"]: JPEG, PNG, WebP (Max 5MB)</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-foreground mb-2">@Localizer["Caption"] (@Localizer["Optional"])</label>
                                        <input type="text" name="caption" placeholder="@Localizer["EnterCaption"]"
                                               class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" name="isPublic" value="true" checked id="isPublicCheck" class="mr-2" />
                                        <input type="hidden" name="isPublic" value="false" />
                                        <label for="isPublicCheck" class="text-sm text-foreground">@Localizer["MakePublic"]</label>
                                    </div>
                                    <div class="flex gap-3">
                                        <button type="submit" class="bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                            @Localizer["Upload"]
                                        </button>
                                        <button type="button" id="cancelUpload" class="bg-background border border-border text-foreground hover:bg-muted font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                            @Localizer["Cancel"]
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Gallery Grid -->
                        @if (Model != null && Model.Any())
                        {
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="galleryGrid">
                                @foreach (var item in Model)
                                {
                                    <div class="gallery-item group relative bg-background border border-border rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300" data-image-id="@item.Id">
                                        <!-- Image -->
                                        <div class="aspect-square relative overflow-hidden">
                                            <img src="@item.ThumbnailUrl" alt="@item.Caption" 
                                                 class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer"
                                                 onclick="viewImage('@item.Id')" />
                                            
                                            <!-- Privacy Indicator -->
                                            <div class="absolute top-2 left-2">
                                                @if (item.IsPublic)
                                                {
                                                    <span class="inline-flex items-center px-2 py-1 bg-green-500/80 text-white text-xs font-medium rounded-full">
                                                        <i data-lucide="globe" class="w-3 h-3 mr-1"></i>
                                                        @Localizer["Public"]
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="inline-flex items-center px-2 py-1 bg-orange-500/80 text-white text-xs font-medium rounded-full">
                                                        <i data-lucide="lock" class="w-3 h-3 mr-1"></i>
                                                        @Localizer["Private"]
                                                    </span>
                                                }
                                            </div>

                                            <!-- Action Buttons (Show on Hover) -->
                                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                <div class="flex gap-1">
                                                    <button onclick="setAsProfilePicture('@item.Id')" 
                                                            class="p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-full transition-colors"
                                                            title="@Localizer["SetAsProfilePicture"]">
                                                        <i data-lucide="user" class="w-3 h-3"></i>
                                                    </button>
                                                    <button onclick="toggleVisibility('@item.Id')" 
                                                            class="p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-full transition-colors"
                                                            title="@Localizer["ToggleVisibility"]">
                                                        <i data-lucide="@(item.IsPublic ? "eye-off" : "eye")" class="w-3 h-3"></i>
                                                    </button>
                                                    <button onclick="deleteImage('@item.Id')" 
                                                            class="p-1.5 bg-red-500/70 hover:bg-red-500/90 text-white rounded-full transition-colors"
                                                            title="@Localizer["Delete"]">
                                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- View Count -->
                                            <div class="absolute bottom-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                <span class="inline-flex items-center px-2 py-1 bg-black/50 text-white text-xs rounded-full">
                                                    <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                                    @item.ViewCount
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Caption -->
                                        @if (!string.IsNullOrEmpty(item.Caption))
                                        {
                                            <div class="p-3">
                                                <p class="text-sm text-foreground line-clamp-2">@item.Caption</p>
                                                <p class="text-xs text-muted-foreground mt-1">@item.TimeAgo</p>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="p-3">
                                                <p class="text-xs text-muted-foreground">@item.TimeAgo</p>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- Empty State -->
                            <div class="text-center py-16">
                                <div class="w-24 h-24 mx-auto mb-6 bg-muted rounded-full flex items-center justify-center">
                                    <i data-lucide="image" class="w-12 h-12 text-muted-foreground"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-foreground mb-2">@Localizer["NoImagesYet"]</h3>
                                <p class="text-muted-foreground mb-6">@Localizer["StartBuildingGallery"]</p>
                                <button onclick="document.getElementById('uploadBtn').click()" 
                                        class="inline-flex items-center justify-center bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                    @Localizer["UploadFirstImage"]
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else
        {
            <!-- Two Column Layout - With Sidebar -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                
                <!-- Profile Sidebar Column -->
                <div class="lg:col-span-1">
                    <div class="bg-card border border-border rounded-2xl shadow-lg p-6 sticky top-24">
                        <partial name="~/Views/Account/Profile/_ProfileSidebar.cshtml" />
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="lg:col-span-3 space-y-6">
                
                    <!-- Tab Navigation & Content -->
                    <div class="bg-card border border-border rounded-2xl shadow-lg overflow-hidden">
                        <partial name="~/Views/Account/Profile/_ProfileNavigation.cshtml" />

                        <div class="p-6 sm:p-8">
                            <div class="mb-8 border-b border-border pb-4 flex items-center justify-between">
                                <h1 class="text-2xl font-black flex items-center mb-0">
                                    <i data-lucide="image" class="w-6 h-6 mr-3 text-primary"></i>@Localizer["Gallery"]
                                    <span class="ml-2 text-sm font-normal text-muted-foreground">(@ViewBag.ImageCount @Localizer["Images"])</span>
                                </h1>
                                <button id="uploadBtn" class="inline-flex items-center justify-center bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all shadow-sm">
                                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                    @Localizer["UploadImage"]
                                </button>
                            </div>

                            <!-- Upload Form (Hidden) -->
                            <div id="uploadForm" class="hidden mb-6 p-6 bg-background border border-border rounded-2xl">
                                <form asp-controller="Gallery" asp-action="Upload" method="post" enctype="multipart/form-data" id="imageUploadForm">
                                    @Html.AntiForgeryToken()
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-2">@Localizer["SelectImage"]</label>
                                            <input type="file" name="file" accept="image/jpeg,image/png,image/webp" required 
                                                   class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                                            <p class="text-xs text-muted-foreground mt-1">@Localizer["SupportedFormats"]: JPEG, PNG, WebP (Max 5MB)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-foreground mb-2">@Localizer["Caption"] (@Localizer["Optional"])</label>
                                            <input type="text" name="caption" placeholder="@Localizer["EnterCaption"]"
                                                   class="w-full px-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary" />
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" name="isPublic" value="true" checked id="isPublicCheck" class="mr-2" />
                                            <input type="hidden" name="isPublic" value="false" />
                                            <label for="isPublicCheck" class="text-sm text-foreground">@Localizer["MakePublic"]</label>
                                        </div>
                                        <div class="flex gap-3">
                                            <button type="submit" class="bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                                @Localizer["Upload"]
                                            </button>
                                            <button type="button" id="cancelUpload" class="bg-background border border-border text-foreground hover:bg-muted font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                                @Localizer["Cancel"]
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- Gallery Grid -->
                            @if (Model != null && Model.Any())
                            {
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="galleryGrid">
                                    @foreach (var item in Model)
                                    {
                                        <div class="gallery-item group relative bg-background border border-border rounded-xl overflow-hidden hover:shadow-lg transition-all duration-300" data-image-id="@item.Id">
                                            <!-- Image -->
                                            <div class="aspect-square relative overflow-hidden">
                                                <img src="@item.ThumbnailUrl" alt="@item.Caption" 
                                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 cursor-pointer"
                                                     onclick="viewImage('@item.Id')" />
                                                
                                                <!-- Privacy Indicator -->
                                                <div class="absolute top-2 left-2">
                                                    @if (item.IsPublic)
                                                    {
                                                        <span class="inline-flex items-center px-2 py-1 bg-green-500/80 text-white text-xs font-medium rounded-full">
                                                            <i data-lucide="globe" class="w-3 h-3 mr-1"></i>
                                                            @Localizer["Public"]
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="inline-flex items-center px-2 py-1 bg-orange-500/80 text-white text-xs font-medium rounded-full">
                                                            <i data-lucide="lock" class="w-3 h-3 mr-1"></i>
                                                            @Localizer["Private"]
                                                        </span>
                                                    }
                                                </div>

                                                <!-- Action Buttons (Show on Hover) -->
                                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                    <div class="flex gap-1">
                                                        <button onclick="setAsProfilePicture('@item.Id')" 
                                                                class="p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-full transition-colors"
                                                                title="@Localizer["SetAsProfilePicture"]">
                                                            <i data-lucide="user" class="w-3 h-3"></i>
                                                        </button>
                                                        <button onclick="toggleVisibility('@item.Id')" 
                                                                class="p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-full transition-colors"
                                                                title="@Localizer["ToggleVisibility"]">
                                                            <i data-lucide="@(item.IsPublic ? "eye-off" : "eye")" class="w-3 h-3"></i>
                                                        </button>
                                                        <button onclick="deleteImage('@item.Id')" 
                                                                class="p-1.5 bg-red-500/70 hover:bg-red-500/90 text-white rounded-full transition-colors"
                                                                title="@Localizer["Delete"]">
                                                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- View Count -->
                                                <div class="absolute bottom-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                    <span class="inline-flex items-center px-2 py-1 bg-black/50 text-white text-xs rounded-full">
                                                        <i data-lucide="eye" class="w-3 h-3 mr-1"></i>
                                                        @item.ViewCount
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- Caption -->
                                            @if (!string.IsNullOrEmpty(item.Caption))
                                            {
                                                <div class="p-3">
                                                    <p class="text-sm text-foreground line-clamp-2">@item.Caption</p>
                                                    <p class="text-xs text-muted-foreground mt-1">@item.TimeAgo</p>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="p-3">
                                                    <p class="text-xs text-muted-foreground">@item.TimeAgo</p>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <!-- Empty State -->
                                <div class="text-center py-16">
                                    <div class="w-24 h-24 mx-auto mb-6 bg-muted rounded-full flex items-center justify-center">
                                        <i data-lucide="image" class="w-12 h-12 text-muted-foreground"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold text-foreground mb-2">@Localizer["NoImagesYet"]</h3>
                                    <p class="text-muted-foreground mb-6">@Localizer["StartBuildingGallery"]</p>
                                    <button onclick="document.getElementById('uploadBtn').click()" 
                                            class="inline-flex items-center justify-center bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                                        @Localizer["UploadFirstImage"]
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

    <script src="~/js/services/gallery-service.js" asp-append-version="true"></script>
    <script src="~/js/modules/gallery-module.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Controller handles events via delegation
        });
    </script>
