@using CommunityCar.Application.Features.Account.ViewModels.Activity
@model WhoViewedMyProfileVM
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

<!-- Stats Overview Matrix -->
<div class="card card-premium overflow-hidden border-0 shadow-lg mb-4 rounded-4">
    <div class="row g-0">
        <div class="col-lg-8 p-4 p-md-5 border-end border-light">
            <div class="mb-5">
                <span class="badge rounded-pill bg-primary-red bg-opacity-10 text-primary-red xx-small fw-black text-uppercase tracking-widest px-3 py-2 border border-primary-red border-opacity-10 mb-3 d-inline-flex align-items-center gap-2">
                    <i class="fas fa-chart-line small"></i> @Localizer["IdentityAnalytics"]
                </span>
                <h1 class="display-5 fw-black text-dark tracking-tighter mb-0">@Localizer["ProfileIntelligence"]</h1>
            </div>

            <div class="row g-4 pt-2">
                <div class="col-6 col-md-3">
                    <div class="h2 fw-black text-dark mb-1">@Model.Stats.TotalViews.ToString("N0")</div>
                    <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["TotalViews"]</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h2 fw-black text-dark mb-1">@Model.Stats.UniqueViewers.ToString("N0")</div>
                    <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["UniqueViewers"]</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h2 fw-black text-dark mb-1">@Model.Stats.TodayViews.ToString("N0")</div>
                    <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50 text-primary-red">@Localizer["Today"]</div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="h2 fw-black text-dark mb-1">@Model.Stats.WeekViews.ToString("N0")</div>
                    <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["ThisWeek"]</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 bg-light bg-opacity-30 p-4 p-md-5 d-flex flex-column justify-content-center gap-4">
            @if (Model.Stats.LastViewedAt.HasValue)
            {
                <div class="p-3 bg-white rounded-4 shadow-sm border border-light transition-all hover-translate-y">
                    <div class="h6 fw-black mb-1 text-primary-red">@Model.Stats.LastViewedAt.Value.ToString("MMM dd, HH:mm")</div>
                    <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["LastViewed"]</div>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.Stats.MostCommonViewSource))
            {
                <div class="p-3 bg-white rounded-4 shadow-sm border border-light transition-all hover-translate-y">
                    <div class="h6 fw-black mb-1 text-dark text-capitalize">@Model.Stats.MostCommonViewSource</div>
                    <div class="xx-small fw-black text-uppercase tracking-widest text-muted opacity-50">@Localizer["TopSource"]</div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Viewers Matrix -->
<div class="card card-premium overflow-hidden border-0 shadow-lg mb-4 rounded-4">
    <div class="card-header border-0 bg-transparent p-4 p-md-5 pb-0">
        <h3 class="xx-small fw-black text-dark text-uppercase tracking-widest mb-0 d-flex align-items-center gap-3">
            <span class="badge bg-primary-red rounded-pill px-3 py-2">@Model.Viewers.Count()</span>
            @Localizer["RecentIntelligenceNodes"]
        </h3>
    </div>

    <div class="card-body p-4 p-md-5">
        @if (Model.Viewers.Any())
        {
            <div class="vstack gap-4">
                @foreach (var viewer in Model.Viewers)
                {
                    <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 hover-white transition-all shadow-sm-hover">
                        <div class="d-flex align-items-center gap-4">
                            <!-- Avatar Node -->
                            <div class="position-relative flex-shrink-0">
                                <div class="rounded-circle overflow-hidden border-2 border-white shadow-sm" style="width: 70px; height: 70px;">
                                    @if (!string.IsNullOrEmpty(viewer.ViewerProfilePicture))
                                    {
                                        <img src="@viewer.ViewerProfilePicture" alt="@viewer.ViewerName" class="w-100 h-100 object-fit-cover transition-all duration-500 hover-scale-110" />
                                    }
                                    else
                                    {
                                        <div class="w-100 h-100 bg-white d-flex align-items-center justify-content-center text-muted">
                                            <i class="fas fa-user fs-3 opacity-20"></i>
                                        </div>
                                    }
                                </div>
                            </div>

                            <!-- Identification & Intel -->
                            <div class="flex-grow-1 min-w-0">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="fw-black text-dark mb-0">@(viewer.ViewerName ?? Localizer["AnonymousUser"].Value)</h5>
                                        <div class="d-flex align-items-center gap-3 xx-small fw-bold text-muted mt-1">
                                            @if (!string.IsNullOrEmpty(viewer.ViewerLocation))
                                            {
                                                <span class="text-uppercase tracking-widest"><i class="fas fa-map-marker-alt text-primary-red me-1"></i> @viewer.ViewerLocation</span>
                                            }
                                            @if (viewer.IsFollowing)
                                            {
                                                <span class="badge rounded-pill bg-primary-red bg-opacity-10 text-primary-red px-2 py-1 border border-primary-red border-opacity-10 opacity-75">
                                                    @(viewer.IsMutualFollowing ? Localizer["Mutual"] : Localizer["Following"])
                                                </span>
                                            }
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="xx-small fw-black text-dark text-uppercase tracking-widest">@viewer.ViewCount @Localizer["Views"]</div>
                                        <div class="xx-small text-muted fw-bold opacity-50">@viewer.LastViewedAt.ToString("MMM dd, HH:mm")</div>
                                    </div>
                                </div>

                                <!-- Meta Intelligence Grid -->
                                <div class="row g-2 pt-3 border-top border-light mt-2">
                                    <div class="col-4 border-end border-light">
                                        <div class="xx-small fw-black text-dark">@viewer.ViewCount</div>
                                        <div class="xx-small text-muted text-uppercase tracking-widest opacity-40">@Localizer["Frequency"]</div>
                                    </div>
                                    <div class="col-4 border-end border-light">
                                        <div class="xx-small fw-black text-dark">@((int)viewer.AverageViewDuration.TotalSeconds)s</div>
                                        <div class="xx-small text-muted text-uppercase tracking-widest opacity-40">@Localizer["AvgDuration"]</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="xx-small fw-black text-dark">@((DateTime.Now - viewer.FirstViewedAt).Days)d</div>
                                        <div class="xx-small text-muted text-uppercase tracking-widest opacity-40">@Localizer["CycleAge"]</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Operation Nodes -->
                            <div class="d-flex flex-md-column gap-2 ms-md-auto">
                                <a href="@Url.Action("Index", "Profile", new { userId = viewer.ViewerId })" 
                                   class="btn btn-white rounded-3 shadow-sm p-3 border border-light transition-all hover-translate-y">
                                    <i class="fas fa-user-circle text-dark fs-5"></i>
                                </a>
                                @if (!viewer.IsFollowing && viewer.ViewerId != Guid.Empty)
                                {
                                    <button onclick="followUser('@viewer.ViewerId')" 
                                            class="btn btn-primary-red rounded-3 shadow-sm p-3 transition-all hover-translate-y">
                                        <i class="fas fa-user-plus text-white fs-5"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination Matrix -->
            @if (Model.HasPreviousPage || Model.HasNextPage)
            {
                <div class="mt-5 d-flex justify-content-center gap-3">
                    @if (Model.HasPreviousPage)
                    {
                        <a href="@Url.Action("WhoViewedMyProfile", new { page = Model.Page - 1, pageSize = Model.PageSize })" 
                           class="btn btn-outline-dark px-4 py-2 rounded-pill xx-small fw-black text-uppercase tracking-widest">
                            @Localizer["Previous"]
                        </a>
                    }
                    @if (Model.HasNextPage)
                    {
                        <a href="@Url.Action("WhoViewedMyProfile", new { page = Model.Page + 1, pageSize = Model.PageSize })" 
                           class="btn btn-primary-red px-5 py-2 rounded-pill xx-small fw-black text-uppercase tracking-widest shadow-lg">
                            @Localizer["Next"]
                        </a>
                    }
                </div>
            }
        }
        else
        {
            <!-- Zero State Hub -->
            <div class="text-center py-5 border border-dashed border-2 border-light rounded-5 mt-4">
                <div class="bg-light bg-opacity-50 rounded-circle d-flex align-items-center justify-content-center mx-auto mb-4 border border-light shadow-sm" style="width: 100px; height: 100px;">
                    <i class="fas fa-eye-slash text-muted opacity-20 display-4"></i>
                </div>
                <h4 class="fw-black text-dark mb-2">@Localizer["NoResultTitle"]</h4>
                <p class="xx-small text-muted fw-black text-uppercase tracking-widest opacity-50">@Localizer["NoViewsStatus"]</p>
            </div>
        }
    </div>
</div>

<!-- Quick Actions Matrix -->
<div class="d-flex flex-wrap gap-3">
    <a href="@Url.Action("ViewAnalytics")" class="btn btn-primary-red px-4 py-3 rounded-4 xx-small fw-black text-uppercase tracking-widest shadow-lg">
        <i class="fas fa-chart-bar me-2 small"></i> @Localizer["FullAnalyticsReport"]
    </a>
    <a href="@Url.Action("MyViewHistory")" class="btn btn-white px-4 py-3 rounded-4 xx-small fw-black text-uppercase tracking-widest border border-light shadow-sm">
        <i class="fas fa-history me-2 small"></i> @Localizer["ViewHistoryMatrix"]
    </a>
</div>

<style>
    .xx-small { font-size: 0.6rem; }
    .card-premium-subtle { border: 1px solid rgba(0,0,0,0.05); }
    .hover-white:hover { background-color: #fff !important; border-color: var(--primary-red) !important; }
    .shadow-sm-hover:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }
    .hover-translate-y:hover { transform: translateY(-3px); }
    .hover-scale-110:hover { transform: scale(1.1); }
    .hover-translate-y-2:hover { transform: translateY(-3px); }
</style>