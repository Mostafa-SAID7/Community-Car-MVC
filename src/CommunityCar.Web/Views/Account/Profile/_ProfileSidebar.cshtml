@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    var userId = ViewBag.UserId?.ToString();
    var fullName = ViewBag.FullName as string ?? "User";
    var userName = ViewBag.UserName as string ?? "---";
    var profilePictureUrl = ViewBag.ProfilePictureUrl as string ?? "/images/default-avatar.png";
    var bio = ViewBag.Bio as string;
    var bioAr = ViewBag.BioAr as string;
    var city = ViewBag.City as string ?? "---";
    var country = ViewBag.Country as string ?? "---";
    var createdAt = ViewBag.CreatedAt is DateTime dt ? dt : DateTime.Now;
    
    var rank = ViewBag.Rank as int? ?? 0;
    var level = ViewBag.Level as int? ?? 0;
    var points = ViewBag.TotalPoints as int? ?? 0;
    var posts = ViewBag.PostsCount as int? ?? 0;
    var comments = ViewBag.CommentsCount as int? ?? 0;
    var badges = ViewBag.BadgesCount as int? ?? 0;

    var currentCulture = System.Globalization.CultureInfo.CurrentCulture.Name;
    var isArabic = currentCulture.StartsWith("ar");
    var displayBio = isArabic && !string.IsNullOrEmpty(bioAr) ? bioAr : bio;
    
    var isOwnProfile = User.Identity?.IsAuthenticated == true && 
                       User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == userId;
}

<!-- Profile Information Card -->
<div class="card card-premium p-4 border-0 mb-4 overflow-hidden position-relative group">
    <!-- Identity Header -->
    <div class="text-center mb-4">
        <div class="user-avatar-container mx-auto mb-3" style="width: 120px; height: 120px;">
            <img src="@profilePictureUrl" alt="@fullName" class="rounded-circle object-fit-cover w-100 h-100 shadow-lg border-4 border-white" />
            <div class="position-absolute bottom-0 end-0 bg-primary-red text-white rounded-circle d-flex align-items-center justify-content-center fw-black shadow-sm" style="width: 32px; height: 32px; font-size: 0.65rem; border: 3px solid white;">
                LVL @level
            </div>
        </div>
        
        <h4 class="fw-black mb-1 text-gradient">@fullName</h4>
        <p class="small text-muted opacity-50 fw-bold text-uppercase tracking-widest mb-3">@@@userName</p>

        <!-- Rank Badge -->
        <span class="badge bg-primary-red-subtle text-primary-red rounded-pill px-3 py-2 border border-primary-red small fw-black tracking-widest">
            RANK #@rank.ToString("N0")
        </span>
    </div>

    <!-- Actions -->
    <div class="d-grid gap-2 mb-4">
        @if (isOwnProfile)
        {
            <a asp-controller="ProfileSettings" asp-action="Index" asp-route-culture="@currentCulture" class="btn btn-primary-red shadow-sm animate-heartbeat">
                <i data-lucide="edit-3" class="me-2" style="width: 16px;"></i> @Localizer["EditProfile"]
            </a>
        }
    </div>

    <!-- Bio -->
    <div class="bg-light p-3 rounded-4 border mb-4 text-center">
        <p class="mb-0 small fw-medium text-muted font-italic">
            "@(string.IsNullOrEmpty(displayBio) ? Localizer["NoBio"].Value : displayBio)"
        </p>
    </div>

    <!-- Metadata -->
    <div class="d-flex flex-column gap-2 mb-4 border-top pt-4">
        <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-black text-muted opacity-40 text-uppercase tracking-widest d-flex align-items-center gap-2">
                <i data-lucide="map-pin" class="text-primary-red" style="width: 14px;"></i> @Localizer["Location"]
            </span>
            <span class="small fw-bold">@city</span>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <span class="small fw-black text-muted opacity-40 text-uppercase tracking-widest d-flex align-items-center gap-2">
                <i data-lucide="calendar" class="text-primary-red" style="width: 14px;"></i> @Localizer["Joined"]
            </span>
            <span class="small fw-bold">@createdAt.ToString("MMM yyyy")</span>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="border-top pt-4">
        <nav class="small fw-black text-uppercase tracking-widest text-primary-red mb-3 d-flex align-items-center gap-2">
            <i data-lucide="bar-chart-3" style="width: 16px;"></i> @Localizer["Statistics"]
        </nav>
        <div class="row g-2">
            <div class="col-6">
                <div class="bg-light p-3 rounded-4 border h-100 group-hover-bg-primary-red-subtle transition-all">
                    <span class="d-block small fw-black text-muted opacity-40 text-uppercase tracking-tighter mb-1">Points</span>
                    <span class="h5 fw-black mb-0">@points.ToString("N0")</span>
                </div>
            </div>
            <div class="col-6">
                <div class="bg-light p-3 rounded-4 border h-100">
                    <span class="d-block small fw-black text-muted opacity-40 text-uppercase tracking-tighter mb-1">Badges</span>
                    <span class="h5 fw-black mb-0">@badges</span>
                </div>
            </div>
            <div class="col-6">
                <div class="bg-light p-3 rounded-4 border h-100">
                    <span class="d-block small fw-black text-muted opacity-40 text-uppercase tracking-tighter mb-1">Posts</span>
                    <span class="h5 fw-black mb-0">@posts</span>
                </div>
            </div>
            <div class="col-6">
                <div class="bg-light p-3 rounded-4 border h-100">
                    <span class="d-block small fw-black text-muted opacity-40 text-uppercase tracking-tighter mb-1">Comments</span>
                    <span class="h5 fw-black mb-0">@comments</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Profile Navigation using Standard Sidebar -->
<div class="standard-sidebar profile-theme">
    <nav class="flex-grow-1">
        <ul class="nav nav-pills flex-column mb-auto gap-2">
            @{
                Func<string, string, bool> isActive = (controller, action) => 
                {
                    var routeData = ViewContext.RouteData.Values;
                    return string.Equals(routeData["controller"]?.ToString(), controller, StringComparison.OrdinalIgnoreCase) &&
                           string.Equals(routeData["action"]?.ToString(), action, StringComparison.OrdinalIgnoreCase);
                };
            }
            
            <li class="nav-item">
                <a asp-controller="Profile" asp-action="Index" asp-route-id="@userId" asp-route-culture="@currentCulture" 
                   class="nav-link sidebar-nav-link @(isActive("Profile", "Index") ? "active" : "") d-flex align-items-center gap-3 py-3 px-3 rounded-4 transition-all">
                    <i data-lucide="user" class="sidebar-icon opacity-75" style="width: 20px; height: 20px;"></i>
                    <span class="sidebar-text fw-bold small text-uppercase tracking-wider">@Localizer["Profile"]</span>
                </a>
            </li>

            <li class="nav-item">
                <a asp-controller="Profile" asp-action="Gallery" asp-route-id="@userId" asp-route-culture="@currentCulture" 
                   class="nav-link sidebar-nav-link @(isActive("Profile", "Gallery") ? "active" : "") d-flex align-items-center gap-3 py-3 px-3 rounded-4 transition-all">
                    <i data-lucide="image" class="sidebar-icon opacity-75" style="width: 20px; height: 20px;"></i>
                    <span class="sidebar-text fw-bold small text-uppercase tracking-wider">@Localizer["Gallery"]</span>
                </a>
            </li>

            <li class="nav-item">
                <a asp-controller="Profile" asp-action="Interests" asp-route-id="@userId" asp-route-culture="@currentCulture" 
                   class="nav-link sidebar-nav-link @(isActive("Profile", "Interests") ? "active" : "") d-flex align-items-center gap-3 py-3 px-3 rounded-4 transition-all">
                    <i data-lucide="heart" class="sidebar-icon opacity-75" style="width: 20px; height: 20px;"></i>
                    <span class="sidebar-text fw-bold small text-uppercase tracking-wider">@Localizer["Interests"]</span>
                </a>
            </li>

            @if (isOwnProfile)
            {
                <li class="nav-item">
                    <hr class="sidebar-divider my-3 opacity-10">
                </li>
                
                <li class="nav-item">
                    <a asp-controller="ProfileSettings" asp-action="Index" asp-route-culture="@currentCulture" 
                       class="nav-link sidebar-nav-link @(isActive("ProfileSettings", "Index") ? "active" : "") d-flex align-items-center gap-3 py-3 px-3 rounded-4 transition-all">
                        <i data-lucide="settings" class="sidebar-icon opacity-75" style="width: 20px; height: 20px;"></i>
                        <span class="sidebar-text fw-bold small text-uppercase tracking-wider">@Localizer["Settings"]</span>
                    </a>
                </li>
            }
        </ul>
    </nav>
</div>
