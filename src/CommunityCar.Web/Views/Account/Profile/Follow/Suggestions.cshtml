@using CommunityCar.Application.Features.Account.ViewModels.Social
@model FollowSuggestionsVM
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["DiscoverPeople"];
    ViewData["HideLeftSidebar"] = true;
    ViewData["HideRightSidebar"] = true;
    ViewData["HideMainContainer"] = true;
    ViewData["HideMainContentId"] = true;
}

<div class="container-fluid py-4 animate-in fade-in">
    <!-- Grid Layout with Sidebar -->
    <div class="row g-4">
        <!-- Left Sidebar -->
        <div class="col-12 col-lg-3">
            <partial name="~/Views/Account/Profile/_ProfileSidebar.cshtml" />
        </div>
        
        <!-- Main Content Area -->
        <div class="col-12 col-lg-9">
            <div class="vstack gap-4">
                <!-- Tab Navigation (Context) -->
                <partial name="~/Views/Account/Profile/_ProfileNavigation.cshtml" />

                <!-- Suggestions Content Card -->
                <div class="card card-premium border-0 shadow-lg overflow-hidden rounded-4">
                    <div class="card-body p-4 p-md-5">
                        <!-- Header -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4 mb-5 pb-4 border-bottom border-light">
                            <div>
                                <h1 class="h3 fw-black text-dark tracking-tighter mb-1 d-flex align-items-center gap-3">
                                    <i class="fas fa-user-plus text-primary-red"></i>
                                    @Localizer["DiscoverInterests"]
                                </h1>
                                <p class="small text-muted fw-bold mb-0">@Localizer["DiscoverSubtitle"]</p>
                            </div>
                        </div>

                        <!-- Suggestions Grid Matrix -->
                        @if (Model.SuggestedUsers.Any())
                        {
                            <div class="row g-4">
                                @foreach (var user in Model.SuggestedUsers)
                                {
                                    <div class="col-12 col-md-6 col-xl-4">
                                        <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 text-center hover-white shadow-hover transition-all duration-300 h-100 position-relative overflow-hidden">
                                            <!-- Suggestion Node Intel -->
                                            @if (!string.IsNullOrEmpty(user.SuggestionReason))
                                            {
                                                <div class="position-absolute top-0 start-0 w-100 p-2">
                                                    <span class="badge rounded-pill bg-primary-red bg-opacity-10 text-primary-red xx-small fw-black text-uppercase tracking-widest px-3 py-1 border border-primary-red border-opacity-10">
                                                        @user.SuggestionReason
                                                    </span>
                                                </div>
                                            }

                                            <!-- Identity Node -->
                                            <div class="pt-3 mb-4">
                                                <div class="mx-auto rounded-4 overflow-hidden border-2 border-light shadow-sm mb-3" style="width: 80px; height: 80px;">
                                                    <img src="@(user.ProfilePictureUrl ?? "/images/default-avatar.png")?v=@DateTime.Now.Ticks" 
                                                         alt="@user.FullName" class="w-100 h-100 object-fit-cover transition-all duration-500 hover-scale-110" />
                                                </div>
                                                <a href="@Url.Action("Index", "Profile", new { userId = user.UserId })" 
                                                   class="h6 fw-black text-dark text-decoration-none hover-text-primary-red transition-all block mb-1">
                                                    @user.FullName
                                                </a>
                                                @if (!string.IsNullOrEmpty(user.City))
                                                {
                                                    <p class="xx-small fw-bold text-muted opacity-50 text-uppercase tracking-widest mb-0">
                                                        <i class="fas fa-map-marker-alt me-1"></i> @user.City
                                                    </p>
                                                }
                                            </div>

                                            <!-- Meta Analytics -->
                                            <div class="d-flex justify-content-center gap-3 mb-4 pb-3 border-bottom border-light border-opacity-50">
                                                <div class="text-center">
                                                    <div class="xx-small fw-black text-dark">@user.FollowersCount</div>
                                                    <div class="xx-small fw-bold text-muted text-uppercase tracking-widest opacity-40">Followers</div>
                                                </div>
                                                <div class="vr bg-light opacity-50"></div>
                                                <div class="text-center">
                                                    <div class="xx-small fw-black text-dark">@user.PostsCount</div>
                                                    <div class="xx-small fw-bold text-muted text-uppercase tracking-widest opacity-40">Posts</div>
                                                </div>
                                            </div>

                                            @if (user.MutualFollowersCount > 0)
                                            {
                                                <div class="xx-small fw-black text-muted mb-4 opacity-75">
                                                    <i class="fas fa-link me-1"></i> @user.MutualFollowersCount @Localizer["MutualConnections"]
                                                </div>
                                            }

                                            <!-- Interaction Flow -->
                                            <button onclick="toggleFollow('@user.UserId')" 
                                                    id="follow-btn-@user.UserId"
                                                    class="btn btn-primary-red w-100 rounded-pill py-2.5 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y">
                                                <i class="fas fa-plus me-2 small"></i> @Localizer["Follow"]
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- Terminal Hub: Zero State -->
                            <div class="text-center py-5">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 100px; height: 100px;">
                                    <i class="fas fa-search text-muted opacity-20 display-4"></i>
                                </div>
                                <h3 class="h4 fw-black text-dark mb-2">@Localizer["NoSuggestionsTitle"]</h3>
                                <p class="small text-muted fw-bold mb-4 mx-auto" style="max-width: 400px;">
                                    @Localizer["NoSuggestionsMsg"]
                                </p>
                                <a href="@Url.Action("Index", "Home")" 
                                   class="btn btn-primary-red px-5 py-3 rounded-pill xx-small fw-black text-uppercase tracking-widest shadow-lg transition-all hover-translate-y">
                                    <i class="fas fa-users me-2 small"></i> @Localizer["ExploreCommunity"]
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .xx-small { font-size: 0.6rem; }
    .card-premium-subtle { border: 1px solid rgba(0,0,0,0.05); }
    .hover-white:hover { background-color: #fff !important; border-color: var(--primary-red) !important; }
    .shadow-hover:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .hover-translate-y:hover { transform: translateY(-3px); }
    .hover-scale-110:hover { transform: scale(1.1); }
</style>

@section Scripts {
    <script>
        async function toggleFollow(userId) {
            const btn = document.getElementById(`follow-btn-${userId}`);
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
            
            try {
                const response = await fetch(`/Profile/Follow/toggle/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || document.querySelector('input[name="antiforgery-token"]')?.value
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.isFollowing) {
                        btn.textContent = '@Localizer["Following"]';
                        btn.className = 'btn btn-light w-100 rounded-pill py-2.5 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y';
                    } else {
                        btn.innerHTML = '<i class="fas fa-plus me-2 small"></i> @Localizer["Follow"]';
                        btn.className = 'btn btn-primary-red w-100 rounded-pill py-2.5 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y';
                    }
                } else {
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
                btn.innerHTML = originalText;
            }
            
            btn.disabled = false;
        }
    </script>
}