@using CommunityCar.Application.Features.Account.ViewModels.Social
@model UserFollowListVM
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    var title = Model.ListType == "following" ? Localizer["Following"] : Localizer["Followers"];
    ViewData["Title"] = $"{Model.ProfileUserName}'s {title}";
    ViewData["HideLeftSidebar"] = true;
    ViewData["HideRightSidebar"] = true;
    ViewData["HideMainContainer"] = true;
    ViewData["HideMainContentId"] = true;
}

<div class="container-fluid py-4 animate-in fade-in">
    <!-- Grid Layout with Sidebar -->
    <div class="row g-4">
        <!-- Left Sidebar -->
        <div class="col-12 col-lg-3">
            <partial name="~/Views/Account/Profile/_ProfileSidebar.cshtml" />
        </div>
        
        <!-- Main Content Area -->
        <div class="col-12 col-lg-9">
            <div class="vstack gap-4">
                <!-- Tab Navigation (Re-using profile navigation for context) -->
                <partial name="~/Views/Account/Profile/_ProfileNavigation.cshtml" />

                <!-- List Content Card -->
                <div class="card card-premium border-0 shadow-lg overflow-hidden rounded-4">
                    <div class="card-body p-4 p-md-5">
                        <!-- Header -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-4 mb-5 pb-4 border-bottom border-light">
                            <div>
                                <h1 class="h3 fw-black text-dark tracking-tighter mb-1 d-flex align-items-center gap-3">
                                    <i class="fas @(Model.ListType == "following" ? "fa-user-plus" : "fa-users") text-primary-red"></i>
                                    @title
                                    <span class="xx-small fw-black text-muted text-uppercase tracking-widest opacity-50 ms-2">(@Model.TotalCount)</span>
                                </h1>
                                <p class="small text-muted fw-bold mb-0">@Model.ProfileUserName's social network matrix.</p>
                            </div>
                            
                            @if (Model.IsOwnProfile)
                            {
                                <a href="@Url.Action("Suggestions", "Follow")" class="btn btn-primary-red px-4 py-2 rounded-3 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y">
                                    <i class="fas fa-search me-2 small"></i> @Localizer["DiscoverPeople"]
                                </a>
                            }
                        </div>

                        <!-- Secondary Tab Navigation (Following/Followers Toggle) -->
                        <div class="d-flex gap-2 mb-5">
                            <a href="@Url.Action("Following", "Follow", new { userId = Model.ProfileUserId })" 
                               class="btn @(Model.ListType == "following" ? "btn-dark shadow-sm" : "btn-link text-muted") rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest text-decoration-none transition-all">
                                @Localizer["Following"]
                            </a>
                            <a href="@Url.Action("Followers", "Follow", new { userId = Model.ProfileUserId })" 
                               class="btn @(Model.ListType == "followers" ? "btn-dark shadow-sm" : "btn-link text-muted") rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest text-decoration-none transition-all">
                                @Localizer["Followers"]
                            </a>
                        </div>

                        <!-- Users Matrix -->
                        @if (Model.Users.Any())
                        {
                            <div class="vstack gap-3">
                                @foreach (var user in Model.Users)
                                {
                                    <div class="card card-premium-subtle bg-light bg-opacity-30 border-light rounded-4 p-4 hover-white shadow-hover transition-all duration-300">
                                        <div class="d-flex align-items-center gap-4">
                                            <!-- Avatar -->
                                            <div class="position-relative">
                                                <div class="rounded-4 overflow-hidden border border-light shadow-sm" style="width: 70px; height: 70px;">
                                                    <img src="@(user.ProfilePictureUrl ?? "/images/default-avatar.png")?v=@DateTime.Now.Ticks" 
                                                         alt="@user.FullName" class="w-100 h-100 object-fit-cover transition-all duration-500 hover-scale-110" />
                                                </div>
                                                @if (user.IsOnline)
                                                {
                                                    <div class="position-absolute bottom-0 end-0 bg-success border-2 border-white rounded-circle shadow-glow-success animate-pulse-subtle" style="width: 14px; height: 14px;"></div>
                                                }
                                            </div>

                                            <!-- Identity & Meta -->
                                            <div class="flex-grow-1 min-w-0">
                                                <div class="d-flex align-items-center gap-2 mb-1">
                                                    <a href="@Url.Action("Index", "Profile", new { userId = user.UserId })" 
                                                       class="h6 fw-black text-dark text-decoration-none hover-text-primary-red transition-all truncate mb-0">
                                                        @user.FullName
                                                    </a>
                                                    @if (user.IsFollowingBack)
                                                    {
                                                        <span class="badge rounded-pill bg-primary-red bg-opacity-10 text-primary-red xx-small fw-black text-uppercase tracking-widest px-2 py-1 border border-primary-red border-opacity-20 ms-1">
                                                            @Localizer["FollowsYou"]
                                                        </span>
                                                    }
                                                </div>
                                                
                                                @if (!string.IsNullOrEmpty(user.Bio))
                                                {
                                                    <p class="xx-small fw-medium text-muted mb-2 line-clamp-1 opacity-75">@user.Bio</p>
                                                }
                                                
                                                <div class="d-flex align-items-center gap-3 xx-small fw-black text-muted text-uppercase tracking-widest opacity-50">
                                                    <span><i class="fas fa-users me-1 small"></i> @user.FollowersCount @Localizer["Followers"]</span>
                                                    <span class="dot"></span>
                                                    <span><i class="fas fa-newspaper me-1 small"></i> @user.PostsCount @Localizer["Posts"]</span>
                                                    @if (user.LastActiveAt.HasValue)
                                                    {
                                                        <span class="dot d-none d-md-inline"></span>
                                                        <span class="d-none d-md-inline"><i class="fas fa-clock me-1 small"></i> @user.LastActiveAt.Value.ToString("MMM dd")</span>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Interaction Node -->
                                            @if (!Model.IsOwnProfile || user.UserId != Guid.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? ""))
                                            {
                                                <button onclick="toggleFollow('@user.UserId')" 
                                                        id="follow-btn-@user.UserId"
                                                        class="btn @(user.IsFollowingBack ? "btn-light" : "btn-primary-red") rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y">
                                                    @(user.IsFollowingBack ? Localizer["Following"] : Localizer["Follow"])
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Pagination Matrix -->
                            @if (Model.Pagination.TotalPages > 1)
                            {
                                <div class="mt-5 d-flex justify-content-center">
                                    <nav>
                                        <ul class="pagination pagination-sm gap-2 border-0">
                                            @if (Model.Pagination.CurrentPage > 1)
                                            {
                                                <li class="page-item">
                                                    <a class="page-link border-0 rounded-3 bg-light text-dark px-3 py-2 fw-black xx-small shadow-sm" 
                                                       href="@Url.Action(Model.ListType == "following" ? "Following" : "Followers", "Follow", new { userId = Model.ProfileUserId, page = Model.Pagination.CurrentPage - 1 })">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </a>
                                                </li>
                                            }

                                            @for (int i = Math.Max(1, Model.Pagination.CurrentPage - 2); i <= Math.Min(Model.Pagination.TotalPages, Model.Pagination.CurrentPage + 2); i++)
                                            {
                                                <li class="page-item @(i == Model.Pagination.CurrentPage ? "active" : "")">
                                                    <a class="page-link border-0 rounded-3 @(i == Model.Pagination.CurrentPage ? "bg-dark text-white" : "bg-light text-dark") px-3 py-2 fw-black xx-small shadow-sm" 
                                                       href="@Url.Action(Model.ListType == "following" ? "Following" : "Followers", "Follow", new { userId = Model.ProfileUserId, page = i })">
                                                        @i
                                                    </a>
                                                </li>
                                            }

                                            @if (Model.Pagination.CurrentPage < Model.Pagination.TotalPages)
                                            {
                                                <li class="page-item">
                                                    <a class="page-link border-0 rounded-3 bg-light text-dark px-3 py-2 fw-black xx-small shadow-sm" 
                                                       href="@Url.Action(Model.ListType == "following" ? "Following" : "Followers", "Follow", new { userId = Model.ProfileUserId, page = Model.Pagination.CurrentPage + 1 })">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </a>
                                                </li>
                                            }
                                        </ul>
                                    </nav>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- Terminal Hub: Zero State -->
                            <div class="text-center py-5">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-4" style="width: 100px; height: 100px;">
                                    <i class="fas @(Model.ListType == "following" ? "fa-user-plus" : "fa-users") text-muted opacity-20 display-4"></i>
                                </div>
                                <h3 class="h4 fw-black text-dark mb-2">@Localizer["NoResultTitle"]</h3>
                                <p class="small text-muted fw-bold mb-4 mx-auto" style="max-width: 300px;">
                                    @(Model.IsOwnProfile ? Localizer["StartFollowingMsg"] : Localizer["NoSocialActivityMsg"])
                                </p>
                                @if (Model.IsOwnProfile && Model.ListType == "following")
                                {
                                    <a href="@Url.Action("Suggestions", "Follow")" 
                                       class="btn btn-primary-red px-5 py-3 rounded-pill xx-small fw-black text-uppercase tracking-widest shadow-lg transition-all hover-translate-y">
                                        <i class="fas fa-search me-2 small"></i> @Localizer["DiscoverNewUsers"]
                                    </a>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .xx-small { font-size: 0.6rem; }
    .card-premium-subtle { border: 1px solid rgba(0,0,0,0.05); }
    .hover-white:hover { background-color: #fff !important; border-color: var(--primary-red) !important; }
    .shadow-hover:hover { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .hover-translate-y:hover { transform: translateY(-3px); }
    .hover-scale-110:hover { transform: scale(1.1); }
    .dot { width: 4px; height: 4px; border-radius: 50%; background: currentColor; opacity: 0.3; }
</style>

@section Scripts {
    <script>
        async function toggleFollow(userId) {
            const btn = document.getElementById(`follow-btn-${userId}`);
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
            
            try {
                const response = await fetch(`/Profile/Follow/toggle/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || document.querySelector('input[name="antiforgery-token"]')?.value
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.textContent = result.isFollowing ? '@Localizer["Following"]' : '@Localizer["Follow"]';
                    btn.className = result.isFollowing ? 
                        'btn btn-light rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y' :
                        'btn btn-primary-red rounded-pill px-4 py-2 xx-small fw-black text-uppercase tracking-widest shadow-sm transition-all hover-translate-y';
                } else {
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
                btn.innerHTML = originalText;
            }
            
            btn.disabled = false;
        }
    </script>
}