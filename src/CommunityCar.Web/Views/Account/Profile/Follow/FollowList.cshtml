@using CommunityCar.Application.Features.Account.ViewModels.Social
@model UserFollowListVM
@{
    ViewData["Title"] = Model.ListType == "following" ? $"{Model.ProfileUserName}'s Following" : $"{Model.ProfileUserName}'s Followers";
    ViewData["PageHeader"] = ViewData["Title"];
    ViewData["PageDescription"] = $"View {Model.ListType} list";
}

<div class="space-y-8 animate-in fade-in duration-700">
    <!-- Header -->
    <div class="eng-card overflow-hidden">
        <div class="p-8 md:p-12 border-b border-border/30">
            <div class="flex items-center justify-between">
                <div class="space-y-2">
                    <h1 class="text-3xl md:text-4xl font-black text-foreground tracking-tighter">
                        @(Model.ListType == "following" ? "Following" : "Followers")
                    </h1>
                    <p class="text-muted-foreground">
                        @Model.ProfileUserName has @Model.TotalCount @(Model.ListType == "following" ? "following" : "followers")
                    </p>
                </div>
                
                @if (Model.IsOwnProfile)
                {
                    <div class="flex gap-3">
                        <a href="@Url.Action("Suggestions", "Follow")" class="px-4 py-2 bg-primary text-primary-foreground rounded-2xl text-sm font-black uppercase tracking-widest hover:bg-primary/90 transition-colors">
                            Find People
                        </a>
                    </div>
                }
            </div>
        </div>

        <!-- Tabs -->
        <div class="border-b border-border/30">
            <div class="flex">
                <a href="@Url.Action("Following", "Follow", new { userId = Model.ProfileUserId })" 
                   class="px-6 py-4 text-sm font-black uppercase tracking-widest transition-colors @(Model.ListType == "following" ? "text-primary border-b-2 border-primary" : "text-muted-foreground hover:text-foreground")">
                    Following
                </a>
                <a href="@Url.Action("Followers", "Follow", new { userId = Model.ProfileUserId })" 
                   class="px-6 py-4 text-sm font-black uppercase tracking-widest transition-colors @(Model.ListType == "followers" ? "text-primary border-b-2 border-primary" : "text-muted-foreground hover:text-foreground")">
                    Followers
                </a>
            </div>
        </div>
    </div>

    <!-- Users List -->
    @if (Model.Users.Any())
    {
        <div class="space-y-4">
            @foreach (var user in Model.Users)
            {
                <div class="eng-card p-6 hover:-translate-y-1 transition-all duration-300">
                    <div class="flex items-center gap-4">
                        <!-- Profile Picture -->
                        <div class="relative">
                            <img src="@(user.ProfilePictureUrl ?? "/images/default-avatar.png")?v=@DateTime.Now.Ticks" 
                                 alt="@user.FullName" 
                                 class="w-16 h-16 rounded-2xl object-cover border-2 border-border/50" />
                            @if (user.IsOnline)
                            {
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-background shadow-glow-success"></div>
                            }
                        </div>

                        <!-- User Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <a href="@Url.Action("Index", "Profile", new { userId = user.UserId })" 
                                   class="text-lg font-black text-foreground hover:text-primary transition-colors truncate">
                                    @user.FullName
                                </a>
                                @if (user.IsFollowingBack)
                                {
                                    <span class="px-2 py-1 bg-blue-500/10 text-blue-600 text-xs font-black uppercase tracking-widest rounded-xl border border-blue-500/20">
                                        Follows You
                                    </span>
                                }
                            </div>
                            
                            @if (!string.IsNullOrEmpty(user.Bio))
                            {
                                <p class="text-sm text-muted-foreground mb-2 line-clamp-2">@user.Bio</p>
                            }
                            
                            @if (!string.IsNullOrEmpty(user.City) || !string.IsNullOrEmpty(user.Country))
                            {
                                <p class="text-xs text-muted-foreground opacity-60 mb-2">
                                    <i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>
                                    @user.City@(!string.IsNullOrEmpty(user.City) && !string.IsNullOrEmpty(user.Country) ? ", " : "")@user.Country
                                </p>
                            }

                            <div class="flex items-center gap-4 text-xs text-muted-foreground">
                                <span>@user.FollowersCount followers</span>
                                <span>@user.FollowingCount following</span>
                                <span>@user.PostsCount posts</span>
                                @if (user.LastActiveAt.HasValue)
                                {
                                    <span>Active @user.LastActiveAt.Value.ToString("MMM dd")</span>
                                }
                            </div>
                        </div>

                        <!-- Follow Button -->
                        @if (!Model.IsOwnProfile || user.UserId != Guid.Parse(User.FindFirst("sub")?.Value ?? ""))
                        {
                            <button onclick="toggleFollow('@user.UserId')" 
                                    id="follow-btn-@user.UserId"
                                    class="px-4 py-2 rounded-2xl text-sm font-black uppercase tracking-widest transition-all hover:scale-105 active:scale-95 @(user.IsFollowingBack ? "bg-muted text-foreground hover:bg-muted/80" : "bg-primary text-primary-foreground hover:bg-primary/90")">
                                @(user.IsFollowingBack ? "Following" : "Follow")
                            </button>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (Model.Pagination.TotalPages > 1)
        {
            <div class="flex justify-center">
                <nav class="flex items-center gap-2">
                    @if (Model.Pagination.CurrentPage > 1)
                    {
                        <a href="@Url.Action(Model.ListType == "following" ? "Following" : "Followers", "Follow", new { userId = Model.ProfileUserId, page = Model.Pagination.CurrentPage - 1 })" 
                           class="px-4 py-2 bg-muted text-foreground rounded-2xl hover:bg-muted/80 transition-colors">
                            Previous
                        </a>
                    }

                    @for (int i = Math.Max(1, Model.Pagination.CurrentPage - 2); i <= Math.Min(Model.Pagination.TotalPages, Model.Pagination.CurrentPage + 2); i++)
                    {
                        <a href="@Url.Action(Model.ListType == "following" ? "Following" : "Followers", "Follow", new { userId = Model.ProfileUserId, page = i })" 
                           class="px-4 py-2 rounded-2xl transition-colors @(i == Model.Pagination.CurrentPage ? "bg-primary text-primary-foreground" : "bg-muted text-foreground hover:bg-muted/80")">
                            @i
                        </a>
                    }

                    @if (Model.Pagination.CurrentPage < Model.Pagination.TotalPages)
                    {
                        <a href="@Url.Action(Model.ListType == "following" ? "Following" : "Followers", "Follow", new { userId = Model.ProfileUserId, page = Model.Pagination.CurrentPage + 1 })" 
                           class="px-4 py-2 bg-muted text-foreground rounded-2xl hover:bg-muted/80 transition-colors">
                            Next
                        </a>
                    }
                </nav>
            </div>
        }
    }
    else
    {
        <div class="eng-card p-12 text-center">
            <div class="w-16 h-16 bg-muted/40 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="users" class="w-8 h-8 text-muted-foreground opacity-40"></i>
            </div>
            <h3 class="text-xl font-black text-foreground mb-3">
                No @(Model.ListType == "following" ? "Following" : "Followers") Yet
            </h3>
            <p class="text-muted-foreground mb-6">
                @if (Model.IsOwnProfile)
                {
                    @(Model.ListType == "following" ? "Start following people to see them here." : "Share your profile to get followers.")
                }
                else
                {
                    @($"{Model.ProfileUserName} hasn't {(Model.ListType == "following" ? "followed anyone" : "gained any followers")} yet.")
                }
            </p>
            @if (Model.IsOwnProfile && Model.ListType == "following")
            {
                <a href="@Url.Action("Suggestions", "Follow")" 
                   class="px-6 py-3 bg-primary text-primary-foreground rounded-2xl font-black uppercase tracking-widest hover:bg-primary/90 transition-colors">
                    Find People to Follow
                </a>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        async function toggleFollow(userId) {
            const btn = document.getElementById(`follow-btn-${userId}`);
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                const response = await fetch(`/Profile/Follow/toggle/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    btn.textContent = result.isFollowing ? 'Following' : 'Follow';
                    btn.className = result.isFollowing ? 
                        'px-4 py-2 rounded-2xl text-sm font-black uppercase tracking-widest transition-all hover:scale-105 active:scale-95 bg-muted text-foreground hover:bg-muted/80' :
                        'px-4 py-2 rounded-2xl text-sm font-black uppercase tracking-widest transition-all hover:scale-105 active:scale-95 bg-primary text-primary-foreground hover:bg-primary/90';
                } else {
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error toggling follow:', error);
                btn.textContent = originalText;
            }
            
            btn.disabled = false;
        }
    </script>
}