@model IEnumerable<CommunityCar.Application.Features.Account.ViewModels.Media.UserGalleryItemVM>
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Gallery"];
    var isOwner = ViewBag.IsOwner as bool? ?? false;
    var userId = ViewBag.UserId as Guid? ?? Guid.Empty;
}

@section Styles {
    <link rel="stylesheet" href="~/css/profile-leetcode.css" asp-append-version="true" />
    <style>
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 1rem;
            overflow: hidden;
            background: var(--background);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }
        
        .gallery-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
        }
        
        .gallery-item:hover .gallery-overlay {
            opacity: 1;
        }
        
        .gallery-actions {
            display: flex;
            gap: 0.5rem;
            align-self: flex-end;
        }
        
        .gallery-info {
            color: white;
            align-self: flex-end;
        }
        
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: var(--primary)/5;
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: var(--primary)/10;
        }
    </style>
}

<div class="profile-container py-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-black text-foreground flex items-center gap-3">
                    <i data-lucide="image" class="w-8 h-8 text-primary"></i>
                    @Localizer["Gallery"]
                </h1>
                <p class="text-muted-foreground mt-2">@Localizer["GalleryDescription"]</p>
            </div>
            
            @if (isOwner)
            {
                <button id="uploadBtn" class="inline-flex items-center gap-2 bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-3 px-6 rounded-xl transition-all shadow-lg shadow-primary/20">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    @Localizer["UploadImage"]
                </button>
            }
        </div>

        <!-- Upload Area (Hidden by default) -->
        @if (isOwner)
        {
            <div id="uploadArea" class="leetcode-card mb-8 hidden">
                <div class="p-6">
                    <h3 class="text-lg font-bold mb-4">@Localizer["UploadNewImage"]</h3>
                    
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="upload-area mb-4" id="dropZone">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-muted-foreground mx-auto mb-4"></i>
                            <p class="text-lg font-medium text-foreground mb-2">@Localizer["DragDropOrClick"]</p>
                            <p class="text-sm text-muted-foreground">@Localizer["SupportedFormats"]</p>
                            <input type="file" id="fileInput" name="file" accept="image/*" class="hidden" />
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">@Localizer["Caption"]</label>
                                <input type="text" name="caption" class="w-full px-3 py-2 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20" placeholder="@Localizer["CaptionPlaceholder"]" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-foreground mb-2">@Localizer["Privacy"]</label>
                                <select name="isPublic" class="w-full px-3 py-2 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
                                    <option value="true">@Localizer["Public"]</option>
                                    <option value="false">@Localizer["Private"]</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="submit" class="bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                @Localizer["Upload"]
                            </button>
                            <button type="button" id="cancelUpload" class="bg-background border border-border text-foreground hover:bg-muted font-bold text-sm py-2 px-4 rounded-lg transition-all">
                                @Localizer["Cancel"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }

        <!-- Gallery Grid -->
        @if (Model.Any())
        {
            <div class="gallery-grid">
                @foreach (var item in Model)
                {
                    <div class="gallery-item" data-id="@item.Id">
                        <img src="@item.ThumbnailUrl" alt="@item.Caption" loading="lazy" />
                        
                        <div class="gallery-overlay">
                            @if (isOwner)
                            {
                                <div class="gallery-actions">
                                    <button class="action-btn set-profile" data-id="@item.Id" title="@Localizer["SetAsProfile"]">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                    </button>
                                    <button class="action-btn set-cover" data-id="@item.Id" title="@Localizer["SetAsCover"]">
                                        <i data-lucide="image" class="w-4 h-4"></i>
                                    </button>
                                    <button class="action-btn toggle-visibility" data-id="@item.Id" title="@(item.IsPublic ? Localizer["MakePrivate"] : Localizer["MakePublic"])">
                                        <i data-lucide="@(item.IsPublic ? "eye" : "eye-off")" class="w-4 h-4"></i>
                                    </button>
                                    <button class="action-btn delete-item" data-id="@item.Id" title="@Localizer["Delete"]">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            }
                            
                            <div class="gallery-info">
                                @if (!string.IsNullOrEmpty(item.Caption))
                                {
                                    <p class="text-sm font-medium mb-1">@item.Caption</p>
                                }
                                <div class="flex items-center gap-2 text-xs opacity-80">
                                    <span>@item.TimeAgo</span>
                                    @if (!item.IsPublic)
                                    {
                                        <i data-lucide="lock" class="w-3 h-3"></i>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="leetcode-card p-12 text-center">
                <i data-lucide="image" class="w-16 h-16 text-muted-foreground mx-auto mb-4"></i>
                <h3 class="text-xl font-bold text-foreground mb-2">@Localizer["NoImagesYet"]</h3>
                <p class="text-muted-foreground mb-6">@Localizer["NoImagesDescription"]</p>
                @if (isOwner)
                {
                    <button id="uploadBtnEmpty" class="bg-primary text-primary-foreground hover:bg-primary/90 font-bold text-sm py-3 px-6 rounded-xl transition-all">
                        @Localizer["UploadFirstImage"]
                    </button>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadBtnEmpty = document.getElementById('uploadBtnEmpty');
            const uploadArea = document.getElementById('uploadArea');
            const cancelUpload = document.getElementById('cancelUpload');
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const uploadForm = document.getElementById('uploadForm');

            // Show/hide upload area
            function showUploadArea() {
                uploadArea.classList.remove('hidden');
                uploadArea.scrollIntoView({ behavior: 'smooth' });
            }

            function hideUploadArea() {
                uploadArea.classList.add('hidden');
            }

            uploadBtn?.addEventListener('click', showUploadArea);
            uploadBtnEmpty?.addEventListener('click', showUploadArea);
            cancelUpload?.addEventListener('click', hideUploadArea);

            // Drag and drop functionality
            dropZone?.addEventListener('click', () => fileInput.click());
            
            dropZone?.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone?.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone?.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                }
            });

            // Upload form submission
            uploadForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(uploadForm);
                const userId = '@userId';
                
                try {
                    const response = await fetch(`/profile/${userId}/gallery/upload`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        location.reload(); // Refresh to show new image
                    } else {
                        alert(result.message || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                }
            });

            // Gallery actions
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    const action = btn.classList.contains('set-profile') ? 'set-profile' :
                                  btn.classList.contains('set-cover') ? 'set-cover' :
                                  btn.classList.contains('toggle-visibility') ? 'toggle-visibility' :
                                  btn.classList.contains('delete-item') ? 'delete' : '';
                    
                    const imageId = btn.dataset.id;
                    const userId = '@userId';
                    
                    if (action === 'delete' && !confirm('@Localizer["ConfirmDelete"]')) {
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/profile/${userId}/gallery/${imageId}/${action}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            }
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            if (action === 'delete') {
                                btn.closest('.gallery-item').remove();
                            } else if (action === 'toggle-visibility') {
                                location.reload(); // Refresh to update visibility icons
                            } else {
                                alert(result.message || 'Action completed');
                            }
                        } else {
                            alert(result.message || 'Action failed');
                        }
                    } catch (error) {
                        console.error('Action error:', error);
                        alert('Action failed');
                    }
                });
            });
        });
    </script>
    
    <style>
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }
        
        .action-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
    </style>
}