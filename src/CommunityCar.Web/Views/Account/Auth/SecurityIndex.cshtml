@model CommunityCar.Application.Features.Account.ViewModels.Security.SecurityVM
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = "Security Settings";
    Layout = "_Layout";
}

<div class="container py-5 animate-in fade-in slide-in-from-bottom-4 duration-500">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Header -->
            <div class="text-center mb-5">
                <div class="position-relative d-inline-flex align-items-center justify-content-center mb-4">
                    <div class="position-absolute inset-0 bg-primary opacity-25 rounded-circle blur-xl animate-pulse"></div>
                    <div class="position-relative w-16 h-16 rounded-4 bg-card border border-border d-flex align-items-center justify-content-center text-primary shadow-lg" style="width: 64px; height: 64px;">
                        <i data-lucide="shield" class="w-8 h-8"></i>
                    </div>
                </div>
                <h1 class="display-6 fw-black text-gradient tracking-tight mb-2">Security Settings</h1>
                <p class="text-sm text-muted-foreground uppercase tracking-widest fw-bold opacity-75">Manage your account security and privacy</p>
            </div>

            <div class="d-grid gap-4">
                <!-- Security Overview -->
                <div class="card card-premium shadow-lg border-0 overflow-hidden">
                    <div class="card-body p-4 p-md-5">
                        <h2 class="h5 fw-black text-uppercase tracking-widest mb-5 d-flex align-items-center gap-2 text-primary-red">
                            <i data-lucide="shield-check" class="w-5 h-5"></i>
                            Security Overview
                        </h2>
                        
                        <div class="row g-4">
                            <!-- Two-Factor Authentication -->
                            <div class="col-12 col-sm-6 col-lg-3">
                                <div class="card h-100 border-border bg-muted-subtle rounded-4 p-3 transition-all hover-translate-y-sm">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div class="w-10 h-10 rounded-circle @(Model.Overview.TwoFactorEnabled ? "bg-success bg-opacity-10 text-success" : "bg-warning bg-opacity-10 text-warning") d-flex align-items-center justify-content-center">
                                            <i data-lucide="@(Model.Overview.TwoFactorEnabled ? "shield-check" : "shield-alert")" class="w-5 h-5"></i>
                                        </div>
                                        <span class="badge rounded-pill @(Model.Overview.TwoFactorEnabled ? "bg-success bg-opacity-10 text-success" : "bg-warning bg-opacity-10 text-warning") px-2 py-1 text-[10px] fw-black text-uppercase tracking-widest">
                                            @(Model.Overview.TwoFactorEnabled ? "Enabled" : "Disabled")
                                        </span>
                                    </div>
                                    <h3 class="h6 fw-bold mb-1">Two-Factor Auth</h3>
                                    <p class="text-xs text-muted-foreground mb-0">
                                        @(Model.Overview.TwoFactorEnabled ? "Account protected" : "Add extra layer")
                                    </p>
                                </div>
                            </div>

                            <!-- Active Sessions -->
                            <div class="col-12 col-sm-6 col-lg-3">
                                <div class="card h-100 border-border bg-muted-subtle rounded-4 p-3 transition-all hover-translate-y-sm">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div class="w-10 h-10 rounded-circle bg-info bg-opacity-10 text-info d-flex align-items-center justify-content-center">
                                            <i data-lucide="monitor" class="w-5 h-5"></i>
                                        </div>
                                        <span class="badge rounded-pill bg-info bg-opacity-10 text-info px-2 py-1 text-[10px] fw-black text-uppercase tracking-widest">
                                            @Model.ActiveSessions.Count Active
                                        </span>
                                    </div>
                                    <h3 class="h6 fw-bold mb-1">Sessions</h3>
                                    <p class="text-xs text-muted-foreground mb-0">Connected devices</p>
                                </div>
                            </div>

                            <!-- Password -->
                            <div class="col-12 col-sm-6 col-lg-3">
                                <div class="card h-100 border-border bg-muted-subtle rounded-4 p-3 transition-all hover-translate-y-sm">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div class="w-10 h-10 rounded-circle bg-primary-red bg-opacity-10 text-primary-red d-flex align-items-center justify-content-center">
                                            <i data-lucide="key" class="w-5 h-5"></i>
                                        </div>
                                        <span class="badge rounded-pill bg-primary-red bg-opacity-10 text-primary-red px-2 py-1 text-[10px] fw-black text-uppercase tracking-widest">
                                            @(Model.Overview.LastPasswordChange?.ToString("MMM dd") ?? "Never")
                                        </span>
                                    </div>
                                    <h3 class="h6 fw-bold mb-1">Password</h3>
                                    <p class="text-xs text-muted-foreground mb-0">Last updated</p>
                                </div>
                            </div>

                            <!-- External Logins -->
                            <div class="col-12 col-sm-6 col-lg-3">
                                <div class="card h-100 border-border bg-muted-subtle rounded-4 p-3 transition-all hover-translate-y-sm">
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div class="w-10 h-10 rounded-circle bg-indigo-100 text-indigo-600 d-flex align-items-center justify-content-center">
                                            <i data-lucide="link" class="w-5 h-5"></i>
                                        </div>
                                        <span class="badge rounded-pill bg-indigo-100 text-indigo-800 px-2 py-1 text-[10px] fw-black text-uppercase tracking-widest">
                                            @(Model.Overview.HasExternalLogins ? "Linked" : "None")
                                        </span>
                                    </div>
                                    <h3 class="h6 fw-bold mb-1">Logins</h3>
                                    <p class="text-xs text-muted-foreground mb-0">Social links</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Actions -->
                <div class="row g-4">
                    <!-- Authentication Settings -->
                    <div class="col-12 col-lg-6">
                        <div class="card card-premium shadow-lg border-0 h-100">
                            <div class="card-body p-4">
                                <h3 class="h6 fw-black text-uppercase tracking-widest text-primary-red mb-4 d-flex align-items-center gap-2">
                                    <i data-lucide="lock" class="w-5 h-5"></i>
                                    Authentication
                                </h3>
                                
                                <div class="d-grid gap-3">
                                    <div class="d-flex align-items-center justify-content-between p-3 bg-muted-subtle border border-border rounded-4 transition-all hover-bg-muted">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="w-10 h-10 rounded-4 bg-primary-red bg-opacity-10 text-primary-red d-flex align-items-center justify-content-center">
                                                <i data-lucide="key" class="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <h4 class="h6 fw-bold mb-1">Update Password</h4>
                                                <p class="text-xs text-muted-foreground mb-0">Regular rotation advised</p>
                                            </div>
                                        </div>
                                        <a href="/account/security/change-password" class="btn btn-primary-red btn-sm rounded-pill px-3 fw-black text-uppercase tracking-widest text-[10px]">
                                            Change
                                        </a>
                                    </div>

                                    <div class="d-flex align-items-center justify-content-between p-3 bg-muted-subtle border border-border rounded-4 transition-all hover-bg-muted">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="w-10 h-10 rounded-4 @(Model.Overview.TwoFactorEnabled ? "bg-success bg-opacity-10 text-success" : "bg-warning bg-opacity-10 text-warning") d-flex align-items-center justify-content-center">
                                                <i data-lucide="shield-check" class="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <h4 class="h6 fw-bold mb-1">Two-Factor</h4>
                                                <p class="text-xs text-muted-foreground mb-0">
                                                    @(Model.Overview.TwoFactorEnabled ? "Currently active" : "Enable extra layer")
                                                </p>
                                            </div>
                                        </div>
                                        <a href="/account/security/two-factor" class="btn @(Model.Overview.TwoFactorEnabled ? "btn-outline-secondary" : "btn-primary-red") btn-sm rounded-pill px-3 fw-black text-uppercase tracking-widest text-[10px]">
                                            @(Model.Overview.TwoFactorEnabled ? "Manage" : "Enable")
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Session Management -->
                    <div class="col-12 col-lg-6">
                        <div class="card card-premium shadow-lg border-0 h-100">
                            <div class="card-body p-4">
                                <h3 class="h6 fw-black text-uppercase tracking-widest text-primary-red mb-4 d-flex align-items-center gap-2">
                                    <i data-lucide="monitor" class="w-5 h-5"></i>
                                    Active Sessions
                                </h3>
                                
                                <div class="d-grid gap-2">
                                    @if (Model.ActiveSessions.Any())
                                    {
                                        @foreach (var session in Model.ActiveSessions.Take(3))
                                        {
                                            <div class="d-flex align-items-center justify-content-between p-3 bg-muted-subtle border border-border rounded-4 transition-all hover-bg-muted">
                                                <div class="d-flex align-items-center gap-3">
                                                    <div class="w-10 h-10 rounded-4 bg-info bg-opacity-10 text-info d-flex align-items-center justify-content-center">
                                                        <i data-lucide="@(session.IsCurrent ? "monitor" : "smartphone")" class="w-5 h-5"></i>
                                                    </div>
                                                    <div>
                                                        <h4 class="h6 fw-bold mb-1 p-0">
                                                            @(session.IsCurrent ? "Current Session" : "Other Device")
                                                        </h4>
                                                        <p class="text-[10px] text-muted-foreground mb-0">
                                                            @session.IpAddress • @session.LastActivityAt.ToString("MMM dd, HH:mm")
                                                        </p>
                                                    </div>
                                                </div>
                                                @if (!session.IsCurrent)
                                                {
                                                    <button class="btn btn-link text-danger text-decoration-none p-0 fw-black text-uppercase tracking-widest text-[10px] hover-opacity-75">
                                                        Revoke
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-2 py-1 text-[9px] fw-black text-uppercase tracking-widest">
                                                        Active
                                                    </span>
                                                }
                                            </div>
                                        }
                                        
                                        @if (Model.ActiveSessions.Count > 3)
                                        {
                                            <div class="text-center pt-2">
                                                <button class="btn btn-link text-primary-red text-decoration-none fw-black text-uppercase tracking-widest text-[10px] p-0">
                                                    View All Sessions (@Model.ActiveSessions.Count)
                                                </button>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="text-center py-4 text-muted-foreground opacity-50">
                                            <i data-lucide="monitor" class="w-8 h-8 mb-2"></i>
                                            <p class="text-xs fw-bold text-uppercase tracking-widest mb-0">No active sessions</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Security Activity -->
                @if (Model.Overview.RecentActivity.Any())
                {
                    <div class="card card-premium shadow-lg border-0 overflow-hidden">
                        <div class="card-body p-4">
                            <h3 class="h6 fw-black text-uppercase tracking-widest text-primary-red mb-4 d-flex align-items-center gap-2">
                                <i data-lucide="activity" class="w-5 h-5"></i>
                                Security Protocol Log
                            </h3>
                            
                            <div class="d-grid gap-2">
                                @foreach (var activity in Model.Overview.RecentActivity.Take(5))
                                {
                                    <div class="d-flex align-items-center gap-4 p-3 bg-muted-subtle border border-border rounded-4 transition-all hover-bg-muted">
                                        <div class="w-10 h-10 rounded-circle @(activity.IsSuccess ? "bg-success bg-opacity-10 text-success" : "bg-danger bg-opacity-10 text-danger") d-flex align-items-center justify-content-center">
                                            <i data-lucide="@(activity.IsSuccess ? "check" : "x")" class="w-5 h-5"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h4 class="h6 fw-bold mb-1">@activity.Action</h4>
                                            <p class="text-[10px] text-muted-foreground mb-0">
                                                @activity.IpAddress • @activity.Location • @activity.Timestamp.ToString("MMM dd, HH:mm")
                                            </p>
                                        </div>
                                        <div class="text-[10px] fw-black text-uppercase tracking-widest text-muted-foreground">
                                            @activity.Device
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Back Button -->
                <div class="text-center pt-4 pb-5">
                    <a href="/profile/settings" class="btn btn-outline-secondary px-5 py-3 rounded-pill fw-black text-uppercase tracking-widest text-xs transition-all hover-bg-muted">
                        <i data-lucide="arrow-left" class="w-4 h-4 me-2"></i>
                        Settings Mainframe
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Handle TempData messages
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
            toastr.success('@Html.Raw(Html.Encode(TempData["SuccessMessage"].ToString()).Replace("'", "\\'"))');
            </text>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <text>
            toastr.error('@Html.Raw(Html.Encode(TempData["ErrorMessage"].ToString()).Replace("'", "\\'"))');
            </text>
        }
    </script>
}