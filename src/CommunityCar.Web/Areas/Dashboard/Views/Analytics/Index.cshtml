@model CommunityCar.Application.Features.Dashboard.Analytics.ViewModels.AnalyticsVM
@{
    ViewData["Title"] = "Analytics Dashboard";
    ViewData["PageTitle"] = "Analytics";
    ViewData["Description"] = "Comprehensive analytics and insights";
    Layout = "_DashboardLayout";
}

<div class="container-fluid py-4 animate-in fade-in">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-5 mt-2">
        <div>
            <h2 class="fw-black text-gradient mb-1"><i class="fas fa-chart-line me-2 small opacity-50"></i>Analytics Engine</h2>
            <p class="text-muted small text-uppercase tracking-widest opacity-50 fw-black">Deep behavioral insights and performance metrics</p>
        </div>
        <div class="d-flex gap-2 bg-light p-1 rounded-4 shadow-sm">
            <button type="button" class="btn btn-sm px-3 rounded-3 fw-bold transition-all" id="btn-7d" onclick="setDateRange('7d')">7D</button>
            <button type="button" class="btn btn-sm px-3 rounded-3 fw-bold transition-all" id="btn-30d" onclick="setDateRange('30d')">30D</button>
            <button type="button" class="btn btn-sm btn-primary-red px-3 rounded-3 fw-bold shadow-sm" id="btn-90d" onclick="setDateRange('90d')">90D</button>
        </div>
    </div>

    <!-- Analytics Navigation -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card card-premium border-0 overflow-hidden">
                <div class="card-body p-2">
                    <ul class="nav nav-pills nav-fill gap-2" id="analyticsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-3 py-3 fw-black text-uppercase tracking-widest small" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-chart-pie me-2 opacity-50"></i>Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-3 py-3 fw-black text-uppercase tracking-widest small" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab">
                                <i class="fas fa-users me-2 opacity-50"></i>Users
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-3 py-3 fw-black text-uppercase tracking-widest small" id="content-tab" data-bs-toggle="pill" data-bs-target="#content" type="button" role="tab">
                                <i class="fas fa-file-alt me-2 opacity-50"></i>Content
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-3 py-3 fw-black text-uppercase tracking-widest small" id="traffic-tab" data-bs-toggle="pill" data-bs-target="#traffic" type="button" role="tab">
                                <i class="fas fa-network-wired me-2 opacity-50"></i>Traffic
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="analyticsTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row g-4">
                <div class="col-md-8">
                    <div class="card card-premium border-0 h-100">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="fw-black text-uppercase tracking-tight mb-0">System-Wide Performance</h5>
                            <i class="fas fa-expand-alt text-muted opacity-50 cursor-pointer"></i>
                        </div>
                        <div class="card-body p-4">
                            <div class="chart-container">
                                <canvas id="overviewChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-premium border-0 h-100">
                        <div class="card-header bg-transparent border-0 pt-4 px-4">
                            <h5 class="fw-black text-uppercase tracking-tight mb-0">Key Infrastructure Metrics</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="vstack gap-3">
                                <div class="p-3 rounded-4 bg-light border border-light transition-all hover-translate-x">
                                    <div class="text-muted xx-small fw-black text-uppercase tracking-widest mb-1">Total System Engagement</div>
                                    <div class="d-flex justify-content-between align-items-end">
                                        <h3 class="fw-black mb-0">@(Model?.TotalViews?.ToString("N0") ?? "0")</h3>
                                        <span class="badge rounded-pill bg-success bg-opacity-10 text-success fw-bold small"><i class="fas fa-caret-up me-1"></i>12%</span>
                                    </div>
                                    <div class="text-muted small opacity-50 fw-bold">Aggregate page views</div>
                                </div>

                                <div class="p-3 rounded-4 bg-light border border-light transition-all hover-translate-x">
                                    <div class="text-muted xx-small fw-black text-uppercase tracking-widest mb-1">Unique Entity Reach</div>
                                    <div class="d-flex justify-content-between align-items-end">
                                        <h3 class="fw-black mb-0">@(Model?.UniqueVisitors?.ToString("N0") ?? "0")</h3>
                                        <span class="badge rounded-pill bg-success bg-opacity-10 text-success fw-bold small"><i class="fas fa-caret-up me-1"></i>5%</span>
                                    </div>
                                    <div class="text-muted small opacity-50 fw-bold">Individual visitor count</div>
                                </div>

                                <div class="p-3 rounded-4 bg-light border border-light transition-all hover-translate-x">
                                    <div class="text-muted xx-small fw-black text-uppercase tracking-widest mb-1">Retention Friction</div>
                                    <div class="d-flex justify-content-between align-items-end">
                                        <h3 class="fw-black mb-0">@(Model?.BounceRate?.ToString("F1") ?? "0")%</h3>
                                        <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger fw-bold small"><i class="fas fa-caret-up me-1"></i>2%</span>
                                    </div>
                                    <div class="text-muted small opacity-50 fw-bold">Single-page session rate</div>
                                </div>

                                <div class="p-4 rounded-4 bg-dark text-white shadow-lg mt-2 overflow-hidden position-relative">
                                    <div class="position-absolute top-0 end-0 p-3 opacity-10">
                                        <i class="fas fa-hourglass-start fs-1"></i>
                                    </div>
                                    <div class="text-white text-opacity-50 xx-small fw-black text-uppercase tracking-widest mb-1">Avg. Temporal Depth</div>
                                    <h3 class="fw-black mb-0 text-white">@(Model?.AverageSessionDuration?.ToString(@"mm\:ss") ?? "00:00")</h3>
                                    <div class="text-white text-opacity-25 small fw-bold">Time per session segment</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card card-premium border-0 h-100">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="fw-black text-uppercase tracking-tight mb-0">Behavioral Matrix</h5>
                            <a href="@Url.Action("Index", "UserAnalyticsBehavior")" class="btn btn-sm btn-ghost text-primary-red analytics-deep-audit-btn">
                                Deep Audit <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                        <div class="card-body p-4">
                            <div class="chart-container-sm">
                                <canvas id="userBehaviorChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-premium border-0 h-100">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="fw-black text-uppercase tracking-tight mb-0">User Stratification</h5>
                            <a href="@Url.Action("Index", "UserAnalyticsSegments")" class="btn btn-sm btn-ghost text-primary-red analytics-deep-audit-btn">
                                Segment Analysis <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                        <div class="card-body p-4">
                            <div class="chart-container-sm">
                                <canvas id="userSegmentsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Tab -->
        <div class="tab-pane fade" id="content" role="tabpanel">
            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card card-premium border-0">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="fw-black text-uppercase tracking-tight mb-0">Entity Performance Feed</h5>
                            <a href="@Url.Action("Index", "ContentAnalytics")" class="btn btn-sm btn-ghost text-primary-red analytics-deep-audit-btn">
                                Full Catalog <i class="fas fa-arrow-right ms-1"></i>
                            </a>
                        </div>
                        <div class="card-body p-4">
                            <div id="contentAnalyticsContainer" class="py-5 text-center">
                                <div class="spinner-border text-primary-red" role="status"></div>
                                <p class="text-muted fw-bold text-uppercase tracking-widest small mt-3">Synthesizing entity data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic Tab -->
        <div class="tab-pane fade" id="traffic" role="tabpanel">
            <div class="row g-4">
                <div class="col-md-12">
                    <div class="card card-premium border-0">
                        <div class="card-header bg-transparent border-0 pt-4 px-4">
                            <h5 class="fw-black text-uppercase tracking-tight mb-0">Network Traffic Vector</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="chart-container-lg">
                                <canvas id="trafficChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dashboard/analytics.js"></script>
    <script>
        let currentDateRange = '90d';

        function setDateRange(range) {
            currentDateRange = range;
            
            // Update UI
            $('.btn-group .btn, .d-flex.gap-2.bg-light .btn').removeClass('btn-primary-red shadow-sm').addClass('bg-transparent');
            $(`#btn-${range}`).removeClass('bg-transparent').addClass('btn-primary-red shadow-sm');
            
            loadAnalyticsData();
        }

        function loadAnalyticsData() {
            const endDate = new Date();
            const startDate = new Date();
            
            switch(currentDateRange) {
                case '7d':
                    startDate.setDate(endDate.getDate() - 7);
                    break;
                case '30d':
                    startDate.setDate(endDate.getDate() - 30);
                    break;
                case '90d':
                    startDate.setDate(endDate.getDate() - 90);
                    break;
            }

            $.get('@Url.Action("GetAnalyticsData", "Analytics", new { area = "Dashboard" })', {
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            }, function(data) {
                if (data.success) {
                    updateCharts(data.data);
                }
            });
        }

        function updateCharts(data) {
            // Updated via dashboard/analytics.js
        }

        $(document).ready(function() {
            loadAnalyticsData();
        });
    </script>
}

<style>
    .hover-translate-x:hover { transform: translateX(5px); }
    .transition-all { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .cursor-pointer { cursor: pointer; }
    .nav-pills .nav-link { color: var(--bs-gray-600); transition: all 0.2s ease; border: 1px solid transparent; }
    .nav-pills .nav-link:hover { background: rgba(0,0,0,0.02); }
    .nav-pills .nav-link.active { background: #000 !important; color: #fff !important; }
    .xx-small { font-size: 0.6rem; }
</style>